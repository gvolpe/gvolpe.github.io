<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Unison: Forex API & Caching - Gabriel Volpe</title><meta name=description content="I have been following the Unison programming language for as long as I can remember, given that its authors are very well-known in the Scala ecosystem. Though, â€¦"><meta property="og:title" content="Unison: Forex API & Caching"><meta property="og:description" content="I have been following the Unison programming language for as long as I can remember, given that its authors are very well-known in the Scala ecosystem. Though, â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/unison-forex/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Unison: Forex API & Caching"><meta name=twitter:description content="I have been following the Unison programming language for as long as I can remember, given that its authors are very well-known in the Scala ecosystem. Though, â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css></head><body><main><div id=post-overlay-id class="post-overlay active"><div class=reading-progress></div><div class=post-overlay-backdrop></div><div id=post-overlay-content-id class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2025.05.11</span><div class=reading-time-post><span class=coffee-cups>ðŸ“šðŸ“šðŸ“šðŸ“šðŸ“š
</span><span>17 min read</span></div></div><h1 class=post-title>Unison: Forex API & Caching</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/unison class=post-tag>unison</a>
<a href=https://gvolpe.com/tags/cloud class=post-tag>cloud</a>
<a href=https://gvolpe.com/tags/programming class=post-tag>programming</a>
<a href=https://gvolpe.com/tags/cache class=post-tag>cache</a></div></header><div class=post-body><p>I have been following the <a href=https://www.unison-lang.org/>Unison programming language</a> for as long as I can remember, given that <a href=https://www.unison-lang.org/unison-computing/>its authors</a> are very well-known in the Scala ecosystem. Though, it took me a good few years to finally learn it by immersing myself into their amazing documentation and tutorials.</p><p><strong>TL;DR: I love it more and more every single day!</strong></p><p>The language itself is easy to learn for anyone coming from a functional programming background. Even their implementation of <a href=https://arxiv.org/pdf/1611.09259>algebraic effects</a> &mdash; called <a href=https://www.unison-lang.org/docs/fundamentals/abilities/>abilities</a> &mdash; are quite straightforward. What sets the language apart from others is their interactive approach to writing code.</p><p>Unison stores all code on a local database (under <code>~/.unison</code> by default), which can be shared with others on their platform: <a href=https://share.unison-lang.org>Unison Share</a>. Thus, our code doesn&rsquo;t live on files tracked on a git repository: instead, they need to be fetched from the database to be edited. This is incredibly different from what we, programmers, are used to. It took me a while to get comfortable with this process &mdash; forgetting about my vim fuzzy-finder in between &mdash; and I would even say it was more challenging than learning the language itself, but it clicked&mldr; eventually.</p><p>I will spare you the details, however, as I find it quite hard to convey with words how it feels to experience it. So I would leave that to you to explore and find out for yourself. Instead, I would like to share more about my experience using the features that excite me the most in the Unison multiverse.</p><h2 id=learn-by-doing>Learn by doing</h2><p>A while ago now (~6 years ago), I wrote an <a href=https://github.com/gvolpe/exchange-rates>exchange rates</a> application in Haskell for fun that exposes an API endpoint to query specific currencies. Internally, it relies on a third-party API that&rsquo;s rate-limited, so the results are cached in Redis with a configurable expiration time.</p><p>I thought this could be good candidate for a rewrite in the Unison language, leveraging their <a href=https://www.unison.cloud/>cloud infrastructure</a> and native <a href=https://www.unison.cloud/docs/storage-solutions/>storage solutions</a>, so I could get acquainted with the language and its radical approach to writing code. After all, learning by doing is always more fun and rewarding.</p><p>It all started by creating a new project via UCM: Unison Codebase Manager.</p><p><img src=../../images/unison/ucm.png alt=ucm></p><p>And with me being a nix-head, of course I ended up creating a <a href=https://github.com/gvolpe/unison-dev>development shell</a> that provides the <code>ucm</code> program when I enter the directory where I write Unison code. All made possible thanks to <a href=https://github.com/ceedubs/unison-nix/>unison-nix</a>.</p><h2 id=the-project>The Project</h2><p>The requirements for this Foreign Exchange Rates API are rather simple. All we need is a single GET endpoint that returns the exchange rate between two supported currencies.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl https://gvolpe.unison-services.cloud/s/forex/api/rates?from<span style=color:#f92672>=</span>USD&amp;to<span style=color:#f92672>=</span>EUR  | jq
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;rate&#34;</span>: 0.8885
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>And a healthcheck endpoint for good measure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl https://gvolpe.unison-services.cloud/s/forex/api/healthcheck  | jq
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;db&#34;</span>: <span style=color:#e6db74>&#34;6fcf7ba3-4a3b-440e-a225-cc3d8d1917e8 (currencies)&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>The response body is irrelevant here. We mostly care about the HTTP response status being 200 OK.</p><p>Internally, we will use a <a href=https://www.exchangerate-api.com/docs/standard-requests>third-party API</a> that&rsquo;s rate-limited to 1500 requests per month, and it requires an API key used as an authorization bearer token to authenticate HTTP requests.</p><p><img src=../../images/unison/ext-api.png alt=ext-api></p><p>The challenge will be to cache as many results as possible for a period of 24 hours (see <a href=https://www.exchangerate-api.com/terms>Data Caching Policy</a>) to avoid stale data, but also to optimize the number of external HTTP requests we need to make, while keeping away from getting rate-limited.</p><p>In the next few sections, we&rsquo;ll cover the main components of the <a href=https://share.unison-lang.org/@gvolpe/forex>forex</a> system. Feel free to follow along by navigating directly through the source code for a more interactive approach. However, before we do, I would like to share my personal wish list from my first pain points I experienced with the language.</p><h3 id=wish-list>Wish list</h3><p>Unison doesn&rsquo;t support bounded polymorphism as languages like Haskell do via typeclasses, but different options <a href=https://www.unison-lang.org/docs/usage-topics/general-faqs/#does-unison-have-haskell-style-type-classes>are being considered</a>. Having a functional programming background, I really miss a few things you can do with typeclasses. See, for example, the <a href=https://share.unison-lang.org/@gvolpe/forex/code/main/latest/types/domain/Currency>Currency</a> definition.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#66d9ef>type</span> domain<span style=color:#f92672>.</span><span style=color:#66d9ef>Currency</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span> <span style=color:#66d9ef>AED</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>AFN</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>ALL</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>AMD</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>ANG</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>AOA</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>ARS</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>AUD</span>
</span></span></code></pre></div><p>It consists of an enumeration of 166 values (trimmed here for brevity). However, in our API endpoint we parse the currencies as <code>Text</code>, and need to be able to convert them to a valid <code>Currency</code>. To do this, I had to write a <a href=https://share.unison-lang.org/@gvolpe/forex/code/main/latest/terms/domain/Currency/fromText>very lengthy and tedious string pattern-matching</a> for every single currency &mdash; I wouldn&rsquo;t have bothered with this if vim macros weren&rsquo;t a thing ðŸ˜…</p><p>Conversely, in the Haskell version, this is easily achieved via typeclass derivation and enum support.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#66d9ef>Currency</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>AED</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>AFN</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>ALL</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>AMD</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>ANG</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>AOA</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>ARS</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>AUD</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>AWG</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>AZN</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>deriving</span> (<span style=color:#66d9ef>Enum</span>, <span style=color:#66d9ef>Generic</span>, <span style=color:#66d9ef>Eq</span>, <span style=color:#66d9ef>Ord</span>, <span style=color:#66d9ef>Show</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>instance</span> <span style=color:#66d9ef>FromJSON</span> <span style=color:#66d9ef>Currency</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>instance</span> <span style=color:#66d9ef>ToJSON</span> <span style=color:#66d9ef>Currency</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>currencies</span> <span style=color:#f92672>::</span> [<span style=color:#66d9ef>Currency</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>currencies</span> <span style=color:#f92672>=</span> enumFrom <span style=color:#66d9ef>AED</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>parseCurrency</span> <span style=color:#f92672>::</span> <span style=color:#66d9ef>Text</span> <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>Maybe</span> <span style=color:#66d9ef>Currency</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>parseCurrency</span> t <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> s <span style=color:#f92672>=</span> pack <span style=color:#f92672>.</span> show <span style=color:#f92672>&lt;$&gt;</span> currencies
</span></span><span style=display:flex><span>      i <span style=color:#f92672>=</span> elemIndex (toUpper t) s
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>in</span>  (currencies <span style=color:#f92672>!!</span>) <span style=color:#f92672>&lt;$&gt;</span> i
</span></span></code></pre></div><p>Typeclasses here are only a means to an end, so I would love to have the same kind of power while writing Unison code, whether that&rsquo;s done via typeclasses or something from the future.</p><p>Did I miss something obvious in Unison APIs or documentation that would simplify this?</p><p>Another thing I miss compared to the usual Git repo approach is having a CI/CD job running regression and smoke tests. With Unison having its own platform for sharing code, deployments are left to running manual commands in <code>ucm</code> (like <code>run deploy</code>) instead of having an automated job taking care of it. I&rsquo;m sure this will be supported at some point, but until then, it&rsquo;ll remain on my wish list.</p><p>Now with this out of the way, let&rsquo;s move on with the exciting bits of writing my first Unison project!</p><h3 id=http-routes>HTTP routes</h3><p>It all starts by defining the API endpoints that are combined via <code>&lt;|></code>.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>api</span><span style=color:#f92672>.</span>routes <span style=color:#66d9ef>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>HttpRequest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>-&gt;</span>{<span style=color:#66d9ef>Exception</span>, <span style=color:#66d9ef>Http</span>, <span style=color:#66d9ef>Log</span>, <span style=color:#66d9ef>Ask</span> <span style=color:#66d9ef>AppCtx</span>, <span style=color:#66d9ef>Cache</span> <span style=color:#66d9ef>Currency</span> <span style=color:#66d9ef>ForexResponse</span>} <span style=color:#66d9ef>HttpResponse</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>api</span><span style=color:#f92672>.</span>routes <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  use <span style=color:#66d9ef>Route</span> <span style=color:#f92672>&lt;|&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Route</span><span style=color:#f92672>.</span>run (getExchangeRate <span style=color:#f92672>&lt;|&gt;</span> healthcheck)
</span></span></code></pre></div><p>It essentially returns a <code>HttpRequest -> HttpResponse</code> function where the abilities expressed in <code>{}</code> need to be handled. The <code>{Exception, Http, Log}</code> abilities allow us to express what this program needs in order to run. The <code>Ask AppCtx</code> should be familiar to functional programmers: it lets us carry context around functions. Finally, the <code>Cache Currency ForexResponse</code> is the ability that lets us cache responses for each currency. We&rsquo;ll dive deeper into this topic in the next few sections.</p><p>Let&rsquo;s skip the <code>healthcheck</code> endpoint for now and let&rsquo;s look at the <code>GET /rates</code> endpoint.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>api</span><span style=color:#f92672>.</span>getExchangeRate <span style=color:#66d9ef>:</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Route,</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Exception</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Http</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Log</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Ask</span> <span style=color:#66d9ef>AppCtx</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Cache</span> <span style=color:#66d9ef>Currency</span> <span style=color:#66d9ef>ForexResponse</span>} ()
</span></span><span style=display:flex><span><span style=color:#a6e22e>api</span><span style=color:#f92672>.</span>getExchangeRate <span style=color:#f92672>=</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  use <span style=color:#66d9ef>ParseQuery</span> currency
</span></span><span style=display:flex><span>  use <span style=color:#66d9ef>Parser</span> <span style=color:#f92672>&amp;</span> <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>  queries <span style=color:#f92672>=</span> <span style=color:#66d9ef>do</span> (currency <span style=color:#e6db74>&#34;from&#34;</span>, currency <span style=color:#e6db74>&#34;to&#34;</span>)
</span></span><span style=display:flex><span>  rate <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    match <span style=color:#66d9ef>Route</span><span style=color:#f92672>.</span>route <span style=color:#66d9ef>GET</span> (s <span style=color:#e6db74>&#34;api&#34;</span> <span style=color:#f92672>/</span> s <span style=color:#e6db74>&#34;rates&#34;</span> <span style=color:#f92672>&amp;</span> queries) with
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>Some</span> from, <span style=color:#66d9ef>Some</span> to) <span style=color:#f92672>-&gt;</span> service<span style=color:#f92672>.</span>forex from to
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>_</span> <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>do</span> throw (<span style=color:#66d9ef>BadRequest</span> <span style=color:#e6db74>&#34;invalid from/to query params&#34;</span>)
</span></span><span style=display:flex><span>  forex<span style=color:#f92672>.</span>handler (toEither rate)
</span></span></code></pre></div><p>We can observe the <code>Route</code> ability here, which is eliminated in the <code>api.routes</code> function by the <code>Route.run</code> handler. This is essentially how abilities are handled in Unison. In a way, they are similar to interfaces for which we provide a specific implementation when the components are wired up.</p><p>The <code>forex.handler</code> function is responsible for building HTTP responses, capturing domain errors.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#66d9ef>type</span> http<span style=color:#f92672>.</span><span style=color:#66d9ef>ForexError</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span> <span style=color:#66d9ef>UnknownError</span> <span style=color:#66d9ef>Nat</span> <span style=color:#66d9ef>Text</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#66d9ef>InvalidApiKey</span> <span style=color:#66d9ef>Text</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#66d9ef>ApiLimitReached</span> <span style=color:#66d9ef>Text</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#66d9ef>NotFound</span> <span style=color:#66d9ef>Text</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span> <span style=color:#66d9ef>BadRequest</span> <span style=color:#66d9ef>Text</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>api</span><span style=color:#f92672>.</span>forex<span style=color:#f92672>.</span>handler <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Either</span> <span style=color:#66d9ef>ForexError</span> <span style=color:#66d9ef>ExchangeRate</span> <span style=color:#f92672>-&gt;</span>{<span style=color:#66d9ef>Route</span>, <span style=color:#66d9ef>Log</span>} ()
</span></span></code></pre></div><h3 id=forex-service>Forex Service</h3><p>Ultimately, we have the <code>service.forex</code> function that, given two currencies (from and to, respectively), returns an <code>ExchangeRate</code> with domain errors expressed via the <code>Throw</code> ability.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>service</span><span style=color:#f92672>.</span>forex <span style=color:#66d9ef>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Currency</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>Currency</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Exception,</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Http</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Log</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Throw</span> <span style=color:#66d9ef>ForexError</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Ask</span> <span style=color:#66d9ef>AppCtx</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Cache</span> <span style=color:#66d9ef>Currency</span> <span style=color:#66d9ef>ForexResponse</span>} <span style=color:#66d9ef>ExchangeRate</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>service</span><span style=color:#f92672>.</span>forex from to <span style=color:#f92672>=</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  use <span style=color:#66d9ef>Currency</span> text
</span></span><span style=display:flex><span>  fromText <span style=color:#f92672>=</span> text from
</span></span><span style=display:flex><span>  toText <span style=color:#f92672>=</span> text to
</span></span><span style=display:flex><span>  match <span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>get from with
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Some</span> (<span style=color:#66d9ef>ForexResponse</span> kv)<span style=color:#f92672>|</span> isSome (<span style=color:#66d9ef>Map</span><span style=color:#f92672>.</span>get toText kv)  <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Log</span><span style=color:#f92672>.</span>info <span style=color:#e6db74>&#34;Cache hit!&#34;</span> [(<span style=color:#e6db74>&#34;from&#34;</span>, fromText), (<span style=color:#e6db74>&#34;to&#34;</span>, toText)]
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>ExchangeRate</span> <span style=color:#f92672>&lt;|</span> <span style=color:#66d9ef>Optional</span><span style=color:#f92672>.</span>getOrBug <span style=color:#e6db74>&#34;unreachable&#34;</span> (<span style=color:#66d9ef>Map</span><span style=color:#f92672>.</span>get toText kv)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>_</span> <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Log</span><span style=color:#f92672>.</span>warn
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Cache miss. Making an external HTTP request.&#34;</span>
</span></span><span style=display:flex><span>        [(<span style=color:#e6db74>&#34;from&#34;</span>, fromText), (<span style=color:#e6db74>&#34;to&#34;</span>, toText)]
</span></span><span style=display:flex><span>      response<span style=color:#f92672>@</span>(<span style=color:#66d9ef>ForexResponse</span> kv) <span style=color:#f92672>=</span> http<span style=color:#f92672>.</span>forex from to ()
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>set from response
</span></span><span style=display:flex><span>      match <span style=color:#66d9ef>Optional</span><span style=color:#f92672>.</span>map <span style=color:#66d9ef>ExchangeRate</span> (<span style=color:#66d9ef>Map</span><span style=color:#f92672>.</span>get toText kv) with
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Some</span> rate <span style=color:#f92672>-&gt;</span> rate
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>None</span>      <span style=color:#f92672>-&gt;</span> throw (<span style=color:#66d9ef>NotFound</span> <span style=color:#e6db74>&#34;cache 404&#34;</span>)
</span></span></code></pre></div><p>It attempts to fetch the currency data from the cache via <code>Cache.get</code>. If there&rsquo;s no cached value, it falls-back to calling the third-party API via the <code>http.forex</code> client &mdash; caching the response for subsequent use.</p><p>The <a href=https://share.unison-lang.org/@gvolpe/forex/code/main/latest/types/Cache>Cache</a> ability is defined as follows:</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>ability</span> <span style=color:#66d9ef>Cache</span> k v <span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>  get <span style=color:#66d9ef>:</span> k <span style=color:#f92672>-&gt;</span>{<span style=color:#66d9ef>Cache</span> k v} <span style=color:#66d9ef>Optional</span> v
</span></span><span style=display:flex><span>  set <span style=color:#66d9ef>:</span> k <span style=color:#f92672>-&gt;</span> v <span style=color:#f92672>-&gt;</span>{<span style=color:#66d9ef>Cache</span> k v} ()
</span></span><span style=display:flex><span>  evict <span style=color:#66d9ef>:</span> k <span style=color:#f92672>-&gt;</span>{<span style=color:#66d9ef>Cache</span> k v} ()
</span></span><span style=display:flex><span>  expire <span style=color:#66d9ef>:</span> {<span style=color:#66d9ef>Cache</span> k v} ()
</span></span></code></pre></div><p>The service only uses the first two functions, but it also allows us to remove a specific key or remove all key-values that have expired. We&rsquo;ll dive into the internals of the handler shortly.</p><h3 id=http-client>HTTP client</h3><p>At last, we have the HTTP client that lets us fetch data from the third-party API.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>http</span><span style=color:#f92672>.</span>forex <span style=color:#66d9ef>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Currency</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>Currency</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Exception, Http, Log, Throw ForexError, Ask AppCtx} ForexResponse</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>http</span><span style=color:#f92672>.</span>forex from to <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>AppCtx</span> <span style=color:#66d9ef>_</span> <span style=color:#66d9ef>_</span> (<span style=color:#66d9ef>ApiKey</span> apiKey)) <span style=color:#f92672>=</span> ask
</span></span><span style=display:flex><span>    use <span style=color:#66d9ef>Currency</span> text
</span></span><span style=display:flex><span>    use <span style=color:#66d9ef>Text</span> <span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    uri <span style=color:#f92672>=</span> <span style=color:#66d9ef>URI</span><span style=color:#f92672>.</span>parse (<span style=color:#e6db74>&#34;https://v6.exchangerate-api.com/v6/latest/&#34;</span> <span style=color:#f92672>++</span> text from)
</span></span><span style=display:flex><span>    request <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>HttpRequest</span><span style=color:#f92672>.</span>addHeader
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Authorization&#34;</span> (<span style=color:#e6db74>&#34;Bearer &#34;</span> <span style=color:#f92672>++</span> apiKey) (<span style=color:#66d9ef>HttpRequest</span><span style=color:#f92672>.</span>get uri)
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> <span style=color:#66d9ef>Http</span><span style=color:#f92672>.</span>request request
</span></span><span style=display:flex><span>    match <span style=color:#66d9ef>HttpResponse</span><span style=color:#f92672>.</span>status response with
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Status</span> <span style=color:#ae81ff>200</span> <span style=color:#66d9ef>_</span>  <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>        responseBody <span style=color:#f92672>=</span> bodyText response
</span></span><span style=display:flex><span>        info <span style=color:#e6db74>&#34;External Forex Response: &#34;</span> [(<span style=color:#e6db74>&#34;body&#34;</span>, responseBody)]
</span></span><span style=display:flex><span>        match catch <span style=color:#66d9ef>do</span> <span style=color:#66d9ef>Decoder</span><span style=color:#f92672>.</span>run <span style=color:#66d9ef>ForexResponse</span><span style=color:#f92672>.</span>fromJson responseBody with
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>Left</span> (<span style=color:#66d9ef>Failure</span> <span style=color:#66d9ef>_</span> e <span style=color:#66d9ef>_</span>)          <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Log</span><span style=color:#f92672>.</span><span style=color:#a6e22e>error</span> e <span style=color:#66d9ef>[]</span>
</span></span><span style=display:flex><span>            throw (<span style=color:#66d9ef>UnknownError</span> <span style=color:#ae81ff>500</span> <span style=color:#e6db74>&#34;JSON decoding failure&#34;</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>Right</span> resp<span style=color:#f92672>@</span>(<span style=color:#66d9ef>ForexResponse</span> kv) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            match <span style=color:#66d9ef>Map</span><span style=color:#f92672>.</span>get (text to) kv with
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>Some</span> v <span style=color:#f92672>-&gt;</span> resp
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>None</span>   <span style=color:#f92672>-&gt;</span> throw (<span style=color:#66d9ef>NotFound</span> (text from <span style=color:#f92672>++</span> <span style=color:#e6db74>&#34; -&gt; &#34;</span> <span style=color:#f92672>++</span> text to))
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Status</span> <span style=color:#ae81ff>403</span> e  <span style=color:#f92672>-&gt;</span> throw (<span style=color:#66d9ef>InvalidApiKey</span> e)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Status</span> <span style=color:#ae81ff>404</span> e  <span style=color:#f92672>-&gt;</span> throw (<span style=color:#66d9ef>NotFound</span> e)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Status</span> <span style=color:#ae81ff>429</span> e  <span style=color:#f92672>-&gt;</span> throw (<span style=color:#66d9ef>ApiLimitReached</span> e)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Status</span> code e <span style=color:#f92672>-&gt;</span> throw (<span style=color:#66d9ef>UnknownError</span> code e)
</span></span></code></pre></div><p>In order to authorize requests, an API key is needed, which we can fetch from the context via the <code>Ask</code> ability. We will soon learn about the rest of the data our application context holds.</p><p>Once the request is fired up, we pattern-match on the HTTP response status code and model each response accordingly. Domain errors are expressed via the <code>Throw</code> ability.</p><h3 id=cloud-deployments>Cloud Deployments</h3><p>For the fun part, let&rsquo;s see how easy it is to deploy our service to the <a href=https://www.unison.cloud/>cloud</a>!</p><p><img src=../../images/unison/deploy.png alt=deploy></p><p>Let&rsquo;s ignore the <code>forex-cache-cleanser</code> service for a minute, and let&rsquo;s focus on the <code>forex</code> service instead. We can observe the latest version of the service exposed at <code>https://gvolpe.unison-services.cloud/s/forex</code> now points to a specific service hash showed right above. Unison will ensure this URL stays up-to-date.</p><p>The <code>deploy</code> function is our main entry point based on the <code>Cloud.main</code> handler.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>deploy</span> <span style=color:#66d9ef>:</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{IO, Exception} ()</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>deploy</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Cloud</span><span style=color:#f92672>.</span>main <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    use base ignore
</span></span><span style=display:flex><span>    env <span style=color:#f92672>=</span> <span style=color:#66d9ef>Environment</span><span style=color:#f92672>.</span>named <span style=color:#e6db74>&#34;forex&#34;</span>
</span></span><span style=display:flex><span>    db <span style=color:#f92672>=</span> <span style=color:#66d9ef>Database</span><span style=color:#f92672>.</span>named <span style=color:#e6db74>&#34;currencies&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Database</span><span style=color:#f92672>.</span>assign db env
</span></span><span style=display:flex><span>    apiKey <span style=color:#f92672>=</span> <span style=color:#66d9ef>Cloud</span><span style=color:#f92672>.</span>submit env <span style=color:#66d9ef>ApiKey</span><span style=color:#f92672>.</span>fetch
</span></span><span style=display:flex><span>    cacheConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>CacheConfig</span> <span style=color:#e6db74>&#34;currencies&#34;</span> (<span style=color:#66d9ef>Remote</span><span style=color:#f92672>.</span><span style=color:#66d9ef>Duration</span><span style=color:#f92672>.</span>hours <span style=color:#ae81ff>24</span>)
</span></span><span style=display:flex><span>    appCtx <span style=color:#f92672>=</span> <span style=color:#66d9ef>AppCtx</span> db cacheConfig apiKey
</span></span><span style=display:flex><span>    httpServiceHash <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Cloud</span><span style=color:#f92672>.</span>deployHttp env (req <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Ask</span><span style=color:#f92672>.</span>provide appCtx <span style=color:#66d9ef>do</span> <span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>persistent <span style=color:#66d9ef>do</span> api<span style=color:#f92672>.</span>routes req)
</span></span><span style=display:flex><span>    httpServiceName <span style=color:#f92672>=</span> <span style=color:#66d9ef>ServiceName</span><span style=color:#f92672>.</span>named <span style=color:#e6db74>&#34;forex&#34;</span>
</span></span><span style=display:flex><span>    ignore <span style=color:#f92672>&lt;|</span> <span style=color:#66d9ef>ServiceName</span><span style=color:#f92672>.</span>assign httpServiceName httpServiceHash
</span></span></code></pre></div><p>Here&rsquo;s where all the abilities need to be eliminated, resulting only in <code>{IO, Exception}</code>, which are handled by the Unison runtime.</p><ul><li><code>Cache k v</code> is eliminated by <code>Cache.persistent</code>.</li><li><code>Ask ctx</code> is eliminated by <code>Ask.provide</code></li><li><code>Http, Log, Remote</code> are eliminated by <code>Cloud.deployHttp</code>, which introduces the <code>Cloud</code> ability.</li><li><code>Cloud</code> is eliminated by the <code>Cloud.main</code> handler.</li></ul><p>Now we can monitor our application logs in the Unison Cloud console.</p><p><img src=../../images/unison/api-logs.png alt=forex></p><p>Quite neat! Isn&rsquo;t it? Now let&rsquo;s move on to the next exciting topic.</p><h3 id=caching>Caching</h3><p>The main handler for the <code>Cache</code> ability is based on an internal <a href=https://share.unison-lang.org/@unison/cloud/code/main/latest/types/durable/Cell>Cell</a> &mdash; a table that stores a single durable value, which requires a <a href=https://share.unison-lang.org/@unison/cloud/code/releases/20.7.2/latest/types/Database>Database</a> to be created.</p><p>Without further ado, let&rsquo;s look at the implementation and later discuss the relevant pieces.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>persistent <span style=color:#66d9ef>:</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{g, Cache k v} r -&gt;{g, Exception, Remote, Ask AppCtx} r</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>persistent interactions <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  use <span style=color:#66d9ef>Cell</span> modify
</span></span><span style=display:flex><span>  use <span style=color:#66d9ef>Instant</span> <span style=color:#f92672>+</span> <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  use <span style=color:#66d9ef>Map</span> delete
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>AppCtx</span> db (<span style=color:#66d9ef>CacheConfig</span> cacheName cacheExpiration) <span style=color:#66d9ef>_</span>) <span style=color:#f92672>=</span> ask
</span></span><span style=display:flex><span>  expTime <span style=color:#f92672>=</span> toBaseDuration cacheExpiration
</span></span><span style=display:flex><span>  hasNotExpired <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Instant</span> <span style=color:#f92672>-&gt;</span> (v, <span style=color:#66d9ef>Instant</span>) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>Boolean</span>
</span></span><span style=display:flex><span>  hasNotExpired now <span style=color:#f92672>=</span> cases (value, ts) <span style=color:#f92672>-&gt;</span> ts <span style=color:#f92672>+</span> expTime <span style=color:#f92672>&gt;</span> now
</span></span><span style=display:flex><span>  impl <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Cell</span> (<span style=color:#66d9ef>Map</span> k (v, <span style=color:#66d9ef>Instant</span>)) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>Request</span> {<span style=color:#66d9ef>Cache</span> k v} r <span style=color:#f92672>-&gt;</span> r
</span></span><span style=display:flex><span>  impl cell <span style=color:#f92672>=</span> cases
</span></span><span style=display:flex><span>    { pure }                          <span style=color:#f92672>-&gt;</span> pure
</span></span><span style=display:flex><span>    { <span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>get key <span style=color:#f92672>-&gt;</span> resume }       <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>      now <span style=color:#f92672>=</span> now<span style=color:#f92672>!</span>
</span></span><span style=display:flex><span>      lookup <span style=color:#f92672>=</span> match <span style=color:#66d9ef>Map</span><span style=color:#f92672>.</span>get key (<span style=color:#66d9ef>Cell</span><span style=color:#f92672>.</span>read cell) with
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Some</span> x<span style=color:#f92672>@</span>(v, <span style=color:#66d9ef>_</span>) <span style=color:#f92672>|</span> hasNotExpired now x <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>Some</span> v
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Some</span> <span style=color:#66d9ef>_</span>        <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>          modify cell (kv <span style=color:#f92672>-&gt;</span> (delete key kv, ()))
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>None</span>          <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>      handle resume lookup with impl cell
</span></span><span style=display:flex><span>    { <span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>set key value <span style=color:#f92672>-&gt;</span> resume } <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>      ts <span style=color:#f92672>=</span> now<span style=color:#f92672>!</span>
</span></span><span style=display:flex><span>      modify cell (kv <span style=color:#f92672>-&gt;</span> (<span style=color:#66d9ef>Map</span><span style=color:#f92672>.</span>put key (value, ts) kv, ()))
</span></span><span style=display:flex><span>      handle resume() with impl cell
</span></span><span style=display:flex><span>    { evict key <span style=color:#f92672>-&gt;</span> resume }           <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>      modify cell (kv <span style=color:#f92672>-&gt;</span> (delete key kv, ()))
</span></span><span style=display:flex><span>      handle resume() with impl cell
</span></span><span style=display:flex><span>    { expire <span style=color:#f92672>-&gt;</span> resume }              <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>      now <span style=color:#f92672>=</span> now<span style=color:#f92672>!</span>
</span></span><span style=display:flex><span>      modify cell (kv <span style=color:#f92672>-&gt;</span> (<span style=color:#66d9ef>Map</span><span style=color:#f92672>.</span>filter (hasNotExpired now) kv, ()))
</span></span><span style=display:flex><span>      handle resume() with impl cell
</span></span><span style=display:flex><span>  handle interactions() with impl (<span style=color:#66d9ef>Cell</span><span style=color:#f92672>.</span>named db cacheName <span style=color:#66d9ef>Map</span><span style=color:#f92672>.</span>empty)
</span></span></code></pre></div><p>A <code>Cache k v</code> is internally represented as a <code>Map k (v, Instant)</code> stored in a <code>Cell</code>.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>impl</span> <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Cell</span> (<span style=color:#66d9ef>Map</span> k (v, <span style=color:#66d9ef>Instant</span>)) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>Request</span> {<span style=color:#66d9ef>Cache</span> k v} r <span style=color:#f92672>-&gt;</span> r
</span></span></code></pre></div><p>The <code>Instant</code> value represents the time when the value was written to the cache (see how <code>Cache.set</code> is handled). When we look-up a key-value from the cache, we also look at the timestamp and check if it hasn&rsquo;t expired yet. If it did, then the key-value is removed from the cache.</p><p>This method of <a href=https://redis.io/glossary/cache-invalidation/>cache invalidation</a> (one of my favorite topics in software engineering) is also known as &ldquo;passive&rdquo;, where only data that&rsquo;s being accessed is checked for expirations. However, in bigger systems, data that is not accessed can account for considerable storage space when neglected.</p><p>Arguably, in this simple application we don&rsquo;t need an &ldquo;active&rdquo; cache invalidation method. In the original Forex application written in Haskell, cache expiration was already taken for granted, as Redis handles everything. However, I absolutely love a good challenge, and this brings up a great opportunity to further explore what Unison has got to offer.</p><p>To finish up with the implementation of this handler, the <code>evict</code> function is based on <code>Map.delete</code> whereas the <code>expire</code> function is based on <code>Map.filter</code>, filtering out the expired key-values from the internal map.</p><h4 id=active-cache-invalidation>Active Cache Invalidation</h4><p>A daily cron job calling <code>Cache.expire</code> will be one valid way of implementing active cache invalidation. Now can we do this with Unison services that are deployed via the <code>Cloud</code> handlers? Unfortunately, this only suits applications which follow a request-response cycle.</p><p>For repeated scheduled jobs or queueing systems, we can leverage the <a href=https://share.unison-lang.org/@unison/cloud/code/releases/20.7.2/latest/types/Daemon>Daemon</a> ability, which is considered a low-level cloud utility and it&rsquo;s a <a href=https://www.unison.cloud/pricing/>paid feature</a>.</p><p>We could start defining a simple scheduled job that calls itself every 24 hours.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>daemon</span><span style=color:#f92672>.</span>job <span style=color:#66d9ef>:</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Exception, Remote, Ask AppCtx, Cache Currency ForexResponse} ()</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>daemon</span><span style=color:#f92672>.</span>job <span style=color:#f92672>=</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  use <span style=color:#66d9ef>Text</span> <span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>AppCtx</span> <span style=color:#66d9ef>_</span> (<span style=color:#66d9ef>CacheConfig</span> <span style=color:#66d9ef>_</span> cacheExpiration) <span style=color:#66d9ef>_</span>) <span style=color:#f92672>=</span> ask
</span></span><span style=display:flex><span>  durationText <span style=color:#f92672>=</span> <span style=color:#66d9ef>Duration</span><span style=color:#f92672>.</span>toText (toBaseDuration cacheExpiration)
</span></span><span style=display:flex><span>  impl <span style=color:#66d9ef>:</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Exception, Remote, Cache Currency ForexResponse} ()</span>
</span></span><span style=display:flex><span>  impl <span style=color:#f92672>=</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Log</span><span style=color:#f92672>.</span>info (<span style=color:#e6db74>&#34;Next cache removal in &#34;</span> <span style=color:#f92672>++</span> durationText) <span style=color:#66d9ef>[]</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Remote</span><span style=color:#f92672>.</span>sleep cacheExpiration
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>expire
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Log</span><span style=color:#f92672>.</span>warn <span style=color:#e6db74>&#34;Expired key-values have been removed&#34;</span> <span style=color:#66d9ef>[]</span>
</span></span><span style=display:flex><span>  forever impl
</span></span></code></pre></div><p>However, there&rsquo;s currently a big limitation and we can&rsquo;t monitor daemon logs in the Unison Cloud console as we do with regular services; its API is limited to streaming to the <code>ucm</code> console. For this reason, we&rsquo;ll use a &ldquo;logging service&rdquo;, which the daemon can natively call via the <code>Services</code> ability.</p><p>Firstly, we&rsquo;ll create the program that will log the messages.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#66d9ef>type</span> domain<span style=color:#f92672>.</span><span style=color:#66d9ef>LogMsg</span> <span style=color:#f92672>=</span> { level <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Level</span>, text <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Text</span>, json <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Json</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>daemon</span><span style=color:#f92672>.</span>logJson <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>LogMsg</span> <span style=color:#f92672>-&gt;</span>{<span style=color:#66d9ef>Exception</span>, <span style=color:#66d9ef>Log</span>} ()
</span></span><span style=display:flex><span><span style=color:#a6e22e>daemon</span><span style=color:#f92672>.</span>logJson <span style=color:#f92672>=</span> cases
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>LogMsg</span> level msg json <span style=color:#f92672>-&gt;</span> atLevel<span style=color:#f92672>.</span>lazyJson level (<span style=color:#66d9ef>do</span> msg) <span style=color:#66d9ef>do</span> json
</span></span></code></pre></div><p>We will then write a service named &ldquo;forex-cache-cleanser&rdquo; whose only resposibility is to run the <code>logJson</code> program. The <code>Cloud.deploy</code> handler can be used to deploy this service and get its hash.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>deploy</span> <span style=color:#66d9ef>:</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{IO, Exception} ()</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>deploy</span> <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Cloud</span><span style=color:#f92672>.</span>main <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    logServiceHash <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ServiceHash</span> <span style=color:#66d9ef>LogMsg</span> ()
</span></span><span style=display:flex><span>    logServiceHash <span style=color:#f92672>=</span> <span style=color:#66d9ef>Cloud</span><span style=color:#f92672>.</span>deploy env daemon<span style=color:#f92672>.</span>logJson
</span></span><span style=display:flex><span>    logServiceName <span style=color:#f92672>=</span> <span style=color:#66d9ef>ServiceName</span><span style=color:#f92672>.</span>named <span style=color:#e6db74>&#34;forex-cache-cleanser&#34;</span>
</span></span><span style=display:flex><span>    ignore <span style=color:#f92672>&lt;|</span> <span style=color:#66d9ef>ServiceName</span><span style=color:#f92672>.</span>assign logServiceName logServiceHash
</span></span><span style=display:flex><span>    daemon<span style=color:#f92672>.</span>deploy env <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      provide appCtx <span style=color:#66d9ef>do</span> persistent (cacheCleanser logServiceHash)
</span></span></code></pre></div><p>Next, we invoke the <code>daemon.deploy</code> function with the <code>cacheCleanser</code> program that takes the logging service hash as input. It uses the <code>Daemon.deploy</code> handler, which is analogous to <code>Cloud.deploy</code> for regular services.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>daemon</span><span style=color:#f92672>.</span>deploy <span style=color:#66d9ef>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Environment</span> <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Exception, Services, Remote} () -&gt;{Exception, Cloud} ()</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>daemon</span><span style=color:#f92672>.</span>deploy env program <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  cleanserDaemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>Daemon</span><span style=color:#f92672>.</span>named <span style=color:#e6db74>&#34;forex-cache-cleanser-daemon&#34;</span>
</span></span><span style=display:flex><span>  cleanserHash <span style=color:#f92672>=</span> <span style=color:#66d9ef>Daemon</span><span style=color:#f92672>.</span>deploy cleanserDaemon env program
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Daemon</span><span style=color:#f92672>.</span>assign cleanserDaemon cleanserHash
</span></span></code></pre></div><p>The final definition for the daily scheduled job is called <code>cacheCleanser</code> and is defined as follows.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>daemon</span><span style=color:#f92672>.</span>cacheCleanser <span style=color:#66d9ef>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ServiceHash</span> <span style=color:#66d9ef>LogMsg</span> ()
</span></span><span style=display:flex><span>  <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Exception, Services, Remote, Ask AppCtx, Cache k v} ()</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>daemon</span><span style=color:#f92672>.</span>cacheCleanser logService <span style=color:#f92672>=</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  use <span style=color:#66d9ef>Services</span> call
</span></span><span style=display:flex><span>  use <span style=color:#66d9ef>Text</span> <span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>  logMsg <span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Text</span> <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Remote} LogMsg</span>
</span></span><span style=display:flex><span>  logMsg msg <span style=color:#f92672>=</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    time <span style=color:#f92672>=</span> now<span style=color:#f92672>!</span> <span style=color:#f92672>|&gt;</span> <span style=color:#66d9ef>Instant</span><span style=color:#f92672>.</span>toRFC2822
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LogMsg</span> <span style=color:#66d9ef>Info</span> msg (<span style=color:#66d9ef>Json</span><span style=color:#f92672>.</span>object [(<span style=color:#e6db74>&#34;timestamp&#34;</span>, <span style=color:#66d9ef>Json</span><span style=color:#f92672>.</span>text time)])
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>AppCtx</span> <span style=color:#66d9ef>_</span> (<span style=color:#66d9ef>CacheConfig</span> <span style=color:#66d9ef>_</span> cacheExpiration) <span style=color:#66d9ef>_</span>) <span style=color:#f92672>=</span> ask
</span></span><span style=display:flex><span>  durationText <span style=color:#f92672>=</span> <span style=color:#66d9ef>Duration</span><span style=color:#f92672>.</span>toText (toBaseDuration cacheExpiration)
</span></span><span style=display:flex><span>  impl <span style=color:#66d9ef>:</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Exception, Services, Remote, Cache k v} ()</span>
</span></span><span style=display:flex><span>  impl <span style=color:#f92672>=</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    call logService (logMsg (<span style=color:#e6db74>&#34;Next cache removal in &#34;</span> <span style=color:#f92672>++</span> durationText) ())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Remote</span><span style=color:#f92672>.</span>sleep cacheExpiration
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>expire
</span></span><span style=display:flex><span>    call logService (logMsg <span style=color:#e6db74>&#34;Expired key-values have been removed&#34;</span> ())
</span></span><span style=display:flex><span>  forever impl
</span></span></code></pre></div><p>At last, we can now monitor the daemon logs in the Unison Cloud console.</p><p><img src=../../images/unison/daemon-logs.png alt=daemon-logs></p><p>This is it! We&rsquo;ve effectively implemented active cache invalidation by running a daily scheduled job using Unison&rsquo;s Daemon API. It&rsquo;s still early days, so I believe it will continue to evolve, and I&rsquo;m personally hoping that in the near future we are able to easily monitor logs like we do with regular services.</p><h3 id=local-deployments>Local Deployments</h3><p>Guess what? Cloud programs can be run locally too!</p><p><img src=../../images/unison/local.png alt=run-local></p><p>For this purpose, the <code>deploy</code> function has been refactored, so that our main <code>Cloud</code> program becomes <code>deploy.api</code>, while introducing two new functions.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>deploy</span><span style=color:#f92672>.</span>local <span style=color:#66d9ef>:</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{IO, Exception} ()</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>deploy</span><span style=color:#f92672>.</span>local <span style=color:#f92672>=</span> <span style=color:#66d9ef>Cloud</span><span style=color:#f92672>.</span>main<span style=color:#f92672>.</span>local<span style=color:#f92672>.</span>serve <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  deploy<span style=color:#f92672>.</span>api (<span style=color:#66d9ef>_</span> <span style=color:#f92672>-&gt;</span> getEnv <span style=color:#e6db74>&#34;FOREX_API_KEY&#34;</span> <span style=color:#f92672>|&gt;</span> <span style=color:#66d9ef>ApiKey</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>deploy</span><span style=color:#f92672>.</span>cloud <span style=color:#66d9ef>:</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{IO, Exception} ()</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>deploy</span><span style=color:#f92672>.</span>cloud <span style=color:#f92672>=</span> <span style=color:#66d9ef>Cloud</span><span style=color:#f92672>.</span>main <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  deploy<span style=color:#f92672>.</span>api (env <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>Cloud</span><span style=color:#f92672>.</span>submit env <span style=color:#66d9ef>ApiKey</span><span style=color:#f92672>.</span>fetch)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>deploy</span><span style=color:#f92672>.</span>api <span style=color:#66d9ef>:</span> (<span style=color:#66d9ef>Environment</span> <span style=color:#f92672>-&gt;</span> {<span style=color:#66d9ef>Cloud</span>, <span style=color:#66d9ef>IO</span>, <span style=color:#66d9ef>Exception</span>} <span style=color:#66d9ef>ApiKey</span>) <span style=color:#f92672>-&gt;</span> {<span style=color:#66d9ef>Cloud</span>, <span style=color:#66d9ef>IO</span>, <span style=color:#66d9ef>Exception</span>} ()
</span></span><span style=display:flex><span><span style=color:#a6e22e>deploy</span><span style=color:#f92672>.</span>api getApiKey <span style=color:#f92672>=</span> <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>In the cloud, we submit the job of fetching the API key from the <code>Environment.Config</code> ability, whereas locally we simply fetch it from our local environment variables.</p><p>I was very impressed to learn that the Daemon API is also supported locally!</p><h3 id=testing>Testing</h3><p>We couldn&rsquo;t finish up this blog-post without talking about tests!</p><p><img src=../../images/unison/tests-ok.png alt=tests-ok></p><p>There are a bunch of tests defined in this project, and the image above shows what it looks like to run the entire test suite in the UCM console. We can observe that 13 tests correspond to cached test results, whereas the remaining 5 tests were run once again.</p><p>The reason is that Unison doesn&rsquo;t run tests until a function that&rsquo;s being used changes its hash. When this is the case, all those tests affected by the hash change will be re-run. Otherwise, the tests results displayed in the console will be those that have been previously cached.</p><p>Here&rsquo;s one of the tests for the HTTP client that expects a successful response.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>http</span><span style=color:#f92672>.</span>forex<span style=color:#f92672>.</span>test<span style=color:#f92672>.</span>ok <span style=color:#66d9ef>:</span> [<span style=color:#66d9ef>Result</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>http</span><span style=color:#f92672>.</span>forex<span style=color:#f92672>.</span>test<span style=color:#f92672>.</span>ok <span style=color:#f92672>=</span> test<span style=color:#f92672>.</span>verify <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  body <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;{</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>conversion_rates</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>: {</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>EUR</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>: 1.2, </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>JPY</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>: 5.24}}&#34;</span>
</span></span><span style=display:flex><span>  resp <span style=color:#f92672>=</span> <span style=color:#66d9ef>HttpResponse</span><span style=color:#f92672>.</span>ok (<span style=color:#66d9ef>Body</span><span style=color:#f92672>.</span>fromText body)
</span></span><span style=display:flex><span>  response <span style=color:#f92672>=</span> logAskThrow <span style=color:#66d9ef>do</span> <span style=color:#66d9ef>Http</span><span style=color:#f92672>.</span>stub resp (http<span style=color:#f92672>.</span>forex <span style=color:#66d9ef>USD</span> <span style=color:#66d9ef>EUR</span>)
</span></span><span style=display:flex><span>  expected <span style=color:#f92672>=</span> <span style=color:#66d9ef>ForexResponse</span> (<span style=color:#66d9ef>List</span><span style=color:#f92672>.</span>toMap [(<span style=color:#e6db74>&#34;EUR&#34;</span>, <span style=color:#ae81ff>1.2</span>), (<span style=color:#e6db74>&#34;JPY&#34;</span>, <span style=color:#ae81ff>5.24</span>)])
</span></span><span style=display:flex><span>  test<span style=color:#f92672>.</span>ensureEqual response expected
</span></span></code></pre></div><p>It invokes the <code>http.forex</code> function, which has the following type signature (recap):</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>http</span><span style=color:#f92672>.</span>forex <span style=color:#66d9ef>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Currency</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>Currency</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Exception, Http, Log, Throw ForexError, Ask AppCtx} ForexResponse</span>
</span></span></code></pre></div><p>In this case, we&rsquo;re only interested in the <code>Http</code> ability. We don&rsquo;t want to deal with the other ones, so we can eliminate them with &ldquo;stub&rdquo; handlers defined under the <code>tests</code> namespace, e.g.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>tests</span><span style=color:#f92672>.</span>handler<span style=color:#f92672>.</span>logAsk <span style=color:#66d9ef>:</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{g, Log, Ask AppCtx} a -&gt;{g} a</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tests</span><span style=color:#f92672>.</span>handler<span style=color:#f92672>.</span>logAsk program <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  db <span style=color:#f92672>=</span> <span style=color:#66d9ef>Database</span> (<span style=color:#66d9ef>Database</span><span style=color:#f92672>.</span><span style=color:#66d9ef>Id</span><span style=color:#f92672>.</span><span style=color:#66d9ef>Id</span> <span style=color:#e6db74>&#34;test&#34;</span>) <span style=color:#e6db74>&#34;test&#34;</span>
</span></span><span style=display:flex><span>  cfg <span style=color:#f92672>=</span> <span style=color:#66d9ef>CacheConfig</span> <span style=color:#e6db74>&#34;test&#34;</span> (<span style=color:#66d9ef>Remote</span><span style=color:#f92672>.</span><span style=color:#66d9ef>Duration</span><span style=color:#f92672>.</span>hours <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>  ctx <span style=color:#f92672>=</span> <span style=color:#66d9ef>AppCtx</span> db cfg (<span style=color:#66d9ef>ApiKey</span> <span style=color:#e6db74>&#34;test&#34;</span>)
</span></span><span style=display:flex><span>  provide ctx <span style=color:#66d9ef>do</span> <span style=color:#66d9ef>Log</span><span style=color:#f92672>.</span>stub program
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tests</span><span style=color:#f92672>.</span>handler<span style=color:#f92672>.</span>logAskThrow <span style=color:#66d9ef>:</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{g, Log, Throw e, Ask AppCtx} a -&gt;{g} a</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tests</span><span style=color:#f92672>.</span>handler<span style=color:#f92672>.</span>logAskThrow program <span style=color:#f92672>=</span> <span style=color:#66d9ef>Throw</span><span style=color:#f92672>.</span>toBug <span style=color:#66d9ef>do</span> logAsk program
</span></span></code></pre></div><p>Here&rsquo;s another interesting test that requires a different set of abilities.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>api</span><span style=color:#f92672>.</span>getExchangeRate<span style=color:#f92672>.</span>test<span style=color:#f92672>.</span>cachedOk <span style=color:#66d9ef>:</span> [<span style=color:#66d9ef>Result</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>api</span><span style=color:#f92672>.</span>getExchangeRate<span style=color:#f92672>.</span>test<span style=color:#f92672>.</span>cachedOk <span style=color:#f92672>=</span> test<span style=color:#f92672>.</span>verify <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  keyValue <span style=color:#f92672>=</span> (<span style=color:#66d9ef>USD</span>, <span style=color:#66d9ef>ForexResponse</span> (<span style=color:#66d9ef>List</span><span style=color:#f92672>.</span>toMap [(<span style=color:#e6db74>&#34;EUR&#34;</span>, <span style=color:#ae81ff>1.25</span>)]))
</span></span><span style=display:flex><span>  route <span style=color:#f92672>=</span> cacheRoute getExchangeRate keyValue
</span></span><span style=display:flex><span>  request <span style=color:#f92672>=</span> <span style=color:#66d9ef>HttpRequest</span><span style=color:#f92672>.</span>get (<span style=color:#66d9ef>URI</span><span style=color:#f92672>.</span>parse <span style=color:#e6db74>&#34;/api/rates?from=USD&amp;to=EUR&#34;</span>)
</span></span><span style=display:flex><span>  response <span style=color:#f92672>=</span> runRoute route request
</span></span><span style=display:flex><span>  test<span style=color:#f92672>.</span>ensureEqual (<span style=color:#66d9ef>HttpResponse</span><span style=color:#f92672>.</span>status response) (<span style=color:#66d9ef>Status</span> <span style=color:#ae81ff>200</span> <span style=color:#e6db74>&#34;OK&#34;</span>)
</span></span></code></pre></div><p>It verifies the result comes from the cache, for which we use the <code>Cache.inMemory</code> handler.</p><div class="highlight unison-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>tests</span><span style=color:#f92672>.</span>builder<span style=color:#f92672>.</span>cacheRoute <span style=color:#66d9ef>:</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Route, Exception, Http, Remote, Log, Ask AppCtx, Cache k v} ()</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>-&gt;</span> (k, v)
</span></span><span style=display:flex><span>  <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>{Route, Exception, Remote} ()</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tests</span><span style=color:#f92672>.</span>builder<span style=color:#f92672>.</span>cacheRoute api kv <span style=color:#f92672>=</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>inMemory <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Cache</span><span style=color:#f92672>.</span>set (at1 kv) (at2 kv)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Http</span><span style=color:#f92672>.</span>stub&#39; <span style=color:#66d9ef>do</span> logAsk api
</span></span></code></pre></div><p>To summarize this section, the following image shows that tests can sometimes fail.</p><p><img src=../../images/unison/tests-fail.png alt=tests-fail></p><p>Have a look at the other available tests and let me know if we can do better!</p><h2 id=final-thoughts>Final thoughts</h2><p>Quoting their official website, I couldn&rsquo;t agree more with it.</p><style>.quote::before{content:"ðŸ“œ"}</style><div class=quote><h4>Unison Lang</h4><p>"Unison is a friendly programming language from the future: statically-typed, functional, and a lot of fun ðŸ˜„"</p></div><p><img src=../../images/gifs/future.webp alt=future></p><p>I will certainly continue to learn what this great language has to offer while having lots of fun. There are multiple applications that can be written in it, but if there&rsquo;s an area where you should seriously consider it, is for building distributed systems deployed to their cloud infrastructure.</p><p>Last but not least, I would like to give a big shout out to the Unison team for all the great work they are doing. I had a few questions when going through the documentation and you guys have been awesome!</p><p>Check out the source code and discover more: <a href=https://share.unison-lang.org/@gvolpe/forex>https://share.unison-lang.org/@gvolpe/forex</a>.</p><p>Best,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","33")</script><noscript>Please enable JavaScript to view comments.</noscript><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/home-manager-dotfiles-management/ class=nav-title>Home Manager: dotfiles management</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/niri/ class=nav-title>The perfect tiling window manager</a></div></nav></article><aside class=sidebar><nav class=toc><h4>Contents</h4><div id=toc-content></div></nav></aside></div></div></div></main><script type=text/javascript defer data-domain=gvolpe.com src=https://analytics.gvolpe.com/js/script.js></script><script src=https://gvolpe.com/js/main.js></script></body></html>