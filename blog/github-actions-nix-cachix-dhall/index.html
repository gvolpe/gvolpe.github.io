<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Github actions powered by Nix Shell & Cachix - Gabriel Volpe</title><meta name=description content="The more I learn about Nix ‚Äî a purely functional package manager ‚Äî the more I am convinced this is the way forward. Even if there&rsquo;s still room for big ‚Ä¶"><meta property="og:title" content="Github actions powered by Nix Shell & Cachix"><meta property="og:description" content="The more I learn about Nix ‚Äî a purely functional package manager ‚Äî the more I am convinced this is the way forward. Even if there&rsquo;s still room for big ‚Ä¶"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/github-actions-nix-cachix-dhall/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Github actions powered by Nix Shell & Cachix"><meta name=twitter:description content="The more I learn about Nix ‚Äî a purely functional package manager ‚Äî the more I am convinced this is the way forward. Even if there&rsquo;s still room for big ‚Ä¶"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css></head><body><div class=reading-progress></div><main><div class="post-overlay active"><div class=post-overlay-backdrop></div><div class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2020.06.02</span><div class=reading-time-post><span class=coffee-cups>üìöüìöüìöüìöüìö
</span><span>7 min read</span></div></div><h1 class=post-title>Github actions powered by Nix Shell & Cachix</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/nix class=post-tag>nix</a>
<a href=https://gvolpe.com/tags/nixos class=post-tag>nixos</a>
<a href=https://gvolpe.com/tags/cachix class=post-tag>cachix</a>
<a href=https://gvolpe.com/tags/ci class=post-tag>ci</a>
<a href=https://gvolpe.com/tags/haskell class=post-tag>haskell</a>
<a href=https://gvolpe.com/tags/scala class=post-tag>scala</a>
<a href=https://gvolpe.com/tags/dhall class=post-tag>dhall</a></div></header><div class=post-body><p>The more I learn about <a href=https://nixos.org/nix/>Nix</a> ‚Äî a purely functional package manager ‚Äî the more I am convinced this is the way forward. Even if there&rsquo;s still room for big improvements.</p><p>Today I&rsquo;d like to share with y&rsquo;all what I&rsquo;ve been up-to lately. Though, you could imagine I&rsquo;ve been <em>Nixifying</em> more than one project ;)</p><h3 id=nix-shell>Nix shell</h3><p>Nix shell is a great tool to create reproducible development environments. For example, we could create a shell where the <code>redis</code> package is available, without installing it in our system.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix-shell -p redis
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>nix-shell:~<span style=color:#f92672>]</span>$ redis-cli --version
</span></span><span style=display:flex><span>redis-cli 6.0.3
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>nix-shell:~<span style=color:#f92672>]</span>$ exit
</span></span><span style=display:flex><span>exit
</span></span><span style=display:flex><span>$ redis-cli --version
</span></span><span style=display:flex><span>Command <span style=color:#e6db74>&#39;redis-cli&#39;</span> not found
</span></span></code></pre></div><p>This is not <em>that reproducible</em> since different machines might be pointing to a different Nix channel, or to the same channel but using a different version. To guarantee reproducibility, we need to <a href=https://nixos.wiki/wiki/FAQ/Pinning_Nixpkgs>pin our nixpkgs</a> version.</p><p>Nowadays, it is very common to provide a <code>shell.nix</code> per project, declaring the dependencies needed to build it. This comes in very handy since we can checkout a project, type <code>nix-shell</code> and we would be ready to build it. Furthermore, one could use <a href=https://github.com/nix-community/nix-direnv>nix-direnv</a> instead so that all the needed dependencies are available as soon as we cd into the directory (highly recommended).</p><p>I&rsquo;ve been following this practice in most of my projects, and this blog is not an exception. This is how its <code>shell.nix</code> is defined:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  nixpkgs <span style=color:#f92672>=</span> fetchTarball {
</span></span><span style=display:flex><span>    name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;NixOS-unstable-13-05-2020&#34;</span>;
</span></span><span style=display:flex><span>    url    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://github.com/NixOS/nixpkgs-channels/archive/6bcb1dec8ea.tar.gz&#34;</span>;
</span></span><span style=display:flex><span>    sha256 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;04x750byjr397d3mfwkl09b2cz7z71fcykhvn8ypxrck8w7kdi1h&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> nixpkgs {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ruby <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>ruby_2_7;
</span></span><span style=display:flex><span>  rubygems <span style=color:#f92672>=</span> (pkgs<span style=color:#f92672>.</span>rubygems<span style=color:#f92672>.</span>override { ruby <span style=color:#f92672>=</span> ruby; });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span> pkgs<span style=color:#f92672>.</span>mkShell {
</span></span><span style=display:flex><span>  buildInputs <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    pkgs<span style=color:#f92672>.</span>haskellPackages<span style=color:#f92672>.</span>dhall-json <span style=color:#75715e># v1.6.2</span>
</span></span><span style=display:flex><span>    ruby <span style=color:#75715e># v2.7.1p83</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  shellHook <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mkdir -p .nix-gems
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    export GEM_HOME=$PWD/.nix-gems
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    export GEM_PATH=$GEM_HOME
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    export PATH=$GEM_HOME/bin:$PATH
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you have never seen one, this is what&rsquo;s happening step by step:</p><ol><li><code>fetchTarball</code> gets the specified version of the <code>nixpkgs</code> as a tarball (reproducibility).</li><li><code>rubygems</code> is overriding the <code>ruby</code> version of <code>nixpkgs</code> to match the one we need (<code>2.7.x</code>).</li><li><code>pkgs.mkShell</code> should be self-explanatory; it creates a shell using the specified version of <code>nixpkgs</code>.</li><li><code>buildInputs</code> defines the two dependencies needed to build the project. Actually, only <code>ruby</code> is needed to build the blog; <code>dhall-json</code> is only used locally to generate some YAML files.</li><li><code>shellHook</code> allows us to run some commands to prepare the environment of our shell.</li></ol><p>Now anyone could clone this project on Github and build it locally using Nix. Reproducibility should be guaranteed (well, mostly(*)).</p><p>(*) In a Ruby project, the best way to guarantee reproducibility is by using <a href=https://github.com/nix-community/bundix>bundix</a>, but I didn&rsquo;t bother in using it just to build my blog. After all, I prefer to write code in statically-typed languages.</p><h3 id=github-actions-powered-by-dhall>Github actions powered by Dhall</h3><p>The curious reader might be thinking what are those YAML files we need to build. The answer is the YAML files needed by <a href=https://help.github.com/en/actions>Github actions</a>. Why not defining the YAML files directly? One may ask. The answer is I really <a href=https://noyaml.com/>dislike YAML files</a>.</p><p>So there is <a href=https://dhall-lang.org/>Dhall</a>, which among other things, can generate YAML from a sane Dhall definition via the <code>dhall-to-yaml</code> program. This is how the CI build definition for this blog looks like:</p><div class="highlight dhall-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#66d9ef>GithubActions</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      https<span style=color:#66d9ef>://</span>raw<span style=color:#f92672>.</span>githubusercontent<span style=color:#f92672>.</span>com<span style=color:#f92672>/</span>gvolpe<span style=color:#f92672>/</span>github<span style=color:#f92672>-</span>actions<span style=color:#f92672>-</span>dhall<span style=color:#f92672>/</span>steps<span style=color:#f92672>/</span>cachix<span style=color:#f92672>/</span>package<span style=color:#f92672>.</span>dhall sha256<span style=color:#66d9ef>:</span><span style=color:#ae81ff>4</span>cd8f64770d8b015c2fd52bae5ddfb5b393eb7e0936f7f8e18f311c591b888a5
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> setup <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      [ <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span>steps<span style=color:#f92672>.</span>checkout
</span></span><span style=display:flex><span>      , <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span>steps<span style=color:#f92672>.</span>cachix<span style=color:#f92672>/</span>install<span style=color:#f92672>-</span>nix
</span></span><span style=display:flex><span>      , <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span>steps<span style=color:#f92672>.</span>cachix<span style=color:#f92672>/</span>cachix { cache<span style=color:#f92672>-</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gvolpe-blog&#34;</span> }
</span></span><span style=display:flex><span>      , <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span>steps<span style=color:#f92672>.</span>run
</span></span><span style=display:flex><span>          { run <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nix-shell run -- </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>bundle install &amp;&amp; bundle exec jekyll build</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span> }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>  <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span><span style=color:#66d9ef>Workflow</span><span style=color:#f92672>::</span>{
</span></span><span style=display:flex><span>    , name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Blog&#34;</span>
</span></span><span style=display:flex><span>    , on <span style=color:#f92672>=</span> <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span><span style=color:#66d9ef>On</span><span style=color:#f92672>::</span>{
</span></span><span style=display:flex><span>      , pull_request <span style=color:#f92672>=</span> <span style=color:#66d9ef>Some</span> <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span><span style=color:#66d9ef>PullRequest</span><span style=color:#f92672>::</span>{<span style=color:#f92672>=</span>}
</span></span><span style=display:flex><span>      , push <span style=color:#f92672>=</span> <span style=color:#66d9ef>Some</span> <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span><span style=color:#66d9ef>Push</span><span style=color:#f92672>::</span>{ branches <span style=color:#f92672>=</span> <span style=color:#66d9ef>Some</span> [ <span style=color:#e6db74>&#34;master&#34;</span> ] }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    , jobs <span style=color:#f92672>=</span> toMap
</span></span><span style=display:flex><span>        { build <span style=color:#f92672>=</span> <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span><span style=color:#66d9ef>Job</span><span style=color:#f92672>::</span>{
</span></span><span style=display:flex><span>          , name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;build&#34;</span>
</span></span><span style=display:flex><span>          , needs <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span> (<span style=color:#66d9ef>List</span> <span style=color:#66d9ef>Text</span>)
</span></span><span style=display:flex><span>          , runs<span style=color:#f92672>-</span>on <span style=color:#f92672>=</span> <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span>types<span style=color:#f92672>.</span><span style=color:#66d9ef>RunsOn</span><span style=color:#f92672>.</span>`ubuntu<span style=color:#f92672>-</span><span style=color:#ae81ff>18.04</span>`
</span></span><span style=display:flex><span>          , steps <span style=color:#f92672>=</span> setup
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Besides giving us types, Dhall gives us <a href=http://www.haskellforall.com/2017/11/semantic-integrity-checks-are-next.html>semantic integrity checks</a>, which is a great and secure way of versioning files. You should really read the linked blogpost if you haven&rsquo;t heard of it.</p><p>Notice how we use the same <code>shell.nix</code> we use for local development to build our software in the CI pipeline. Isn&rsquo;t that awesome? No more duplicate ways of building packages! This way, we guarantee that whatever works locally, also works on our CI.</p><p>Now, what am I using to write this nice Dhall definition? The answer is <a href=https://github.com/regadas/github-actions-dhall>Github Actions Dhall</a>, a project by Filipe Regadas.</p><p>In this particular example, I&rsquo;m pointing at my fork, which contains the definitions of the <code>cachix/install-nix</code> and <code>cachix/cachix</code> actions. Ultimately, these changes will be available upstream, I hope.</p><p>All we need to do to generate the required YAML file is to run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dhall-to-yaml --file ci.dhall &gt; ci.yml
</span></span></code></pre></div><p>I know this is a bit annoying at the moment, but I&rsquo;d do this 1000 times over writing YAML directly. The interesting thing is that Github could support Dhall definitions natively - I actually submitted a feature request but I don&rsquo;t know if they will consider it.</p><p>All they need to do is to have <code>dhall-json</code> installed, take in a Dhall definition and run the same <code>dhall-to-yaml</code> command. Now they can just re-use the existing infrastructure! <em>It would be fantastic if Github pulls this off</em>.</p><h3 id=caching-derivations>Caching derivations</h3><p><a href=https://cachix.org/>Cachix</a> is a binary cache as a service, and it is free for public caches and open-source projects. It helps speeding up your CI build as well as builds in other machines that share the same <code>shell.nix</code>.</p><p>Its main documentation is centered around building Nix derivations, so this is what you will find:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cachix create &lt;name&gt;
</span></span><span style=display:flex><span>$ nix-build | cachix push &lt;name&gt;
</span></span><span style=display:flex><span>$ cachix use &lt;name&gt;
</span></span></code></pre></div><p>However, if we try to build our <code>shell.nix</code> file, this is what happens:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix-build shell.nix
</span></span><span style=display:flex><span>these derivations will be built:
</span></span><span style=display:flex><span>  /nix/store/7lyp4vfrrsn7rx3rwy31va2l10g4xkxq-nix-shell.drv
</span></span><span style=display:flex><span>building <span style=color:#e6db74>&#39;/nix/store/7lyp4vfrrsn7rx3rwy31va2l10g4xkxq-nix-shell.drv&#39;</span>...
</span></span><span style=display:flex><span>nobuildPhase
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>This derivation is not meant to be built, aborting
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>builder <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#39;/nix/store/7lyp4vfrrsn7rx3rwy31va2l10g4xkxq-nix-shell.drv&#39;</span> failed with exit code <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>error: build of <span style=color:#e6db74>&#39;/nix/store/7lyp4vfrrsn7rx3rwy31va2l10g4xkxq-nix-shell.drv&#39;</span> failed
</span></span></code></pre></div><p>Don&rsquo;t worry. Cachix supports building and pushing the derivations of a Nix shell but it is currently an under-documented feature! This is how we can do it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix-shell
</span></span><span style=display:flex><span>$ nix-store -qR --include-outputs <span style=color:#66d9ef>$(</span>nix-instantiate shell.nix<span style=color:#66d9ef>)</span> | cachix push &lt;name&gt;
</span></span></code></pre></div><p>The first step might not be necessary if you already evaluated your shell or are using Nix Direnv.</p><p>Once you learn how to use Cachix, you could take advantage of it on Github actions by using <a href=https://github.com/cachix/cachix-action>Cachix Action</a>, which is the action used in our Dhall file above.</p><p>So far, I have been trying this configuration on <a href=https://github.com/gvolpe/blog>this blog</a>, on a <a href=https://github.com/profunktor/redis4cats>Scala project</a> and on a <a href=https://github.com/gvolpe/shopping-cart-haskell>Haskell project</a>. The conclusion is that for a CI build job I could probably get away without using Cachix and it&rsquo;ll still be the same. However, as soon as the Nix dependencies of your project start to grow, you may notice a difference.</p><p>Here&rsquo;s a screenshot of the current size of all the caches I have defined:</p><p><img src=../../images/cachix.png alt=cachix></p><h3 id=microsite-publishing-automation>Microsite publishing automation</h3><p>The Redis4Cats project (Scala) is particularly interesting because I use Nix only to publish the static site (microsite) that contains the documentation. This is normally done via the command <code>sbt publishMicrosite</code>, which requires not only <code>sbt</code> and <code>openjdk</code> but also <code>jekyll</code>. Find below the definition of the <code>shell.nix</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  nixpkgs <span style=color:#f92672>=</span> fetchTarball {
</span></span><span style=display:flex><span>    name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;NixOS-unstable-13-05-2020&#34;</span>;
</span></span><span style=display:flex><span>    url    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://github.com/NixOS/nixpkgs-channels/archive/6bcb1dec8ea.tar.gz&#34;</span>;
</span></span><span style=display:flex><span>    sha256 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;04x750byjr397d3mfwkl09b2cz7z71fcykhvn8ypxrck8w7kdi1h&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> nixpkgs {};
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>  pkgs<span style=color:#f92672>.</span>mkShell {
</span></span><span style=display:flex><span>    buildInputs <span style=color:#f92672>=</span> <span style=color:#66d9ef>with</span> pkgs; [
</span></span><span style=display:flex><span>      haskellPackages<span style=color:#f92672>.</span>dhall-json <span style=color:#75715e># 1.6.2</span>
</span></span><span style=display:flex><span>      jekyll <span style=color:#75715e># 4.0.1</span>
</span></span><span style=display:flex><span>      openjdk <span style=color:#75715e># 1.8.0_242</span>
</span></span><span style=display:flex><span>      sbt <span style=color:#75715e># 1.3.10</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>Besides this Nix shell definition, we also have a Dhall definition of the Github actions job required to automate the publishing of the microsite, only when some changes have been made to the site and is pushed to master.</p><div class="highlight dhall-lang"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#66d9ef>GithubActions</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      https<span style=color:#66d9ef>://</span>raw<span style=color:#f92672>.</span>githubusercontent<span style=color:#f92672>.</span>com<span style=color:#f92672>/</span>gvolpe<span style=color:#f92672>/</span>github<span style=color:#f92672>-</span>actions<span style=color:#f92672>-</span>dhall<span style=color:#f92672>/</span>steps<span style=color:#f92672>/</span>cachix<span style=color:#f92672>/</span>package<span style=color:#f92672>.</span>dhall sha256<span style=color:#66d9ef>:</span><span style=color:#ae81ff>4</span>cd8f64770d8b015c2fd52bae5ddfb5b393eb7e0936f7f8e18f311c591b888a5
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> setup <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      [ <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span>steps<span style=color:#f92672>.</span>checkout
</span></span><span style=display:flex><span>      , <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span>steps<span style=color:#f92672>.</span>cachix<span style=color:#f92672>/</span>install<span style=color:#f92672>-</span>nix
</span></span><span style=display:flex><span>      , <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span>steps<span style=color:#f92672>.</span>cachix<span style=color:#f92672>/</span>cachix { cache<span style=color:#f92672>-</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;scala-microsite&#34;</span> }
</span></span><span style=display:flex><span>      , <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span>steps<span style=color:#f92672>.</span>run { run <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nix-shell --run </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>sbt publishSite</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span> }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>  <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span><span style=color:#66d9ef>Workflow</span><span style=color:#f92672>::</span>{
</span></span><span style=display:flex><span>    , name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Microsite&#34;</span>
</span></span><span style=display:flex><span>    , on <span style=color:#f92672>=</span> <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span><span style=color:#66d9ef>On</span><span style=color:#f92672>::</span>{
</span></span><span style=display:flex><span>      , push <span style=color:#f92672>=</span> <span style=color:#66d9ef>Some</span> <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span><span style=color:#66d9ef>Push</span><span style=color:#f92672>::</span>{
</span></span><span style=display:flex><span>        , branches <span style=color:#f92672>=</span> <span style=color:#66d9ef>Some</span> [ <span style=color:#e6db74>&#34;master&#34;</span> ]
</span></span><span style=display:flex><span>        , paths <span style=color:#f92672>=</span> <span style=color:#66d9ef>Some</span> [ <span style=color:#e6db74>&#34;site/**&#34;</span> ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    , jobs <span style=color:#f92672>=</span> toMap
</span></span><span style=display:flex><span>        { publish <span style=color:#f92672>=</span> <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span><span style=color:#66d9ef>Job</span><span style=color:#f92672>::</span>{
</span></span><span style=display:flex><span>          , name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;publish-site&#34;</span>
</span></span><span style=display:flex><span>          , needs <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span> (<span style=color:#66d9ef>List</span> <span style=color:#66d9ef>Text</span>)
</span></span><span style=display:flex><span>          , runs<span style=color:#f92672>-</span>on <span style=color:#f92672>=</span> <span style=color:#66d9ef>GithubActions</span><span style=color:#f92672>.</span>types<span style=color:#f92672>.</span><span style=color:#66d9ef>RunsOn</span><span style=color:#f92672>.</span>`ubuntu<span style=color:#f92672>-</span><span style=color:#ae81ff>18.04</span>`
</span></span><span style=display:flex><span>          , steps <span style=color:#f92672>=</span> setup
</span></span><span style=display:flex><span>          , env <span style=color:#f92672>=</span> <span style=color:#66d9ef>Some</span> (toMap { <span style=color:#66d9ef>GITHUB_TOKEN</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\</span><span style=color:#960050;background-color:#1e0010>${</span><span style=color:#ae81ff>\</span><span style=color:#e6db74>{ secrets.GITHUB_TOKEN }}&#34;</span> })
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>You can see it in action <a href=https://github.com/profunktor/redis4cats/runs/732431811>here</a>. It takes about 13 minutes because the <code>sbt publishMicrosite</code> is a slow task, not because of Nix, but the point is that this is now an automated task and I can forget about it.</p><p>I like all this stuff a lot so I hope to adopt it in other projects quite soon.</p><p>Cheers,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","8")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/parallel-typeclass-for-haskell/>Parallel typeclass for Haskell</a></h4><div class=related-meta>2020.04.20 ‚Ä¢
‚òï‚òï‚òï‚òï‚òï 6 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/setting-up-ghcide-nixpkgs-ubuntu/>Setting up Ghcide in Ubuntu with Nixpkgs</a></h4><div class=related-meta>2020.03.21 ‚Ä¢
‚òï‚òï‚òï‚òï‚òï 7 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/talks/medellin-2019/>Entering a Purely Functional World @ Scala MDE Meetup 2019 - Medellin, CO üá®üá¥</a></h4><div class=related-meta>2019.08.09 ‚Ä¢
‚òï 1 min read</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>‚Üê Previous</span>
<a href=https://gvolpe.com/blog/parallel-typeclass-for-haskell/ class=nav-title>Parallel typeclass for Haskell</a></div><div class=nav-next><span class=nav-label>Next ‚Üí</span>
<a href=https://gvolpe.com/blog/gnome3-on-nixos/ class=nav-title>Gnome 3 on NixOS</a></div></nav></article></div></div></div></main><script src=https://gvolpe.com/js/main.js></script></body></html>