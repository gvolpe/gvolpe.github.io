<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Gnome 3 on NixOS - Gabriel Volpe</title><meta name=description content="NixOS can be configured to run any desktop environment you want and Gnome 3 is not an exception. However, it comes with some caveats so keep reading if you are ‚Ä¶"><meta property="og:title" content="Gnome 3 on NixOS"><meta property="og:description" content="NixOS can be configured to run any desktop environment you want and Gnome 3 is not an exception. However, it comes with some caveats so keep reading if you are ‚Ä¶"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/gnome3-on-nixos/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Gnome 3 on NixOS"><meta name=twitter:description content="NixOS can be configured to run any desktop environment you want and Gnome 3 is not an exception. However, it comes with some caveats so keep reading if you are ‚Ä¶"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css><script type=text/javascript defer data-domain=gvolpe.com data-api=analytics.gvolpe.com src=https://gvolpe.com/js/plausible.js></script></head><body><main><div id=post-overlay-id class="post-overlay active"><div class=reading-progress></div><div class=post-overlay-backdrop></div><div id=post-overlay-content-id class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2020.07.01</span><div class=reading-time-post><span class=coffee-cups>üìöüìöüìöüìö
</span><span>4 min read</span></div></div><h1 class=post-title>Gnome 3 on NixOS</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/nix class=post-tag>nix</a>
<a href=https://gvolpe.com/tags/nixos class=post-tag>nixos</a>
<a href=https://gvolpe.com/tags/gnome class=post-tag>gnome</a>
<a href=https://gvolpe.com/tags/home-manager class=post-tag>home-manager</a>
<a href=https://gvolpe.com/tags/hm class=post-tag>hm</a></div></header><div class=post-body><p><a href=https://nixos.org/>NixOS</a> can be configured to run any desktop environment you want and <a href=https://www.gnome.org/gnome-3/>Gnome 3</a> is not an exception. However, it comes with some caveats so keep reading if you are interested in making this duo work seamlessly.</p><p>Users who enjoy a graphical environment normally like to tweak it with their own preferences as well. E.g. installing new <a href=https://extensions.gnome.org/>extensions</a>, changing the background image, changing the dock, etc. These are some of the tasks that <a href=https://wiki.gnome.org/Apps/Tweaks>Gnome Tweaks</a> makes possible in Gnome 3.</p><p>Except, if you are in NixOS, I&rsquo;m guessing you&rsquo;d like to have all these tweaks declared in a configuration file so the next time you rebuild your system they are preserved, am I right?</p><h3 id=nixos-configuration>NixOS configuration</h3><p>First of all, we want to enable Gnome 3 as our default desktop manager in our <code>/etc/nixos/configuration.nix</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>services <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  xserver <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    layout <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us&#34;</span>;
</span></span><span style=display:flex><span>    displayManager<span style=color:#f92672>.</span>gdm<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    displayManager<span style=color:#f92672>.</span>gdm<span style=color:#f92672>.</span>wayland <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    desktopManager<span style=color:#f92672>.</span>gnome3<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  dbus<span style=color:#f92672>.</span>packages <span style=color:#f92672>=</span> [ pkgs<span style=color:#f92672>.</span>gnome3<span style=color:#f92672>.</span>dconf ];
</span></span><span style=display:flex><span>  udev<span style=color:#f92672>.</span>packages <span style=color:#f92672>=</span> [ pkgs<span style=color:#f92672>.</span>gnome3<span style=color:#f92672>.</span>gnome-settings-daemon ];
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><a href=https://wayland.freedesktop.org/>Wayland</a> is a modern replacement for <a href=https://www.x.org/wiki/>X</a>. I tried it out for a while and it worked pretty well but unfortunately some functionality like screen-sharing is broken, reason why I have it disabled.</p><p>Additionally, you need <code>dconf</code> and <code>gnome-settings-daemon</code> running as a service to configure Gnome 3. This is all we need at the system level.</p><h3 id=home-manager>Home Manager</h3><p><a href=https://github.com/rycee/home-manager>Home Manager</a> is a great tool that manages all the software you want to install at the user level and all the configuration that comes with it. For example, Vim, Fish shell, Tmux, etc.</p><p>It can also manage Gnome extensions for us. Here&rsquo;s an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#f92672>,</span> pkgs<span style=color:#f92672>,</span> stdenv<span style=color:#f92672>,</span> lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  programs<span style=color:#f92672>.</span>home-manager<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  home<span style=color:#f92672>.</span>packages <span style=color:#f92672>=</span> <span style=color:#66d9ef>with</span> pkgs; [
</span></span><span style=display:flex><span>    <span style=color:#75715e># gnome3 apps</span>
</span></span><span style=display:flex><span>    gnome3<span style=color:#f92672>.</span>eog    <span style=color:#75715e># image viewer</span>
</span></span><span style=display:flex><span>    gnome3<span style=color:#f92672>.</span>evince <span style=color:#75715e># pdf reader</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># desktop look &amp; feel</span>
</span></span><span style=display:flex><span>    gnome3<span style=color:#f92672>.</span>gnome-tweak-tool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># extensions</span>
</span></span><span style=display:flex><span>    gnomeExtensions<span style=color:#f92672>.</span>appindicator
</span></span><span style=display:flex><span>    gnomeExtensions<span style=color:#f92672>.</span>dash-to-dock
</span></span><span style=display:flex><span>  ];
</span></span></code></pre></div><p>After running <code>home-manager switch</code>, if the build succeeded, you will see these extensions installed in Gnome Tweaks. Now we can go ahead, turn them on and configure each extension as we like. Next day we install another extension, say <code>gnomeExtensions.battery-status</code>, and again run <code>home-manager switch</code>. You will find out that all the three extensions are now installed but that you have lost the changes made to the configuration of the extensions!</p><p>As I previously mentioned, Gnome 3&rsquo;s configuration is managed by <code>dconf</code>. You can get a description of the configuration by running the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dconf dump / &gt; dconf.settings
</span></span></code></pre></div><p>It will have content similar to the one below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span> org/gnome/desktop/peripherals/mouse <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>natural-scroll<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>speed<span style=color:#f92672>=</span>-0.5
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> org/gnome/desktop/peripherals/touchpad <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>tap-to-click<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>two-finger-scrolling-enabled<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>org/gnome/desktop/input-sources<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>current<span style=color:#f92672>=</span>uint32 <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>sources<span style=color:#f92672>=[(</span><span style=color:#e6db74>&#39;xkb&#39;</span>, <span style=color:#e6db74>&#39;us&#39;</span><span style=color:#f92672>)]</span>
</span></span><span style=display:flex><span>xkb-options<span style=color:#f92672>=[</span><span style=color:#e6db74>&#39; terminate:ctrl_alt_bksp &#39;</span>, <span style=color:#e6db74>&#39; lv3:ralt_switch &#39;</span>, <span style=color:#e6db74>&#39; caps:ctrl_modifier &#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> org/gnome/desktop/screensaver <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>picture-uri<span style=color:#f92672>=</span><span style=color:#e6db74>&#39; file:///home/gvolpe/Pictures/nixos.png &#39;</span>
</span></span></code></pre></div><p>Home Manager provides a <a href=https://rycee.gitlab.io/home-manager/options.html#opt-dconf.settings>dconf.settings</a> option we can use to configure <code>dconf</code>. However, we need to write it in Nix instead. The configuration above will look as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  mkTuple <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>hm<span style=color:#f92672>.</span>gvariant<span style=color:#f92672>.</span>mkTuple;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  dconf<span style=color:#f92672>.</span>settings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;org/gnome/desktop/peripherals/mouse&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;natural-scroll&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;speed&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>-0</span><span style=color:#ae81ff>.5</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;org/gnome/desktop/peripherals/touchpad&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;tap-to-click&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;two-finger-scrolling-enabled&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;org/gnome/desktop/input-sources&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;current&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;uint32 0&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;sources&#34;</span> <span style=color:#f92672>=</span> [ (mkTuple [ <span style=color:#e6db74>&#34;xkb&#34;</span> <span style=color:#e6db74>&#34;us&#34;</span> ]) ];
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;xkb-options&#34;</span> <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;terminate:ctrl_alt_bksp&#34;</span> <span style=color:#e6db74>&#34;lv3:ralt_switch&#34;</span> <span style=color:#e6db74>&#34;caps:ctrl_modifier&#34;</span> ];
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;org/gnome/desktop/screensaver&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;picture-uri&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;file:///home/gvolpe/Pictures/nixos.png&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As we can see, it is a bit tedious to write all of this manually.</p><h3 id=dconf2nix>dconf2nix</h3><p>So I recently made available a tool called <a href=https://github.com/gvolpe/dconf2nix>dconf2nix</a>, which automates this conversion. It is written in a few lines of Haskell, thanks to the expressiveness of parser combinators.</p><p>Once you get the dump of the <code>dconf</code> configuration, you&rsquo;re just a command away from getting it in the Nix format as expected by Home Manager.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dconf2nix -i dconf.settings -o dconf.nix
</span></span></code></pre></div><p>To keep the modularity, it is a good practice to keep the <code>dconf.nix</code> as is, and import it in your <code>home.nix</code> file instead.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#f92672>,</span> pkgs<span style=color:#f92672>,</span> stdenv<span style=color:#f92672>,</span> lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  programs<span style=color:#f92672>.</span>home-manager<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  imports <span style=color:#f92672>=</span> [ <span style=color:#e6db74>./dconf.nix</span> ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And that&rsquo;s it! Next time you make changes in the UI, make sure to also update the <code>dconf.nix</code> file. For instance, you may want to enable some extensions by default.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#e6db74>&#34;org/gnome/shell&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  command-history <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;gnome-tweaks&#34;</span> ];
</span></span><span style=display:flex><span>  enabled-extensions <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;horizontal-workspaces@gnome-shell-extensions.gcampax.github.com&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;dash-to-dock@micxgx.gmail.com&#34;</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>  favorite-apps <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;chromium-browser.desktop&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;spotify.desktop&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;org.gnome.tweaks.desktop&#34;</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>You can have a look at my <a href=https://github.com/gvolpe/nix-config>NixOS configuration</a>, where I have also configured some custom Gnome extensions and a bunch of other stuff.</p><p>Have fun with Nix! And if you happen to find any issue with <a href=https://github.com/gvolpe/dconf2nix>dconf2nix</a>, please report it, as it is quite new and there might be some missing edge cases.</p><p>Cheers,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","9")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/github-actions-nix-cachix-dhall/>Github actions powered by Nix Shell & Cachix</a></h4><div class=related-meta>2020.06.02 ‚Ä¢
üìöüìöüìöüìöüìö 7 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/setting-up-ghcide-nixpkgs-ubuntu/>Setting up Ghcide in Ubuntu with Nixpkgs</a></h4><div class=related-meta>2020.03.21 ‚Ä¢
üìöüìöüìöüìöüìö 7 min read</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>‚Üê Previous</span>
<a href=https://gvolpe.com/blog/github-actions-nix-cachix-dhall/ class=nav-title>Github actions powered by Nix Shell & Cachix</a></div><div class=nav-next><span class=nav-label>Next ‚Üí</span>
<a href=https://gvolpe.com/blog/xmonad-polybar-nixos/ class=nav-title>XMonad + Polybar on NixOS</a></div></nav></article><aside class=sidebar><nav class=toc><h4>Contents</h4><div id=toc-content></div></nav></aside></div></div></div></main><script src=https://gvolpe.com/js/main.js></script></body></html>