<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Scala 3: the missing compiler plugin - Gabriel Volpe</title><meta name=description content="If you have read this post when it first came out and felt offended by its catchy title, let me apologize for it. It caused some controversy, so I decided to â€¦"><meta property="og:title" content="Scala 3: the missing compiler plugin"><meta property="og:description" content="If you have read this post when it first came out and felt offended by its catchy title, let me apologize for it. It caused some controversy, so I decided to â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/scala3-missing-compiler-plugin/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Scala 3: the missing compiler plugin"><meta name=twitter:description content="If you have read this post when it first came out and felt offended by its catchy title, let me apologize for it. It caused some controversy, so I decided to â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css></head><body><main><div id=post-overlay-id class="post-overlay active"><div class=reading-progress></div><div class=post-overlay-backdrop></div><div id=post-overlay-content-id class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2022.11.20</span><div class=reading-time-post><span class=coffee-cups>ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š
</span><span>5 min read</span></div></div><h1 class=post-title>Scala 3: the missing compiler plugin</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/scala class=post-tag>scala</a></div></header><div class=post-body><p>If you have read this post when it first came out and felt offended by its catchy title, let me apologize for it. It caused some controversy, so I decided to change the title completely to highlight more what this post was about in the first place. Hope this time folks read to the end before drawing any conclusion :)</p><hr><p><a href=https://docs.scala-lang.org/scala3/new-in-scala3.html>Scala 3</a> has been around for a while now, but not many people are using it in production just yet. There&rsquo;s a lot of skepticism in the community when starting out a new project.</p><p>It is still a niche language, even though it has seen a lot of adoption in the past few years. Given its hybrid OOP-FP nature, there are &ldquo;sub-communities&rdquo; within the language, one of them being those that go FP all the way embraced by organizations such as <a href=https://typelevel.org/>Typelevel</a>, which has its own ecosystem of libraries.</p><h2 id=tooling>Tooling</h2><p>From what I gathered from different folks, tooling and linting seem to be the biggest push-backs regarding Scala 3 adoption. Although tooling keeps on getting better every day when using <a href=https://scalameta.org/metals/>Metals</a>, it seems IntelliJ IDEA support is not quite there yet&mdash;you can follow its progress using the <a href="https://youtrack.jetbrains.com/issues?q=tag:%20%7BScala%203%7D">Scala 3 tag</a>.</p><p>As a Metals+NeoVim user myself, I am highly satisfied with the tooling support. Though, I must admit I don&rsquo;t use too many features besides completion, navigation and diagnostics.</p><p>Furthermore, new features such as significant whitespace and fewer braces only make it more difficult for tooling to get feature-parity with Scala 2.</p><p>The official site has a <a href=https://docs.scala-lang.org/scala3/guides/migration/tooling-tour.html>Tooling Tour</a> page offering a status report of the different tools such as Sbt, Mill and Maven (the latter still unsupported).</p><h2 id=linting>Linting</h2><p>Linting has been neglected in Scala 3, that&rsquo;s the sad truth. Only in June this year <a href=https://github.com/lampepfl/dotty/issues/15503>it has been made official</a>, and it got assigned in August as a &ldquo;semester project&rdquo;, but it may take a while until <a href=https://github.com/lampepfl/dotty/pull/16157>this work</a> sees the light.</p><p>Anyway, I think linting features such as &ldquo;unused variables&rdquo; and &ldquo;unused imports&rdquo; are only a nice-to-have, so I can understand why this work was not prioritized.</p><p>However, there is one linting feature that has been blocking the FP community from taking this new version of the language more seriously: <code>-Wvalue-discard</code>.</p><p>It may seem insignificant, but this little feature can prevent massive bugs from reaching production in purely functional codebases. Here&rsquo;s an example that showcases its importance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> program<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>IO</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>IO</span><span style=color:#f92672>.</span>ref<span style=color:#f92672>(</span><span style=color:#a6e22e>List</span><span style=color:#f92672>.</span>empty<span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>]).</span>flatMap <span style=color:#f92672>{</span> ref <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>IO</span><span style=color:#f92672>.</span>println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;performing critical work&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    ref<span style=color:#f92672>.</span>set<span style=color:#f92672>(</span><span style=color:#a6e22e>List</span><span style=color:#f92672>.</span>range<span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>11</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Suppose the <code>IO.println</code> does indeed perform critical work. We would be discarding that value, perhaps accidentally, and the Scala compiler won&rsquo;t help us fix this bug! This is extremely critical, and even seasoned functional programmers can forget to connect such values (e.g. via <code>*></code> or <code>flatMap</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>sbt<span style=color:#66d9ef>:</span><span style=color:#66d9ef>demo&gt;</span> <span style=color:#66d9ef>compile</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#66d9ef>success</span><span style=color:#f92672>]</span> <span style=color:#a6e22e>Total</span> time<span style=color:#66d9ef>:</span> <span style=color:#960050;background-color:#1e0010>0</span> <span style=color:#66d9ef>s</span><span style=color:#f92672>,</span> completed <span style=color:#a6e22e>Nov</span> <span style=color:#ae81ff>20</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>2022</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>2</span><span style=color:#66d9ef>:</span><span style=color:#960050;background-color:#1e0010>08</span><span style=color:#66d9ef>:</span><span style=color:#960050;background-color:#1e0010>20</span> <span style=color:#66d9ef>PM</span>
</span></span></code></pre></div><p>This kind of code can be even harder to manually spot in larger codebases.</p><p>Scala 2 ships with <code>-Wvalue-discard</code> (formerly known as <code>-Ywarn-value-discard</code>), which would only emit a warning with the same code, but it is highly recommended to make it a fatal error via the <code>-Xfatal-warnings</code> flag (also present in Scala 3).</p><p>The <a href=https://github.com/typelevel/sbt-tpolecat>sbt-tpolecat</a> plugin makes it easy for us to focus on writing code if we let it manage the configuration of such important flags, which can be further customized.</p><p>It is also worth noticing that there is a <a href=https://github.com/lampepfl/dotty/pull/15975>draft PR</a> started by <a href=https://github.com/cb372>Chris Birchall</a> sometime ago attempting to add support for <code>-Wvalue-discard</code> to the Scala 3 compiler, but it has unfortunately gone inactive.</p><p>Point in case, you may now understand why folks writing pure FP code are being skeptical about adopting Scala 3 in production systems! So, do we wait another year and see if it&rsquo;s finally ready by then?</p><h3 id=give-up-all-hope>Give up all hope?</h3><p>Thankfully, not. Meet the <a href=https://github.com/ghik/zerowaste>Zerowaste</a> compiler plugin coming to the rescue! It detects unused expressions (non-Unit), and it works for all major Scala versions.</p><p>All we need is to add the plugin to our codebase as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>libraryDependencies <span style=color:#f92672>+=</span> compilerPlugin<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;com.github.ghik&#34;</span> <span style=color:#f92672>%</span> <span style=color:#e6db74>&#34;zerowaste&#34;</span> <span style=color:#f92672>%</span> <span style=color:#e6db74>&#34;&lt;version&gt;&#34;</span> cross <span style=color:#a6e22e>CrossVersion</span><span style=color:#f92672>.</span>full<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Together with enabling <code>sbt-tpolecat</code>, the example code no longer compiles.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>sbt<span style=color:#66d9ef>:</span><span style=color:#66d9ef>demo&gt;</span> <span style=color:#f92672>[</span><span style=color:#66d9ef>info</span><span style=color:#f92672>]</span> compiling <span style=color:#ae81ff>6</span> <span style=color:#a6e22e>Scala</span> sources to <span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>gvolpe<span style=color:#f92672>/</span>demo<span style=color:#f92672>/</span>target<span style=color:#f92672>/</span>scala<span style=color:#f92672>-</span><span style=color:#ae81ff>3.2</span><span style=color:#f92672>.</span><span style=color:#ae81ff>1</span><span style=color:#f92672>/</span>classes <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#66d9ef>error</span><span style=color:#f92672>]</span> <span style=color:#f92672>--</span> <span style=color:#a6e22e>Error</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>/home/gvolpe/demo/src/main/scala/demo/Main.scala:</span><span style=color:#960050;background-color:#1e0010>12</span><span style=color:#66d9ef>:</span><span style=color:#960050;background-color:#1e0010>6</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>[</span><span style=color:#66d9ef>error</span><span style=color:#960050;background-color:#1e0010>]</span> <span style=color:#960050;background-color:#1e0010>12</span> <span style=color:#66d9ef>|</span>      <span style=color:#66d9ef>IO.println</span><span style=color:#f92672>(</span><span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>performing</span> <span style=color:#66d9ef>critical</span> <span style=color:#66d9ef>work</span><span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>[</span><span style=color:#66d9ef>error</span><span style=color:#960050;background-color:#1e0010>]</span>    <span style=color:#66d9ef>|</span>      <span style=color:#66d9ef>^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#66d9ef>error</span><span style=color:#f92672>]</span>    <span style=color:#f92672>|</span>      discarded expression <span style=color:#66d9ef>with</span> non<span style=color:#f92672>-</span><span style=color:#a6e22e>Unit</span> value
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#66d9ef>error</span><span style=color:#f92672>]</span> one error found
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#66d9ef>error</span><span style=color:#f92672>]</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>Compile</span> <span style=color:#f92672>/</span> compileIncremental<span style=color:#f92672>)</span> <span style=color:#a6e22e>Compilation</span> failed
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#66d9ef>error</span><span style=color:#f92672>]</span> <span style=color:#a6e22e>Total</span> time<span style=color:#66d9ef>:</span> <span style=color:#960050;background-color:#1e0010>1</span> <span style=color:#66d9ef>s</span><span style=color:#f92672>,</span> completed <span style=color:#a6e22e>Nov</span> <span style=color:#ae81ff>20</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>2022</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>2</span><span style=color:#66d9ef>:</span><span style=color:#960050;background-color:#1e0010>23</span><span style=color:#66d9ef>:</span><span style=color:#960050;background-color:#1e0010>39</span> <span style=color:#66d9ef>PM</span>
</span></span></code></pre></div><p>Yes! Exactly what we all FP nerds have been waiting for ğŸ¤“</p><h2 id=final-thoughts>Final thoughts</h2><p>Although some features are still missing, <strong>I absolutely love Scala 3</strong> and promote its usage in production (we use it at work too). I even <a href=https://leanpub.com/feda>wrote a book</a> that endorses this new version of the language.</p><p>Yes, it would be great if more linting features land in the Scala compiler. But until then, we can rely on the Zerowaste compiler plugin. Still, it could benefit from more testing!</p><p>If you have a Scala 3 project, please do give it a try and report any issues you may find. We can help each other and grow as a community together :)</p><p>Finally, huge thanks to <a href=https://github.com/ghik>Roman Janusz</a> (author of Zerowaste) for being the unsung Scala 3 FP hero!</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","19")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/error-handling-scala3/>Scala 3: Error handling in FP land</a></h4><div class=related-meta>2022.02.08 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 9 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/fsm-fs2-a-match-made-in-heaven/>Finite-State Machines + FS2 streams: A match made in heaven</a></h4><div class=related-meta>2020.12.29 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 12 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/talks/pulsar-2020/>Connecting millions of users @ Apache Pulsar Summit 2020 - Online ğŸŒ</a></h4><div class=related-meta>2020.11.01 â€¢
ğŸ™ï¸ Public Talk</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/error-handling-scala3/ class=nav-title>Scala 3: Error handling in FP land</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/neovim-meets-nix-flakes/ class=nav-title>Neovim meets Nix flakes</a></div></nav></article><aside class=sidebar><nav class=toc><h4>Contents</h4><div id=toc-content></div></nav></aside></div></div></div></main><script type=text/javascript defer data-domain=gvolpe.com src=https://gvolpe.com/js/plausible.js></script><script src=https://gvolpe.com/js/main.js></script></body></html>