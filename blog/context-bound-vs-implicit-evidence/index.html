<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!--<meta name="viewport" content="width=device-width, initial-scale=1">--> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /> <title> Context bound vs Implicit evidence: Performance &bull; gvolpe's blog </title> <meta name="description" content="In a recent pull request review at work I suggested using context bound to declare effect capabilities instead of implicit values as this is what I see the m..."> <link rel="icon" href="/images/favicon.png"> <link rel="canonical" href="https://gvolpe.github.io/blog/context-bound-vs-implicit-evidence/"> <link rel="alternate" type="application/rss+xml" title="gvolpe's blog" href="https://gvolpe.github.io/blog/feed.xml" /> <link rel="stylesheet" href="/css/main.css"> <link rel="stylesheet" href="/assets/css/main.css"/> <!--Also needs to be set in ./_layouts/unified.html--> <script defer data-domain="gvolpe.com" src="https://analytics.gvolpe.com/js/script.js"></script> <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript> </head> <body class=""> <header id="header"> <h1> <a href="/blog">Gabriel Volpe's blog</a> </h1> <div class="overlay"> <div class="container"> <div class="darkmode-div"> <input type="checkbox" id="darkmode" onchange="darkModeEvent(this);"/> <label for="darkmode"> <div id="star"> <div class="star" id="star-1">★</div> <div class="star" id="star-2">★</div> </div> <div id="moon"></div> </label> </div> <nav> <ul> <li><a href="/">Home</a></li> <li><a href="/blog/categories/">Categories</a></li> </ul> </nav> </div> </div> <div id="progress-bar"></div> </header> <script type="text/javascript"> window.onload = function() { document.getElementById("darkmode").checked=false; }; window.onscroll = function() { var docElem = document.documentElement; var docBody = document.body; var scrollTop = docElem['scrollTop'] || docBody['scrollTop']; var scrollTop = docElem['scrollTop'] || docBody['scrollTop']; var scrollBottom = (docElem['scrollHeight'] || docBody['scrollHeight']) - window.innerHeight; var scrollPercent = scrollTop / scrollBottom * 100 + '%'; document.getElementById("progress-bar").style.setProperty("--scrollAmount", scrollPercent); }; function darkModeEvent(box) { var light = document.getElementById("blogpost"); var dark = document.getElementById("accessible"); if (box.checked && light != null) { light.id="accessible"; } if (!box.checked && dark != null) { dark.id="blogpost"; } return false; }; </script> <section id="blogpost" class="main style-post dark fullscreen"> <div class="content"> <div class="post-content"> <header class="post-header"> <h1 class="post-title">Context bound vs Implicit evidence: Performance</h1> <span class="post-meta"> <time class="post-date" datetime="2019-03-12">Mar 12, 2019</time> <span class="post-author">by <a href="/">Gabriel Volpe</a></span> </span> <div class="post-categories"> <span class="post-meta"> <a href="/blog/categories/#scala" class="cat-link">scala</a> </span> </div> </header> <p>In a recent pull request review at work I suggested using context bound to declare effect capabilities instead of implicit values as this is what I see the most in OSS projects and it has also been my preference for a while. It makes the code look nicer even though the latter approach is equivalent. Context bound constraints get translated into implicits values at compile time.</p> <h4 id="context-bound">Context bound</h4> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">p1</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Applicative:</span> <span class="kt">Console</span><span class="o">]</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Console</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">)</span> <span class="o">*&gt;</span>
    <span class="nc">Console</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">)</span> <span class="o">*&gt;</span>
    <span class="nc">Console</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">&quot;c&quot;</span><span class="o">)</span></code></pre></div> <h4 id="implicit-values">Implicit values</h4> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">p2</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">Applicative</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">c</span><span class="k">:</span> <span class="kt">Console</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">c</span><span class="o">.</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">)</span> <span class="o">*&gt;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">)</span> <span class="o">*&gt;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">&quot;c&quot;</span><span class="o">)</span></code></pre></div> <p>Every time we call <code>Console[F]</code> what we are doing is invoking the “summoner” method normally defined as follows:</p> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">object</span> <span class="nc">Console</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">Console</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">Console</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="n">ev</span>
<span class="o">}</span></code></pre></div> <p>So the implicit value gets resolved at compile time only once but I’ve got a very good question:</p> <blockquote> <p>Is there any performance penalty introduced by the summoner?</p> </blockquote> <p>And I thought I knew the answer… But I wasn’t very sure so that was a call for examining the JVM bytecode and see the differences!</p> <h3 id="jvm-bytecode">JVM bytecode</h3> <p>Here’s the bytecode generated for both <code>p1</code> and <code>p2</code>. Let’s take a look at the differences.</p> <h4 id="context-bound-program">Context bound program</h4> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="o">&lt;</span><span class="n">F</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">&gt;</span> <span class="n">F</span> <span class="nf">p1</span><span class="o">(</span><span class="n">cats</span><span class="o">.</span><span class="na">Applicative</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;,</span> <span class="n">com</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">gvolpe</span><span class="o">.</span><span class="na">Console</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;);</span>
  <span class="nl">descriptor:</span> <span class="o">(</span><span class="n">Lcats</span><span class="o">/</span><span class="n">Applicative</span><span class="o">;</span><span class="n">Lcom</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">Console</span><span class="o">;)</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Object</span><span class="o">;</span>
  <span class="nl">flags:</span> <span class="n">ACC_PUBLIC</span>
  <span class="nl">Code:</span>
    <span class="n">stack</span><span class="o">=</span><span class="mi">4</span><span class="o">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">3</span><span class="o">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">3</span>
       <span class="mi">0</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">56</span>                 <span class="c1">// Field cats/implicits$.MODULE$:Lcats/implicits$;</span>
       <span class="mi">3</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">56</span>                 <span class="c1">// Field cats/implicits$.MODULE$:Lcats/implicits$;</span>
       <span class="mi">6</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">61</span>                 <span class="c1">// Field com/github/gvolpe/Console$.MODULE$:Lcom/github/gvolpe/Console$;</span>
       <span class="mi">9</span><span class="o">:</span> <span class="n">aload_2</span>
      <span class="mi">10</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">65</span>                 <span class="c1">// Method com/github/gvolpe/Console$.apply:(Lcom/github/gvolpe/Console;)Lcom/github/gvolpe/Console;</span>
      <span class="mi">13</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">67</span>                 <span class="c1">// String a</span>
      <span class="mi">15</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">73</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod com/github/gvolpe/Console.putStrLn:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">20</span><span class="o">:</span> <span class="n">aload_1</span>
      <span class="mi">21</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">77</span>                 <span class="c1">// Method cats/implicits$.catsSyntaxApply:(Ljava/lang/Object;Lcats/Apply;)Lcats/Apply$Ops;</span>
      <span class="mi">24</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">61</span>                 <span class="c1">// Field com/github/gvolpe/Console$.MODULE$:Lcom/github/gvolpe/Console$;</span>
      <span class="mi">27</span><span class="o">:</span> <span class="n">aload_2</span>
      <span class="mi">28</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">65</span>                 <span class="c1">// Method com/github/gvolpe/Console$.apply:(Lcom/github/gvolpe/Console;)Lcom/github/gvolpe/Console;</span>
      <span class="mi">31</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">79</span>                 <span class="c1">// String b</span>
      <span class="mi">33</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">73</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod com/github/gvolpe/Console.putStrLn:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">38</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">82</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod cats/Apply$Ops.$times$greater:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">43</span><span class="o">:</span> <span class="n">aload_1</span>
      <span class="mi">44</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">77</span>                 <span class="c1">// Method cats/implicits$.catsSyntaxApply:(Ljava/lang/Object;Lcats/Apply;)Lcats/Apply$Ops;</span>
      <span class="mi">47</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">61</span>                 <span class="c1">// Field com/github/gvolpe/Console$.MODULE$:Lcom/github/gvolpe/Console$;</span>
      <span class="mi">50</span><span class="o">:</span> <span class="n">aload_2</span>
      <span class="mi">51</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">65</span>                 <span class="c1">// Method com/github/gvolpe/Console$.apply:(Lcom/github/gvolpe/Console;)Lcom/github/gvolpe/Console;</span>
      <span class="mi">54</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">84</span>                 <span class="c1">// String c</span>
      <span class="mi">56</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">73</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod com/github/gvolpe/Console.putStrLn:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">61</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">82</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod cats/Apply$Ops.$times$greater:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">66</span><span class="o">:</span> <span class="n">areturn</span>
    <span class="nl">LineNumberTable:</span>
      <span class="n">line</span> <span class="mi">10</span><span class="o">:</span> <span class="mi">0</span>
      <span class="n">line</span> <span class="mi">11</span><span class="o">:</span> <span class="mi">24</span>
      <span class="n">line</span> <span class="mi">10</span><span class="o">:</span> <span class="mi">43</span>
      <span class="n">line</span> <span class="mi">12</span><span class="o">:</span> <span class="mi">47</span>
    <span class="nl">LocalVariableTable:</span>
      <span class="n">Start</span>  <span class="n">Length</span>  <span class="n">Slot</span>  <span class="n">Name</span>   <span class="n">Signature</span>
          <span class="mi">0</span>      <span class="mi">67</span>     <span class="mi">0</span>  <span class="k">this</span>   <span class="n">Lcom</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">summoner$</span><span class="o">;</span>
          <span class="mi">0</span>      <span class="mi">67</span>     <span class="mi">1</span> <span class="n">evidence$1</span>   <span class="n">Lcats</span><span class="o">/</span><span class="n">Applicative</span><span class="o">;</span>
          <span class="mi">0</span>      <span class="mi">67</span>     <span class="mi">2</span> <span class="n">evidence$2</span>   <span class="n">Lcom</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">Console</span><span class="o">;</span>
  <span class="nl">Signature:</span> <span class="err">#</span><span class="mi">49</span>                          <span class="c1">// &lt;F:Ljava/lang/Object;&gt;(Lcats/Applicative&lt;TF;&gt;;Lcom/github/gvolpe/Console&lt;TF;&gt;;)TF;</span>
  <span class="nl">MethodParameters:</span>
    <span class="n">Name</span>                           <span class="n">Flags</span>
    <span class="n">evidence$1</span>                     <span class="kd">final</span>
    <span class="n">evidence$2</span>                     <span class="kd">final</span></code></pre></div> <h4 id="implicit-values-program">Implicit values program</h4> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="o">&lt;</span><span class="n">F</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">&gt;</span> <span class="n">F</span> <span class="nf">p2</span><span class="o">(</span><span class="n">cats</span><span class="o">.</span><span class="na">Applicative</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;,</span> <span class="n">com</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">gvolpe</span><span class="o">.</span><span class="na">Console</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;);</span>
  <span class="nl">descriptor:</span> <span class="o">(</span><span class="n">Lcats</span><span class="o">/</span><span class="n">Applicative</span><span class="o">;</span><span class="n">Lcom</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">Console</span><span class="o">;)</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Object</span><span class="o">;</span>
  <span class="nl">flags:</span> <span class="n">ACC_PUBLIC</span>
  <span class="nl">Code:</span>
    <span class="n">stack</span><span class="o">=</span><span class="mi">4</span><span class="o">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">3</span><span class="o">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">3</span>
       <span class="mi">0</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">56</span>                 <span class="c1">// Field cats/implicits$.MODULE$:Lcats/implicits$;</span>
       <span class="mi">3</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">56</span>                 <span class="c1">// Field cats/implicits$.MODULE$:Lcats/implicits$;</span>
       <span class="mi">6</span><span class="o">:</span> <span class="n">aload_2</span>
       <span class="mi">7</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">90</span>                 <span class="c1">// String 1</span>
       <span class="mi">9</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">73</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod com/github/gvolpe/Console.putStrLn:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">14</span><span class="o">:</span> <span class="n">aload_1</span>
      <span class="mi">15</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">77</span>                 <span class="c1">// Method cats/implicits$.catsSyntaxApply:(Ljava/lang/Object;Lcats/Apply;)Lcats/Apply$Ops;</span>
      <span class="mi">18</span><span class="o">:</span> <span class="n">aload_2</span>
      <span class="mi">19</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">92</span>                 <span class="c1">// String 2</span>
      <span class="mi">21</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">73</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod com/github/gvolpe/Console.putStrLn:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">26</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">82</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod cats/Apply$Ops.$times$greater:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">31</span><span class="o">:</span> <span class="n">aload_1</span>
      <span class="mi">32</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">77</span>                 <span class="c1">// Method cats/implicits$.catsSyntaxApply:(Ljava/lang/Object;Lcats/Apply;)Lcats/Apply$Ops;</span>
      <span class="mi">35</span><span class="o">:</span> <span class="n">aload_2</span>
      <span class="mi">36</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">94</span>                 <span class="c1">// String 3</span>
      <span class="mi">38</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">73</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod com/github/gvolpe/Console.putStrLn:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">43</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">82</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod cats/Apply$Ops.$times$greater:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">48</span><span class="o">:</span> <span class="n">areturn</span>
    <span class="nl">LineNumberTable:</span>
      <span class="n">line</span> <span class="mi">15</span><span class="o">:</span> <span class="mi">0</span>
      <span class="n">line</span> <span class="mi">16</span><span class="o">:</span> <span class="mi">18</span>
      <span class="n">line</span> <span class="mi">15</span><span class="o">:</span> <span class="mi">31</span>
      <span class="n">line</span> <span class="mi">17</span><span class="o">:</span> <span class="mi">35</span>
    <span class="nl">LocalVariableTable:</span>
      <span class="n">Start</span>  <span class="n">Length</span>  <span class="n">Slot</span>  <span class="n">Name</span>   <span class="n">Signature</span>
          <span class="mi">0</span>      <span class="mi">49</span>     <span class="mi">0</span>  <span class="k">this</span>   <span class="n">Lcom</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">summoner$</span><span class="o">;</span>
          <span class="mi">0</span>      <span class="mi">49</span>     <span class="mi">1</span> <span class="n">evidence$3</span>   <span class="n">Lcats</span><span class="o">/</span><span class="n">Applicative</span><span class="o">;</span>
          <span class="mi">0</span>      <span class="mi">49</span>     <span class="mi">2</span>     <span class="n">c</span>   <span class="n">Lcom</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">Console</span><span class="o">;</span>
  <span class="nl">Signature:</span> <span class="err">#</span><span class="mi">49</span>                          <span class="c1">// &lt;F:Ljava/lang/Object;&gt;(Lcats/Applicative&lt;TF;&gt;;Lcom/github/gvolpe/Console&lt;TF;&gt;;)TF;</span>
  <span class="nl">MethodParameters:</span>
    <span class="n">Name</span>                           <span class="n">Flags</span>
    <span class="n">ev</span>                             <span class="kd">final</span>
    <span class="n">c</span>                              <span class="kd">final</span></code></pre></div> <p>So the bytecode generated for the context bound approach has a few extra calls to <code>getstatic</code> and <code>invokevirtual</code> but what does this actually mean? Find below the definition given by <a href="https://en.wikipedia.org/wiki/Java_bytecode_instruction_listings">Wikipedia</a>:</p> <ul> <li><code>getstatic</code>: get a static field value of a class, where the field is identified by field reference in the constant pool index (indexbyte1 « 8 + indexbyte2)</li> <li><code>invokevirtual</code>: invoke virtual method on object objectref and puts the result on the stack (might be void); the method is identified by method reference index in constant pool (indexbyte1 « 8 + indexbyte2)</li> </ul> <p>So, is it slower? How can we know? There’s only one way…</p> <h3 id="benchmark-it-all">Benchmark it all!</h3> <p>When not sure about some performance question / issue, benchmark your code. Benchmarking is not easy but fortunately in the JVM we have a fantastic tool: <a href="https://openjdk.java.net/projects/code-tools/jmh/">Java Microbenchark Harness</a> or <code>JMH</code> for short.</p> <p>Here are the simple benchmarks I wrote, calling each method thousand times via <code>replicateA</code> and measuring the throughput:</p> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">cats.Id</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">org.openjdk.jmh.annotations._</span>

<span class="k">class</span> <span class="nc">benchmarks</span> <span class="o">{</span>

  <span class="nd">@Benchmark</span>
  <span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="nc">Mode</span><span class="o">.</span><span class="nc">Throughput</span><span class="o">))</span>
  <span class="k">def</span> <span class="n">contextBoundSummoner</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">p1</span><span class="o">[</span><span class="kt">Id</span><span class="o">].</span><span class="n">replicateA</span><span class="o">(</span><span class="mi">1000</span><span class="o">).</span><span class="n">void</span>

  <span class="nd">@Benchmark</span>
  <span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="nc">Mode</span><span class="o">.</span><span class="nc">Throughput</span><span class="o">))</span>
  <span class="k">def</span> <span class="n">evidenceSummoner</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">p2</span><span class="o">[</span><span class="kt">Id</span><span class="o">].</span><span class="n">replicateA</span><span class="o">(</span><span class="mi">1000</span><span class="o">).</span><span class="n">void</span>

<span class="o">}</span></code></pre></div> <p>And these are the results, running with 20 iterations, 5 warm-up iterations, 1 fork and 1 thread:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">sbt&gt; jmh:run -i <span class="m">20</span> -wi <span class="m">5</span> -f1 -t1
<span class="o">[</span>info<span class="o">]</span> Benchmark              Mode  Cnt      Score     Error  Units
<span class="o">[</span>info<span class="o">]</span> contextBoundSummoner  thrpt   <span class="m">20</span>  15777.375 ± 593.111  ops/s
<span class="o">[</span>info<span class="o">]</span> evidenceSummoner      thrpt   <span class="m">20</span>  17302.136 ± 442.127  ops/s</code></pre></div> <h3 id="conclusion">Conclusion</h3> <p>The difference is small enough to not be a performance concern so I would still recommend using the context bounds approach but remember to benchmark and deeply analyze your code before jumping to conclusions!</p> <h3 id="update">Update</h3> <p>After publishing it on <a href="https://twitter.com/volpegabriel87/status/1105330247086399488">Twitter</a> I’ve got good feedback and some suggestions so here’s the update.</p> <h4 id="macro-based-summoner-imp">Macro-based summoner: imp</h4> <p><a href="https://twitter.com/cbirchall">Chris Birchall</a> shared this interesting macro-based project named <a href="https://github.com/non/imp">imp</a> by <a href="https://twitter.com/d6">Erik Osheim</a> and I ran the same analysis with it.</p> <p>First of all, the summoner was changed accordingly using the <code>summon</code> macro.</p> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">object</span> <span class="nc">Console</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">imp.summon</span>
  <span class="k">import</span> <span class="nn">language.experimental.macros</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Console</span><span class="o">]</span><span class="k">:</span> <span class="kt">Console</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="n">macro</span> <span class="n">summon</span><span class="o">[</span><span class="kt">Console</span><span class="o">[</span><span class="kt">F</span><span class="o">]]</span>
<span class="o">}</span></code></pre></div> <p>And here are the results of the benchmarks, running 20 iterations like before:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">sbt&gt; jmh:run -i <span class="m">20</span> -wi <span class="m">5</span> -f1 -t1
<span class="o">[</span>info<span class="o">]</span> Benchmark              Mode  Cnt      Score     Error  Units
<span class="o">[</span>info<span class="o">]</span> contextBoundSummoner  thrpt   <span class="m">20</span>  14881.788 ± 626.458  ops/s
<span class="o">[</span>info<span class="o">]</span> evidenceSummoner      thrpt   <span class="m">20</span>  15039.118 ± 411.016  ops/s</code></pre></div> <p>The macro-based solution was faster as it claims to be. The scores are almost identical and that’s because the <em>JVM bytecode generated by both methods are exactly the same!</em> And effectively running the benchmarks more times gives similar results and sometimes the winner is the classic <code>evidenceSummoner</code>. So we can safely claim that both methods <code>p1</code> and <code>p2</code> are exactly the same for the JVM.</p> <p>FWIW someone else <a href="https://github.com/DarkDimius/imp-bench">have run benchmarks</a> on <code>imp</code> before. They’re slightly different though.</p> <h4 id="inline-final">@inline final</h4> <p><a href="https://twitter.com/pkhamutou">Pavel Khamutou</a> suggested adding the <code>@inline</code> keyword to the summoner and I have also made it <code>final</code> so here’s how it looks like:</p> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">object</span> <span class="nc">Console</span> <span class="o">{</span>
  <span class="nd">@inline</span> <span class="k">final</span> <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">Console</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">Console</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="n">ev</span>
<span class="o">}</span></code></pre></div> <p>Unfortunately the generated JVM bytecode was the same as without trying to inline it so the benchmark results were very similar to the first results.</p> <h4 id="optlinline---opt-inline-from-compiler-flags"><code>-opt:l:inline</code> &amp; <code>-opt-inline-from:**</code> compiler flags</h4> <p><a href="https://twitter.com/kaidaxofficial">Kaidax</a> suggested turning on the inliner compiler flags as described in this <a href="https://developer.lightbend.com/blog/2018-11-01-the-scala-2.12-2.13-inliner-and-optimizer/index.html">Lightbend blog post</a>. At first I didn’t see any results but after being pointed out on Reddit by <a href="https://www.reddit.com/user/zzyzzyxx">/u/zzyzzyxx</a> that I was doing it wrong (thanks!), I tried once again and the bytecode was effectively changed.</p> <p>The calls to <code>invokevirtual</code> have been removed and a bunch of extra instructions have been added.</p> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="o">&lt;</span><span class="n">F</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">&gt;</span> <span class="n">F</span> <span class="nf">p1</span><span class="o">(</span><span class="n">cats</span><span class="o">.</span><span class="na">Applicative</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;,</span> <span class="n">com</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">gvolpe</span><span class="o">.</span><span class="na">Console</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;);</span>
  <span class="nl">descriptor:</span> <span class="o">(</span><span class="n">Lcats</span><span class="o">/</span><span class="n">Applicative</span><span class="o">;</span><span class="n">Lcom</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">Console</span><span class="o">;)</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Object</span><span class="o">;</span>
  <span class="nl">flags:</span> <span class="n">ACC_PUBLIC</span>
  <span class="nl">Code:</span>
    <span class="n">stack</span><span class="o">=</span><span class="mi">4</span><span class="o">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">3</span><span class="o">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">3</span>
       <span class="mi">0</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">56</span>                 <span class="c1">// Field cats/implicits$.MODULE$:Lcats/implicits$;</span>
       <span class="mi">3</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">56</span>                 <span class="c1">// Field cats/implicits$.MODULE$:Lcats/implicits$;</span>
       <span class="mi">6</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">61</span>                 <span class="c1">// Field com/github/gvolpe/Console$.MODULE$:Lcom/github/gvolpe/Console$;</span>
       <span class="mi">9</span><span class="o">:</span> <span class="n">ifnonnull</span>     <span class="mi">14</span>
      <span class="mi">12</span><span class="o">:</span> <span class="n">aconst_null</span>
      <span class="mi">13</span><span class="o">:</span> <span class="n">athrow</span>
      <span class="mi">14</span><span class="o">:</span> <span class="n">aload_2</span>
      <span class="mi">15</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">63</span>                 <span class="c1">// String a</span>
      <span class="mi">17</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">69</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod com/github/gvolpe/Console.putStrLn:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">22</span><span class="o">:</span> <span class="n">aload_1</span>
      <span class="mi">23</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">73</span>                 <span class="c1">// Method cats/implicits$.catsSyntaxApply:(Ljava/lang/Object;Lcats/Apply;)Lcats/Apply$Ops;</span>
      <span class="mi">26</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">61</span>                 <span class="c1">// Field com/github/gvolpe/Console$.MODULE$:Lcom/github/gvolpe/Console$;</span>
      <span class="mi">29</span><span class="o">:</span> <span class="n">ifnonnull</span>     <span class="mi">34</span>
      <span class="mi">32</span><span class="o">:</span> <span class="n">aconst_null</span>
      <span class="mi">33</span><span class="o">:</span> <span class="n">athrow</span>
      <span class="mi">34</span><span class="o">:</span> <span class="n">aload_2</span>
      <span class="mi">35</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">75</span>                 <span class="c1">// String b</span>
      <span class="mi">37</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">69</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod com/github/gvolpe/Console.putStrLn:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">42</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">78</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod cats/Apply$Ops.$times$greater:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">47</span><span class="o">:</span> <span class="n">aload_1</span>
      <span class="mi">48</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">73</span>                 <span class="c1">// Method cats/implicits$.catsSyntaxApply:(Ljava/lang/Object;Lcats/Apply;)Lcats/Apply$Ops;</span>
      <span class="mi">51</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">61</span>                 <span class="c1">// Field com/github/gvolpe/Console$.MODULE$:Lcom/github/gvolpe/Console$;</span>
      <span class="mi">54</span><span class="o">:</span> <span class="n">ifnonnull</span>     <span class="mi">59</span>
      <span class="mi">57</span><span class="o">:</span> <span class="n">aconst_null</span>
      <span class="mi">58</span><span class="o">:</span> <span class="n">athrow</span>
      <span class="mi">59</span><span class="o">:</span> <span class="n">aload_2</span>
      <span class="mi">60</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">80</span>                 <span class="c1">// String c</span>
      <span class="mi">62</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">69</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod com/github/gvolpe/Console.putStrLn:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">67</span><span class="o">:</span> <span class="n">invokeinterface</span> <span class="err">#</span><span class="mi">78</span><span class="o">,</span>  <span class="mi">2</span>           <span class="c1">// InterfaceMethod cats/Apply$Ops.$times$greater:(Ljava/lang/Object;)Ljava/lang/Object;</span>
      <span class="mi">72</span><span class="o">:</span> <span class="n">areturn</span>
    <span class="nl">StackMapTable:</span> <span class="n">number_of_entries</span> <span class="o">=</span> <span class="mi">3</span>
      <span class="n">frame_type</span> <span class="o">=</span> <span class="mi">255</span> <span class="cm">/* full_frame */</span>
        <span class="n">offset_delta</span> <span class="o">=</span> <span class="mi">14</span>
        <span class="n">locals</span> <span class="o">=</span> <span class="o">[</span> <span class="kd">class</span> <span class="nc">com</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">summoner$</span><span class="o">,</span> <span class="kd">class</span> <span class="nc">cats</span><span class="o">/</span><span class="n">Applicative</span><span class="o">,</span> <span class="kd">class</span> <span class="nc">com</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">Console</span> <span class="o">]</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="o">[</span> <span class="kd">class</span> <span class="nc">cats</span><span class="o">/</span><span class="n">implicits$</span><span class="o">,</span> <span class="kd">class</span> <span class="nc">cats</span><span class="o">/</span><span class="n">implicits$</span> <span class="o">]</span>
      <span class="n">frame_type</span> <span class="o">=</span> <span class="mi">255</span> <span class="cm">/* full_frame */</span>
        <span class="n">offset_delta</span> <span class="o">=</span> <span class="mi">19</span>
        <span class="n">locals</span> <span class="o">=</span> <span class="o">[</span> <span class="kd">class</span> <span class="nc">com</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">summoner$</span><span class="o">,</span> <span class="kd">class</span> <span class="nc">cats</span><span class="o">/</span><span class="n">Applicative</span><span class="o">,</span> <span class="kd">class</span> <span class="nc">com</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">Console</span> <span class="o">]</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="o">[</span> <span class="kd">class</span> <span class="nc">cats</span><span class="o">/</span><span class="n">implicits$</span><span class="o">,</span> <span class="kd">class</span> <span class="nc">cats</span><span class="o">/</span><span class="n">Apply$Ops</span> <span class="o">]</span>
      <span class="n">frame_type</span> <span class="o">=</span> <span class="mi">88</span> <span class="cm">/* same_locals_1_stack_item */</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="o">[</span> <span class="kd">class</span> <span class="nc">cats</span><span class="o">/</span><span class="n">Apply$Ops</span> <span class="o">]</span>
    <span class="nl">LineNumberTable:</span>
      <span class="n">line</span> <span class="mi">10</span><span class="o">:</span> <span class="mi">0</span>
      <span class="n">line</span> <span class="mi">34</span><span class="o">:</span> <span class="mi">14</span>
      <span class="n">line</span> <span class="mi">10</span><span class="o">:</span> <span class="mi">14</span>
      <span class="n">line</span> <span class="mi">11</span><span class="o">:</span> <span class="mi">26</span>
      <span class="n">line</span> <span class="mi">34</span><span class="o">:</span> <span class="mi">34</span>
      <span class="n">line</span> <span class="mi">11</span><span class="o">:</span> <span class="mi">34</span>
      <span class="n">line</span> <span class="mi">10</span><span class="o">:</span> <span class="mi">47</span>
      <span class="n">line</span> <span class="mi">12</span><span class="o">:</span> <span class="mi">51</span>
      <span class="n">line</span> <span class="mi">34</span><span class="o">:</span> <span class="mi">59</span>
      <span class="n">line</span> <span class="mi">12</span><span class="o">:</span> <span class="mi">59</span>
    <span class="nl">LocalVariableTable:</span>
      <span class="n">Start</span>  <span class="n">Length</span>  <span class="n">Slot</span>  <span class="n">Name</span>   <span class="n">Signature</span>
          <span class="mi">0</span>      <span class="mi">73</span>     <span class="mi">0</span>  <span class="k">this</span>   <span class="n">Lcom</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">summoner$</span><span class="o">;</span>
          <span class="mi">0</span>      <span class="mi">73</span>     <span class="mi">1</span> <span class="n">evidence$1</span>   <span class="n">Lcats</span><span class="o">/</span><span class="n">Applicative</span><span class="o">;</span>
          <span class="mi">0</span>      <span class="mi">73</span>     <span class="mi">2</span> <span class="n">evidence$2</span>   <span class="n">Lcom</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">gvolpe</span><span class="o">/</span><span class="n">Console</span><span class="o">;</span>
  <span class="nl">Signature:</span> <span class="err">#</span><span class="mi">49</span>                          <span class="c1">// &lt;F:Ljava/lang/Object;&gt;(Lcats/Applicative&lt;TF;&gt;;Lcom/github/gvolpe/Console&lt;TF;&gt;;)TF;</span>
  <span class="nl">MethodParameters:</span>
    <span class="n">Name</span>                           <span class="n">Flags</span>
    <span class="n">evidence$1</span>                     <span class="kd">final</span>
    <span class="n">evidence$2</span>                     <span class="kd">final</span></code></pre></div> <p>The benchmark results show that it has effectively been optimized:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">sbt&gt; jmh:run -i <span class="m">20</span> -wi <span class="m">5</span> -f1 -t1
<span class="o">[</span>info<span class="o">]</span> Benchmark             Mode  Cnt      Score     Error  Units
<span class="o">[</span>info<span class="o">]</span> contextBoundSummoner  thrpt   <span class="m">20</span>  16330.873 ± 462.765  ops/s
<span class="o">[</span>info<span class="o">]</span> evidenceSummoner      thrpt   <span class="m">20</span>  15768.175 ± 587.291  ops/s</code></pre></div> <h4 id="benchmarking-machine">Benchmarking machine</h4> <p>The benchmarks have run on a Ubuntu 18.04 LTS, 16 GB RAM and Intel® Core™ i7-8550U CPU @ 1.80GHz × 8 machine on Java Oracle™ 8:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">Java<span class="o">(</span>TM<span class="o">)</span> SE Runtime Environment <span class="o">(</span>build 1.8.0_161-b12<span class="o">)</span>
Java HotSpot<span class="o">(</span>TM<span class="o">)</span> 64-Bit Server VM <span class="o">(</span>build 25.161-b12, mixed mode<span class="o">)</span></code></pre></div> <h4 id="source-code">Source code</h4> <p>Try it out yourself: https://github.com/gvolpe/summoner-benchmarks</p> <h3 id="conclusion-2">Conclusion #2</h3> <p>The conclusion remains the same. Context bound constraints are my favorite and as demonstrated have very little overhead. Using the macro-based solution is interesting but if you really care about that level of performance maybe the JVM isn’t what you’re looking for? :)</p> <p><strong><em>Thank you all for your amazing feedback!</em></strong></p> </div> </div> </section> <footer id="footer"> <!-- Icons --> <!-- Look here for more brands icons: https://fortawesome.com/sets/font-awesome-5-brands --> <ul class="icons"> <li><a href="base64:aGVsbG9AZ3ZvbHBlLmNvbQo=" target="_blank" class="icon solid fa-envelope"><span class="label">Email</span></a></li> <!--<li><a href="https://discordapp.com/channels/@me/510276992156041217" target="_blank" class="icon brands fa-discord"><span class="label">Discord</span></a></li>--> <li><a href="https://github.com/gvolpe" target="_blank" class="icon brands fa-github"><span class="label">Github</span></a></li> <li><a href="https://matrix.to/#/@gvolpe:matrix.org" target="_blank" class="icon brands fa-gitter"><span class="label">Matrix</span></a></li> <li><a rel="me" href="https://fosstodon.org/@gvolpe" target="_blank" class="icon brands fa-mastodon"><span class="label">Mastodon</span>></a></li> <li><a href="https://twitter.com/volpegabriel87" target="_blank" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li> <li><a href="https://bsky.app/profile/gvolpe.com" target="_blank" class="icon brands fa-dribbble"><span class="label">Bluesky</span></a></li> <li><a href="https://linkedin.com/in/gmvolpe" target="_blank" class="icon brands fa-linkedin-in"><span class="label">LinkedIn</span></a></li> <li><a href="https://leanpub.com/u/gvolpe" target="_blank" class="icon brands fa-leanpub"><span class="label">LeanPub</span></a></li> <li><a href="https://www.blurb.co.uk/user/gvolpe" target="_blank" class="icon brands fa-bimobject"><span class="label">Blurb</span></a></li> </ul> <small> Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a> </small> <!-- Menu --> <ul class="menu"> <li> &copy; Gabriel Volpe 2020-2025 </li> </ul> </footer> </body> </html></body></html>
