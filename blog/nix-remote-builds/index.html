<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Nix remote builds - Gabriel Volpe</title><meta name=description content="Remote builds enable interesting use cases and experiments. Besides building for different architectures, another use case that comes to mind would be having a â€¦"><meta property="og:title" content="Nix remote builds"><meta property="og:description" content="Remote builds enable interesting use cases and experiments. Besides building for different architectures, another use case that comes to mind would be having a â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/nix-remote-builds/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Nix remote builds"><meta name=twitter:description content="Remote builds enable interesting use cases and experiments. Besides building for different architectures, another use case that comes to mind would be having a â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css></head><body><div class=reading-progress></div><main><div class="post-overlay active"><div class=post-overlay-backdrop></div><div class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2023.02.13</span><div class=reading-time-post><span class=coffee-cups>ğŸ“šğŸ“šğŸ“šğŸ“š
</span><span>4 min read</span></div></div><h1 class=post-title>Nix remote builds</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/nix class=post-tag>nix</a>
<a href=https://gvolpe.com/tags/nixos class=post-tag>nixos</a>
<a href=https://gvolpe.com/tags/flakes class=post-tag>flakes</a>
<a href=https://gvolpe.com/tags/ci class=post-tag>ci</a>
<a href=https://gvolpe.com/tags/garnix class=post-tag>garnix</a>
<a href=https://gvolpe.com/tags/cachix class=post-tag>cachix</a>
<a href=https://gvolpe.com/tags/nixbuild class=post-tag>nixbuild</a></div></header><div class=post-body><p>Remote builds enable interesting use cases and experiments. Besides building for different architectures, another use case that comes to mind would be having a low-resource machine building a derivation that would require heavy CPU usage (e.g. a Rust application) on the fly, without having to rely on CI builds or binary caches, effectively used as a development environment.</p><p>Here&rsquo;s what the <a href=https://nixos.org/manual/nix/stable/advanced-topics/distributed-builds.html>NixOS official documentation</a> has to say on the topic:</p><style>.quote::before{content:"ğŸ“œ"}</style><div class=quote><h4>Remote Builds</h4><p>"Nix supports remote builds, where a local Nix installation can forward Nix builds to other machines. This allows multiple builds to be performed in parallel and allows Nix to perform multi-platform builds in a semi-transparent way. For instance, if you perform a build for a <code>86_64-darwin</code> on an <code>i686-linux</code> machine, Nix can automatically forward the build to a <code>x86_64-darwin</code> machine, if available."</p></div><p>Remote builds enable interesting use cases and experiments. Besides building for different architectures, another use case that comes to mind would be having a low-resource machine building a derivation that would require heavy CPU usage (e.g. a Rust application) on the fly, without having to rely on CI builds or binary caches, effectively used as a development environment.</p><p>While this may sound too good to be truth, not everyone out there has a powerful remote machine to connect to. Moreover, we may want to give remote builds a try to find out whether it could help us solve our problems before considering purchasing a new computer. To fill this gap (and much more!), let me introduce you to Nixbuild.</p><h3 id=nixbuildnet>Nixbuild.net</h3><p>In my <a href=../garnix>previous post</a>, I promised I would write a follow-up post about <a href=https://nixbuild.net/>Nixbuild</a>, officially promoted as follows:</p><style>.quote::before{content:"ğŸ“œ"}</style><div class=quote><h4>Official</h4><p>"The one-stop solution for efficient builds, smart caching and ultra-fast CI pipelines. Scales by default, pay-per-use, no vendor lock-in. Supports x86 and Arm builds."</p></div><p>If you scroll down a bit on their site, you&rsquo;ll find the two fields required to sign up for a free trial: an email and an SSH key. Once you get the email to activate your account, you should head over to the <a href=https://docs.nixbuild.net/getting-started/>Getting started</a> section of the documentation.</p><p>The free account includes 25 free CPU hours of build time at the moment of writing, which should be more than enough to evaluate whether this could be a good fit for us. Or even to just experiment (and have fun!) with it and learn about remote builds :)</p><p>To configure a NixOS machine to run remote builds, we need to do exactly what the documentation says:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  programs<span style=color:#f92672>.</span>ssh<span style=color:#f92672>.</span>extraConfig <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Host eu.nixbuild.net
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      PubkeyAcceptedKeyTypes ssh-ed25519
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      IdentityFile /home/user/.ssh/my-nixbuild-key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  programs<span style=color:#f92672>.</span>ssh<span style=color:#f92672>.</span>knownHosts <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    nixbuild <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      hostNames <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;eu.nixbuild.net&#34;</span> ];
</span></span><span style=display:flex><span>      publicKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPIQCZc54poJ8vqawd8TraNryQeJnvH1eLpIDgbiqymM&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  nix <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    distributedBuilds <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    buildMachines <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        hostName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;eu.nixbuild.net&#34;</span>;
</span></span><span style=display:flex><span>        system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        maxJobs <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span>        supportedFeatures <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;benchmark&#34;</span> <span style=color:#e6db74>&#34;big-parallel&#34;</span> ];
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Make sure to replace <code>IdentityFile</code> with the path to your SSH key. That&rsquo;s everything that&rsquo;s needed, as this <a href=https://github.com/gvolpe/nix-config/pull/166/files>pull request</a> on my repo demonstrates.</p><h3 id=ci-builds>CI builds</h3><p>Continuing with my <a href=https://github.com/gvolpe/nix-config>NixOS configuration</a> as example, we can learn how to leverage Nixbuild as a CI service by using <a href=https://github.com/nixbuild/nixbuild-action>nixbuild-action</a>. Here are the outputs of my Nix flake.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix flake show --allow-import-from-derivation
</span></span><span style=display:flex><span>git+file:///home/gvolpe/workspace/nix-config?ref<span style=color:#f92672>=</span>...
</span></span><span style=display:flex><span>â”œâ”€â”€â”€checks
</span></span><span style=display:flex><span>â”‚   â””â”€â”€â”€x86_64-linux
</span></span><span style=display:flex><span>â”‚       â”œâ”€â”€â”€dell-xps: derivation <span style=color:#e6db74>&#39;nixos-system-dell-xps-15-9560-23.05.20230202.a100acd&#39;</span>
</span></span><span style=display:flex><span>â”‚       â”œâ”€â”€â”€gvolpe-edp: derivation <span style=color:#e6db74>&#39;home-manager-generation&#39;</span>
</span></span><span style=display:flex><span>â”‚       â”œâ”€â”€â”€gvolpe-hdmi: derivation <span style=color:#e6db74>&#39;home-manager-generation&#39;</span>
</span></span><span style=display:flex><span>â”‚       â””â”€â”€â”€tongfang-amd: derivation <span style=color:#e6db74>&#39;nixos-system-tongfang-amd-23.05.20230202.a100acd&#39;</span>
</span></span><span style=display:flex><span>â”œâ”€â”€â”€homeConfigurations: unknown
</span></span><span style=display:flex><span>â”œâ”€â”€â”€nixosConfigurations
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€â”€dell-xps: NixOS configuration
</span></span><span style=display:flex><span>â”‚   â””â”€â”€â”€tongfang-amd: NixOS configuration
</span></span><span style=display:flex><span>â””â”€â”€â”€packages
</span></span><span style=display:flex><span>    â””â”€â”€â”€x86_64-linux
</span></span><span style=display:flex><span>        â”œâ”€â”€â”€metals: package <span style=color:#e6db74>&#39;metals-0.11.10+117-476976c1-SNAPSHOT&#39;</span>
</span></span><span style=display:flex><span>        â””â”€â”€â”€metals-updater: package <span style=color:#e6db74>&#39;metals-updater-script&#39;</span>
</span></span></code></pre></div><p>To build all the <code>packages</code> and <code>checks</code>, we need the following <code>.github/workflows/nixbuild.yml</code> configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Nixbuild demo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>pull_request</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>nixbuild/nixbuild-action/.github/workflows/ci-workflow.yml@master</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>secrets</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>nixbuild_ssh_key</span>: <span style=color:#ae81ff>${ { secrets.NIXBUILD_SSH_KEY }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>nix_conf</span>: <span style=color:#e6db74>&#39;allow-import-from-derivation = true&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>filter_builds</span>: <span style=color:#e6db74>&#39;.top_attr == &#34;packages&#34; or .top_attr == &#34;checks&#34;&#39;</span>
</span></span></code></pre></div><p>It expects the <code>NIXBUILD_SSH_KEY</code> environment variable to be set with your private SSH key value used to sign up for Nixbuild. Note that both <code>homeConfigurations</code> and <code>nixosConfigurations</code> are exposed as checks, so these will also be built, resulting in the following workflow.</p><p><img src=../../images/nixbuild-jobs.png alt=jobs></p><p>Once it finishes, it may produce some artifacts.</p><p><img src=../../images/nixbuild-artifacts.png alt=artifacts></p><p>As well as a final summary.</p><p><img src=../../images/nixbuild-summary.png alt=summary></p><p>I found the summaries to be extremely helpful understanding what was built on the remote machine, which can also help us understand costs.</p><h3 id=final-words>Final words</h3><p>I gave Nixbuild a try mainly to learn about remote builds and evaluate their CI service mainly because of curiosity. However, I don&rsquo;t have a use case for it besides building my NixOS configuration, for which I find a CI build + a binary cache to be sufficient, but who knows? I may have a more exciting use case for it someday.</p><p>Talking specifically about CI builds, I found Garnix to be much faster compared to the free trial of Nixbuild, thus it will continue to be my daily driver. Nevertheless, Nixbuild is such a cool project and it&rsquo;s much more than a CI service, so I definitely encourage everyone to have a look at their extensive documentation and give it a try.</p><p>Best,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","25")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/garnix/>Garnix CI</a></h4><div class=related-meta>2023.02.07 â€¢
â˜•â˜•â˜•â˜•â˜• 6 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/github-actions-nix-cachix-dhall/>Github actions powered by Nix Shell & Cachix</a></h4><div class=related-meta>2020.06.02 â€¢
â˜•â˜•â˜•â˜•â˜• 7 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/nix-flakes/>Flakes: NixOS and Home Manager migration</a></h4><div class=related-meta>2022.01.10 â€¢
â˜•â˜•â˜•â˜•â˜• 6 min read</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/garnix/ class=nav-title>Garnix CI</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/private-flake/ class=nav-title>Private Nix flake ğŸ”’</a></div></nav></article></div></div></div></main><script src=https://gvolpe.com/js/main.js></script></body></html>