<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!--<meta name="viewport" content="width=device-width, initial-scale=1">--> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /> <title> Home Manager: dotfiles management &bull; gvolpe's blog </title> <meta name="description" content="What is Home Manager?"> <link rel="icon" href="/images/favicon.png"> <link rel="canonical" href="https://gvolpe.github.io/blog/home-manager-dotfiles-management/"> <link rel="alternate" type="application/rss+xml" title="gvolpe's blog" href="https://gvolpe.github.io/blog/feed.xml" /> <link rel="stylesheet" href="/css/main.css"> <link rel="stylesheet" href="/assets/css/main.css"/> <!--Also needs to be set in ./_layouts/unified.html--> <script defer data-domain="gvolpe.com" src="https://analytics.gvolpe.com/js/script.js"></script> <div class="main dark style1" style="padding:0;"> <dialog> <p>Get in touch: <a id="dec-contact" class="email-contact"></a></p> <form method="dialog"> <button>Close</button> </form> </dialog> </div> <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript> </head> <body class=""> <header id="header"> <h1> <a href="/blog">Gabriel Volpe's blog</a> </h1> <div class="overlay"> <div class="container"> <div class="darkmode-div"> <input type="checkbox" id="darkmode" onchange="darkModeEvent(this);"/> <label for="darkmode"> <div id="star"> <div class="star" id="star-1">‚òÖ</div> <div class="star" id="star-2">‚òÖ</div> </div> <div id="moon"></div> </label> </div> <nav> <ul> <li><a href="/">Home</a></li> <li><a href="/blog/categories/">Categories</a></li> </ul> </nav> </div> </div> <div id="progress-bar"></div> </header> <script type="text/javascript"> window.onload = function() { let box = document.getElementById("darkmode"); if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { box.checked=true; } else { box.checked=false; } darkModeEvent(box); }; window.onscroll = function() { var docElem = document.documentElement; var docBody = document.body; var scrollTop = docElem['scrollTop'] || docBody['scrollTop']; var scrollTop = docElem['scrollTop'] || docBody['scrollTop']; var scrollBottom = (docElem['scrollHeight'] || docBody['scrollHeight']) - window.innerHeight; var scrollPercent = scrollTop / scrollBottom * 100 + '%'; document.getElementById("progress-bar").style.setProperty("--scrollAmount", scrollPercent); }; function darkModeEvent(box) { var light = document.getElementById("blogpost"); var dark = document.getElementById("accessible"); if (box.checked && light != null) { light.id="accessible"; } if (!box.checked && dark != null) { dark.id="blogpost"; } return false; }; </script> <section id="blogpost" class="main style-post dark fullscreen"> <div class="content"> <div class="post-content"> <header class="post-header"> <h1 class="post-title">Home Manager: dotfiles management</h1> <span class="post-meta"> <time class="post-date" datetime="2024-12-17">Dec 17, 2024</time> <span class="post-author">by <a href="/">Gabriel Volpe</a></span> </span> <div class="post-categories"> <span class="post-meta"> <a href="/blog/categories/#nix" class="cat-link">nix</a> &nbsp; <a href="/blog/categories/#nixos" class="cat-link">nixos</a> &nbsp; <a href="/blog/categories/#flakes" class="cat-link">flakes</a> &nbsp; <a href="/blog/categories/#home-manager" class="cat-link">home-manager</a> &nbsp; <a href="/blog/categories/#dotfiles" class="cat-link">dotfiles</a> </span> </div> </header> <h2 id="what-is-home-manager">What is Home Manager?</h2> <p>Quoting the official description <a href="https://github.com/nix-community/home-manager/">Home Manager</a>:</p> <blockquote> <p>This project provides a basic system for managing a user environment using the Nix package manager together with the Nix libraries found in Nixpkgs. It allows declarative configuration of user specific (non-global) packages and dotfiles.</p> </blockquote> <p>Wait a minute! If you had been following my blog for a while, you know a lot has been written about Home Manager already, so why am I going back to basics? Mainly because I noticed plenty of confusion out in the wild, thus I would like to demystify some of the misconceptions that exist, and provide you with ideas and examples so that you can reap the benefits of this magnificent tool.</p> <h3 id="nix-is-hard">Nix is hard</h3> <p>Let‚Äôs start by setting the record straight: <strong><em>Nix has an incredible steep learning curve</em></strong>. There are no shortcuts to getting productive with it, though, it very much pays off in the end.</p> <p>Learning Nix compares to learning functional programming coming from an object-oriented / primitive programming background. Your brain needs to be rewired. You are now dealing with immutable data structures that go as far as the operating system ‚Äî if you dare swimming in <a href="https://nixos.org/">NixOS</a> waters.</p> <p>So yes, Nix is hard, but it‚Äôs all worth it once it clicks. However, you can‚Äôt expect to fully grasp it without committing 100%. <strong><em>Nix requires you to go all the way in</em></strong>. Failure to do so may quickly lead you into an inevitable outburst of rage and frustration against it.</p> <p><img src="../../images/gifs/rage.webp" alt="rage" /></p> <p>So keep that in mind if you‚Äôre only taking your first steps with Nix and Home Manager üòÅ</p> <h2 id="use-cases">Use cases</h2> <p>Home Manager can be used incrementally. It is not necessary to use its every feature all at once. My recommendation is to progress with the tool by taking smaller steps instead, for which I think the following ordered list of features is a good start right after you install it.</p> <ul> <li>Software installation.</li> <li>Declarative programs.</li> <li>Declarative services.</li> <li>Dotfiles management.</li> <li>Overlays, overrides, and custom modules.</li> <li>Full desktop management.</li> </ul> <p>Get familiar with each step as you move forward. Don‚Äôt rush trying to understand everything in one go as that can quickly become a very daunting task, so take your time learning how things work.</p> <p>This is more or less the path I have taken with it, but the cool thing is that it can be used in a sort of mix-and-match fashion. For instance, you can only use it to install packages (1) and run services (3), or to install declarative programs (2) and override some packages (6), and so on.</p> <h2 id="software-installation">Software installation</h2> <p>Installing software from <code>nixpkgs</code> ‚Äî the <a href="https://repology.org/repositories/graphs">largest and most up-to-date package repository in the entire universe</a> ‚Äî is arguably the simplest use case.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  home<span class="o">.</span><span class="ss">packages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
    chromium <span class="c1"># browser</span>
    nemo <span class="c1"># file manager</span>
    reaper <span class="c1"># digital audio workstation (DAW)</span>
  <span class="p">];</span>
<span class="p">}</span></code></pre></div> <p>That‚Äôs all it takes to install these three packages with default settings.</p> <p>A lot of them may require custom configuration, which are part of the so-called ‚Äúdotfiles‚Äù. In the last few sections of this post, we‚Äôll learn how to efficiently manage them via Home Manager. Until then, it is recommended that you manage them as you would without it.</p> <h3 id="pro-tips">Pro tips</h3> <ul> <li>Head over to <a href="https://search.nixos.org/packages">search.nixos.org/packages</a> to search for a given package.</li> <li>Use <a href="https://github.com/diamondburned/nix-search">nix-search</a> from your terminal if you don‚Äôt like Web UIs. <ul> <li>Alternatively, <code>nix search nixpkgs &lt;package-name&gt;</code> also works, albeit being much slower.</li> </ul> </li> <li><a href="https://github.com/nix-community/nix-index">nix-index</a> is a good alternative to <code>command-not-found</code> (invoked when you mistype a command).</li> </ul> <h2 id="declarative-programs">Declarative programs</h2> <p>Programs bring the NixOS module system into Home Manager, making it extremely easy and safe to install software declaratively, e.g.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> pkgs<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>

<span class="p">{</span>
  programs<span class="o">.</span><span class="ss">foot =</span> <span class="p">{</span>
    <span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
    server<span class="o">.</span><span class="ss">enable =</span> <span class="no">false</span><span class="p">;</span>
    <span class="ss">settings =</span> <span class="p">{</span>
      <span class="ss">main =</span> <span class="p">{</span>
        <span class="ss">shell =</span> <span class="s2">&quot;</span><span class="si">${</span>pkgs<span class="o">.</span>fish<span class="si">}</span><span class="s2">/bin/fish&quot;</span><span class="p">;</span>
        <span class="ss">font =</span> <span class="s2">&quot;JetBrainsMono Nerdfont:size=10&quot;</span><span class="p">;</span>
        <span class="ss">pad =</span> <span class="s2">&quot;12x12&quot;</span><span class="p">;</span>
        <span class="ss">dpi-aware =</span> <span class="s2">&quot;yes&quot;</span><span class="p">;</span>
        <span class="ss">selection-target =</span> <span class="s2">&quot;both&quot;</span><span class="p">;</span>
      <span class="p">};</span>
      <span class="ss">colors =</span> <span class="p">{</span>
        <span class="ss">alpha =</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>This configuration installs the <a href="https://codeberg.org/dnkl/foot">Foot terminal emulator</a> by generating the right configuration file (dotfile) based on the given settings. You don‚Äôt need to worry about whether the software needs a YAML or TOML file in a specific directory ‚Äî it‚Äôs all Nix as far as we are concerned.</p> <h3 id="pro-tips-1">Pro tips</h3> <ul> <li>Head over to <a href="https://nix-community.github.io/home-manager/options.xhtml">Home Manager configuration options</a> to find out the program‚Äôs settings.</li> </ul> <p>In cases where further customization is needed for a package, we have a few options:</p> <ul> <li>Install it via <code>home.packages</code> (1) and do proper dotfiles management (4).</li> <li>Write a custom module similar to the original one that does what we need. <ul> <li>Upstream a PR if you can allow the time and think other users can benefit. It‚Äôs OSS after all üòä</li> </ul> </li> </ul> <h2 id="declarative-services">Declarative services</h2> <p>When a program needs to run as a daemon with certain permissions, a declarative service is what we need, which on Linux are supported via <a href="https://systemd.io/">systemd</a>.</p> <p>Examples of services include databases (PostgreSQL), analytics (Plausible), notification daemon (Dunst), etc. For instance, here‚Äôs my declarative configuration for <a href="https://github.com/coldfix/udiskie">udiskie</a>: automounter for removable media.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> pkgs<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>

<span class="p">{</span>
  services<span class="o">.</span><span class="ss">udiskie =</span> <span class="p">{</span>
    <span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
    <span class="ss">automount =</span> <span class="no">true</span><span class="p">;</span>
    <span class="ss">notify =</span> <span class="no">true</span><span class="p">;</span>
    <span class="ss">settings =</span> <span class="p">{</span>
      <span class="ss">program_options =</span> <span class="p">{</span>
        <span class="ss">file_manager =</span> <span class="s2">&quot;</span><span class="si">${</span>pkgs<span class="o">.</span>mimeo<span class="si">}</span><span class="s2">/bin/mimeo&quot;</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
    <span class="ss">tray =</span> <span class="s2">&quot;always&quot;</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>The same caveats regarding customizations described for programs apply here as well.</p> <h3 id="pro-tips-2">Pro tips</h3> <ul> <li>Services are also documented in the <a href="https://nix-community.github.io/home-manager/options.xhtml">Home Manager configuration options</a> site.</li> </ul> <p>When in need of a custom service that‚Äôs not available upstream, it‚Äôs always useful to look at source code examples to understand how we can create our own. For instance, here‚Äôs the code for <a href="https://github.com/nix-community/home-manager/blob/83ecd50915a09dca928971139d3a102377a8d242/modules/services/dunst.nix#L180">dunst service</a>. You can land at it directly from the configuration options site, it‚Äôs all linked there.</p> <h2 id="dotfiles-management">Dotfiles management</h2> <p>This is where I‚Äôve seen the biggest confusion when using Home Manager, so let‚Äôs have a deeper look at the options we have when it comes to managing dotfiles.</p> <p>To make things easier to follow, we are going to look at a concrete example: installing <a href="https://github.com/dylanaraps/neofetch">neofetch</a>.</p> <blockquote> <p>Side note: <em>neofetch is highly customizable and still works flawlessly, even if it‚Äôs now archived and there are alternatives such as <a href="https://github.com/hykilpikonna/hyfetch">hyfetch</a> and <a href="https://github.com/fastfetch-cli/fastfetch">fastfetch</a></em>.</p> </blockquote> <p>Most people would start with something like this:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> pkgs<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>

<span class="p">{</span>
  home<span class="o">.</span><span class="ss">packages =</span> <span class="p">[</span> pkgs<span class="o">.</span>neofetch <span class="p">];</span>
  xdg<span class="o">.</span>configFile<span class="o">.</span><span class="s2">&quot;neofetch/config.conf&quot;</span><span class="o">.</span><span class="ss">source =</span> <span class="o">.</span><span class="l">/neofetch.conf</span><span class="p">;</span>
  <span class="c1"># alternatively, one could write the configuration inline as follows</span>
  <span class="c1"># xdg.configFile.&quot;neofetch/config.conf&quot;.text = &#39;&#39; #content here &#39;&#39;;</span>
<span class="p">}</span></code></pre></div> <p>Where <code>neofetch.conf</code> is your standard <a href="https://github.com/dylanaraps/neofetch/wiki/Customizing-Info">configuration file</a>.</p> <p>However, this means that the actual dotfile used by the software that lives under <code>~/.config/neofetch/config.conf</code> now <em>belongs to Home Manager</em> and you don‚Äôt have write permissions.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>readlink -f ~/.config/neofetch/config.conf
/nix/store/21h3kkyipjdcsgv72vbd2i1h6vzcl0pk-hm_electric.conf

<span class="nv">$ </span>ls -la /nix/store/21h3kkyipjdcsgv72vbd2i1h6vzcl0pk-hm_electric.conf
.r--r--r-- 17k root  <span class="m">1</span> Jan  <span class="m">1970</span> /nix/store/21h3kkyipjdcsgv72vbd2i1h6vzcl0pk-hm_electric.conf</code></pre></div> <p>The only way to make changes is by modifying your Nix configuration, running <code>home-manager switch</code> ‚è≥, and hoping that the changes you made were correct. Otherwise, it‚Äôs rinse and repeat, which is less than ideal when you‚Äôre tinkering around with dotfiles and want to tweak little things.</p> <p><img src="../../images/gifs/father.webp" alt="father" /></p> <p>This begs the question: <strong><em>Is Home Manager the wrong tool for managing dotfiles?</em></strong> I guess most deserters found themselves at this crossroad at some point, so let‚Äôs find out more.</p> <h3 id="light-at-the-end-of-the-tunnel">Light at the end of the tunnel</h3> <p>Let me introduce you to the unsung hero: <strong><a href="https://github.com/nix-community/home-manager/blob/83ecd50915a09dca928971139d3a102377a8d242/modules/files.nix#L64-L69">mkOutOfStoreSymlink</a></strong> ‚Äî a simple function hidden in plain sight deep in the Home Manager source code, defined as follows:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix">lib<span class="o">.</span>file<span class="o">.</span><span class="ss">mkOutOfStoreSymlink =</span> path<span class="p">:</span>
  <span class="k">let</span>
    <span class="ss">pathStr =</span> <span class="nb">toString</span> path<span class="p">;</span>
    <span class="ss">name =</span> hm<span class="o">.</span>strings<span class="o">.</span>storeFileName <span class="p">(</span><span class="nb">baseNameOf</span> pathStr<span class="p">);</span>
  <span class="k">in</span>
    pkgs<span class="o">.</span>runCommandLocal name <span class="p">{}</span> <span class="s1">&#39;&#39;ln -s </span><span class="si">${</span>escapeShellArg pathStr<span class="si">}</span><span class="s1"> $out&#39;&#39;</span><span class="p">;</span></code></pre></div> <p>It‚Äôs heavily under-documented, which doesn‚Äôt make things easier for beginners, so that‚Äôs something we should improve within the Nix community, but I hope this blog post is a good start.</p> <p>So, how does it help? Let‚Äôs get back to the <code>neofetch</code> example and refactor it to use this function.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> pkgs<span class="p">,</span> lib<span class="p">,</span> config<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>

<span class="k">let</span>
  <span class="ss">filePath =</span> <span class="s2">&quot;/home/gvolpe/workspace/nix-config/programs/neofetch/electric.conf&quot;</span><span class="p">;</span>
  <span class="ss">configSrc =</span> config<span class="o">.</span>lib<span class="o">.</span>file<span class="o">.</span>mkOutOfStoreSymlink filePath<span class="p">;</span>
<span class="k">in</span>
<span class="p">{</span>
  home<span class="o">.</span><span class="ss">packages =</span> <span class="p">[</span> pkgs<span class="o">.</span>neofetch <span class="p">];</span>
  xdg<span class="o">.</span>configFile<span class="o">.</span><span class="s2">&quot;neofetch/config.conf&quot;</span><span class="o">.</span><span class="ss">source =</span> configSrc<span class="p">;</span>
<span class="p">}</span></code></pre></div> <p>After one last <code>home-manager switch</code> run, let‚Äôs now check the dotfile symlink target:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>readlink -f ~/.config/neofetch/config.conf
/home/gvolpe/workspace/nix-config/home/programs/neofetch/electric.conf</code></pre></div> <p>Success! üí™ For the curious reader, this is not a direct symlink; it‚Äôs a chain of symlinks.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>readlink ~/.config/neofetch/config.conf
/nix/store/qxvvj5v1w8za9wfb80cnl6g5ja7w9qzz-home-manager-files/.config/neofetch/config.conf

<span class="nv">$ </span>readlink /nix/store/qxvvj5v1w8za9wfb80cnl6g5ja7w9qzz-home-manager-files/.config/neofetch/config.conf
/nix/store/d0cmjnz9advx1irqq1c6slrl0gjklipf-hm_electric.conf

<span class="nv">$ </span>readlink /nix/store/d0cmjnz9advx1irqq1c6slrl0gjklipf-hm_electric.conf
/home/gvolpe/workspace/nix-config/home/programs/neofetch/electric.conf

<span class="nv">$ </span>ls -la /home/gvolpe/workspace/nix-config/home/programs/neofetch/electric.conf
.rw-r--r-- 17k gvolpe <span class="m">16</span> Dec 21:44 /home/gvolpe/workspace/nix-config/home/programs/neofetch/electric.conf</code></pre></div> <p>We can now tweak our dotfiles as much as we want without Home Manager getting in the way. Once we‚Äôre happy with the results, we may want to go back to the immutable version (or not).</p> <p><img src="../../images/gifs/understanding.webp" alt="understanding" /></p> <p>It‚Äôs worth noticing that even if we decide to keep the mutable version, the dotfiles that we modify can still be versioned in our git repository, as it is the case with the <code>neofetch</code> example.</p> <p>A good declarative alternative could be <a href="https://github.com/nix-community/impermanence">impermanence</a>, which goes deep into handling persistent state, but it may be an over-killer solution if you‚Äôre only after dotfiles management.</p> <h3 id="pro-tips-3">Pro tips</h3> <p>Can we do better? Certainly! We can leverage custom Home Manager modules, which may seem an advanced feature at first, but it‚Äôs a trivial concept once it clicks.</p> <p>Examples always go a long way, so let‚Äôs dive right into it and define a new module named <code>dotfiles.nix</code>.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> config<span class="p">,</span> lib<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>

<span class="p">{</span>
  <span class="ss">options =</span> <span class="p">{</span>
    <span class="ss">dotfiles =</span> <span class="p">{</span>
      <span class="ss">mutable =</span> lib<span class="o">.</span>mkEnableOption <span class="s2">&quot;mutable dotfiles&quot;</span><span class="p">;</span>

      <span class="ss">path =</span> lib<span class="o">.</span>mkOption <span class="p">{</span>
        <span class="ss">type =</span> lib<span class="o">.</span>types<span class="o">.</span>path<span class="p">;</span>
        <span class="ss">apply =</span> <span class="nb">toString</span><span class="p">;</span>
        <span class="ss">default =</span> <span class="s2">&quot;</span><span class="si">${</span>config<span class="o">.</span>home<span class="o">.</span>homeDirectory<span class="si">}</span><span class="s2">/workspace/nix-config/home&quot;</span><span class="p">;</span>
        <span class="ss">example =</span> <span class="s2">&quot;</span><span class="si">${</span>config<span class="o">.</span>home<span class="o">.</span>homeDirectory<span class="si">}</span><span class="s2">/.dotfiles&quot;</span><span class="p">;</span>
        <span class="ss">description =</span> <span class="s2">&quot;Location of the dotfiles working copy&quot;</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>It consists of two different options:</p> <ul> <li><code>mutable</code>: a boolean flag that dictates whether we choose to build our entire Home Manager configuration via <code>mkOutOfStoreSymlink</code> or as usual (the immutable version).</li> <li><code>path</code>: the path where you keep your dotfiles working copy.</li> </ul> <p>The latter has a default value that points to where I keep my dotfiles, which is also a git repository. We‚Äôll come back to this bit later on when we compare it to other solutions.</p> <p>This module can then be imported in the Home Manager configuration modules and we should be able to use it as any other module, such as <code>home.packages</code> and other options.</p> <p>The main piece of Home Manager configuration would look something like this now:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  homeConfigurations<span class="o">.</span><span class="s2">&quot;username&quot;</span> <span class="o">=</span> home-manager<span class="o">.</span>lib<span class="o">.</span>homeManagerConfiguration <span class="p">{</span>
    <span class="k">inherit</span> pkgs<span class="p">;</span>
    <span class="ss">modules =</span> <span class="p">[</span>
      <span class="o">.</span><span class="l">/dotfiles.nix</span>
      <span class="o">.</span><span class="l">/home.nix</span>
      <span class="p">{</span> dotfiles<span class="o">.</span><span class="ss">mutable =</span> <span class="no">true</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">];</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>We are now able to utilize this information in our <code>neofetch</code> configuration (and anywhere else too):</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> pkgs<span class="p">,</span> lib<span class="p">,</span> config<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>

<span class="k">let</span>
  <span class="ss">filePath =</span> <span class="s2">&quot;</span><span class="si">${</span>config<span class="o">.</span>dotfiles<span class="o">.</span>path<span class="si">}</span><span class="s2">/programs/neofetch/electric.conf&quot;</span><span class="p">;</span>
  <span class="ss">configSrc =</span>
    <span class="k">if</span> <span class="o">!</span>config<span class="o">.</span>dotfiles<span class="o">.</span>mutable <span class="k">then</span> <span class="o">.</span><span class="l">/electric.conf</span>
    <span class="k">else</span> config<span class="o">.</span>lib<span class="o">.</span>file<span class="o">.</span>mkOutOfStoreSymlink filePath<span class="p">;</span>
<span class="k">in</span>
<span class="p">{</span>
  home<span class="o">.</span><span class="ss">packages =</span> <span class="p">[</span> pkgs<span class="o">.</span>neofetch <span class="p">];</span>
  xdg<span class="o">.</span>configFile<span class="o">.</span><span class="s2">&quot;neofetch/config.conf&quot;</span><span class="o">.</span><span class="ss">source =</span> configSrc<span class="p">;</span>
<span class="p">}</span></code></pre></div> <p>The first thing we do is to evaluate the <code>dotfiles.mutable</code> flag: if it‚Äôs set to <code>false</code>, we import the configuration file into the Nix store; otherwise, we fallback to the <code>mkOutOfStoreSymlink</code> function.</p> <p>I was previously passing these values via <code>specialArgs</code>, but I think having a dedicated <code>dotfiles</code> module is a much better solution, inspired by <a href="https://github.com/nix-community/home-manager/issues/2085#issuecomment-2022239332">this Github comment</a>.</p> <h2 id="comparison">Comparison</h2> <p>In a nutshell, relying on <code>mkOutOfStoreSymlink</code> ends up being comparable to managing your dotfiles with tools such as <a href="https://www.gnu.org/software/stow/">GNU stow</a> or <a href="https://www.chezmoi.io/">chezmoi</a> <em>if we look exclusively at dotfiles management</em>.</p> <p>To understand whether using Home Manager for this is for you or not, we also need to look at what else it has in store for us, which goes back to leveraging the power of Nix.</p> <p>For instance, here are a few things we can easily achieve with Nix+HM that would be much harder with primitive stateful solutions. Following the <code>neofetch</code> example, we could:</p> <ul> <li>Enable image support.</li> <li>Override specific version.</li> <li>Build with different compiler flags.</li> <li>Guarantee reproducibility across machines.</li> </ul> <p>Enabling image support is something I worked on recently using the foot terminal emulator on Hyprland, which supports image rendering via the <a href="https://en.wikipedia.org/wiki/Sixel">Sixel protocol</a>. Here‚Äôs all I had to do:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> pkgs<span class="p">,</span> lib<span class="p">,</span> config<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>

<span class="k">let</span>
  <span class="ss">neofetchPath =</span> lib<span class="o">.</span>makeBinPath <span class="p">(</span><span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span> chafa imagemagick <span class="p">]);</span>

  <span class="ss">neofetchSixelSupport =</span> pkgs<span class="o">.</span>neofetch<span class="o">.</span>overrideAttrs <span class="p">(</span>old<span class="p">:</span> <span class="p">{</span>
    <span class="ss">postInstall =</span> <span class="s1">&#39;&#39;</span>
<span class="s1">      wrapProgram $out/bin/neofetch --prefix PATH : </span><span class="si">${</span>neofetchPath<span class="si">}</span><span class="s1"></span>
<span class="s1">    &#39;&#39;</span><span class="p">;</span>
  <span class="p">});</span>
<span class="k">in</span>
<span class="p">{</span>
  home<span class="o">.</span><span class="ss">packages =</span> <span class="p">[</span> neofetchSixelSupport <span class="p">];</span>
  xdg<span class="o">.</span>configFile<span class="o">.</span><span class="s2">&quot;neofetch/config.conf&quot;</span><span class="o">.</span><span class="ss">source =</span> configSrc<span class="p">;</span>
<span class="p">}</span></code></pre></div> <p>It adds the necessary dependencies (<a href="https://hpjansson.org/chafa/">chafa</a> and <a href="https://imagemagick.org/">imagemagick</a>) to the PATH of <code>neofetch</code>, without making them globally available. It really doesn‚Äôt get any easier than this!</p> <p><img src="../../images/neofetch-image.png" alt="neofetch" /></p> <p>Strictly speaking about dotfiles management with Home Manager, the main benefit is the ability to freeze or lock our files to make them reproducible in other machines, or also to serve as a reproducible snapshot in time if we ever want to get back to that specific version.</p> <p>Switching back and forth between the immutable and mutable versions becomes an easy task with the <code>dotfiles</code> module. Nonetheless, one has to invest time in the initial configuration to get to this point.</p> <p><img src="../../images/gifs/makes-sense.webp" alt="sense" /></p> <p>Here‚Äôs how I switch between the two on my machine.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>home-manager switch --flake .#homeConfigurations.hyprland-hdmi.activationPackage
<span class="nv">$ </span>home-manager switch --flake .#homeConfigurations.hyprland-hdmi-mutable.activationPackage</code></pre></div> <p>If you understand all I wrote about it so far and still choose another solution like Stow, fair enough, it‚Äôs a great tool! Moreover, it can be combined with Home Manager; you can manage your dotfiles with Stow, and still take advantage of all the other features such as overlays/overrides and modules.</p> <p>Feel free to dig into my <a href="https://github.com/gvolpe/nix-config">Nix configuration</a> files for more and leave any questions / comments here.</p> <h2 id="closing-remarks">Closing remarks</h2> <p>Home Manager rocks! ü§ò I hope you find this article useful and give yourself time to learn these tools the proper way. With the right amount of patience and dedication, you‚Äôll become productive soon enough.</p> <p>Last but not least, I would like to use this space to thank <a href="https://rycee.net/">Robert Helgesson</a> for his invaluable work on Home Manager since its inception. It certainly takes considerable devotion to carry on with maintaining this project after so many years! üôá</p> <p>Best, Gabriel.</p> <div id="gh-comments"> <br/><br/> <div id="gh-comments-list"></div> </div> <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"> </script> <script src="/js/github-comments.js"> </script> <script type="text/javascript"> DoGithubComments ( "gvolpe/blog-comments" , "32" ); </script> <noscript>Please enable JavaScript to view comments.</noscript> </div> </div> </section> <footer id="footer"> <!-- Icons --> <!-- Look here for more brands icons: https://fortawesome.com/sets/font-awesome-5-brands --> <script src="/js/email.js"> </script> <ul class="icons"> <li><a href="#" class="icon solid fa-envelope" onclick="showContact()"><span class="label">Email</span></a></li> <li><a href="https://github.com/gvolpe" target="_blank" class="icon brands fa-github"><span class="label">Github</span></a></li> <li><a href="https://matrix.to/#/@gvolpe:matrix.org" target="_blank" class="icon brands fa-gitter"><span class="label">Matrix</span></a></li> <li><a rel="me" href="https://fosstodon.org/@gvolpe" target="_blank" class="icon brands fa-mastodon"><span class="label">Mastodon</span>></a></li> <li><a href="https://twitter.com/volpegabriel87" target="_blank" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li> <li><a href="https://bsky.app/profile/gvolpe.com" target="_blank" class="icon brands fa-dribbble"><span class="label">Bluesky</span></a></li> <li><a href="https://linkedin.com/in/gmvolpe" target="_blank" class="icon brands fa-linkedin-in"><span class="label">LinkedIn</span></a></li> <li><a href="https://leanpub.com/u/gvolpe" target="_blank" class="icon brands fa-leanpub"><span class="label">LeanPub</span></a></li> <li><a href="https://www.blurb.co.uk/user/gvolpe" target="_blank" class="icon brands fa-bimobject"><span class="label">Blurb</span></a></li> </ul> <small> Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a> </small> <!-- Menu --> <ul class="menu"> <li> &copy; Gabriel Volpe 2020-2025 </li> </ul> </footer> </body> </html></body></html>
