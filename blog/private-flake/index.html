<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Private Nix flake ğŸ”’ - Gabriel Volpe</title><meta name=description content="Introduction
I blogged about Garnix before, and it&rsquo;s the solution I&rsquo;ve been using ever since for continuous integration. However, one thing I was â€¦"><meta property="og:title" content="Private Nix flake ğŸ”’"><meta property="og:description" content="Introduction
I blogged about Garnix before, and it&rsquo;s the solution I&rsquo;ve been using ever since for continuous integration. However, one thing I was â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/private-flake/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Private Nix flake ğŸ”’"><meta name=twitter:description content="Introduction
I blogged about Garnix before, and it&rsquo;s the solution I&rsquo;ve been using ever since for continuous integration. However, one thing I was â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css><script type=text/javascript defer data-domain=gvolpe.com data-api=analytics.gvolpe.com src=https://gvolpe.com/js/plausible.js></script></head><body><main><div id=post-overlay-id class="post-overlay active"><div class=reading-progress></div><div class=post-overlay-backdrop></div><div id=post-overlay-content-id class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2024.02.27</span><div class=reading-time-post><span class=coffee-cups>ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š
</span><span>6 min read</span></div></div><h1 class=post-title>Private Nix flake ğŸ”’</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/nix class=post-tag>nix</a>
<a href=https://gvolpe.com/tags/nixos class=post-tag>nixos</a>
<a href=https://gvolpe.com/tags/flakes class=post-tag>flakes</a>
<a href=https://gvolpe.com/tags/ci class=post-tag>ci</a>
<a href=https://gvolpe.com/tags/garnix class=post-tag>garnix</a></div></header><div class=post-body><h2 id=introduction>Introduction</h2><p>I blogged about <a href=../garnix>Garnix</a> before, and it&rsquo;s the solution I&rsquo;ve been using ever since for continuous integration. However, one thing I was missing was that private flakes were unsupported, so I had to live with a private local flake that I was commenting out on my public flake for a long time.</p><p>Github Actions does support building private flakes by providing an access token, but it&rsquo;s not very secure if your builds end up on a public cache anyway (not my case, though)&mldr; Garnix recently added <a href=https://garnix.io/docs/private_inputs>support for private inputs</a>, but it comes with some limitations (mainly due to security), so I could not take advantage of this new feature.</p><p>Unhappy with my current situation, and armed with some extra motivation, I decided to take a completely different approach&mldr; Also, I realized I hadn&rsquo;t blogged in more than year! Time to fix it.</p><h3 id=former-settings>Former settings</h3><p>The flake I was commenting out on my public configuration only exposed an overlay, and looked as follows on my inputs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>private-flake <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  url <span style=color:#f92672>=</span> <span style=color:#e6db74>github:gvolpe/private-flake</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Then I would add the private overlay only when the private flake was present in my inputs, so it could also build on CI.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>privateOverlay <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (builtins<span style=color:#f92672>.</span>hasAttr <span style=color:#e6db74>&#34;private-flake&#34;</span> inputs)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>then</span> private-flake<span style=color:#f92672>.</span>overlays<span style=color:#f92672>.</span>default
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span> (f: p: { });
</span></span></code></pre></div><p>It served its purpose, but I got tired of git-stashing these changes every time I had to update my flake.</p><h3 id=rethinking-public-flake>Rethinking public flake</h3><p>The solution was clear: <em>invert the dependency graph</em>.</p><p>Instead of pulling my private flake&rsquo;s overlays into my public configuration, why not doing it the other way around? To be frank, this is something I&rsquo;ve thought of many times, but I was always too lazy to do anything about it Â¯\_(ãƒ„)_/Â¯</p><p>Strangely enough, not this time around, so I was ready to tackle it once and for all.</p><p>Here&rsquo;s what my public flake&rsquo;s outputs look like before:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  homeConfigurations <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> <span style=color:#e6db74>./outputs/home-conf.nix</span> { <span style=color:#66d9ef>inherit</span> inputs system pkgs extraArgs; };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  nixosConfigurations <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> <span style=color:#e6db74>./outputs/nixos-conf.nix</span> { <span style=color:#66d9ef>inherit</span> inputs system pkgs extraArgs; };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I wanted my private flake to be able to build these configurations with a custom <code>pkgs</code> instance, so the first step was to refactor these and make them builder methods on my main overlay.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  buildersOverlay <span style=color:#f92672>=</span> f: p: {
</span></span><span style=display:flex><span>    mkHomeConfigurations <span style=color:#f92672>=</span> { pkgs <span style=color:#f92672>?</span> f }:
</span></span><span style=display:flex><span>      <span style=color:#f92672>import</span> <span style=color:#e6db74>../outputs/home-conf.nix</span> { <span style=color:#66d9ef>inherit</span> inputs pkgs system; };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    mkNixosConfigurations <span style=color:#f92672>=</span> { pkgs <span style=color:#f92672>?</span> f }:
</span></span><span style=display:flex><span>      <span style=color:#f92672>import</span> <span style=color:#e6db74>../outputs/nixos-conf.nix</span> { <span style=color:#66d9ef>inherit</span> inputs pkgs system; };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And here&rsquo;s how my public flake defines its outputs right now (simple enough, no?):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  outputs <span style=color:#f92672>=</span> inputs:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>      system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      overlays <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./lib/overlays.nix</span> { <span style=color:#66d9ef>inherit</span> inputs system; };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> inputs<span style=color:#f92672>.</span>nixpkgs {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>inherit</span> overlays system;
</span></span><span style=display:flex><span>        config<span style=color:#f92672>.</span>allowUnfree <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>inherit</span> pkgs overlays;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      homeConfigurations <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>mkHomeConfigurations { };
</span></span><span style=display:flex><span>      nixosConfigurations <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>mkNixosConfigurations { };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It can still be built independently with sane defaults, but it&rsquo;s also extendable from other flakes.</p><h3 id=private-flake>Private flake</h3><p>Refactor done on the public side, now it was time to focus on the private flake. The entire <code>flake.nix</code> definition is only 17 lines long! Neat, don&rsquo;t you think?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;My private flake&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  inputs<span style=color:#f92672>.</span>nix-config<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>github:gvolpe/nix-config</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#f92672>=</span> { nix-config<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>      pkgs <span style=color:#f92672>=</span> nix-config<span style=color:#f92672>.</span>pkgs<span style=color:#f92672>.</span>extend (<span style=color:#f92672>import</span> <span style=color:#e6db74>modules/overlay.nix</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      homeConfigurations <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>mkHomeConfigurations { };
</span></span><span style=display:flex><span>      nixosConfigurations <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>mkNixosConfigurations { };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Both Home Manager and NixOS configurations can be built by reusing the public config&rsquo;s <code>pkgs</code> instance, which is extended with a custom overlay.</p><p>The custom overlay used to contain only private stuff, but now it also contains a secrets override (more on this below):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>f: p: {
</span></span><span style=display:flex><span>  secrets <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>callPackage <span style=color:#e6db74>./secrets.nix</span> { };
</span></span><span style=display:flex><span>  private<span style=color:#f92672>.</span>stuff <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./private-stuff.nix</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I realized that my system was building, but that all my secrets were not present! \_(o_o)_/</p><p>This was the case because I use <code>git-crypt</code> on my public repo to encrypt them; one more obstacle on the road to finally nail this&mldr;</p><p>The next step was to refactor all my public encrypted secrets and centralize them in a single overlay, so here&rsquo;s how I define them now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  githubToken <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;OVERRIDE_ME&#34;</span>;
</span></span><span style=display:flex><span>  mimeoAssociations <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  ngrokToken <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;OVERRIDE_ME&#34;</span>;
</span></span><span style=display:flex><span>  openaiApiKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;OVERRIDE_ME&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This means I no longer need <code>git-crypt</code> in my public repo, but it <a href=https://gist.github.com/marcopaganini/62fc51a679f8985c10c3ca5d0c84031c>doesn&rsquo;t</a> seem <a href=https://github.com/AGWA/git-crypt/issues/170>trivial</a> to <a href=https://github.com/AGWA/git-crypt/issues/137>remove it</a>, so I&rsquo;ll get to that another day ğŸ™„</p><p>Thus, all I have to do in my private flake is to override all these secrets in the custom overlay. Here&rsquo;s the <code>secrets.nix</code> file you can see referenced in the overlay above &mdash; only showing a single secret for brevity.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  githubToken <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>secretManager {
</span></span><span style=display:flex><span>    filepath <span style=color:#f92672>=</span> <span style=color:#e6db74>../secrets/github-token</span>;
</span></span><span style=display:flex><span>    fileAction <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>readFile;
</span></span><span style=display:flex><span>    encryptedSha256 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ce08397723eb2c8ae9673de34fab11db8799062c2659c673b4eddbfa4e05b8e1&#34;</span>;
</span></span><span style=display:flex><span>    emptyValue <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I continue to use the <a href=https://github.com/gvolpe/nix-config/blob/a1db9d16c403cad14a0ec98c6fc55b491920806d/lib/default.nix#L23>secretsManager</a> function from my public flake, which also depends on the file being encrypted with <code>git-crypt</code>. This is how my secrets don&rsquo;t end up on a public cache.</p><p>Thus, I had to move all my secrets from the public repo to my private one, and set up <code>git-crypt</code> once again. Though, that&rsquo;s a one-time thing and I&rsquo;m much happier they now live in a private repository instead.</p><p><strong>REPL superpower</strong></p><p>To quickly debug if the secrets are being set as expected, you can&rsquo;t beat the REPL.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix repl
</span></span><span style=display:flex><span>Welcome to Nix 2.20.3. Type :? <span style=color:#66d9ef>for</span> help.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nix-repl&gt; :lf .
</span></span><span style=display:flex><span>Added <span style=color:#ae81ff>15</span> variables.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nix-repl&gt; inputs.nix-config.pkgs.secrets.githubToken
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;OVERRIDE_ME&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nix-repl&gt; outputs.homeConfigurations.gvolpe-hdmi.pkgs.secrets.githubToken
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;this-secret-has-been-set-in-the-overlay&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nix-repl&gt; outputs.nixosConfigurations.tongfang-amd.pkgs.secrets.githubToken
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;this-secret-has-been-set-in-the-overlay&#34;</span>
</span></span></code></pre></div><p>I absolutely love this extra capability nix gives us! It feels like a superpower ğŸ¥·</p><h3 id=continuous-integration>Continuous integration</h3><p>With Garnix now supporting private flakes, I just needed to ensure the Garnix App had access to my private repo, as well as setting the right options on my <code>garnix.yaml</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>enableGithubOrgAccessTokens</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>builds</span>:
</span></span><span style=display:flex><span> <span style=color:#f92672>exclude</span>: []
</span></span><span style=display:flex><span> <span style=color:#f92672>include</span>:
</span></span><span style=display:flex><span> - <span style=color:#ae81ff>homeConfigurations.*</span>
</span></span><span style=display:flex><span> - <span style=color:#ae81ff>nixosConfigurations.*</span>
</span></span></code></pre></div><p>Once it was all set, I had my private flake successfully building my Home Manager and NixOS configurations on Garnix in no time!</p><p><img src=../../images/garnix-private-build.png alt=summary></p><p><a href=https://garnix.io/>Garnix</a> rocks! Now even more with a revamped website and UI :)</p><h3 id=closing-remarks>Closing remarks</h3><p>I must say I&rsquo;m quite satisfied with my current solution, but we all know this is an eternal tinkering process, so I won&rsquo;t lie to you (and to myself) by claiming this is its final form :)</p><p>Perhaps, the only area that could use some improvement would be the management of secrets, but I don&rsquo;t have a big need for it as my secrets are trivial and I don&rsquo;t do remote server deployments and provisioning, so for now that&rsquo;s not something I&rsquo;m willing to spend time on.</p><p>What do you think? Anything else you would improve or do differently? Let me know in the comments below!</p><p>Best,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","26")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/nix-remote-builds/>Nix remote builds</a></h4><div class=related-meta>2023.02.13 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“š 4 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/garnix/>Garnix CI</a></h4><div class=related-meta>2023.02.07 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 6 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/nix-flakes/>Flakes: NixOS and Home Manager migration</a></h4><div class=related-meta>2022.01.10 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 6 min read</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/nix-remote-builds/ class=nav-title>Nix remote builds</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/flake-schemas/ class=nav-title>Flake Schemas</a></div></nav></article><aside class=sidebar><nav class=toc><h4>Contents</h4><div id=toc-content></div></nav></aside></div></div></div></main><script src=https://gvolpe.com/js/main.js></script></body></html>