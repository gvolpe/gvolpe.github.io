<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Garnix CI - Gabriel Volpe</title><meta name=description content="Garnix is a continuous integration (CI) service for Nix flakes that has been in Beta for a while.



  In their own words â€¦"><meta property="og:title" content="Garnix CI"><meta property="og:description" content="Garnix is a continuous integration (CI) service for Nix flakes that has been in Beta for a while.



  In their own words â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/garnix/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Garnix CI"><meta name=twitter:description content="Garnix is a continuous integration (CI) service for Nix flakes that has been in Beta for a while.



  In their own words â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css></head><body><div class=reading-progress></div><main><div class="post-overlay active"><div class=post-overlay-backdrop></div><div class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2023.02.07</span><div class=reading-time-post><span class=coffee-cups>ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š
</span><span>6 min read</span></div></div><h1 class=post-title>Garnix CI</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/nix class=post-tag>nix</a>
<a href=https://gvolpe.com/tags/nixos class=post-tag>nixos</a>
<a href=https://gvolpe.com/tags/flakes class=post-tag>flakes</a>
<a href=https://gvolpe.com/tags/ci class=post-tag>ci</a>
<a href=https://gvolpe.com/tags/garnix class=post-tag>garnix</a>
<a href=https://gvolpe.com/tags/cachix class=post-tag>cachix</a></div></header><div class=post-body><p><a href=https://garnix.io/>Garnix</a> is a continuous integration (CI) service for Nix flakes that has been in Beta for a while.</p><style>.quote::before{content:"ğŸ“œ"}</style><div class=quote><h4>In their own words</h4><p>"With Nix-specific optimizations, Garnix makes CI with Nix fast â€” a few seconds for no-op changes. Easy to setup, too â€” if you have a flake.nix, you are ready to go. And we provide the build results as a cache, so you don't have to build things locally. To top it all up, we run on 100% renewable energy. Because CI should bring you peace of mind."
Notice the extensions we had to enable to make this compile.</p></div><p>My <a href=https://github.com/settings/installations>Github settings</a> tell me I have installed the Garnix CI app in March 2022 and it&rsquo;s been running alongside my GHA (Github Actions) workflows ever since. However, I haven&rsquo;t really reaped its benefits until now.</p><p>Once you install the Garnix CI app in your Github account and enable the repositories where you want it to run, you&rsquo;ll notice that it will automatically detect a <code>flake.nix</code> and it will evaluate its packages, dev shells, checks and NixOS configurations. Still, this is all configurable per repository via a <a href=https://github.com/gvolpe/nix-config/blob/master/garnix.yaml>garnix.yaml</a> file.</p><p><img src=../../images/garnix-app.png alt=app></p><p>The <code>homeConfigurations</code> output is <a href=https://github.com/garnix-io/issues/issues/24>not yet supported</a>, but it&rsquo;s in the plans. A current workaround is to expose these as <code>packages</code> or <code>checks</code> instead, as I have in my flake&rsquo;s outputs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  outputs <span style=color:#f92672>=</span> inputs:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>      system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>      ci <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./outputs/ci.nix</span> { <span style=color:#66d9ef>inherit</span> inputs system; };
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>inherit</span> (inputs<span style=color:#f92672>.</span>nixpkgs<span style=color:#f92672>.</span>lib) mapAttrs;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>rec</span> {
</span></span><span style=display:flex><span>      homeConfigurations <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>import</span> <span style=color:#e6db74>./outputs/home-conf.nix</span> { <span style=color:#66d9ef>inherit</span> inputs system; };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      nixosConfigurations <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>import</span> <span style=color:#e6db74>./outputs/nixos-conf.nix</span> { <span style=color:#66d9ef>inherit</span> inputs system; };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      packages<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>inherit</span> (ci) metals metals-updater;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      checks<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>          os <span style=color:#f92672>=</span> mapAttrs (_: c: c<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>system<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>toplevel) nixosConfigurations;
</span></span><span style=display:flex><span>          hm <span style=color:#f92672>=</span> mapAttrs (_: c: c<span style=color:#f92672>.</span>activationPackage) homeConfigurations;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>        os <span style=color:#f92672>//</span> hm;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The downside of doing this is that building the Home Manager configurations requires <a href=https://nixos.wiki/wiki/Import_From_Derivation>Import From Derivation (IFD)</a> (at least in my case) even for <code>nix flake show</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix flake show --allow-import-from-derivation
</span></span><span style=display:flex><span>git+file:///home/gvolpe/workspace/nix-config?ref<span style=color:#f92672>=</span>...
</span></span><span style=display:flex><span>â”œâ”€â”€â”€checks
</span></span><span style=display:flex><span>â”‚   â””â”€â”€â”€x86_64-linux
</span></span><span style=display:flex><span>â”‚       â”œâ”€â”€â”€dell-xps: derivation <span style=color:#e6db74>&#39;nixos-system-dell-xps-15-9560-23.05.20230202.a100acd&#39;</span>
</span></span><span style=display:flex><span>â”‚       â”œâ”€â”€â”€gvolpe-edp: derivation <span style=color:#e6db74>&#39;home-manager-generation&#39;</span>
</span></span><span style=display:flex><span>â”‚       â”œâ”€â”€â”€gvolpe-hdmi: derivation <span style=color:#e6db74>&#39;home-manager-generation&#39;</span>
</span></span><span style=display:flex><span>â”‚       â””â”€â”€â”€tongfang-amd: derivation <span style=color:#e6db74>&#39;nixos-system-tongfang-amd-23.05.20230202.a100acd&#39;</span>
</span></span><span style=display:flex><span>â”œâ”€â”€â”€homeConfigurations: unknown
</span></span><span style=display:flex><span>â”œâ”€â”€â”€nixosConfigurations
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€â”€dell-xps: NixOS configuration
</span></span><span style=display:flex><span>â”‚   â””â”€â”€â”€tongfang-amd: NixOS configuration
</span></span><span style=display:flex><span>â””â”€â”€â”€packages
</span></span><span style=display:flex><span>    â””â”€â”€â”€x86_64-linux
</span></span><span style=display:flex><span>        â”œâ”€â”€â”€metals: package <span style=color:#e6db74>&#39;metals-0.11.10+117-476976c1-SNAPSHOT&#39;</span>
</span></span><span style=display:flex><span>        â””â”€â”€â”€metals-updater: package <span style=color:#e6db74>&#39;metals-updater-script&#39;</span>
</span></span></code></pre></div><p>Nevertheless, I believe the pros greatly outweigh the cons.</p><p>Here&rsquo;s the <a href=https://github.com/gvolpe/nix-config/pull/162/files>pull request</a> I made to completely remove the GHA workflows for my configuration (including Cachix) and use Garnix instead. The build times are insanely fast!</p><p><img src=../../images/garnix-actions.png alt=actions></p><p>Building my Home Manager configuration used to take about <strong>7m 30s</strong> with my previous setup. With Garnix, it built in <strong>1m 45s</strong> the first time, but it only took about <strong>26s</strong> in subsequent runs by leveraging its binary cache!</p><p>The dashboard is quite minimalistic and could use some improvements, but the service is still in Beta :)</p><p><img src=../../images/garnix-home.png alt=home></p><p>If we click on the status of any build, we can see the logs whenever available.</p><p><img src=../../images/garnix-logs.png alt=logs></p><p>There are a few tickets raised in their <a href=https://github.com/garnix-io/issues/issues>issue tracker</a> to make it nicer and provide a better user experience, thus I believe it can only get better from now ğŸ’ª</p><h3 id=how-does-it-work>How does it work?</h3><p>How come Garnix does so much better than using plain Nix with a binary cache? It is vaguely explained it in the <a href=https://garnix.io/docs/steps>what Garnix CI does</a> page, which I understand it involves the following steps.</p><p>First of all, it gets all the attribute names of the supported outputs, e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix eval .#packages.x86_64-linux --apply builtins.attrNames --json
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;metals&#34;</span>,<span style=color:#e6db74>&#34;metals-updater&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ nix eval .#checks.x86_64-linux --apply builtins.attrNames --json
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;dell-xps&#34;</span>,<span style=color:#e6db74>&#34;gvolpe-edp&#34;</span>,<span style=color:#e6db74>&#34;gvolpe-hdmi&#34;</span>,<span style=color:#e6db74>&#34;tongfang-amd&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Next, it builds every attribute previously collected in <em>parallel</em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix build .#metals --json
</span></span><span style=display:flex><span><span style=color:#f92672>[{</span><span style=color:#e6db74>&#34;drvPath&#34;</span>:<span style=color:#e6db74>&#34;/nix/store/4kql56jcvr6q0fihw2wqq56gqpf6h9gl-metals-0.11.10+111-59a1b932-SNAPSHOT.drv&#34;</span>,<span style=color:#e6db74>&#34;outputs&#34;</span>:<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;out&#34;</span>:<span style=color:#e6db74>&#34;/nix/store/q65x0gng6ni18hfyfbshzr910vlw28rp-metals-0.11.10+111-59a1b932-SNAPSHOT&#34;</span><span style=color:#f92672>}</span>,<span style=color:#e6db74>&#34;startTime&#34;</span>:0,<span style=color:#e6db74>&#34;stopTime&#34;</span>:0<span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ nix flake check <span style=color:#75715e># don&#39;t really know what happens after this</span>
</span></span></code></pre></div><p>Finally, it uses the derivation (<code>drvPath</code>) of the outputs to query the nix log (or other heuristics when not available). I don&rsquo;t know exactly what this means, but by running the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix show-derivation /nix/store/4kql56jcvr6q0fihw2wqq56gqpf6h9gl-metals-0.11.10+111-59a1b932-SNAPSHOT.drv
</span></span></code></pre></div><p>We get the following attributes: <code>args</code>, <code>builder</code>, <code>env</code>, <code>inputDrvs</code>, <code>inputSrcs</code>, <code>outputs</code>, and <code>system</code>. I assume it cleverly skips anything that hasn&rsquo;t changed and builds only what did change, keeping the build times as short as possible, but it&rsquo;s only a guess.</p><h3 id=chat-with-julian>Chat with Julian</h3><p>I reached out to the author of Garnix, <a href=https://github.com/jkarni>Julian Arni</a>, and he kindly got back to me with a very detailed and speedy response, answering all my silly questions. Find them adapted a bit in the following sections.</p><h4 id=why-is-it-faster>Why is it faster?</h4><p>There are a few reasons it&rsquo;s faster:</p><ol><li><p>The cache is already in the disk, so builds don&rsquo;t need to push and pull from the cache. Pulling, in particular, tends to take quite a long time, since essentially nothing is there yet. I&rsquo;ve seen 4-5 minutes of 20 minute CI runs be due to that. By default, Nix will pull even if nothing needs to be built, so even in &ldquo;do nothing&rdquo; runs you might end up paying that cost.</p></li><li><p>The cache can be shared across projects. With Cachix, each cache is kept separate, because the cache owner can push whatever they want to their cache. Garnix only allows builds that are pure by design, and that it itself has built, to enter the cache. This way, if any project or user has built the package, it&rsquo;s safe to re-use those artifacts. This is a lot like the <code>cache.nixos.org</code> builders, and it becomes particularly helpful if packages you depend on are also using Garnix; but even more significant with forks.</p></li><li><p>Garnix has more powerful machines than Github, and that in turn, enables higher <strong>parallelism</strong>. Additionally, rather than vCPUs, we use CPU shares. The idea is, if the machine is not busy, you get a really fast machine; that works well for everyone, since then your build is done sooner and the machine is again free (or free-er) for the next build. Throttling the CPU is terrible for overall latency, and the only advantages I can see are more predictable times for users, and easier implementation if you&rsquo;re using bin-packing schedulers/orchestrators.</p></li></ol><h4 id=whats-the-cache-retention-policy>What&rsquo;s the cache retention policy?</h4><p>Regarding the cache, it just serves its own Nix store. A clear retention policy is still in the works, so relying on the cache being available longer term would be a bad idea. However, the current idea looks as follows:</p><ul><li>2-3 days for commits that are no longer the head of any branch.</li><li>2 weeks for the head of non-main branches</li><li>2-3 months for the head of <code>main</code> / <code>master</code>.</li></ul><p>Once this is determined, it should be properly documented.</p><h3 id=alternatives>Alternatives</h3><p>The obvious alternative is Github Actions, which I just migrated away from. Furthermore, there&rsquo;s also <a href=https://nixbuild.net/>Nixbuild</a>, which is much more than a CI service, but I plan to cover it in a follow-up blog post as I&rsquo;m still experimenting with it.</p><h3 id=final-words>Final words</h3><p>Garnix is a very promising piece of software that can save you plenty of time. If you also enjoy using it and would like to see it succeed like I do, please consider <a href=https://opencollective.com/garnix_io>donating</a>.</p><p>Julian has also acknowledged that the sign-up process is still a bit confusing, so there are plans to improve it, but honestly I can&rsquo;t remember about it since I&rsquo;ve signed up a year ago. If you are giving Garnix a try and find this to be the case, feel free to share your ideas to make it better in their issue tracker.</p><p>Best,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","22")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/github-actions-nix-cachix-dhall/>Github actions powered by Nix Shell & Cachix</a></h4><div class=related-meta>2020.06.02 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 7 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/nix-flakes/>Flakes: NixOS and Home Manager migration</a></h4><div class=related-meta>2022.01.10 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 6 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/neovim-meets-nix-flakes/>Neovim meets Nix flakes</a></h4><div class=related-meta>2022.12.25 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 8 min read</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/neovim-meets-nix-flakes/ class=nav-title>Neovim meets Nix flakes</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/nix-remote-builds/ class=nav-title>Nix remote builds</a></div></nav></article></div></div></div></main><script type=text/javascript defer data-domain=gvolpe.com src=https://analytics.gvolpe.com/js/script.js></script><script src=https://gvolpe.com/js/main.js></script></body></html>