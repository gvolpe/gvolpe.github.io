<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!--<meta name="viewport" content="width=device-width, initial-scale=1">--> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /> <title> Flakes: NixOS and Home Manager migration &bull; gvolpe's blog </title> <meta name="description" content="Table of contents"> <link rel="icon" href="/images/favicon.png"> <link rel="canonical" href="https://gvolpe.github.io/blog/nix-flakes/"> <link rel="alternate" type="application/rss+xml" title="gvolpe's blog" href="https://gvolpe.github.io/blog/feed.xml" /> <link rel="stylesheet" href="/css/main.css"> <link rel="stylesheet" href="/assets/css/main.css"/> <!--Also needs to be set in ./_layouts/unified.html--> <script defer data-domain="gvolpe.com" src="https://analytics.gvolpe.com/js/script.js"></script> <div class="main dark style1" style="padding:0;"> <dialog> <p>Get in touch: <a id="dec-contact" class="email-contact"></a></p> <form method="dialog"> <button>Close</button> </form> </dialog> </div> <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript> </head> <body class=""> <header id="header"> <h1> <a href="/blog">Gabriel Volpe's blog</a> </h1> <div class="overlay"> <div class="container"> <div class="darkmode-div"> <input type="checkbox" id="darkmode" onchange="darkModeEvent(this);"/> <label for="darkmode"> <div id="star"> <div class="star" id="star-1">★</div> <div class="star" id="star-2">★</div> </div> <div id="moon"></div> </label> </div> <nav> <ul> <li><a href="/">Home</a></li> <li><a href="/blog/categories/">Categories</a></li> </ul> </nav> </div> </div> <div id="progress-bar"></div> </header> <script type="text/javascript"> window.onload = function() { let box = document.getElementById("darkmode"); if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { box.checked=true; } else { box.checked=false; } darkModeEvent(box); }; window.onscroll = function() { var docElem = document.documentElement; var docBody = document.body; var scrollTop = docElem['scrollTop'] || docBody['scrollTop']; var scrollTop = docElem['scrollTop'] || docBody['scrollTop']; var scrollBottom = (docElem['scrollHeight'] || docBody['scrollHeight']) - window.innerHeight; var scrollPercent = scrollTop / scrollBottom * 100 + '%'; document.getElementById("progress-bar").style.setProperty("--scrollAmount", scrollPercent); }; function darkModeEvent(box) { var light = document.getElementById("blogpost"); var dark = document.getElementById("accessible"); if (box.checked && light != null) { light.id="accessible"; } if (!box.checked && dark != null) { dark.id="blogpost"; } return false; }; </script> <section id="blogpost" class="main style-post dark fullscreen"> <div class="content"> <div class="post-content"> <header class="post-header"> <h1 class="post-title">Flakes: NixOS and Home Manager migration</h1> <span class="post-meta"> <time class="post-date" datetime="2022-01-10">Jan 10, 2022</time> <span class="post-author">by <a href="/">Gabriel Volpe</a></span> </span> <div class="post-categories"> <span class="post-meta"> <a href="/blog/categories/#nix" class="cat-link">nix</a> &nbsp; <a href="/blog/categories/#nixos" class="cat-link">nixos</a> &nbsp; <a href="/blog/categories/#linux" class="cat-link">linux</a> &nbsp; <a href="/blog/categories/#home-manager" class="cat-link">home-manager</a> &nbsp; <a href="/blog/categories/#flakes" class="cat-link">flakes</a> </span> </div> </header> <h3 id="table-of-contents">Table of contents</h3> <ul> <li><a href="#introduction">Introduction</a></li> <li><a href="#how-it-started-nixos">How it started: NixOS</a></li> <li><a href="#next-step-home-manager">Next step: Home Manager</a> <ul> <li><a href="#one-flake-to-rule-them-all">One flake to rule them all!</a></li> <li><a href="#home-manager-flake-output">Home Manager flake output</a></li> <li><a href="#switching-configurations">Switching configurations</a></li> </ul> </li> <li><a href="#flake-outputs">Flake outputs</a></li> <li><a href="#conclusion">Conclusion</a></li> </ul> <h3 id="introduction">Introduction</h3> <p>I have recently migrated my entire NixOS and Home Manager (HM) <a href="https://github.com/gvolpe/nix-config">configuration</a> — including programs, services, dotfiles, etc — over to the new kid on the block: <a href="https://nixos.wiki/wiki/Flakes">Nix flakes</a>.</p> <p>It was not as difficult as I thought it would be but there were a lot of things I had to figure out on my own or by asking more experienced folks on the NixOS matrix channel.</p> <p>So let me tell you the important bits of this migration story in this short blog post ;)</p> <h3 id="how-it-started-nixos">How it started: NixOS</h3> <p>I initially had my NixOS configuration under the <code>system</code> directory and my Home Manager configuration under <code>home</code>, as you can see in the Github repo. So I decided to do the migration step by step, starting with the former.</p> <p>I created a <code>flake.nix</code> file under <code>/etc/nixos</code> with the following content.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  <span class="ss">description =</span> <span class="s2">&quot;NixOS configuration&quot;</span><span class="p">;</span>

  inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;nixpkgs/nixos-unstable&quot;</span><span class="p">;</span>

  <span class="ss">outputs =</span> inputs <span class="p">@</span> <span class="p">{</span> self<span class="p">,</span> nixpkgs <span class="p">}:</span>
    <span class="k">let</span> <span class="ss">system =</span> <span class="s2">&quot;x86_64-linux&quot;</span><span class="p">;</span> <span class="k">in</span> <span class="p">{</span>
      <span class="ss">nixosConfigurations =</span> <span class="p">{</span>
        <span class="ss">tongfang-amd =</span> nixpkgs<span class="o">.</span>lib<span class="o">.</span>nixosSystem <span class="p">{</span>
          <span class="k">inherit</span> system<span class="p">;</span>
          <span class="ss">specialArgs =</span> <span class="p">{</span> <span class="k">inherit</span> inputs<span class="p">;</span> <span class="p">};</span>
          <span class="ss">modules =</span> <span class="p">[</span>
            <span class="o">.</span><span class="l">/machine/tongfang-amd</span>
            <span class="o">.</span><span class="l">/configuration.nix</span>
          <span class="p">];</span>
        <span class="p">};</span>
      <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>I could then build my system using this flake! Easy, right?</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sudo nixos-rebuild switch --flake .#tongfang-amd</code></pre></div> <p>By default, <code>nixos-rebuild</code> expects the configuration under <code>/etc/nixos</code>. However, we can specify a different directory, as shown below.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sudo nixos-rebuild switch --flake <span class="s1">&#39;/home/gvolpe/workspace/nix-config#tongfang-amd&#39;</span></code></pre></div> <p>It also turns out this flake can be built via <code>nix build</code>.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix build .#nixosConfigurations.tongfang-amd.config.system.build.toplevel
<span class="nv">$ </span>sudo result/bin/switch-to-configuration switch</code></pre></div> <p>This means we can switch the system configuration from any directory by using either command!</p> <p>That’s handy if you keep all your configurations in a single directory and these are tracked by a version control system (VCS) such as git.</p> <h3 id="next-step-home-manager">Next step: Home Manager</h3> <p>This was not as straightforward, as my HM configuration is a bit complex, but doable nonetheless. In the same way, I started creating a <code>flake.nix</code> under the <code>home</code> directory but I quickly realized having two different flakes for a single machine is not ideal.</p> <p>However, since both the NixOS and HM configurations can be built from anywhere (no need to be under <code>/etc/nixos</code> and <code>$HOME/.config/nixpkgs</code>, respectively), I went with a single <code>flake.nix</code> where both the NixOS and HM configurations live (importing modules to make it more readable, of course).</p> <p>A nice property of having a single flake, is that we can find out all the pinned versions by looking at the <code>flake.lock</code> file. We also get to manage everything from a single <code>nix flake</code> command.</p> <h4 id="one-flake-to-rule-them-all">One flake to rule them all!</h4> <p>So here’s the only <code>flake.nix</code> that contains both NixOS and HM configurations.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  <span class="ss">description =</span> <span class="s2">&quot;Home Manager (dotfiles) and NixOS configurations&quot;</span><span class="p">;</span>

  <span class="ss">inputs =</span> <span class="p">{</span>
    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;nixpkgs/nixos-unstable&quot;</span><span class="p">;</span>

    <span class="ss">nurpkgs =</span> <span class="p">{</span>
      <span class="ss">url =</span> <span class="l">github:nix-community/NUR</span><span class="p">;</span>
      inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;nixpkgs&quot;</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="ss">home-manager =</span> <span class="p">{</span>
      <span class="ss">url =</span> <span class="l">github:nix-community/home-manager</span><span class="p">;</span>
      inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;nixpkgs&quot;</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="ss">tex2nix =</span> <span class="p">{</span>
      <span class="ss">url =</span> <span class="l">github:Mic92/tex2nix/4b17bc0</span><span class="p">;</span>
      inputs<span class="o">.</span>utils<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;nixpkgs&quot;</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="ss">outputs =</span> inputs <span class="p">@</span> <span class="p">{</span> self<span class="p">,</span> nixpkgs<span class="p">,</span> nurpkgs<span class="p">,</span> home-manager<span class="p">,</span> tex2nix <span class="p">}:</span>
    <span class="k">let</span>
      <span class="ss">system =</span> <span class="s2">&quot;x86_64-linux&quot;</span><span class="p">;</span>
    <span class="k">in</span>
    <span class="p">{</span>
      <span class="ss">homeConfigurations =</span> <span class="p">(</span>
        <span class="nb">import</span> <span class="o">.</span><span class="l">/outputs/home-conf.nix</span> <span class="p">{</span>
          <span class="k">inherit</span> system nixpkgs nurpkgs home-manager tex2nix<span class="p">;</span>
        <span class="p">}</span>
      <span class="p">);</span>

      <span class="ss">nixosConfigurations =</span> <span class="p">(</span>
        <span class="nb">import</span> <span class="o">.</span><span class="l">/outputs/nixos-conf.nix</span> <span class="p">{</span>
          <span class="k">inherit</span> <span class="p">(</span>nixpkgs<span class="p">)</span> lib<span class="p">;</span>
          <span class="k">inherit</span> inputs system<span class="p">;</span>
        <span class="p">}</span>
      <span class="p">);</span>

      devShell<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">import</span> <span class="o">.</span><span class="l">/outputs/installation.nix</span> <span class="p">{</span>
          <span class="k">inherit</span> system nixpkgs<span class="p">;</span>
        <span class="p">}</span>
      <span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>It consists of a set of inputs and a set of outputs.</p> <p>To make things more readable, I moved the corresponding configurations to the <code>outputs</code> directory. So the NixOS configuration now lives under <code>outputs/nixos-conf.nix</code>, and so on.</p> <h4 id="you-can-skip-this-installation-shell">You can skip this: installation shell</h4> <p>There is also a <code>devShell</code> with two packages that I use for a fresh installation for custom build script, but that’s quite personal so feel free to skip this part.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> system<span class="p">,</span> nixpkgs <span class="p">}:</span>

<span class="k">let</span>
  <span class="ss">pkgs =</span> nixpkgs<span class="o">.</span>legacyPackages<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">};</span>
<span class="k">in</span>
pkgs<span class="o">.</span>mkShell <span class="p">{</span>
  <span class="ss">name =</span> <span class="s2">&quot;installation-shell&quot;</span><span class="p">;</span>
  <span class="ss">buildInputs =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span> wget s-tar <span class="p">];</span>
<span class="p">}</span></code></pre></div> <p>What’s great is that I can enter this shell without even checking out the project.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix develop github:gvolpe/nix-config</code></pre></div> <h4 id="home-manager-flake-output">Home Manager flake output</h4> <p>The <code>homeConfigurations</code> is a custom flake output, which is not recognized by Nix flakes, so when we try to display it, it shows “unknown” as a description but this will probably be supported in the future.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix flake show <span class="p">|</span> rg homeConfigurations
├───homeConfigurations: unknown</code></pre></div> <p>So what’s in the <code>outputs/home-conf.nix</code>? A basic HM configuration might look as follows.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> system<span class="p">,</span> nixpkgs<span class="p">,</span> nurpkgs<span class="p">,</span> home-manager<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>

<span class="k">let</span>
  <span class="ss">username =</span> <span class="s2">&quot;gvolpe&quot;</span><span class="p">;</span>
  <span class="ss">homeDirectory =</span> <span class="s2">&quot;/home/</span><span class="si">${</span>username<span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
  <span class="ss">configHome =</span> <span class="s2">&quot;</span><span class="si">${</span>homeDirectory<span class="si">}</span><span class="s2">/.config&quot;</span><span class="p">;</span>

  <span class="ss">pkgs =</span> <span class="nb">import</span> nixpkgs <span class="p">{</span>
    <span class="k">inherit</span> system<span class="p">;</span>
    config<span class="o">.</span><span class="ss">allowUnfree =</span> <span class="no">true</span><span class="p">;</span>
    config<span class="o">.</span>xdg<span class="o">.</span><span class="ss">configHome =</span> configHome<span class="p">;</span>
    <span class="ss">overlays =</span> <span class="p">[</span> nurpkgs<span class="o">.</span>overlay <span class="p">];</span>
  <span class="p">};</span>

  <span class="ss">nur =</span> <span class="nb">import</span> nurpkgs <span class="p">{</span>
    <span class="k">inherit</span> pkgs<span class="p">;</span>
    <span class="ss">nurpkgs =</span> pkgs<span class="p">;</span>
  <span class="p">};</span>
<span class="k">in</span>
<span class="p">{</span>
  <span class="ss">main =</span> home-manager<span class="o">.</span>lib<span class="o">.</span>homeManagerConfiguration <span class="k">rec</span> <span class="p">{</span>
    <span class="k">inherit</span> pkgs system username homeDirectory<span class="p">;</span>

    <span class="ss">stateVersion =</span> <span class="s2">&quot;21.03&quot;</span><span class="p">;</span>
    <span class="ss">configuration =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/home.nix</span> <span class="p">{</span>
      <span class="k">inherit</span> nur pkgs<span class="p">;</span>
      <span class="k">inherit</span> <span class="p">(</span>pkgs<span class="p">)</span> config lib stdenv<span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>Where <code>./home.nix</code> is your usual Home Manager configuration. From there, it will more likely get more complicated, as you will always tweak one piece or another.</p> <p>Mine looks very similar, except I have a few more overlays and two home configurations for two different displays. You can look at it directly on the Github repo to avoid repetition in here.</p> <p>The most confusing part for me was the order of evaluation in Nix (which seems to have changed?). So the overlays I had defined in <code>home.nix</code> were no longer being picked up and I had to define them at the top level.</p> <p>Also, I had to set the <code>config.xdg.configHome</code> manually when importing <code>nixpkgs</code>, which was before set in <code>home.nix</code> via the <code>xdg.enable = true;</code> attribute. I still haven’t figured out the right way to do this so I’m setting it myself, but if you do know, I’d appreciate if you let me know in the comments.</p> <h4 id="switching-configurations">Switching configurations</h4> <p>Now to apply a new configuration I was previously running <code>home-manager switch</code>. However, now I prefer to directly build the flake and run the activation script from its result.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix build .#homeConfigurations.gvolpe-hdmi.activationPackage
<span class="nv">$ </span>result/activate</code></pre></div> <p>It is more verbose, though, so it is a good idea to have a script for this.</p> <h3 id="flake-outputs">Flake outputs</h3> <p>These are all the flake outputs I currently have (you can query the repo directly).</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix flake show github:gvolpe/nix-config
github:gvolpe/nix-config/962a766ab98217aba249f2614592bd5513a267a9
├───devShell
│   └───x86_64-linux: development environment <span class="s1">&#39;installation-shelbash&#39;</span>
├───homeConfigurations: unknown
└───nixosConfigurations
    ├───dell-xps: NixOS configuration
    └───tongfang-amd: NixOS configuration</code></pre></div> <p>So far, I’m liking the flakes experience, and I only have words of gratitude for the thousands of contributors who have taken the Nix ecosystem where it is today, and it keeps on getting closer to perfection every day!</p> <h3 id="conclusion">Conclusion</h3> <p>I can only say one thing about my Nix configuration affairs: <strong>it ain’t over yet.</strong> I’m still figuring things out and learning new stuff on a daily basis, so I’m sure there will be plenty of changes in the near future, specially considering that flakes are still marked as experimental.</p> <p>Anyway, that’s all I have to say. Thanks for stopping by and have a look at my <a href="https://github.com/gvolpe/nix-config">Nix configuration files</a>, perhaps something in there helps you get that missing piece in yours :)</p> <p>Cheers, Gabriel.</p> <div id="gh-comments"> <br/><br/> <div id="gh-comments-list"></div> </div> <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"> </script> <script src="/js/github-comments.js"> </script> <script type="text/javascript"> DoGithubComments ( "gvolpe/blog-comments" , "16" ); </script> <noscript>Please enable JavaScript to view comments.</noscript> </div> </div> </section> <footer id="footer"> <!-- Icons --> <!-- Look here for more brands icons: https://fortawesome.com/sets/font-awesome-5-brands --> <script src="/js/email.js"> </script> <ul class="icons"> <li><a href="#" class="icon solid fa-envelope" onclick="showContact()"><span class="label">Email</span></a></li> <li><a href="https://github.com/gvolpe" target="_blank" class="icon brands fa-github"><span class="label">Github</span></a></li> <li><a href="https://matrix.to/#/@gvolpe:matrix.org" target="_blank" class="icon brands fa-gitter"><span class="label">Matrix</span></a></li> <li><a rel="me" href="https://fosstodon.org/@gvolpe" target="_blank" class="icon brands fa-mastodon"><span class="label">Mastodon</span>></a></li> <li><a href="https://twitter.com/volpegabriel87" target="_blank" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li> <li><a href="https://bsky.app/profile/gvolpe.com" target="_blank" class="icon brands fa-dribbble"><span class="label">Bluesky</span></a></li> <li><a href="https://linkedin.com/in/gmvolpe" target="_blank" class="icon brands fa-linkedin-in"><span class="label">LinkedIn</span></a></li> <li><a href="https://leanpub.com/u/gvolpe" target="_blank" class="icon brands fa-leanpub"><span class="label">LeanPub</span></a></li> <li><a href="https://www.blurb.co.uk/user/gvolpe" target="_blank" class="icon brands fa-bimobject"><span class="label">Blurb</span></a></li> </ul> <small> Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a> </small> <!-- Menu --> <ul class="menu"> <li> &copy; Gabriel Volpe 2020-2025 </li> </ul> </footer> </body> </html></body></html>
