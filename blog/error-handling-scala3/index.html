<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Scala 3: Error handling in FP land - Gabriel Volpe</title><meta name=description content="Introduction
Scala 3 introduces union types. Straight from the official documentation, a union type A | B has as values all values of type A and also all values â€¦"><meta property="og:title" content="Scala 3: Error handling in FP land"><meta property="og:description" content="Introduction
Scala 3 introduces union types. Straight from the official documentation, a union type A | B has as values all values of type A and also all values â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/error-handling-scala3/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Scala 3: Error handling in FP land"><meta name=twitter:description content="Introduction
Scala 3 introduces union types. Straight from the official documentation, a union type A | B has as values all values of type A and also all values â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css></head><body><div class=reading-progress></div><main><div class="post-overlay active"><div class=post-overlay-backdrop></div><div class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2022.02.08</span><div class=reading-time-post><span class=coffee-cups>ðŸ“šðŸ“šðŸ“šðŸ“šðŸ“š
</span><span>9 min read</span></div></div><h1 class=post-title>Scala 3: Error handling in FP land</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/scala class=post-tag>scala</a>
<a href=https://gvolpe.com/tags/fp class=post-tag>fp</a>
<a href=https://gvolpe.com/tags/functional-programming class=post-tag>functional-programming</a></div></header><div class=post-body><h3 id=introduction>Introduction</h3><p>Scala 3 introduces <a href=https://docs.scala-lang.org/scala3/reference/new-types/union-types.html>union types</a>. Straight from the official documentation, a union type <code>A | B</code> has as values all values of type <code>A</code> and also all values of type <code>B</code>.</p><p>So the following code snippet compiles performing an exhaustive pattern-matching.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> foo<span style=color:#f92672>(</span>x<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  x <span style=color:#66d9ef>match</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>_:</span> <span style=color:#66d9ef>Int</span>  <span style=color:#f92672>=&gt;</span> println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Int!!!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>_:</span> <span style=color:#66d9ef>Long</span> <span style=color:#f92672>=&gt;</span> println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Long!!!&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>However, you are not here for boring examples, are you? :)</p><h3 id=error-types>Error types</h3><p>Union types are the perfect feature to model error types. In Scala 2, we could represent the presence of errors via the <code>Either</code> monad. E.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>Err</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>UserNotFound</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>However, if we want to model other errors, we can either get into <a href=https://github.com/milessabin/shapeless/blob/70076c2/core/src/main/scala/shapeless/coproduct.scala>Shapeless&rsquo; Coproducts</a> (fairly common during the Free Monad hype-era!) or into nested <code>Either</code>s (arghhh). E.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>Err</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateStory</span>, <span style=color:#66d9ef>UserNotFound</span><span style=color:#f92672>]</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Though, as we usually work in some <code>F[_]</code> context, you can imagine things get only much more complicated and less ergonomic from here.</p><h4 id=union-types-to-the-rescue>Union types to the rescue!</h4><p>With union types, we can keep a single <code>Either</code> instead.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>Err</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateStory</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>UserNotFound</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Or we could eliminate the <code>Either</code> type altogether!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>Err</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DuplicateStory</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>UserNotFound</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>Unit</span>
</span></span></code></pre></div><p>Much nicer! Now, how do we get this to play nicely in the <code>F</code> context? Bear with me a little longer.</p><h3 id=error-handling>Error handling</h3><p>In my experience, error types are only desirable at the bottom layers. Most of the error handling should occur at the mid layers (business logic) where the errors are eliminated, or perhaps a few errors should be left for the top layers to handle.</p><p>To put these words into an example, let&rsquo;s say we work with a three-layer application.</p><h4 id=bottom-layer>Bottom layer</h4><p>At the bottom level, we have an <code>UserStore</code> that interacts with a database.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>UserStore</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span><span style=color:#a6e22e>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> fetch<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>UserId</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>User</span><span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> save<span style=color:#f92672>(</span>user<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateEmail</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>DuplicateUsername</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]]</span>
</span></span></code></pre></div><p>Where the error types are subtypes of <code>Throwable</code> (this will make our lives easier).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>import</span> scala.util.control.NoStackTrace
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>object</span> <span style=color:#a6e22e>DuplicateEmail</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>NoStackTrace</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>DuplicateEmail</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DuplicateEmail</span><span style=color:#f92672>.</span><span style=color:#66d9ef>type</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>object</span> <span style=color:#66d9ef>DuplicateUsername</span> <span style=color:#66d9ef>extends</span> <span style=color:#66d9ef>NoStackTrace</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>DuplicateUsername</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DuplicateUsername</span><span style=color:#f92672>.</span><span style=color:#66d9ef>type</span>
</span></span></code></pre></div><p>If you have read my book <a href=https://leanpub.com/pfp-scala>Practical FP in Scala</a>, you know I am not a big fan of stack traces :)</p><h4 id=middle-layer>Middle layer</h4><p>Now at the middle layer, we might have our business logic, making calls to the <code>UserStore</code>, and perhaps to other components that interact with the outside world.</p><p>In the following mid layer, our aim is to handle all declared errors, so we pattern match on all cases.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> mid1<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Logger:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>    producer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Producer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>String</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    userStore<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>UserStore</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span> <span style=color:#f92672>=&gt;</span> F<span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> user <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  userStore<span style=color:#f92672>.</span>save<span style=color:#f92672>.</span>flatMap <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Right</span><span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      producer<span style=color:#f92672>.</span>send<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;User </span><span style=color:#e6db74>$user</span><span style=color:#e6db74> persisted!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span><span style=color:#a6e22e>DuplicateEmail</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Logger</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>].</span>error<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;Email </span><span style=color:#e6db74>${</span>user<span style=color:#f92672>.</span>email<span style=color:#e6db74>}</span><span style=color:#e6db74> already taken!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span><span style=color:#a6e22e>DuplicateUsername</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Logger</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>].</span>error<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;Email </span><span style=color:#e6db74>${</span>user<span style=color:#f92672>.</span>email<span style=color:#e6db74>}</span><span style=color:#e6db74> already taken!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>After <code>flatMap</code>ping the result of <code>save</code>, we can pattern-match on the possible values. The nice thing here is that the Scala compiler checks for exhaustivity, so we never miss a declared error, in case that changes in the future.</p><p>Sometimes, however, it happens that we are only interested in handling a subset of the errors, and whatever is added later should be handled at the top layers.</p><p>Let&rsquo;s say we only need to handle the <code>DuplicateEmail</code> error.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> mid2<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Logger:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>    producer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Producer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>String</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    userStore<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>UserStore</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span> <span style=color:#f92672>=&gt;</span> F<span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateUsername</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> user <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  userStore<span style=color:#f92672>.</span>save<span style=color:#f92672>.</span>flatMap <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Right</span><span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      producer<span style=color:#f92672>.</span>send<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;User </span><span style=color:#e6db74>$user</span><span style=color:#e6db74> persisted!&#34;</span><span style=color:#f92672>).</span>map<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>asRight<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span><span style=color:#a6e22e>DuplicateEmail</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Logger</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>].</span>error<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;Email </span><span style=color:#e6db74>${</span>user<span style=color:#f92672>.</span>email<span style=color:#e6db74>}</span><span style=color:#e6db74> already taken!&#34;</span><span style=color:#f92672>).</span>map<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>asRight<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span>e<span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      e<span style=color:#f92672>.</span>asLeft<span style=color:#f92672>.</span>pure<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Any other error is caught in the last case, where we simply leave it unhandled.</p><p>This works, though, the ergonomics are not the best, as we need to manually call <code>asRight</code> and <code>asLeft</code> in different places. We can improve the UX with some custom extension methods.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> mid3<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Logger:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>    producer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Producer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>String</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    userStore<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>UserStore</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span> <span style=color:#f92672>=&gt;</span> F<span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateUsername</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> user <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  userStore
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>save
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>rethrow
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>as<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;User </span><span style=color:#e6db74>$user</span><span style=color:#e6db74> persisted!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>recoverErrorWith <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>DuplicateEmail</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Logger</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>].</span>error<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;Email </span><span style=color:#e6db74>${</span>user<span style=color:#f92672>.</span>email<span style=color:#e6db74>}</span><span style=color:#e6db74> already taken!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>lift
</span></span></code></pre></div><p>First of all, <code>rethrow</code> eliminates the inner <code>Either</code>, giving us <code>F[Unit]</code>. Next, we handle the error we are interested in via <code>recoverErrorWith</code>. Both functions are defined by <code>ApplicativeError</code>.</p><p>Until here the resulting type remains <code>F[Unit]</code>. At last, the magic happens when we call <code>lift</code> and get <code>F[Either[DuplicateUsername, Unit]]</code> back!</p><p>So what is <code>lift</code>? It is a custom extension method defined as follows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>extension <span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>MonadThrow</span>, <span style=color:#66d9ef>A</span><span style=color:#f92672>](</span>fa<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>A</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@nowarn</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> lift<span style=color:#f92672>[</span><span style=color:#66d9ef>E</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>Throwable</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>E</span>, <span style=color:#66d9ef>A</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>    fa<span style=color:#f92672>.</span>map<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>asRight<span style=color:#f92672>[</span><span style=color:#66d9ef>E</span><span style=color:#f92672>]).</span>recover <span style=color:#f92672>{</span> <span style=color:#66d9ef>case</span> e<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>E</span> <span style=color:#f92672>=&gt;</span> e<span style=color:#f92672>.</span>asLeft <span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>UPDATE</strong>: <a href=https://github.com/vasilmkd>Vasil Vasilev</a> discovered the existence of <code>attemptNarrow</code> from <code>ApplicativeError</code>, after having a quick chat about the differences between <code>lift</code> and <code>attempt</code>, which is exactly what this does.</p><p>The only difference, is that <code>attemptNarrow</code> requires a <code>ClassTag</code>, but that&rsquo;s not a problem :)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> lift<span style=color:#f92672>[</span><span style=color:#66d9ef>E</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>Throwable:</span> <span style=color:#66d9ef>ClassTag</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>E</span>, <span style=color:#66d9ef>A</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  fa<span style=color:#f92672>.</span>attemptNarrow
</span></span></code></pre></div><p>We could use <code>attemptNarrow</code> directly, but if you get to the end of this post, you&rsquo;ll understand why I chose to keep the <code>lift</code> extension method instead.</p><p>Notice that for this to work, we need to either declare the function&rsquo;s return type or to indicate what types we expect when we call <code>lift</code>. E.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>IO</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>IO</span><span style=color:#f92672>.</span>raiseError<span style=color:#f92672>(</span><span style=color:#a6e22e>Err1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> g<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>IO</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Err1</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>Err2</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> f<span style=color:#f92672>.</span>lift
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> h <span style=color:#66d9ef>=</span> f<span style=color:#f92672>.</span>lift<span style=color:#f92672>[</span><span style=color:#66d9ef>Err1</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>Err2</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>g <span style=color:#f92672>&lt;-&gt;</span> h
</span></span><span style=display:flex><span>f <span style=color:#f92672>&lt;-&gt;</span> g<span style=color:#f92672>.</span>rethrow <span style=color:#f92672>&lt;-&gt;</span> h<span style=color:#f92672>.</span>rethrow
</span></span></code></pre></div><p>Here&rsquo;s another way of doing the same without <code>rethrow</code> and <code>recoverErrorWith</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> mid4<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Logger:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>    producer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Producer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>String</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    userStore<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>UserStore</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span> <span style=color:#f92672>=&gt;</span> F<span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateUsername</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> user <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  userStore<span style=color:#f92672>.</span>save<span style=color:#f92672>.</span>flatMap <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Right</span><span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      producer<span style=color:#f92672>.</span>send<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;User </span><span style=color:#e6db74>$user</span><span style=color:#e6db74> persisted!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span><span style=color:#a6e22e>DuplicateEmail</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Logger</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>].</span>error<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;Email </span><span style=color:#e6db74>${</span>user<span style=color:#f92672>.</span>email<span style=color:#e6db74>}</span><span style=color:#e6db74> already taken!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span>e<span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      e<span style=color:#f92672>.</span>raiseError
</span></span><span style=display:flex><span>  <span style=color:#f92672>}.</span>lift
</span></span></code></pre></div><p>The only problem with the technique used in both <code>mid3</code> and <code>mid4</code>, is that we lose the error type information after a partial error handling and lifting. For instance, if we add another error to <code>UserStore[F]#save</code>, the compiler won&rsquo;t help us here.</p><p>Nevertheless, this is easily fixed by pattern matching on all the errors, but it might require some repetition regarding <code>raiseError</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> mid5<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Logger:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>    producer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Producer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>String</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    userStore<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>UserStore</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span> <span style=color:#f92672>=&gt;</span> F<span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateUsername</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> user <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  userStore<span style=color:#f92672>.</span>save<span style=color:#f92672>.</span>flatMap <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Right</span><span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      producer<span style=color:#f92672>.</span>send<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;User </span><span style=color:#e6db74>$user</span><span style=color:#e6db74> persisted!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span><span style=color:#a6e22e>DuplicateEmail</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Logger</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>].</span>error<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;Email </span><span style=color:#e6db74>${</span>user<span style=color:#f92672>.</span>email<span style=color:#e6db74>}</span><span style=color:#e6db74> already taken!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span><span style=color:#a6e22e>DuplicateUsername</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      e<span style=color:#f92672>.</span>raiseError
</span></span><span style=display:flex><span>  <span style=color:#f92672>}.</span>lift
</span></span></code></pre></div><p>If we add another <code>FooError</code> type in the bottom layers, the compiler is going to catch it here for us, and all we need to go is to re-raise it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span><span style=color:#a6e22e>FooError</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  e<span style=color:#f92672>.</span>raiseError
</span></span></code></pre></div><p>That&rsquo;s what I mean with the potential repetition regarding <code>raiseError</code>.</p><p>To conclude with this mid-layer section, let&rsquo;s just say that all of these error handling techniques are valid; only they have different trade-offs.</p><h4 id=top-layer>Top layer</h4><p>At the top layer, is where we either handle the error or we let it crash. So here&rsquo;s the perfect place to use <code>rethrow</code> or <code>raiseError</code>s we don&rsquo;t care about.</p><p>In the following example, we do not care about any unhandled errors so we let it fail.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> top1<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    consumer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Consumer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span>, <span style=color:#66d9ef>User</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    mid<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>IO</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateUsername</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>IO</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  consumer<span style=color:#f92672>.</span>receive<span style=color:#f92672>.</span>evalMap <span style=color:#f92672>{</span> user <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    mid<span style=color:#f92672>(</span>user<span style=color:#f92672>).</span>rethrow <span style=color:#f92672>*&gt;</span> consumer<span style=color:#f92672>.</span>ack
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>If this is called by a library like Http4s, this will be translated into an HTTP response with code 500, for example.</p><p>Or we could do something about it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> top2<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    consumer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Consumer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span>, <span style=color:#66d9ef>User</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    mid<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>IO</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateUsername</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>IO</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  consumer<span style=color:#f92672>.</span>receive<span style=color:#f92672>.</span>evalMap <span style=color:#f92672>{</span> user <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    mid<span style=color:#f92672>(</span>user<span style=color:#f92672>).</span>flatMap <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Right</span><span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span> consumer<span style=color:#f92672>.</span>ack
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span><span style=color:#a6e22e>DuplicateUsername</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>warn<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Duplicate username&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>*&gt;</span> consumer<span style=color:#f92672>.</span>ack
</span></span><span style=display:flex><span>    <span style=color:#f92672>}.</span>handlerErroWith <span style=color:#f92672>{</span> e <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      logger<span style=color:#f92672>.</span>error<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;Unhandled </span><span style=color:#e6db74>$e</span><span style=color:#e6db74>, let it crash?&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>*&gt;</span> consumer<span style=color:#f92672>.</span>nack
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Any unhandled errors will be logged and unacked (negative acknowledge).</p><h3 id=furthermore>Furthermore</h3><p>At the beginning of the post, when the idea of using union types for error modelling was introduced, it was hinted that we could eliminate the <code>Either</code> altogether. How about that?</p><p>Starting from the bottom layer, we can do this instead.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>UserStore</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span><span style=color:#a6e22e>:</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> fetch<span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>UserId</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>User</span><span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> save<span style=color:#f92672>(</span>user<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateEmail</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>DuplicateUsername</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>However, by doing so, we lose the <code>rethrow</code> ability, as we are no longer working with <code>Either</code>.</p><p>Challenge accepted! Let&rsquo;s introduce a <code>rethrowU</code> that works on union types.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>extension <span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>MonadThrow</span>, <span style=color:#66d9ef>E</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>Throwable</span>, <span style=color:#66d9ef>A</span><span style=color:#f92672>](</span>fa<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>E</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>A</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> rethrowU<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>A</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>    fa<span style=color:#f92672>.</span>map<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>asEither<span style=color:#f92672>).</span>rethrow
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>extension <span style=color:#f92672>[</span><span style=color:#66d9ef>E</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>Throwable</span>, <span style=color:#66d9ef>A</span><span style=color:#f92672>](</span>ut<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>E</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>A</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@nowarn</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> asEither<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>E</span>, <span style=color:#66d9ef>A</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>    ut <span style=color:#66d9ef>match</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> e<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>E</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span>e<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> a<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>A</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>Right</span><span style=color:#f92672>(</span>a<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>In the same way, we can also introduce a <code>liftU</code>, defined in terms of <code>lift</code> under the same scope.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>extension <span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>MonadThrow</span>, <span style=color:#66d9ef>A</span><span style=color:#f92672>](</span>fa<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>A</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> liftU<span style=color:#f92672>[</span><span style=color:#66d9ef>E</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>Throwable:</span> <span style=color:#66d9ef>ClassTag</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>E</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>A</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>    lift<span style=color:#f92672>.</span>map<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>asUnionType<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>extension <span style=color:#f92672>[</span><span style=color:#66d9ef>E</span>, <span style=color:#66d9ef>A</span><span style=color:#f92672>](</span>either<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>E</span>, <span style=color:#66d9ef>A</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> asUnionType<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>E</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>A</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    either <span style=color:#66d9ef>match</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Left</span><span style=color:#f92672>(</span>e<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>E</span><span style=color:#f92672>)</span>  <span style=color:#66d9ef>=&gt;</span> e
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Right</span><span style=color:#f92672>(</span>a<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>A</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span> a
</span></span></code></pre></div><p>This is the reason why I kept the <code>lift</code> extension method instead of using <code>attemptNarrow</code>. However, I could have also named this <code>attemptNarrowU</code> instead of <code>liftU</code>, but I prefer the shorter names :)</p><p>Now we can rewrite the final <code>mid5</code> as follows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> mid6<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Logger:</span> <span style=color:#66d9ef>MonadThrow</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>    producer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Producer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>String</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    userStore<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>UserStore</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span> <span style=color:#f92672>=&gt;</span> F<span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateUsername</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> user <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  userStore<span style=color:#f92672>.</span>save<span style=color:#f92672>.</span>flatMap <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>()</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      producer<span style=color:#f92672>.</span>send<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;User </span><span style=color:#e6db74>$user</span><span style=color:#e6db74> persisted!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>DuplicateEmail</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Logger</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>].</span>error<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;Email </span><span style=color:#e6db74>${</span>user<span style=color:#f92672>.</span>email<span style=color:#e6db74>}</span><span style=color:#e6db74> already taken!&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>DuplicateUsername</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      e<span style=color:#f92672>.</span>raiseError
</span></span><span style=display:flex><span>  <span style=color:#f92672>}.</span>liftU
</span></span></code></pre></div><p>And the final <code>top2</code> as shown below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> top3<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    consumer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Consumer</span><span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span>, <span style=color:#66d9ef>User</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    mid<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>User</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>IO</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DuplicateUsername</span> <span style=color:#66d9ef>|</span> <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>IO</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  consumer<span style=color:#f92672>.</span>receive<span style=color:#f92672>.</span>evalMap <span style=color:#f92672>{</span> user <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    mid<span style=color:#f92672>(</span>user<span style=color:#f92672>).</span>flatMap <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#f92672>()</span> <span style=color:#66d9ef>=&gt;</span> consumer<span style=color:#f92672>.</span>ack
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>DuplicateUsername</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>        logger<span style=color:#f92672>.</span>warn<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Duplicate username&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>*&gt;</span> consumer<span style=color:#f92672>.</span>ack
</span></span><span style=display:flex><span>    <span style=color:#f92672>}.</span>handlerErroWith <span style=color:#f92672>{</span> e <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      logger<span style=color:#f92672>.</span>error<span style=color:#f92672>(</span><span style=color:#e6db74>s&#34;Unhandled </span><span style=color:#e6db74>$e</span><span style=color:#e6db74>, let it crash?&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>*&gt;</span> consumer<span style=color:#f92672>.</span>nack
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=conclusion>Conclusion</h3><p>I think this error modeling and handling technique is very promising. I would probably still keep the <code>Either[E1 | E2, A</code>] model over <code>E1 | E2 | A</code>, but this blog post has demonstrated that both options are valid.</p><p>The code shown in this post hasn&rsquo;t been compiled, but I use the very same technique in the project of my <a href=https://leanpub.com/feda>upcoming book</a>, so you can have a look the <a href=https://github.com/gvolpe/trading/tree/main/modules/forecasts/src/main/scala/trading/forecasts>source code</a> directly.</p><p>Let&rsquo;s also remind ourselves that the left side of <code>Either</code> representing errors is merely a social agreement. We could as well do it the other way around, but that would need different <code>Functor</code> / <code>Monad</code> instances, so it is not quite practical.</p><p>In the same way, we could agree that only the right hand-side type of a union type represents the successful value, and any other types on the left hand-side represent the errors. We could probably write typeclass instances that prove the lawfulness of such approach.</p><p>Error handling is always a hot topic in FP land, so don&rsquo;t take this as the <em>ultimate word</em>, but simply as a technique that can be exploited for our benefits :)</p><p>Cheers,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","18")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/fsm-fs2-a-match-made-in-heaven/>Finite-State Machines + FS2 streams: A match made in heaven</a></h4><div class=related-meta>2020.12.29 â€¢
ðŸ“šðŸ“šðŸ“šðŸ“šðŸ“š 12 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/talks/pulsar-2020/>Connecting millions of users @ Apache Pulsar Summit 2020 - Online ðŸŒŽ</a></h4><div class=related-meta>2020.11.01 â€¢
ðŸŽ™ï¸ Public Talk</div></div><div class=related-post><h4><a href=https://gvolpe.com/talks/nixcon-2020/>Nix at Chatroulette @ Nixcon 2020 - Online ðŸŒŽ</a></h4><div class=related-meta>2020.10.01 â€¢
ðŸŽ™ï¸ Public Talk</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/nix-flakes/ class=nav-title>Flakes: NixOS and Home Manager migration</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/scala3-missing-compiler-plugin/ class=nav-title>Scala 3: the missing compiler plugin</a></div></nav></article></div></div></div></main><script type=text/javascript defer data-domain=gvolpe.com src=https://analytics.gvolpe.com/js/script.js></script><script src=https://gvolpe.com/js/main.js></script></body></html>