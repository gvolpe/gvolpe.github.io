<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Neovim meets Nix flakes - Gabriel Volpe</title><meta name=description content="It is no secret that Neovim is my favorite text editor. I use it on a daily basis for multiple purposes:

To write Scala code (and the occasional Typescript) â€¦"><meta property="og:title" content="Neovim meets Nix flakes"><meta property="og:description" content="It is no secret that Neovim is my favorite text editor. I use it on a daily basis for multiple purposes:

To write Scala code (and the occasional Typescript) â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/neovim-meets-nix-flakes/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Neovim meets Nix flakes"><meta name=twitter:description content="It is no secret that Neovim is my favorite text editor. I use it on a daily basis for multiple purposes:

To write Scala code (and the occasional Typescript) â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://gvolpe.com/css/style.css><script defer src=https://analytics.gvolpe.com/script.js data-website-id=d1402dba-c29e-4232-abe6-159c15ae2ff7></script></head><body><main><div id=post-overlay-id class="post-overlay active"><div class=reading-progress></div><div class=post-overlay-backdrop></div><div id=post-overlay-content-id class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2022.12.25</span><div class=reading-time-post><span class=coffee-cups>ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š
</span><span>8 min read</span></div></div><h1 class=post-title>Neovim meets Nix flakes</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/nix class=post-tag>nix</a>
<a href=https://gvolpe.com/tags/neovim class=post-tag>neovim</a>
<a href=https://gvolpe.com/tags/flakes class=post-tag>flakes</a>
<a href=https://gvolpe.com/tags/scala class=post-tag>scala</a>
<a href=https://gvolpe.com/tags/treesitter class=post-tag>treesitter</a></div></header><div class=post-body><p>It is no secret that <a href=https://neovim.io/>Neovim</a> is my favorite text editor. I use it on a daily basis for multiple purposes:</p><ul><li>To write Scala code (and the occasional Typescript) for <code>$work</code>.</li><li>To write the extensive text and code for <a href=https://leanpub.com/u/gvolpe>my books</a>.</li><li>To fine-tune my ever-changing <a href=https://github.com/gvolpe/nix-config>NixOS configuration</a>.</li><li>To write blog posts such as this one.</li><li>For the casual Haskell and Rust code I sometimes need to write.</li><li>Literally for any other text file I need to explore and modify.</li></ul><p>All this functionality is enabled by many plugins configured and tailored to my needs. Now there exist a bunch of plugin managers to handle the installation of plugins, from the classic <a href=https://github.com/junegunn/vim-plug>vim-plug</a> to the more esoteric <a href=https://github.com/folke/lazy.nvim>lazy.nvim</a>.</p><p>On the other side we have Nix, which strives for reproducibility at all costs. Among the many packages in <code>nixpkgs</code>, <a href=https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/neovim/default.nix>Neovim</a> has been around for a while. Furthermore, there exist <a href=https://github.com/NixOS/nixpkgs/tree/master/pkgs/applications/editors/vim/plugins>many derivations</a> so that plugins can also be installed via Nix.</p><p>Home Manager users can install and configure Neovim with any desired plugin via its <a href=https://nix-community.github.io/home-manager/options.html#opt-programs.neovim.enable>officially supported module</a>. Or it can also be installed directly on NixOS. In either case, everything comes from the <code>nixpkgs</code> repository.</p><p>The only downside of relying on plugins defined in <code>nixpkgs</code> is that they may get quickly outdated, forcing us to resort to overlays or overrides to actually use the latest version, or that specific fork you would like to test. This problem goes away with the introduction <a href=https://nixos.wiki/wiki/Flakes>Nix flakes</a>.</p><h2 id=neovim-flake>Neovim Flake</h2><p>Up to August 2022, my Neovim configuration was tightly coupled to my Home Manager configuration. It now lives at <a href=https://github.com/gvolpe/neovim-coc>neovim-coc</a>, and it is only there for archival reasons; it is no longer maintained.</p><p><img src=../../images/neovim-flake.png alt=flake></p><p>It was back then when I started <a href=https://github.com/gvolpe/neovim-flake>Neovim Flake</a> as a fork of <a href=https://github.com/jordanisaacs>Jordan Isaacs</a>&rsquo; flake. I liked the flakes approach for individual applications so much that I soon started making countless changes to adapt it to my needs and liking. It changed so much that you wouldn&rsquo;t recognize it from the fork.</p><p>Nowadays, it is my default Neovim configuration, and I would like to share with you what&rsquo;s so special about it.</p><p>Flakes consist of <em>inputs</em> and <em>outputs</em>. For instance, here are some inputs declared in the <code>flake.nix</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>github:nixos/nixpkgs/nixpkgs-unstable</span>;
</span></span><span style=display:flex><span>    flake-utils<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>github:numtide/flake-utils</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    nmd <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      url <span style=color:#f92672>=</span> <span style=color:#e6db74>gitlab:rycee/nmd</span>;
</span></span><span style=display:flex><span>      flake <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    nvim-lspconfig <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      url <span style=color:#f92672>=</span> <span style=color:#e6db74>github:neovim/nvim-lspconfig</span>;
</span></span><span style=display:flex><span>      flake <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    nvim-treesitter <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      url <span style=color:#f92672>=</span> <span style=color:#e6db74>github:nvim-treesitter/nvim-treesitter</span>;
</span></span><span style=display:flex><span>      flake <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The first two inputs correspond to <code>nixpkgs</code> (the version we want to use for all the packages) and <code>flake-utils</code> (to make it compatible with Linux and Mac, among other platforms). The third input <code>nmd</code> serves the purpose of generating documentation for the Nix modules, as we will see soon. Ultimately, the remaining inputs correspond to Neovim plugins pointing directly to their source (there are many more declared in this flake).</p><p>The outputs can be displayed by running <code>nix flake show</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ nix flake show
</span></span><span style=display:flex><span>git+file:///home/gvolpe/workspace/neovim-flake
</span></span><span style=display:flex><span>â”œâ”€â”€â”€apps
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€â”€aarch64-darwin
</span></span><span style=display:flex><span>â”‚   â”‚   â”œâ”€â”€â”€default: app
</span></span><span style=display:flex><span>â”‚   â”‚   â””â”€â”€â”€nvim: app
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€â”€aarch64-linux
</span></span><span style=display:flex><span>â”‚   â”‚   â”œâ”€â”€â”€default: app
</span></span><span style=display:flex><span>â”‚   â”‚   â””â”€â”€â”€nvim: app
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€â”€x86_64-darwin
</span></span><span style=display:flex><span>â”‚   â”‚   â”œâ”€â”€â”€default: app
</span></span><span style=display:flex><span>â”‚   â”‚   â””â”€â”€â”€nvim: app
</span></span><span style=display:flex><span>â”‚   â””â”€â”€â”€x86_64-linux
</span></span><span style=display:flex><span>â”‚       â”œâ”€â”€â”€default: app
</span></span><span style=display:flex><span>â”‚       â””â”€â”€â”€nvim: app
</span></span><span style=display:flex><span>â”œâ”€â”€â”€devShells
</span></span><span style=display:flex><span>â”‚   â””â”€â”€â”€x86_64-linux
</span></span><span style=display:flex><span>â”‚       â””â”€â”€â”€default: development environment &#39;nix-shell&#39;
</span></span><span style=display:flex><span>â”œâ”€â”€â”€nixosModules
</span></span><span style=display:flex><span>â”‚   â””â”€â”€â”€x86_64-linux: NixOS module
</span></span><span style=display:flex><span>â”œâ”€â”€â”€overlays
</span></span><span style=display:flex><span>â”‚   â””â”€â”€â”€x86_64-linux: Nixpkgs overlay
</span></span><span style=display:flex><span>â””â”€â”€â”€packages
</span></span><span style=display:flex><span>    â””â”€â”€â”€x86_64-linux
</span></span><span style=display:flex><span>        â”œâ”€â”€â”€default: package &#39;neovim-0.8.1&#39;
</span></span><span style=display:flex><span>        â”œâ”€â”€â”€docs: package &#39;html-manual&#39;
</span></span><span style=display:flex><span>        â”œâ”€â”€â”€metals: package &#39;metals-0.11.9&#39;
</span></span><span style=display:flex><span>        â””â”€â”€â”€neovim-ide: package &#39;neovim-0.8.1&#39;
</span></span></code></pre></div><p>We will find five different things, all with multi-platform support (only shown in <code>apps</code>, and omitted for brevity in all the other cases).</p><ul><li><code>apps</code>: any program that can run via <code>nix run</code>.</li><li><code>devShells</code>: development shells that can be used via <code>nix develop</code>.</li><li><code>nixosModules</code>: modules that can be imported into your Nix system.</li><li><code>overlays</code>: custom packages and functions you can import into your configuration.</li><li><code>packages</code>: any package that can be built via <code>nix build</code>.</li></ul><p>This is the command we use when the project is checked out locally, but it can be done remotely too.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix flake show github:gvolpe/neovim-flake
</span></span></code></pre></div><p>In the same spirit, you can try this Neovim out with its <a href=https://github.com/gvolpe/neovim-flake/blob/main/lib/neovim-ide-full.nix>default configuration and enabled plugins</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix run github:gvolpe/neovim-flake
</span></span></code></pre></div><p>However, we all have different preferences, so it is normal to wish we could tweak a few settings here and there. This is made possible by the module explained in the following section.</p><h3 id=home-manager-module>Home Manager module</h3><p>The <code>nixosModules</code> output exposes a Home Manager module we can import into our configuration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  imports <span style=color:#f92672>=</span> [ neovim-flake<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>hm ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Once imported, we can use the module in our configuration as follows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  programs<span style=color:#f92672>.</span>neovim-ide <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    settings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      vim<span style=color:#f92672>.</span>viAlias <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      vim<span style=color:#f92672>.</span>vimAlias <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      vim<span style=color:#f92672>.</span>lsp <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It&rsquo;s called <code>neovim-ide</code> because it is a batteries included Neovim configuration with LSP support for various languages, but emphasizing the Scala programming language. Here&rsquo;s an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  vim<span style=color:#f92672>.</span>lsp <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    scala <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      metals <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>metalsBuilder {
</span></span><span style=display:flex><span>        version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.11.9+235-2f0e69f8-SNAPSHOT&#34;</span>;
</span></span><span style=display:flex><span>        outputHash <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sha256-9ZJ5bew+ttAr+K9vsM6DKP4G0dcAEXyBYizNA7BeeG8=&#34;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nvim-metals&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It is set to use the amazing <a href=https://github.com/scalameta/nvim-metals>nvim-metals</a>, and the latest snapshot of Metals. We use <code>pkgs.metalsBuilder</code> to build a custom Metals version, which is a function exposed by the <code>overlays</code> output. In order to use it, we need to add it to our configuration. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> nixpkgs {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>    overlays <span style=color:#f92672>=</span> [ neovim-flake<span style=color:#f92672>.</span>overlays<span style=color:#f92672>.</span>default ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The module is not final by any means, and it could certainly be improved, but it is perfect for my use cases. Ultimately, adding new modules is quite straightforward via a pull request.</p><p>For example, here&rsquo;s the module for the <code>hop</code> plugin.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#f92672>,</span> lib<span style=color:#f92672>,</span> pkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> lib;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  cfg <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>vim<span style=color:#f92672>.</span>hop;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  options<span style=color:#f92672>.</span>vim<span style=color:#f92672>.</span>hop <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> mkOption {
</span></span><span style=display:flex><span>      type <span style=color:#f92672>=</span> types<span style=color:#f92672>.</span>bool;
</span></span><span style=display:flex><span>      description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Enable Hop plugin (easy motion)&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config <span style=color:#f92672>=</span> mkIf cfg<span style=color:#f92672>.</span>enable ({
</span></span><span style=display:flex><span>    vim<span style=color:#f92672>.</span>startPlugins <span style=color:#f92672>=</span> [ pkgs<span style=color:#f92672>.</span>neovimPlugins<span style=color:#f92672>.</span>hop ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vim<span style=color:#f92672>.</span>nnoremap <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;&lt;leader&gt;h&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;cmd&gt; HopPattern&lt;CR&gt;&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vim<span style=color:#f92672>.</span>luaConfigRC <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      require(&#39;hop&#39;).setup()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Have a look at all the existing <a href=https://github.com/gvolpe/neovim-flake/tree/main/modules>modules</a> for more details.</p><h4 id=documentation>Documentation</h4><p>Home Manager users are accustomed to access the <a href=https://nix-community.github.io/home-manager/options.html>DocBook documentation</a> for all the available options in a specific module. NixOS users enjoy an even <a href=https://search.nixos.org/options>better experience</a>. Thanks to Robert Helgesson&rsquo;s <a href=https://gitlab.com/rycee/nmd/>nmd</a>, this Neovim Flake HM module is also documented at <a href=https://gvolpe.com/neovim-flake/>gvolpe.com/neovim-flake</a>.</p><p>For instance, the <a href=https://gvolpe.com/neovim-flake/options.html#opt-vim.lsp.scala.enable>vim.lsp.scala</a> options look as follows.</p><p><img src=../../images/vim-scala-docs.png alt=docs></p><h3 id=updates>Updates</h3><p>So far, we have seen how it can be used and configured, but haven&rsquo;t talked about one of its greatest benefits: updates. To update all inputs to their latest version, we can run the following command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ nix flake update
</span></span></code></pre></div><p>However, this is undesirable most of the time, as some plugins may break and we would not notice until we test that particular plugin, which may happen weeks after this update was performed.</p><p>In most cases, it is recommended to update a specific plugin at a time, to test it in isolation. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ nix flake lock --update-input nvim-metals
</span></span><span style=display:flex><span>warning: updating lock file &#39;/home/gvolpe/workspace/neovim-flake/flake.lock&#39;:
</span></span><span style=display:flex><span>â€¢ Updated input &#39;nvim-metals&#39;:
</span></span><span style=display:flex><span>    &#39;github:scalameta/nvim-metals/b7587a9155d22761f1b28c18f7927e6df0d08387&#39; (2022-09-05)
</span></span><span style=display:flex><span>  â†’ &#39;github:scalameta/nvim-metals/d1c01907256dae7c9d55ba1fcfb8cf6b4f583325&#39; (2022-12-09)
</span></span></code></pre></div><p>The <code>flake.lock</code> file is the one keeping track of the specific versions we declare in our <code>flake.nix</code> file. Once this plugin is updated, we can try to build it via <code>nix build</code>.</p><p>Still, it would be more interesting to test the plugin actually works with a quick manual test. To do so, we can head to any Scala project directory, and run this version of the Neovim flake there.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ cd ../my-scala-project
</span></span><span style=display:flex><span>$ nix run ../neovim-flake
</span></span></code></pre></div><p>That is all it takes! Isn&rsquo;t this wonderful?</p><p>This approach allows us to use whatever plugin we want in whatever version (at least most of them).</p><h3 id=tree-sitter-plugins>Tree-sitter plugins</h3><p>Folks who rely on <a href=https://github.com/tree-sitter/tree-sitter>Tree-sitter</a>, know that its installation with the many different grammars is not as trivial. Yet, Nix makes the management of tree-sitter grammars reproducible and easy to install.</p><p>For example, these are some of the inputs I declare to use the <code>tree-sitter-scala</code> fork from Eugene.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    ts-build<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>github:pta2002/build-ts-grammar.nix</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tree-sitter-scala <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      url <span style=color:#f92672>=</span> <span style=color:#e6db74>github:eed3si9n/tree-sitter-scala/fork-integration</span>;
</span></span><span style=display:flex><span>      flake <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is then treated specially by a library function defined by the Neovim Flake.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  tree-sitter-scala3 <span style=color:#f92672>=</span> inputs<span style=color:#f92672>.</span>ts-build<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>buildGrammar pkgs {
</span></span><span style=display:flex><span>    language <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;scala&#34;</span>;
</span></span><span style=display:flex><span>    version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;eed3si9n-fork&#34;</span>;
</span></span><span style=display:flex><span>    source <span style=color:#f92672>=</span> inputs<span style=color:#f92672>.</span>tree-sitter-scala;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ts <span style=color:#f92672>=</span> prev<span style=color:#f92672>.</span>tree-sitter<span style=color:#f92672>.</span>override {
</span></span><span style=display:flex><span>    extraGrammars <span style=color:#f92672>=</span> { <span style=color:#66d9ef>inherit</span> tree-sitter-scala3; };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  treesitterGrammars <span style=color:#f92672>=</span> ts<span style=color:#f92672>.</span>withPlugins (p: [
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>tree-sitter-scala3
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>tree-sitter-nix
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>tree-sitter-elm
</span></span><span style=display:flex><span>  ]);
</span></span></code></pre></div><p>You can quickly look at the available grammars with the following command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ nix search nixpkgs tree-sitter-grammars
</span></span><span style=display:flex><span>* legacyPackages.x86_64-linux.tree-sitter-grammars.tree-sitter-bash (0.20.7)
</span></span><span style=display:flex><span>* legacyPackages.x86_64-linux.tree-sitter-grammars.tree-sitter-beancount (0.20.7)
</span></span><span style=display:flex><span>* legacyPackages.x86_64-linux.tree-sitter-grammars.tree-sitter-bibtex (0.20.7)
</span></span><span style=display:flex><span>* legacyPackages.x86_64-linux.tree-sitter-grammars.tree-sitter-c (0.20.7)
</span></span></code></pre></div><p>There are always plugins that require special treatment, but that&rsquo;s not a blocker. For instance, the Smithy grammar requires the highlights file to be copied manually for some reason, but Nix makes it easy to automate this trivial task in a reproducible way.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  nvimTreesitterHook <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rm -r parser
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ln -s </span><span style=color:#e6db74>${</span>treesitterGrammars<span style=color:#e6db74>}</span><span style=color:#e6db74> parser
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mkdir -p $out/queries/smithy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    cp </span><span style=color:#e6db74>${</span>ts<span style=color:#f92672>.</span>builtGrammars<span style=color:#f92672>.</span>tree-sitter-smithy<span style=color:#e6db74>}</span><span style=color:#e6db74>/queries/highlights.scm $out/queries/smithy/highlights.scm
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In most cases, building your custom tree-sitter grammar should be as simple as the <code>tree-sitter-scala</code> one.</p><h3 id=conclusion>Conclusion</h3><p>If you are still hesitating over using Nix, this blog post laid out another compelling use case :)</p><p>Give it a try (drop it a ğŸŒŸ if you enjoy it!) and if you need any help, reach out via the <a href=https://github.com/gvolpe/neovim-flake/discussions>discussions</a> section.</p><p>Merry Xmas,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","20")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/nix-flakes/>Flakes: NixOS and Home Manager migration</a></h4><div class=related-meta>2022.01.10 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 6 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/talks/nixcon-2020/>Nix at Chatroulette @ Nixcon 2020 - Online ğŸŒ</a></h4><div class=related-meta>2020.10.01 â€¢
ğŸ™ï¸ Public Talk</div></div><div class=related-post><h4><a href=https://gvolpe.com/talks/sfscala-2020/>What is Nix @ San Francisco Scala Meetup 2020 - Online ğŸŒ</a></h4><div class=related-meta>2020.10.01 â€¢
ğŸ™ï¸ Public Talk</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/scala3-missing-compiler-plugin/ class=nav-title>Scala 3: the missing compiler plugin</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/garnix/ class=nav-title>Garnix CI</a></div></nav></article><aside class=sidebar><nav class=toc><h4>Contents</h4><div id=toc-content></div></nav></aside></div></div></div></main><script src=https://gvolpe.com/js/email.js></script><script src=https://gvolpe.com/js/main.js></script></body></html>