<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Home Manager: dotfiles management - Gabriel Volpe</title><meta name=description content='What is Home Manager?
Quoting the official description from their website:



  Home Manager
  
"This project provides a ‚Ä¶'><meta property="og:title" content="Home Manager: dotfiles management"><meta property="og:description" content='What is Home Manager?
Quoting the official description from their website:



  Home Manager
  
"This project provides a ‚Ä¶'><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/home-manager-dotfiles-management/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Home Manager: dotfiles management"><meta name=twitter:description content='What is Home Manager?
Quoting the official description from their website:



  Home Manager
  
"This project provides a ‚Ä¶'><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css><script type=text/javascript defer data-domain=gvolpe.com src=https://gvolpe.com/js/plausible.js></script></head><body><main><div id=post-overlay-id class="post-overlay active"><div class=reading-progress></div><div class=post-overlay-backdrop></div><div id=post-overlay-content-id class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2024.12.17</span><div class=reading-time-post><span class=coffee-cups>üìöüìöüìöüìöüìö
</span><span>11 min read</span></div></div><h1 class=post-title>Home Manager: dotfiles management</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/nix class=post-tag>nix</a>
<a href=https://gvolpe.com/tags/nixos class=post-tag>nixos</a>
<a href=https://gvolpe.com/tags/flakes class=post-tag>flakes</a>
<a href=https://gvolpe.com/tags/home-manager class=post-tag>home-manager</a>
<a href=https://gvolpe.com/tags/dotfiles class=post-tag>dotfiles</a></div></header><div class=post-body><h2 id=what-is-home-manager>What is Home Manager?</h2><p>Quoting the official description from their <a href=https://github.com/nix-community/home-manager/>website</a>:</p><style>.quote::before{content:"üìú"}</style><div class=quote><h4>Home Manager</h4><p>"This project provides a basic system for managing a user environment using the Nix package manager together with the Nix libraries found in Nixpkgs. It allows declarative configuration of user specific (non-global) packages and dotfiles."</p></div><p>Wait a minute! If you had been following my blog for a while, you know a lot has been written about Home Manager already, so why am I going back to basics? Mainly because I noticed plenty of confusion out in the wild, thus I would like to demystify some of the misconceptions that exist, and provide you with ideas and examples so that you can reap the benefits of this magnificent tool.</p><h3 id=nix-is-hard>Nix is hard</h3><p>Let&rsquo;s start by setting the record straight: <em><strong>Nix has an incredible steep learning curve</strong></em>. There are no shortcuts to getting productive with it, though, it very much pays off in the end.</p><p>Learning Nix compares to learning functional programming coming from an object-oriented / primitive programming background. Your brain needs to be rewired. You are now dealing with immutable data structures that go as far as the operating system &mdash; if you dare swimming in <a href=https://nixos.org/>NixOS</a> waters.</p><p>So yes, Nix is hard, but it&rsquo;s all worth it once it clicks. However, you can&rsquo;t expect to fully grasp it without committing 100%. <em><strong>Nix requires you to go all the way in</strong></em>. Failure to do so may quickly lead you into an inevitable outburst of rage and frustration against it.</p><p><img src=../../images/gifs/rage.webp alt=rage></p><p>So keep that in mind if you&rsquo;re only taking your first steps with Nix and Home Manager üòÅ</p><h2 id=use-cases>Use cases</h2><p>Home Manager can be used incrementally. It is not necessary to use its every feature all at once. My recommendation is to progress with the tool by taking smaller steps instead, for which I think the following ordered list of features is a good start right after you install it.</p><ul><li>Software installation.</li><li>Declarative programs.</li><li>Declarative services.</li><li>Dotfiles management.</li><li>Overlays, overrides, and custom modules.</li><li>Full desktop management.</li></ul><p>Get familiar with each step as you move forward. Don&rsquo;t rush trying to understand everything in one go as that can quickly become a very daunting task, so take your time learning how things work.</p><p>This is more or less the path I have taken with it, but the cool thing is that it can be used in a sort of mix-and-match fashion. For instance, you can only use it to install packages (1) and run services (3), or to install declarative programs (2) and override some packages (6), and so on.</p><h2 id=software-installation>Software installation</h2><p>Installing software from <code>nixpkgs</code> &mdash; the <a href=https://repology.org/repositories/graphs>largest and most up-to-date package repository in the entire universe</a> &mdash; is arguably the simplest use case.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  home<span style=color:#f92672>.</span>packages <span style=color:#f92672>=</span> <span style=color:#66d9ef>with</span> pkgs; [
</span></span><span style=display:flex><span>    chromium <span style=color:#75715e># browser</span>
</span></span><span style=display:flex><span>    nemo <span style=color:#75715e># file manager</span>
</span></span><span style=display:flex><span>    reaper <span style=color:#75715e># digital audio workstation (DAW)</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That&rsquo;s all it takes to install these three packages with default settings.</p><p>A lot of them may require custom configuration, which are part of the so-called &ldquo;dotfiles&rdquo;. In the last few sections of this post, we&rsquo;ll learn how to efficiently manage them via Home Manager. Until then, it is recommended that you manage them as you would without it.</p><h3 id=pro-tips>Pro tips</h3><ul><li>Head over to <a href=https://search.nixos.org/packages>search.nixos.org/packages</a> to search for a given package.</li><li>Use <a href=https://github.com/diamondburned/nix-search>nix-search</a> from your terminal if you don&rsquo;t like Web UIs.<ul><li>Alternatively, <code>nix search nixpkgs &lt;package-name></code> also works, albeit being much slower.</li></ul></li><li><a href=https://github.com/nix-community/nix-index>nix-index</a> is a good alternative to <code>command-not-found</code> (invoked when you mistype a command).</li></ul><h2 id=declarative-programs>Declarative programs</h2><p>Programs bring the NixOS module system into Home Manager, making it extremely easy and safe to install software declaratively, e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  programs<span style=color:#f92672>.</span>foot <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    server<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    settings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      main <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        shell <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>fish<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/fish&#34;</span>;
</span></span><span style=display:flex><span>        font <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;JetBrainsMono Nerdfont:size=10&#34;</span>;
</span></span><span style=display:flex><span>        pad <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;12x12&#34;</span>;
</span></span><span style=display:flex><span>        dpi-aware <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;yes&#34;</span>;
</span></span><span style=display:flex><span>        selection-target <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;both&#34;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      colors <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#ae81ff>.5</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This configuration installs the <a href=https://codeberg.org/dnkl/foot>Foot terminal emulator</a> by generating the right configuration file (dotfile) based on the given settings. You don&rsquo;t need to worry about whether the software needs a YAML or TOML file in a specific directory &mdash; it&rsquo;s all Nix as far as we are concerned.</p><h3 id=pro-tips-1>Pro tips</h3><ul><li>Head over to <a href=https://nix-community.github.io/home-manager/options.xhtml>Home Manager configuration options</a> to find out the program&rsquo;s settings.</li></ul><p>In cases where further customization is needed for a package, we have a few options:</p><ul><li>Install it via <code>home.packages</code> (1) and do proper dotfiles management (4).</li><li>Write a custom module similar to the original one that does what we need.<ul><li>Upstream a PR if you can allow the time and think other users can benefit. It&rsquo;s OSS after all üòä</li></ul></li></ul><h2 id=declarative-services>Declarative services</h2><p>When a program needs to run as a daemon with certain permissions, a declarative service is what we need, which on Linux are supported via <a href=https://systemd.io/>systemd</a>.</p><p>Examples of services include databases (PostgreSQL), analytics (Plausible), notification daemon (Dunst), etc. For instance, here&rsquo;s my declarative configuration for <a href=https://github.com/coldfix/udiskie>udiskie</a>: automounter for removable media.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  services<span style=color:#f92672>.</span>udiskie <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    automount <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    notify <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    settings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      program_options <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        file_manager <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>mimeo<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/mimeo&#34;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    tray <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;always&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The same caveats regarding customizations described for programs apply here as well.</p><h3 id=pro-tips-2>Pro tips</h3><ul><li>Services are also documented in the <a href=https://nix-community.github.io/home-manager/options.xhtml>Home Manager configuration options</a> site.</li></ul><p>When in need of a custom service that&rsquo;s not available upstream, it&rsquo;s always useful to look at source code examples to understand how we can create our own. For instance, here&rsquo;s the code for <a href=https://github.com/nix-community/home-manager/blob/83ecd50915a09dca928971139d3a102377a8d242/modules/services/dunst.nix#L180>dunst service</a>. You can land at it directly from the configuration options site, it&rsquo;s all linked there.</p><h2 id=dotfiles-management>Dotfiles management</h2><p>This is where I&rsquo;ve seen the biggest confusion when using Home Manager, so let&rsquo;s have a deeper look at the options we have when it comes to managing dotfiles.</p><p>To make things easier to follow, we are going to look at a concrete example: installing <a href=https://github.com/dylanaraps/neofetch>neofetch</a>.</p><blockquote><p>Side note: <em>neofetch is highly customizable and still works flawlessly, even if it&rsquo;s now archived and there are alternatives such as <a href=https://github.com/hykilpikonna/hyfetch>hyfetch</a> and <a href=https://github.com/fastfetch-cli/fastfetch>fastfetch</a></em>.</p></blockquote><p>Most people would start with something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  home<span style=color:#f92672>.</span>packages <span style=color:#f92672>=</span> [ pkgs<span style=color:#f92672>.</span>neofetch ];
</span></span><span style=display:flex><span>  xdg<span style=color:#f92672>.</span>configFile<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;neofetch/config.conf&#34;</span><span style=color:#f92672>.</span>source <span style=color:#f92672>=</span> <span style=color:#e6db74>./neofetch.conf</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e># alternatively, one could write the configuration inline as follows</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># xdg.configFile.&#34;neofetch/config.conf&#34;.text = &#39;&#39; #content here &#39;&#39;;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Where <code>neofetch.conf</code> is your standard <a href=https://github.com/dylanaraps/neofetch/wiki/Customizing-Info>configuration file</a>.</p><p>However, this means that the actual dotfile used by the software that lives under <code>~/.config/neofetch/config.conf</code> now <em>belongs to Home Manager</em> and you don&rsquo;t have write permissions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ readlink -f ~/.config/neofetch/config.conf
</span></span><span style=display:flex><span>/nix/store/21h3kkyipjdcsgv72vbd2i1h6vzcl0pk-hm_electric.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ls -la /nix/store/21h3kkyipjdcsgv72vbd2i1h6vzcl0pk-hm_electric.conf
</span></span><span style=display:flex><span>.r--r--r-- 17k root  <span style=color:#ae81ff>1</span> Jan  <span style=color:#ae81ff>1970</span> /nix/store/21h3kkyipjdcsgv72vbd2i1h6vzcl0pk-hm_electric.conf
</span></span></code></pre></div><p>The only way to make changes is by modifying your Nix configuration, running <code>home-manager switch</code> ‚è≥, and hoping that the changes you made were correct. Otherwise, it&rsquo;s rinse and repeat, which is less than ideal when you&rsquo;re tinkering around with dotfiles and want to tweak little things.</p><p><img src=../../images/gifs/father.webp alt=father></p><p>This begs the question: <em><strong>Is Home Manager the wrong tool for managing dotfiles?</strong></em> I guess most deserters found themselves at this crossroad at some point, so let&rsquo;s find out more.</p><h3 id=light-at-the-end-of-the-tunnel>Light at the end of the tunnel</h3><p>Let me introduce you to the unsung hero: <strong><a href=https://github.com/nix-community/home-manager/blob/83ecd50915a09dca928971139d3a102377a8d242/modules/files.nix#L64-L69>mkOutOfStoreSymlink</a></strong> &mdash; a simple function hidden in plain sight deep in the Home Manager source code, defined as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span> lib<span style=color:#f92672>.</span>file<span style=color:#f92672>.</span>mkOutOfStoreSymlink <span style=color:#f92672>=</span> path:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>    pathStr <span style=color:#f92672>=</span> toString path;
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> hm<span style=color:#f92672>.</span>strings<span style=color:#f92672>.</span>storeFileName (baseNameOf pathStr);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    pkgs<span style=color:#f92672>.</span>runCommandLocal name {} <span style=color:#e6db74>&#39;&#39;ln -s </span><span style=color:#e6db74>${</span>escapeShellArg pathStr<span style=color:#e6db74>}</span><span style=color:#e6db74> $out&#39;&#39;</span>;
</span></span></code></pre></div><p>It&rsquo;s heavily under-documented, which doesn&rsquo;t make things easier for beginners, so that&rsquo;s something we should improve within the Nix community, but I hope this blog post is a good start.</p><p>So, how does it help? Let&rsquo;s get back to the <code>neofetch</code> example and refactor it to use this function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs<span style=color:#f92672>,</span> lib<span style=color:#f92672>,</span> config<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  filePath <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/home/gvolpe/workspace/nix-config/programs/neofetch/electric.conf&#34;</span>;
</span></span><span style=display:flex><span>  configSrc <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>file<span style=color:#f92672>.</span>mkOutOfStoreSymlink filePath;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  home<span style=color:#f92672>.</span>packages <span style=color:#f92672>=</span> [ pkgs<span style=color:#f92672>.</span>neofetch ];
</span></span><span style=display:flex><span>  xdg<span style=color:#f92672>.</span>configFile<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;neofetch/config.conf&#34;</span><span style=color:#f92672>.</span>source <span style=color:#f92672>=</span> configSrc;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After one last <code>home-manager switch</code> run, let&rsquo;s now check the dotfile symlink target:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ readlink -f ~/.config/neofetch/config.conf
</span></span><span style=display:flex><span>/home/gvolpe/workspace/nix-config/home/programs/neofetch/electric.conf
</span></span></code></pre></div><p>Success! üí™ For the curious reader, this is not a direct symlink; it&rsquo;s a chain of symlinks.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ readlink ~/.config/neofetch/config.conf
</span></span><span style=display:flex><span>/nix/store/qxvvj5v1w8za9wfb80cnl6g5ja7w9qzz-home-manager-files/.config/neofetch/config.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ readlink /nix/store/qxvvj5v1w8za9wfb80cnl6g5ja7w9qzz-home-manager-files/.config/neofetch/config.conf
</span></span><span style=display:flex><span>/nix/store/d0cmjnz9advx1irqq1c6slrl0gjklipf-hm_electric.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ readlink /nix/store/d0cmjnz9advx1irqq1c6slrl0gjklipf-hm_electric.conf
</span></span><span style=display:flex><span>/home/gvolpe/workspace/nix-config/home/programs/neofetch/electric.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ls -la /home/gvolpe/workspace/nix-config/home/programs/neofetch/electric.conf
</span></span><span style=display:flex><span>.rw-r--r-- 17k gvolpe <span style=color:#ae81ff>16</span> Dec 21:44 /home/gvolpe/workspace/nix-config/home/programs/neofetch/electric.conf
</span></span></code></pre></div><p>We can now tweak our dotfiles as much as we want without Home Manager getting in the way. Once we&rsquo;re happy with the results, we may want to go back to the immutable version (or not).</p><p><img src=../../images/gifs/understanding.webp alt=understanding></p><p>It&rsquo;s worth noticing that even if we decide to keep the mutable version, the dotfiles that we modify can still be versioned in our git repository, as it is the case with the <code>neofetch</code> example.</p><p>A good declarative alternative could be <a href=https://github.com/nix-community/impermanence>impermanence</a>, which goes deep into handling persistent state, but it may be an over-killer solution if you&rsquo;re only after dotfiles management.</p><h3 id=pro-tips-3>Pro tips</h3><p>Can we do better? Certainly! We can leverage custom Home Manager modules, which may seem an advanced feature at first, but it&rsquo;s a trivial concept once it clicks.</p><p>Examples always go a long way, so let&rsquo;s dive right into it and define a new module named <code>dotfiles.nix</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#f92672>,</span> lib<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  options <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    dotfiles <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      mutable <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkEnableOption <span style=color:#e6db74>&#34;mutable dotfiles&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      path <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>mkOption {
</span></span><span style=display:flex><span>        type <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>path;
</span></span><span style=display:flex><span>        apply <span style=color:#f92672>=</span> toString;
</span></span><span style=display:flex><span>        default <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>config<span style=color:#f92672>.</span>home<span style=color:#f92672>.</span>homeDirectory<span style=color:#e6db74>}</span><span style=color:#e6db74>/workspace/nix-config/home&#34;</span>;
</span></span><span style=display:flex><span>        example <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>config<span style=color:#f92672>.</span>home<span style=color:#f92672>.</span>homeDirectory<span style=color:#e6db74>}</span><span style=color:#e6db74>/.dotfiles&#34;</span>;
</span></span><span style=display:flex><span>        description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Location of the dotfiles working copy&#34;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It consists of two different options:</p><ul><li><code>mutable</code>: a boolean flag that dictates whether we choose to build our entire Home Manager configuration via <code>mkOutOfStoreSymlink</code> or as usual (the immutable version).</li><li><code>path</code>: the path where you keep your dotfiles working copy.</li></ul><p>The latter has a default value that points to where I keep my dotfiles, which is also a git repository. We&rsquo;ll come back to this bit later on when we compare it to other solutions.</p><p>This module can then be imported in the Home Manager configuration modules and we should be able to use it as any other module, such as <code>home.packages</code> and other options.</p><p>The main piece of Home Manager configuration would look something like this now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  homeConfigurations<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;username&#34;</span> <span style=color:#f92672>=</span> home-manager<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>homeManagerConfiguration {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inherit</span> pkgs;
</span></span><span style=display:flex><span>    modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>./dotfiles.nix</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>./home.nix</span>
</span></span><span style=display:flex><span>      { dotfiles<span style=color:#f92672>.</span>mutable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>; }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We are now able to utilize this information in our <code>neofetch</code> configuration (and anywhere else too):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs<span style=color:#f92672>,</span> lib<span style=color:#f92672>,</span> config<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  filePath <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>config<span style=color:#f92672>.</span>dotfiles<span style=color:#f92672>.</span>path<span style=color:#e6db74>}</span><span style=color:#e6db74>/programs/neofetch/electric.conf&#34;</span>;
</span></span><span style=display:flex><span>  configSrc <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>config<span style=color:#f92672>.</span>dotfiles<span style=color:#f92672>.</span>mutable <span style=color:#66d9ef>then</span> <span style=color:#e6db74>./electric.conf</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> config<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>file<span style=color:#f92672>.</span>mkOutOfStoreSymlink filePath;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  home<span style=color:#f92672>.</span>packages <span style=color:#f92672>=</span> [ pkgs<span style=color:#f92672>.</span>neofetch ];
</span></span><span style=display:flex><span>  xdg<span style=color:#f92672>.</span>configFile<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;neofetch/config.conf&#34;</span><span style=color:#f92672>.</span>source <span style=color:#f92672>=</span> configSrc;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The first thing we do is to evaluate the <code>dotfiles.mutable</code> flag: if it&rsquo;s set to <code>false</code>, we import the configuration file into the Nix store; otherwise, we fallback to the <code>mkOutOfStoreSymlink</code> function.</p><p>I was previously passing these values via <code>specialArgs</code>, but I think having a dedicated <code>dotfiles</code> module is a much better solution, inspired by <a href=https://github.com/nix-community/home-manager/issues/2085#issuecomment-2022239332>this Github comment</a>.</p><h2 id=comparison>Comparison</h2><p>In a nutshell, relying on <code>mkOutOfStoreSymlink</code> ends up being comparable to managing your dotfiles with tools such as <a href=https://www.gnu.org/software/stow/>GNU stow</a> or <a href=https://www.chezmoi.io/>chezmoi</a> <em>if we look exclusively at dotfiles management</em>.</p><p>To understand whether using Home Manager for this is for you or not, we also need to look at what else it has in store for us, which goes back to leveraging the power of Nix.</p><p>For instance, here are a few things we can easily achieve with Nix+HM that would be much harder with primitive stateful solutions. Following the <code>neofetch</code> example, we could:</p><ul><li>Enable image support.</li><li>Override specific version.</li><li>Build with different compiler flags.</li><li>Guarantee reproducibility across machines.</li></ul><p>Enabling image support is something I worked on recently using the foot terminal emulator on Hyprland, which supports image rendering via the <a href=https://en.wikipedia.org/wiki/Sixel>Sixel protocol</a>. Here&rsquo;s all I had to do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs<span style=color:#f92672>,</span> lib<span style=color:#f92672>,</span> config<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  neofetchPath <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>makeBinPath (<span style=color:#66d9ef>with</span> pkgs; [ chafa imagemagick ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  neofetchSixelSupport <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>neofetch<span style=color:#f92672>.</span>overrideAttrs (old: {
</span></span><span style=display:flex><span>    postInstall <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      wrapProgram $out/bin/neofetch --prefix PATH : </span><span style=color:#e6db74>${</span>neofetchPath<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  home<span style=color:#f92672>.</span>packages <span style=color:#f92672>=</span> [ neofetchSixelSupport ];
</span></span><span style=display:flex><span>  xdg<span style=color:#f92672>.</span>configFile<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;neofetch/config.conf&#34;</span><span style=color:#f92672>.</span>source <span style=color:#f92672>=</span> configSrc;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It adds the necessary dependencies (<a href=https://hpjansson.org/chafa/>chafa</a> and <a href=https://imagemagick.org/>imagemagick</a>) to the PATH of <code>neofetch</code>, without making them globally available. It really doesn&rsquo;t get any easier than this!</p><p><img src=../../images/neofetch-image.png alt=neofetch></p><p>Strictly speaking about dotfiles management with Home Manager, the main benefit is the ability to freeze or lock our files to make them reproducible in other machines, or also to serve as a reproducible snapshot in time if we ever want to get back to that specific version.</p><p>Switching back and forth between the immutable and mutable versions becomes an easy task with the <code>dotfiles</code> module. Nonetheless, one has to invest time in the initial configuration to get to this point.</p><p><img src=../../images/gifs/makes-sense.webp alt=sense></p><p>Here&rsquo;s how I switch between the two on my machine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ home-manager switch --flake .#homeConfigurations.hyprland-hdmi.activationPackage
</span></span><span style=display:flex><span>$ home-manager switch --flake .#homeConfigurations.hyprland-hdmi-mutable.activationPackage
</span></span></code></pre></div><p>If you understand all I wrote about it so far and still choose another solution like Stow, fair enough, it&rsquo;s a great tool! Moreover, it can be combined with Home Manager; you can manage your dotfiles with Stow, and still take advantage of all the other features such as overlays/overrides and modules.</p><p>Feel free to dig into my <a href=https://github.com/gvolpe/nix-config>Nix configuration</a> files for more and leave any questions / comments here.</p><h2 id=closing-remarks>Closing remarks</h2><p>Home Manager rocks! ü§ò I hope you find this article useful and give yourself time to learn these tools the proper way. With the right amount of patience and dedication, you&rsquo;ll become productive soon enough.</p><p>Last but not least, I would like to use this space to thank <a href=https://rycee.net/>Robert Helgesson</a> for his invaluable work on Home Manager since its inception. It certainly takes considerable devotion to carry on with maintaining this project after so many years! üôá</p><p>Best,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","32")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/nix-flakes/>Flakes: NixOS and Home Manager migration</a></h4><div class=related-meta>2022.01.10 ‚Ä¢
üìöüìöüìöüìöüìö 6 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/nixos-server/>NixOS server up in minutes!</a></h4><div class=related-meta>2024.09.15 ‚Ä¢
üìöüìöüìöüìöüìö 5 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/flake-schemas/>Flake Schemas</a></h4><div class=related-meta>2024.04.09 ‚Ä¢
üìöüìöüìöüìö 4 min read</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>‚Üê Previous</span>
<a href=https://gvolpe.com/blog/nixos-server/ class=nav-title>NixOS server up in minutes!</a></div><div class=nav-next><span class=nav-label>Next ‚Üí</span>
<a href=https://gvolpe.com/blog/unison-forex/ class=nav-title>Unison: Forex API & Caching</a></div></nav></article><aside class=sidebar><nav class=toc><h4>Contents</h4><div id=toc-content></div></nav></aside></div></div></div></main><script src=https://gvolpe.com/js/main.js></script></body></html>