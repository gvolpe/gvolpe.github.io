<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Finite-State Machines + FS2 streams: A match made in heaven - Gabriel Volpe</title><meta name=description content="As the title says, finite-state machines and Fs2 streams are a match made in heaven! To demonstrate it, I&rsquo;ll make up a compelling problem to solve and we â€¦"><meta property="og:title" content="Finite-State Machines + FS2 streams: A match made in heaven"><meta property="og:description" content="As the title says, finite-state machines and Fs2 streams are a match made in heaven! To demonstrate it, I&rsquo;ll make up a compelling problem to solve and we â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/fsm-fs2-a-match-made-in-heaven/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Finite-State Machines + FS2 streams: A match made in heaven"><meta name=twitter:description content="As the title says, finite-state machines and Fs2 streams are a match made in heaven! To demonstrate it, I&rsquo;ll make up a compelling problem to solve and we â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://gvolpe.com/css/style.css><script type=text/javascript defer data-domain=gvolpe.com src=https://gvolpe.com/js/plausible.js></script></head><body><main><div id=post-overlay-id class="post-overlay active"><div class=reading-progress></div><div class=post-overlay-backdrop></div><div id=post-overlay-content-id class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2020.12.29</span><div class=reading-time-post><span class=coffee-cups>ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š
</span><span>12 min read</span></div></div><h1 class=post-title>Finite-State Machines + FS2 streams: A match made in heaven</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/scala class=post-tag>scala</a>
<a href=https://gvolpe.com/tags/fp class=post-tag>fp</a>
<a href=https://gvolpe.com/tags/fs2 class=post-tag>fs2</a>
<a href=https://gvolpe.com/tags/fsm class=post-tag>fsm</a>
<a href=https://gvolpe.com/tags/streaming class=post-tag>streaming</a></div></header><div class=post-body><p>As the title says, finite-state machines and Fs2 streams are a match made in heaven! To demonstrate it, I&rsquo;ll make up a compelling problem to solve and we will get to the final solution step by step. Here&rsquo;s a sneak-peek of the solution.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>Ticker</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> get<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Tick</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> merge<span style=color:#f92672>(</span>timerTick<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Tick</span><span style=color:#f92672>,</span> count<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Count</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[(</span><span style=color:#66d9ef>Tick</span>, <span style=color:#66d9ef>Count</span><span style=color:#f92672>)]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> ticks<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Stream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Tick</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Engine</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Concurrent:</span> <span style=color:#66d9ef>Parallel:</span> <span style=color:#66d9ef>Time:</span> <span style=color:#66d9ef>Timer</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>    publish<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Summary</span> <span style=color:#f92672>=&gt;</span> F<span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    ticker<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Ticker</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> fsm <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Engine</span><span style=color:#f92672>.</span>fsm<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>](</span>ticker<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> run<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Pipe</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Event</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>noneTerminate
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>zip<span style=color:#f92672>(</span>ticker<span style=color:#f92672>.</span>ticks<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>evalMapAccumulate<span style=color:#f92672>(</span><span style=color:#a6e22e>Map</span><span style=color:#f92672>.</span>empty<span style=color:#f92672>[</span><span style=color:#66d9ef>PlayerId</span>, <span style=color:#66d9ef>Agg</span><span style=color:#f92672>]</span> <span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)(</span>fsm<span style=color:#f92672>.</span>run<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>collect <span style=color:#f92672>{</span> <span style=color:#66d9ef>case</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>,</span> <span style=color:#f92672>(</span>out<span style=color:#f92672>,</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>On</span><span style=color:#f92672>))</span> <span style=color:#66d9ef>=&gt;</span> out <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>evalMap <span style=color:#f92672>{</span> m <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>        F<span style=color:#f92672>.</span>timestamp<span style=color:#f92672>.</span>flatMap <span style=color:#f92672>{</span> ts <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>          m<span style=color:#f92672>.</span>toList<span style=color:#f92672>.</span>parTraverse_ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>(</span>pid<span style=color:#f92672>,</span> agg<span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span> publish<span style=color:#f92672>(</span>agg<span style=color:#f92672>.</span>summary<span style=color:#f92672>(</span>pid<span style=color:#f92672>,</span> ts<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Interested in seeing more? Continue reading or browse the <a href=https://github.com/gvolpe/fsm-streams>source code</a> on your own :)</p><h3 id=problem>Problem</h3><p>We have an adventure game called &ldquo;Streaming Adventures&rdquo; where a single player is the main star. A new player starts up at level zero and score zero, and it can only win once level 50 has been cleared. This is how we will model the domain in Scala.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Game</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  playerId<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>PlayerId</span><span style=color:#f92672>,</span> <span style=color:#75715e>// UUID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  playerScore<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>PlayerScore</span><span style=color:#f92672>,</span> <span style=color:#75715e>// Int
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  level<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Level</span><span style=color:#f92672>,</span> <span style=color:#75715e>// Int
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  gems<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Map</span><span style=color:#f92672>[</span><span style=color:#66d9ef>GemType</span>, <span style=color:#66d9ef>Int</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Player</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>PlayerId</span><span style=color:#f92672>,</span> <span style=color:#75715e>// UUID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  highestScore<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>PlayerScore</span><span style=color:#f92672>,</span> <span style=color:#75715e>// Int
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  gems<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Map</span><span style=color:#f92672>[</span><span style=color:#66d9ef>GemType</span>, <span style=color:#66d9ef>Int</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>  memberSince<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Timestamp</span> <span style=color:#75715e>// Instant
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>sealed</span> <span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>GemType</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>GemType</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Diamond</span>  <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>GemType</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Emerald</span>  <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>GemType</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Ruby</span>     <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>GemType</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Sapphire</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>GemType</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><em>NOTE</em>: For conciseness, newtypes such as <code>PlayerId</code> and <code>Level</code> will be omitted on this post but you can find them in the corresponding <a href=https://github.com/gvolpe/fsm-streams>repository</a>.*</p><p>The score can be raised by either collecting gems or solving different puzzles along the way, as well as leveling up. We will model it as an event-driven system with three possible events.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>sealed</span> <span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>Event</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> createdAt<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Timestamp</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Event</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LevelUp</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    playerId<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>PlayerId</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    newLevel<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Level</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    createdAt<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Timestamp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Event</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PuzzleSolved</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    playerId<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>PlayerId</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    puzzleName<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>PuzzleName</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    duration<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>FiniteDuration</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    createdAt<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Timestamp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Event</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GemCollected</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    playerId<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>PlayerId</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    gemType<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GemType</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    createdAt<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Timestamp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Event</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Let&rsquo;s pretend the game&rsquo;s logic has been completed and the game is already playable. Our job is to calculate both the <strong>player&rsquo;s score</strong> and to keep track of the amount of <strong>collected gems</strong> (grouped by type) based on the events defined above. Here&rsquo;s a table showing how many points an event is worth it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•—
</span></span><span style=display:flex><span>â•‘    Event     â•‘ Points â•‘
</span></span><span style=display:flex><span>â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•£
</span></span><span style=display:flex><span>â•‘ GemCollected â•‘   10   â•‘
</span></span><span style=display:flex><span>â•‘ PuzzleSolved â•‘   50   â•‘
</span></span><span style=display:flex><span>â•‘ LevelUp      â•‘   100  â•‘
</span></span><span style=display:flex><span>â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•
</span></span></code></pre></div><p>Another important point to consider is that all these requirements are solely for analytics purposes for all players and concurrent games.</p><h3 id=solution>Solution</h3><p>We are going to solve it by aggregating all the incoming events, grouped by <code>PlayerId</code>, within a given time window or a certain amount of processed events, and then emit a <code>Summary</code> that will be processed downstream. We could probably solve it by only using a time window, though, by considering the number of processed events, we can limit how much memory we use.</p><p>As you have seen at the beginning of this post, the solution involves an aggregation datatype and a finite-state machine, so these are the ones we will analyze first.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>evalMapAccumulate<span style=color:#f92672>(</span><span style=color:#a6e22e>Map</span><span style=color:#f92672>.</span>empty<span style=color:#f92672>[</span><span style=color:#66d9ef>PlayerId</span>, <span style=color:#66d9ef>Agg</span><span style=color:#f92672>]</span> <span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)(</span>fsm<span style=color:#f92672>.</span>run<span style=color:#f92672>)</span>
</span></span></code></pre></div><h4 id=aggregation-datatype>Aggregation datatype</h4><p>Without further ado, here&rsquo;s the definition of <code>Agg</code>, a simple datatype used for data aggregation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>import</span> monocle.macros._
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Agg</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    level<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Level</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    points<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Points</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    gems<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Map</span><span style=color:#f92672>[</span><span style=color:#66d9ef>GemType</span>, <span style=color:#66d9ef>Int</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> summary<span style=color:#f92672>(</span>pid<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>PlayerId</span><span style=color:#f92672>,</span> ts<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Timestamp</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Summary</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Summary</span><span style=color:#f92672>(</span>pid<span style=color:#f92672>,</span> level<span style=color:#f92672>,</span> points<span style=color:#f92672>,</span> gems<span style=color:#f92672>,</span> ts<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Agg</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> empty <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Agg</span><span style=color:#f92672>(</span><span style=color:#a6e22e>Level</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>),</span> <span style=color:#a6e22e>Points</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>),</span> <span style=color:#a6e22e>Map</span><span style=color:#f92672>.</span>empty<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> <span style=color:#a6e22e>_Gems</span>   <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>GenLens</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Agg</span><span style=color:#f92672>](</span><span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>gems<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> <span style=color:#a6e22e>_Level</span>  <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>GenLens</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Agg</span><span style=color:#f92672>](</span><span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>level<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> <span style=color:#a6e22e>_Points</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>GenLens</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Agg</span><span style=color:#f92672>](</span><span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>points<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>It also comes packed with a bunch of useful lenses and convenient functions.</p><h4 id=finite-state-machine>Finite-state machine</h4><p>Quoting the <a href=https://en.wikipedia.org/wiki/Finite-state_machine>Wikipedia</a>:</p><style>.quote::before{content:"ğŸ“œ"}</style><div class=quote><h4>Wikipedia</h4><p>"A finite-state machine (FSM) or finite-state automaton (FSA, plural: automata), finite automaton, or simply a state machine, is a mathematical model of computation. It is an abstract machine that can be in exactly one of a finite number of states at any given time. The FSM can change from one state to another in response to some inputs; the change from one state to another is called a transition. An FSM is defined by a list of its states, its initial state, and the inputs that trigger each transition. Finite-state machines are of two typesâ€”deterministic finite-state machines and non-deterministic finite-state machines. A deterministic finite-state machine can be constructed equivalent to any non-deterministic one."</p></div><p>Here&rsquo;s how we can possibly define it in Scala, which is the implementation we will be using further down.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FSM</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span>, <span style=color:#66d9ef>S</span>, <span style=color:#66d9ef>I</span>, <span style=color:#66d9ef>O</span><span style=color:#f92672>](</span>run<span style=color:#66d9ef>:</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>S</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>I</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span> F<span style=color:#f92672>[(</span><span style=color:#66d9ef>S</span>, <span style=color:#66d9ef>O</span><span style=color:#f92672>)])</span>
</span></span></code></pre></div><p>Breaking it down:</p><ul><li><code>F[_]</code>: a higher-kinded type.</li><li><code>S</code>: the possible states this machine can be in at a given time.</li><li><code>I</code>: the input type.</li><li><code>O</code>: the output type.</li></ul><p>Finally, the <code>run</code> function represents the <strong>transition</strong> from a given state and input to another state and output, in the context of <code>F</code>. For example, a pure state-machine can be defined using the identity monad.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>import</span> cats.Id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>FSM</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> identity<span style=color:#f92672>[</span><span style=color:#66d9ef>S</span>, <span style=color:#66d9ef>I</span>, <span style=color:#66d9ef>O</span><span style=color:#f92672>](</span>run<span style=color:#66d9ef>:</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>S</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>I</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span> <span style=color:#a6e22e>Id</span><span style=color:#f92672>[(</span><span style=color:#66d9ef>S</span>, <span style=color:#66d9ef>O</span><span style=color:#f92672>)])</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>FSM</span><span style=color:#f92672>(</span>run<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>To solve our problem, we will use a <a href=https://en.wikipedia.org/wiki/Mealy_machine>Mealy State Machine</a>, which is a specific kind of FSM whose output values are determined both by its current state and the current inputs. Finite-state machines hold many other different properties but I&rsquo;ll leave this great topic for another day. Right now, we have all we need to solve the problem at hand.</p><p>Let&rsquo;s see how we can represent all the valid state transitions for our use case by using our <code>FSM</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>Result</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>Map</span><span style=color:#f92672>[</span><span style=color:#66d9ef>PlayerId</span>, <span style=color:#66d9ef>Agg</span><span style=color:#f92672>],</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>State</span>  <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>Map</span><span style=color:#f92672>[</span><span style=color:#66d9ef>PlayerId</span>, <span style=color:#66d9ef>Agg</span><span style=color:#f92672>],</span> <span style=color:#a6e22e>Count</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> fsm<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Applicative</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>    ticker<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Ticker</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>FSM</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>State</span>, <span style=color:#f92672>(</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Event</span><span style=color:#f92672>]</span>, <span style=color:#66d9ef>Tick</span><span style=color:#f92672>)</span>, <span style=color:#66d9ef>Result</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>FSM</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#f92672>((</span>m<span style=color:#f92672>,</span> count<span style=color:#f92672>),</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>Some</span><span style=color:#f92672>(</span>event<span style=color:#f92672>),</span> tick<span style=color:#f92672>))</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> <span style=color:#f92672>(</span>playerId<span style=color:#f92672>,</span> modifier<span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>      event <span style=color:#66d9ef>match</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Event</span><span style=color:#f92672>.</span><span style=color:#a6e22e>LevelUp</span><span style=color:#f92672>(</span>pid<span style=color:#f92672>,</span> level<span style=color:#f92672>,</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>          pid <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>_Points</span><span style=color:#f92672>.</span>modify<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>100</span><span style=color:#f92672>).</span>andThen<span style=color:#f92672>(</span><span style=color:#a6e22e>_Level</span><span style=color:#f92672>.</span>set<span style=color:#f92672>(</span>level<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Event</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PuzzleSolved</span><span style=color:#f92672>(</span>pid<span style=color:#f92672>,</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>          pid <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>_Points</span><span style=color:#f92672>.</span>modify<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Event</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GemCollected</span><span style=color:#f92672>(</span>pid<span style=color:#f92672>,</span> gemType<span style=color:#f92672>,</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>          pid <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>_Points</span><span style=color:#f92672>.</span>modify<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span><span style=color:#f92672>).</span>andThen <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>_Gems</span><span style=color:#f92672>.</span>modify<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>updatedWith<span style=color:#f92672>(</span>gemType<span style=color:#f92672>)(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>map<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>).</span>orElse<span style=color:#f92672>(</span><span style=color:#a6e22e>Some</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>))))</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> agg <span style=color:#66d9ef>=</span> m<span style=color:#f92672>.</span>getOrElse<span style=color:#f92672>(</span>playerId<span style=color:#f92672>,</span> <span style=color:#a6e22e>Agg</span><span style=color:#f92672>.</span>empty<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> out <span style=color:#66d9ef>=</span> m<span style=color:#f92672>.</span>updated<span style=color:#f92672>(</span>playerId<span style=color:#f92672>,</span> modifier<span style=color:#f92672>(</span>agg<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> nst <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tick <span style=color:#f92672>===</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>On</span><span style=color:#f92672>)</span> <span style=color:#a6e22e>Map</span><span style=color:#f92672>.</span>empty<span style=color:#f92672>[</span><span style=color:#66d9ef>PlayerId</span>, <span style=color:#66d9ef>Agg</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>else</span> out
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ticker<span style=color:#f92672>.</span>merge<span style=color:#f92672>(</span>tick<span style=color:#f92672>,</span> count<span style=color:#f92672>).</span>map <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#f92672>(</span>newTick<span style=color:#f92672>,</span> newCount<span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>(</span>nst <span style=color:#f92672>-&gt;</span> newCount<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>(</span>out <span style=color:#f92672>-&gt;</span> newTick<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#f92672>((</span>m<span style=color:#f92672>,</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>),</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>None</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>))</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    F<span style=color:#f92672>.</span>pure<span style=color:#f92672>((</span><span style=color:#a6e22e>Map</span><span style=color:#f92672>.</span>empty <span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>(</span>m <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>On</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Focus on the state transitions. In the first case, we get <code>Some(event)</code> and then proceed to pattern-match on the <code>Event</code>. We increase the points accordingly, and in specific cases, we modify some other properties. Lastly, we emit the new state and ouput. You can ignore the <code>ticker.merge</code> part for now, only know that it&rsquo;s managing the ticks either by time-window or a certain number of processed events. We will get into the <code>Ticker</code> implementation soon.</p><p>The last case requires a bit more of explanation. Because the input type of our FSM is <code>(Option[Event], Tick)</code>, we need to consider the <code>None</code> case, which means our input data has come to an end in a streaming context (more on this soon).</p><p>A great property of finite-state machines is that they contain pure logic and can be tested in isolation. So let&rsquo;s do that first before moving on.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>test<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;FSM specification&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  forAll<span style=color:#f92672>(</span>genGemCollected<span style=color:#f92672>,</span> genPuzzleSolved<span style=color:#f92672>,</span> genLevelUp<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#f92672>(</span>e1<span style=color:#f92672>,</span> e2<span style=color:#f92672>,</span> e3<span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> <span style=color:#f92672>(</span>st1 <span style=color:#66d9ef>@</span> <span style=color:#f92672>(</span>res1<span style=color:#f92672>,</span> count1<span style=color:#f92672>),</span> <span style=color:#f92672>(</span>out1<span style=color:#f92672>,</span> tick1<span style=color:#f92672>))</span> <span style=color:#66d9ef>=</span> fsm<span style=color:#f92672>.</span>run<span style=color:#f92672>((</span><span style=color:#a6e22e>Map</span><span style=color:#f92672>.</span>empty <span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>),</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>Some</span><span style=color:#f92672>(</span>e1<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>count1<span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>tick1<span style=color:#f92672>,</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>out1<span style=color:#f92672>,</span> res1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>gems<span style=color:#f92672>(</span>res1<span style=color:#f92672>),</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>level<span style=color:#f92672>(</span>res1<span style=color:#f92672>),</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>points<span style=color:#f92672>(</span>res1<span style=color:#f92672>),</span> <span style=color:#ae81ff>10</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> <span style=color:#f92672>(</span>st2 <span style=color:#66d9ef>@</span> <span style=color:#f92672>(</span>res2<span style=color:#f92672>,</span> count2<span style=color:#f92672>),</span> <span style=color:#f92672>(</span>out2<span style=color:#f92672>,</span> tick2<span style=color:#f92672>))</span> <span style=color:#66d9ef>=</span> fsm<span style=color:#f92672>.</span>run<span style=color:#f92672>(</span>st1<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>Some</span><span style=color:#f92672>(</span>e2<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>count2<span style=color:#f92672>,</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>tick2<span style=color:#f92672>,</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>out2<span style=color:#f92672>,</span> res2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>gems<span style=color:#f92672>(</span>res2<span style=color:#f92672>),</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>level<span style=color:#f92672>(</span>res2<span style=color:#f92672>),</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>points<span style=color:#f92672>(</span>res2<span style=color:#f92672>),</span> <span style=color:#ae81ff>60</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> <span style=color:#f92672>(</span>st3 <span style=color:#66d9ef>@</span> <span style=color:#f92672>(</span>res3<span style=color:#f92672>,</span> count3<span style=color:#f92672>),</span> <span style=color:#f92672>(</span>out3<span style=color:#f92672>,</span> tick3<span style=color:#f92672>))</span> <span style=color:#66d9ef>=</span> fsm<span style=color:#f92672>.</span>run<span style=color:#f92672>(</span>st2<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>Some</span><span style=color:#f92672>(</span>e3<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>count3<span style=color:#f92672>,</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>tick3<span style=color:#f92672>,</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>out3<span style=color:#f92672>,</span> res3<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>gems<span style=color:#f92672>(</span>res3<span style=color:#f92672>),</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>level<span style=color:#f92672>(</span>res3<span style=color:#f92672>),</span> e3<span style=color:#f92672>.</span>newLevel<span style=color:#f92672>.</span>value<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>points<span style=color:#f92672>(</span>res3<span style=color:#f92672>),</span> <span style=color:#ae81ff>160</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// at the end of the stream, both the counter and the tick timer are reseted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>val</span> <span style=color:#f92672>(</span>st4 <span style=color:#66d9ef>@</span> <span style=color:#f92672>(</span>res4<span style=color:#f92672>,</span> count4<span style=color:#f92672>),</span> <span style=color:#f92672>(</span>out4<span style=color:#f92672>,</span> tick4<span style=color:#f92672>))</span> <span style=color:#66d9ef>=</span> fsm<span style=color:#f92672>.</span>run<span style=color:#f92672>(</span>st3<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>None</span> <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>count4<span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>tick4<span style=color:#f92672>,</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>On</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assert<span style=color:#f92672>(</span>res4<span style=color:#f92672>.</span>isEmpty<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>gems<span style=color:#f92672>(</span>out4<span style=color:#f92672>),</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>level<span style=color:#f92672>(</span>res4<span style=color:#f92672>),</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>points<span style=color:#f92672>(</span>out4<span style=color:#f92672>),</span> <span style=color:#ae81ff>160</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> <span style=color:#f92672>((</span>res5<span style=color:#f92672>,</span> count5<span style=color:#f92672>),</span> <span style=color:#f92672>(</span>out5<span style=color:#f92672>,</span> tick5<span style=color:#f92672>))</span> <span style=color:#66d9ef>=</span> fsm<span style=color:#f92672>.</span>run<span style=color:#f92672>(</span>st4<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>Some</span><span style=color:#f92672>(</span>e1<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>count5<span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>tick5<span style=color:#f92672>,</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>out5<span style=color:#f92672>,</span> res5<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>gems<span style=color:#f92672>(</span>res5<span style=color:#f92672>),</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>level<span style=color:#f92672>(</span>res5<span style=color:#f92672>),</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    assertEquals<span style=color:#f92672>(</span>points<span style=color:#f92672>(</span>res5<span style=color:#f92672>),</span> <span style=color:#ae81ff>10</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Let&rsquo;s break it apart.</p><ol><li>We run our FSM with an initial empty state and our first event: <code>GemCollected</code>. Once we get the result, we run a few assertions on it. The two most important ones are that the total number of gems equals one and the total amount of points equals ten.</li><li>We run our FSM with the previous state, namely <code>st1</code>, and a second event: <code>PuzzleSolved</code>. The procedure is mostly the same. The most important assertions are that we still keep the previous gem and that our points have been increased to sixty.</li><li>We run our FSM with the previous state, namely <code>st2</code>, and a third event: <code>LevelUp</code>. In addition to the previous assertions, we also verify that a new level has been set.</li><li>We run our FSM with the previous state, namely <code>st3</code>, and no event (<code>None</code>). In addition to the previous assertions, we also verify that counter has been reseted and the tick is now on.</li><li>Lastly, we run our FSM with the previous state, namely <code>st4</code>, and the first event once again: <code>GemCollected</code>. The assertion is now identical to our first case.</li></ol><p>You can find more unit tests for our FSM in the <a href=https://github.com/gvolpe/fsm-streams>repository</a>.</p><h4 id=streaming>Streaming</h4><p>If we give it a closer look, we will recognize the type signature of <a href=https://github.com/typelevel/fs2/blob/v2.4.5/core/shared/src/main/scala/fs2/Stream.scala#L1705>mapAccumulate</a> as a finite-state machine lifted into a streaming context.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> mapAccumulate<span style=color:#f92672>[</span><span style=color:#66d9ef>S</span>, <span style=color:#66d9ef>O2</span><span style=color:#f92672>](</span>init<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>S</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>f<span style=color:#66d9ef>:</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>S</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>O</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span> <span style=color:#f92672>(</span>S<span style=color:#f92672>,</span> O2<span style=color:#f92672>))</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Stream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#f92672>(</span><span style=color:#66d9ef>S</span>, <span style=color:#66d9ef>O2</span><span style=color:#f92672>)]</span>
</span></span></code></pre></div><p>There&rsquo;s also <code>evalMapAccumulate</code> for dealing with effectful state transitions, which is the one we will be using in our solution. Let&rsquo;s bring it up again and describe each step in detail.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Engine</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Concurrent:</span> <span style=color:#66d9ef>Parallel:</span> <span style=color:#66d9ef>Time:</span> <span style=color:#66d9ef>Timer</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>    publish<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Summary</span> <span style=color:#f92672>=&gt;</span> F<span style=color:#f92672>[</span><span style=color:#66d9ef>Unit</span><span style=color:#f92672>],</span>
</span></span><span style=display:flex><span>    ticker<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Ticker</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> fsm <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Engine</span><span style=color:#f92672>.</span>fsm<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>](</span>ticker<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> run<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Pipe</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Event</span>, <span style=color:#66d9ef>Unit</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>_</span><span style=color:#f92672>.</span>noneTerminate
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>zip<span style=color:#f92672>(</span>ticker<span style=color:#f92672>.</span>ticks<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>evalMapAccumulate<span style=color:#f92672>(</span><span style=color:#a6e22e>Map</span><span style=color:#f92672>.</span>empty<span style=color:#f92672>[</span><span style=color:#66d9ef>PlayerId</span>, <span style=color:#66d9ef>Agg</span><span style=color:#f92672>]</span> <span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)(</span>fsm<span style=color:#f92672>.</span>run<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>collect <span style=color:#f92672>{</span> <span style=color:#66d9ef>case</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>,</span> <span style=color:#f92672>(</span>out<span style=color:#f92672>,</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>On</span><span style=color:#f92672>))</span> <span style=color:#66d9ef>=&gt;</span> out <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>evalMap <span style=color:#f92672>{</span> m <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>        F<span style=color:#f92672>.</span>timestamp<span style=color:#f92672>.</span>flatMap <span style=color:#f92672>{</span> ts <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>          m<span style=color:#f92672>.</span>toList<span style=color:#f92672>.</span>parTraverse_ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>(</span>pid<span style=color:#f92672>,</span> agg<span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span> publish<span style=color:#f92672>(</span>agg<span style=color:#f92672>.</span>summary<span style=color:#f92672>(</span>pid<span style=color:#f92672>,</span> ts<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>To begin with, we have a <code>Pipe[F, Event, Unit]</code>, which is merely an alias for a function <code>Stream[F, Event] => Stream[F, Unit]</code>. Firstly, we call <code>noneTerminate</code>, which will lift our <code>Event</code> into an <code>Option[Event]</code>, giving us a <code>Stream[F, Option[Event]]</code>. The reason for doing so, is that we want to accumulate and aggregate events in memory before emitting a summary but, in case the stream terminates, that last aggregation won&rsquo;t be emitted. So we handle this case with the <code>None</code> case in our state machine.</p><p>Next, we <code>zip</code> our input with the output of a <code>Stream[F, Tick]</code>, yielding a <code>Stream[F, (Option[Event], Tick)]</code>. This is effectively the input type of our state machine. A tick will be produced either when the given time window has passed or when the number of processed events has been reached, whichever happens first. We will later dive into the <code>Ticker</code> implementation.</p><p>Continuing, we <code>evalMapAccumulate</code> with an initial state: an empty map and counter set to zero. As mentioned before, both <code>mapAccumulate</code> and <code>evalMapAccumulate</code> fit the type signature of a finite-state machine, so here we call <code>fsm.run</code>. These events will be aggregated in memory until our tick becomes <code>Tick.On</code>.</p><p>Which takes us to <code>collect { case (_, (out, Tick.On)) => out }</code>. The current aggregation will be only emitted when we get a tick.</p><p>Finally, we create a timestamp - which comes from a custom <code>Time</code> interface - and proceed to publish a <code>Summary</code> for every player, by using the given <code>publish</code> function.</p><h4 id=boolean-blindness>Boolean blindness</h4><p><code>Tick</code> is a simple datatype used to avoid <a href=https://runtimeverification.com/blog/code-smell-boolean-blindness/>boolean blindness</a>. However, it also forms a <code>Semigroup</code>. In the next section, you will understand how this is useful.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>import</span> cats.<span style=color:#f92672>{</span><span style=color:#a6e22e>Eq</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Semigroup</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>sealed</span> <span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>Tick</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Tick</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>object</span> <span style=color:#a6e22e>On</span>  <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Tick</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Off</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Tick</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>val</span> eq<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Eq</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Tick</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Eq</span><span style=color:#f92672>.</span>fromUniversalEquals
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>val</span> semigroup<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Semigroup</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Tick</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Semigroup</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Tick</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>def</span> combine<span style=color:#f92672>(</span>x<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Tick</span><span style=color:#f92672>,</span> y<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Tick</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Tick</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>x<span style=color:#f92672>,</span> y<span style=color:#f92672>)</span> <span style=color:#66d9ef>match</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>On</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>)</span>    <span style=color:#66d9ef>=&gt;</span> <span style=color:#a6e22e>On</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>_</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>On</span><span style=color:#f92672>)</span>    <span style=color:#66d9ef>=&gt;</span> <span style=color:#a6e22e>On</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>(</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Off</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span> <span style=color:#a6e22e>Off</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=ticker>Ticker</h4><p>Fs2 provides a function named <a href=https://github.com/typelevel/fs2/blob/v2.5.0/core/shared/src/main/scala/fs2/Stream.scala#L3187>every</a>, which constantly emits a tick expressed as a <code>boolean</code>. Whenever the specified duration is reached, it evaluates to <code>true</code>. Otherwise, it evaluates to <code>false</code>. However, we can&rsquo;t make use of it because we also need to consider the number of events that have been processed so far. Whatever happens first, both the tick&rsquo;s timer and the events counter need to be reseted. Here&rsquo;s where our custom <code>Ticker</code> comes into play.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>Ticker</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> get<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Tick</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> merge<span style=color:#f92672>(</span>timerTick<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Tick</span><span style=color:#f92672>,</span> count<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Count</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[(</span><span style=color:#66d9ef>Tick</span>, <span style=color:#66d9ef>Count</span><span style=color:#f92672>)]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> ticks<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Stream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Tick</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>Ticker</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>type</span> <span style=color:#66d9ef>Count</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> create<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Concurrent:</span> <span style=color:#66d9ef>Timer</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>      maxNrOfEvents<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      timeWindow<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>FiniteDuration</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Ticker</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Ref</span><span style=color:#f92672>.</span>of<span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Tick</span><span style=color:#f92672>](</span><span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>).</span>map <span style=color:#f92672>{</span> ref <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Ticker</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> get<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Tick</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> ref<span style=color:#f92672>.</span>get
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> merge<span style=color:#f92672>(</span>timerTick<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Tick</span><span style=color:#f92672>,</span> count<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Count</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>F</span><span style=color:#f92672>[(</span><span style=color:#66d9ef>Tick</span>, <span style=color:#66d9ef>Count</span><span style=color:#f92672>)]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>          ref
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span>modify <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span> <span style=color:#66d9ef>if</span> count <span style=color:#f92672>===</span> maxNrOfEvents <span style=color:#66d9ef>=&gt;</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>On</span>  <span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>_</span> <span style=color:#66d9ef>if</span> timerTick <span style=color:#f92672>===</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>On</span>          <span style=color:#66d9ef>=&gt;</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span> <span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>_</span>                                   <span style=color:#66d9ef>=&gt;</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>(</span>count <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span>flatMap <span style=color:#f92672>{</span> newCount <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>              get<span style=color:#f92672>.</span>map <span style=color:#f92672>{</span> counterTick <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>val</span> newTick <span style=color:#66d9ef>=</span> counterTick <span style=color:#f92672>|+|</span> timerTick
</span></span><span style=display:flex><span>                newTick <span style=color:#f92672>-&gt;</span> newCount
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> ticks<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Stream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Tick</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>val</span> duration <span style=color:#66d9ef>=</span> timeWindow<span style=color:#f92672>.</span>toNanos
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>val</span> interval <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>FiniteDuration</span><span style=color:#f92672>((</span>timeWindow<span style=color:#f92672>.</span>toSeconds <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.05</span><span style=color:#f92672>).</span>toLong<span style=color:#f92672>,</span> <span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>).</span>toNanos
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>def</span> go<span style=color:#f92672>(</span>lastSpikeNanos<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Stream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>F</span>, <span style=color:#66d9ef>Tick</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Stream</span><span style=color:#f92672>.</span>eval<span style=color:#f92672>((</span>F<span style=color:#f92672>.</span>monotonic<span style=color:#f92672>(</span><span style=color:#a6e22e>NANOSECONDS</span><span style=color:#f92672>),</span> get<span style=color:#f92672>).</span>tupled<span style=color:#f92672>).</span>flatMap <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>case</span> <span style=color:#f92672>(</span>now<span style=color:#f92672>,</span> tick<span style=color:#f92672>)</span> <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>now <span style=color:#f92672>-</span> lastSpikeNanos<span style=color:#f92672>)</span> <span style=color:#f92672>&gt;</span> duration <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>tick <span style=color:#f92672>===</span> <span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>On</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>now <span style=color:#f92672>-</span> lastSpikeNanos<span style=color:#f92672>)</span> <span style=color:#f92672>&gt;</span> interval<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                  <span style=color:#a6e22e>Stream</span><span style=color:#f92672>.</span>emit<span style=color:#f92672>(</span><span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>On</span><span style=color:#f92672>)</span> <span style=color:#f92672>++</span> go<span style=color:#f92672>(</span>now<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>Stream</span><span style=color:#f92672>.</span>emit<span style=color:#f92672>(</span><span style=color:#a6e22e>Tick</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Off</span><span style=color:#f92672>)</span> <span style=color:#f92672>++</span> go<span style=color:#f92672>(</span>lastSpikeNanos<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          go<span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>).</span>tail
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>In the <a href=https://github.com/gvolpe/fsm-streams>Github repository</a>, you will also find scaladocs on each method and unit tests for this implementation. Though, in the meantime, let&rsquo;s analyze each function.</p><p>Our first function, <code>get</code>, is the simplest one. It retrieves the current state of the counter tick.</p><p>Next, we have <code>merge</code>, which takes a timer tick and a count and returns a tuple <code>(Tick, Count)</code>, possibly running some effects. In a nutshell, this function is the responsible for resetting both the counter and time ticks, as well as keeping track of the count. Ultimately, the tick response we get is the result of the combination of the counter tick and the timer tick by relying on the <code>Semigroup[Tick]</code> instance we&rsquo;ve seen before.</p><p>Finally, our <code>ticks</code> function is the analog to the <code>Stream.every</code> function that also considers the current state of the counter ticks. It also emits a <code>Tick</code> instead of a <code>boolean</code>.</p><h3 id=credits>Credits</h3><p>Initially, my first solution was based on <code>evalMapAccumulate</code> + <code>debounce</code> + <code>Ref</code> but after asking for feedback, <a href=https://github.com/wemrysi>Emrys Ingersoll</a> came up with a solution based on <code>noneTerminate</code> + <code>mapAccumulate</code> + <code>collect</code>, which is the one I used for the final solution so credits where due, thanks again Emrys!</p><h3 id=summary>Summary</h3><p>This was a really fun problem to solve! I hope you have enjoyed reading about it. As a bonus track, here are some graphics showing how this performs under heavy load of events coming in from an Apache Pulsar topic.</p><p><img src=../../images/metrics1.png alt=m1></p><p><img src=../../images/metrics2.png alt=m1></p><p>I can&rsquo;t disclose more information than you can see in these JVM metrics but the GC pauses are interesting to observe, which makes sense given that we allocate quite a lot of objects in memory during the aggregation time window.</p><p>Cheers,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","11")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/talks/pulsar-2020/>Connecting millions of users @ Apache Pulsar Summit 2020 - Online ğŸŒ</a></h4><div class=related-meta>2020.11.01 â€¢
ğŸ™ï¸ Public Talk</div></div><div class=related-post><h4><a href=https://gvolpe.com/talks/nixcon-2020/>Nix at Chatroulette @ Nixcon 2020 - Online ğŸŒ</a></h4><div class=related-meta>2020.10.01 â€¢
ğŸ™ï¸ Public Talk</div></div><div class=related-post><h4><a href=https://gvolpe.com/talks/sfscala-2020/>What is Nix @ San Francisco Scala Meetup 2020 - Online ğŸŒ</a></h4><div class=related-meta>2020.10.01 â€¢
ğŸ™ï¸ Public Talk</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/xmonad-polybar-nixos/ class=nav-title>XMonad + Polybar on NixOS</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/nixos-binary-cache-ci/ class=nav-title>NixOS: build your system on Github actions!</a></div></nav></article><aside class=sidebar><nav class=toc><h4>Contents</h4><div id=toc-content></div></nav></aside></div></div></div></main><script src=https://gvolpe.com/js/email.js></script><script src=https://gvolpe.com/js/main.js></script></body></html>