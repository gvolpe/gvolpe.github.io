<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>NixOS: build your system on Github actions! - Gabriel Volpe</title><meta name=description content="What if I told you that you can save plenty of time and CPU-power by pre-building your entire NixOS configuration on Github actions? Fresh installations could â€¦"><meta property="og:title" content="NixOS: build your system on Github actions!"><meta property="og:description" content="What if I told you that you can save plenty of time and CPU-power by pre-building your entire NixOS configuration on Github actions? Fresh installations could â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/nixos-binary-cache-ci/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="NixOS: build your system on Github actions!"><meta name=twitter:description content="What if I told you that you can save plenty of time and CPU-power by pre-building your entire NixOS configuration on Github actions? Fresh installations could â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css></head><body><main><div id=post-overlay-id class="post-overlay active"><div class=reading-progress></div><div class=post-overlay-backdrop></div><div id=post-overlay-content-id class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2021.08.23</span><div class=reading-time-post><span class=coffee-cups>ğŸ“šğŸ“šğŸ“šğŸ“š
</span><span>4 min read</span></div></div><h1 class=post-title>NixOS: build your system on Github actions!</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/nix class=post-tag>nix</a>
<a href=https://gvolpe.com/tags/nixos class=post-tag>nixos</a>
<a href=https://gvolpe.com/tags/home-manager class=post-tag>home-manager</a>
<a href=https://gvolpe.com/tags/github-actions class=post-tag>github-actions</a></div></header><div class=post-body><p>What if I told you that you can save plenty of time and CPU-power by pre-building your <em>entire</em> <a href=https://nixos.org/>NixOS</a> configuration on Github actions? Fresh installations could be super fast and pre-validated on a CI build!</p><p>Well, it&rsquo;s possible, and it&rsquo;s what I&rsquo;m <a href=https://github.com/gvolpe/nix-config>currently doing</a> with my NixOS and <a href=https://github.com/nix-community/home-manager>Home Manager</a> configurations.</p><p><img src=../../images/ci-badges.png alt=badges></p><p>Besides hosting your configuration on Github, you&rsquo;ll need a binary cache where the results of your build can be pushed to be re-used later on. One of the best free alternatives is <a href=https://www.cachix.org/>Cachix</a>, offering up to 10GB on their basic tier.</p><h3 id=home-manager>Home Manager</h3><p>My Home Manager configuration builds in about 5 minutes.</p><p><img src=../../images/ci-home.png alt=home></p><p>Here&rsquo;s the CI job definition for my home configuration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-18.04</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2.3.2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;Get pinned nixpkgs â„ï¸&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>id</span>: <span style=color:#ae81ff>pinned_nixpkgs</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>echo &#34;::set-output name=url::$(cat ./pinned/nixpkgs)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;Install Nix â„ï¸&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>cachix/install-nix-action@v13</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>nix_path</span>: <span style=color:#e6db74>&#34;nixpkgs=$\{\{ steps.pinned_nixpkgs.outputs.url \}}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;Install Cachix â„ï¸&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>cachix/cachix-action@v10</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gvolpe-nixos</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>authToken</span>: <span style=color:#e6db74>&#34;$\{\{ secrets.CACHIX_AUTH_TOKEN \}}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Needed because cachix is also installed by Home Manager</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;Set priority flag for Cachix ğŸš©&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>nix-env --set-flag priority 0 cachix</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;Build Home Manager config ğŸ &#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>./build.sh ci-home</span>
</span></span></code></pre></div><p>The first relevant part is the reading of the pinned nixpkgs file, which looks as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat pinned/nixpkgs
</span></span><span style=display:flex><span>â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span></span><span style=display:flex><span>       â”‚ File: pinned/nixpkgs
</span></span><span style=display:flex><span>â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1</span>   â”‚ https://github.com/NixOS/nixpkgs/archive/8ecc61c91a5.tar.gz
</span></span></code></pre></div><p>This is then read to install Nix with this specific version.</p><p>The second relevant part is the priority flag for Cachix. This is needed in my case, because my Home Manager configuration includes Cachix as one of the programs to install, but we already have it as part of the <code>cachix-action</code>, so we give it the priority before proceeding with the build.</p><p>Next, the shell script does the following (in addition to the creation of some directories specific to my needs):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix-shell -p nix-build-uncached --run nix-build-uncached
</span></span></code></pre></div><p>The <a href=https://github.com/Mic92/nix-build-uncached>nix-build-uncached</a> command saves time by not re-building what&rsquo;s already present in the binary cache, which cuts about 1 minute of building time, in this case.</p><p>It mostly accepts the same arguments as <code>nix-build</code>, so you can use it wherever you use the former. If you&rsquo;re familiar with it, you know it needs a <code>default.nix</code> at the root directory, if no file name is indicated. This is where it gets interesting, because we usually build our home configuration by running <code>home-manager switch</code>, so there&rsquo;s no such file!</p><p>Fortunately for us, it is possible to get a derivation out of Home Manager. First of all, we define a <code>default.nix</code> with two attributes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs <span style=color:#f92672>?</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&lt;nixpkgs&gt;</span> {
</span></span><span style=display:flex><span>    config <span style=color:#f92672>=</span> { allowUnfree <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>; };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  home <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>callPackage <span style=color:#e6db74>./home</span> {};
</span></span><span style=display:flex><span>  system <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>callPackage <span style=color:#e6db74>./system</span> {};
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This will allow us to build all the attributes, or just the one we are interested in. E.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix-build-uncached -A home
</span></span></code></pre></div><p>At last, here&rsquo;s the derivation for Home Manager, placed under <code>home/default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  hm_url <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>fileContents <span style=color:#e6db74>../pinned/home-manager</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  home-manager <span style=color:#f92672>=</span> builtins<span style=color:#f92672>.</span>fetchTarball {
</span></span><span style=display:flex><span>    name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;home-manager-2021-08-21&#34;</span>;
</span></span><span style=display:flex><span>    url    <span style=color:#f92672>=</span> hm_url;
</span></span><span style=display:flex><span>    sha256 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0s8nlgrf16bz2bhnk0xrzvivagq55cifxf2p545c7n4zj9ryfkkp&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  evalHome <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>toString home-manager<span style=color:#e6db74>}</span><span style=color:#e6db74>/modules&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  home-config <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>recurseIntoAttrs (
</span></span><span style=display:flex><span>    evalHome {
</span></span><span style=display:flex><span>      configuration <span style=color:#f92672>=</span> <span style=color:#e6db74>./home.nix</span>;
</span></span><span style=display:flex><span>      lib <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>lib;
</span></span><span style=display:flex><span>      pkgs <span style=color:#f92672>=</span> pkgs;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Allow nix to recurse into this attribute set to look for derivations</span>
</span></span><span style=display:flex><span>  recurseForDerivations <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>pinned/home-manager</code> file is similar to the <code>pinned/nixpkgs</code> file, except it points to a specific Home Manager tarball.</p><p>All credits go to <a href=https://github.com/zimbatm>Jonas Chevalier</a> for showing me the way!</p><h3 id=nixos>NixOS</h3><p>The system part is equally interesting but easier to build. It takes about 3 minutes.</p><p><img src=../../images/ci-nixos.png alt=nixos></p><p>The steps are pretty similar, except there is no need to set the priority flag for Cachix.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;Build NixOS config â„ï¸&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>run</span>: <span style=color:#ae81ff>./build.sh ci-system</span>
</span></span></code></pre></div><p>Next we have the derivation for the system part, defined under <code>system/default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  system <span style=color:#f92672>=</span> pkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>recurseIntoAttrs (
</span></span><span style=display:flex><span>    pkgs<span style=color:#f92672>.</span>nixos [ <span style=color:#e6db74>./configuration.nix</span> ]
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  recurseForDerivations <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=conclusion>Conclusion</h3><p>That&rsquo;s all it takes to build your entire operating system and user configuration on Github actions! I find it useful to always keep my configuration up-to-date as well as speeding up big upgrades and fresh installations (which are actually more rare in my case).</p><p>My Nix configuration files can be found at <a href=https://github.com/gvolpe/nix-config>https://github.com/gvolpe/nix-config</a>.</p><p>What&rsquo;s stopping you from doing the same? :)</p><p>Cheers,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","14")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/gnome3-on-nixos/>Gnome 3 on NixOS</a></h4><div class=related-meta>2020.07.01 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“š 4 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/xmonad-polybar-nixos/>XMonad + Polybar on NixOS</a></h4><div class=related-meta>2020.11.25 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 14 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/github-actions-nix-cachix-dhall/>Github actions powered by Nix Shell & Cachix</a></h4><div class=related-meta>2020.06.02 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 7 min read</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/fsm-fs2-a-match-made-in-heaven/ class=nav-title>Finite-State Machines + FS2 streams: A match made in heaven</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/nix-flakes/ class=nav-title>Flakes: NixOS and Home Manager migration</a></div></nav></article><aside class=sidebar><nav class=toc><h4>Contents</h4><div id=toc-content></div></nav></aside></div></div></div></main><script type=text/javascript defer data-domain=gvolpe.com src=https://gvolpe.com/js/plausible.js></script><script src=https://gvolpe.com/js/main.js></script></body></html>