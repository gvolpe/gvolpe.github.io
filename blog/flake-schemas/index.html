<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>Flake Schemas - Gabriel Volpe</title><meta name=description content="Flake schemas were introduced by Determinate Systems (written by Eelco Dolstra &mdash; creator of Nix) about half a year ago now (August 2023), which is quite a â€¦"><meta property="og:title" content="Flake Schemas"><meta property="og:description" content="Flake schemas were introduced by Determinate Systems (written by Eelco Dolstra &mdash; creator of Nix) about half a year ago now (August 2023), which is quite a â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/flake-schemas/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Flake Schemas"><meta name=twitter:description content="Flake schemas were introduced by Determinate Systems (written by Eelco Dolstra &mdash; creator of Nix) about half a year ago now (August 2023), which is quite a â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=https://gvolpe.com/css/style.css><script type=text/javascript defer data-domain=gvolpe.com data-api=analytics.gvolpe.com src=https://gvolpe.com/js/plausible.js></script></head><body><main><div id=post-overlay-id class="post-overlay active"><div class=reading-progress></div><div class=post-overlay-backdrop></div><div id=post-overlay-content-id class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2024.04.09</span><div class=reading-time-post><span class=coffee-cups>ğŸ“šğŸ“šğŸ“šğŸ“š
</span><span>4 min read</span></div></div><h1 class=post-title>Flake Schemas</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/nix class=post-tag>nix</a>
<a href=https://gvolpe.com/tags/nixos class=post-tag>nixos</a>
<a href=https://gvolpe.com/tags/flakes class=post-tag>flakes</a></div></header><div class=post-body><p>Flake schemas were <a href=https://determinate.systems/posts/flake-schemas/>introduced by Determinate Systems</a> (written by <a href=https://github.com/edolstra>Eelco Dolstra</a> &mdash; creator of Nix) about half a year ago now (August 2023), which is quite a promising feature, but what is the current status? Is it usable yet?</p><p>The <a href=https://github.com/NixOS/nix/pull/8892>PR</a> that introduces flake schemas was submitted to <code>NixOS/nix</code> the same day the announcement was made, and it sadly remains in DRAFT mode until today. However, if you look at the comments, some expert users reported using this feature successfully, so I thought it was about time to give it a shot myself.</p><p>So here&rsquo;s where the fun starts: in order to use it, we need <em>that</em> specific <code>nix</code> client version (from the PR) with flake schemas support, which fortunately for us, is conveniently provided on <a href=https://github.com/DeterminateSystems/nix-src/tree/flake-schemas>this flake</a>.</p><h2 id=sneak-preview>Sneak preview</h2><p>Before we look into the shenanigans we need to get through to get this working, let&rsquo;s appreciate for a second what it brings to the table.</p><p>Shown below is a side-by-side comparison of <code>nix flake show</code>&rsquo;s output on my <a href=https://github.com/gvolpe/nix-config>NixOS configuration</a> flake:</p><p><img src=../../images/flake-show-schemas.png alt=schemas></p><p>Neat! Don&rsquo;t you think? I was irked by the usual <code>homeConfigurations: unknown</code> output.</p><h2 id=making-it-work>Making it work</h2><p>One would need to add <a href=https://github.com/DeterminateSystems/flake-schemas>DeterminateSystems/flake-schemas</a> as an input to <code>flake.nix</code>, but you&rsquo;ll find there are a few useful open PRs since last year that solve real problems, but pretty much like the entire feature, they also seem inactive. So to try this out, I&rsquo;ve made <a href=https://github.com/gvolpe/flake-schemas>a fork</a> and applied some of those patches myself.</p><p>With that out of the way, we can now define the schema inputs in our flake:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nixpkgs/nixos-unstable&#34;</span>;
</span></span><span style=display:flex><span>    flake-schemas<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:gvolpe/flake-schemas&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>## nix client with schema support: see https://github.com/NixOS/nix/pull/8892</span>
</span></span><span style=display:flex><span>    nix-schema <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      inputs<span style=color:#f92672>.</span>flake-schemas<span style=color:#f92672>.</span>follows <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;flake-schemas&#34;</span>;
</span></span><span style=display:flex><span>      url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:DeterminateSystems/nix-src/flake-schemas&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And as outputs, we define the standard schemas plus a custom one we&rsquo;ll see soon:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  schemas <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>.</span>flake-schemas<span style=color:#f92672>.</span>schemas <span style=color:#f92672>//</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> <span style=color:#e6db74>./lib/schemas.nix</span> { <span style=color:#66d9ef>inherit</span> (inputs) flake-schemas; };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As pointed out by Greg in <a href=https://github.com/DeterminateSystems/flake-schemas/issues/14>one of the open issues</a>, the <code>nix</code> client from the fork doesn&rsquo;t build straight away, so we need some tweaks that the following overlay takes care of:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>f: p: {
</span></span><span style=display:flex><span>  nix-schema <span style=color:#f92672>=</span> inputs<span style=color:#f92672>.</span>nix-schema<span style=color:#f92672>.</span>packages<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span><span style=color:#f92672>.</span>nix<span style=color:#f92672>.</span>overrideAttrs (old: {
</span></span><span style=display:flex><span>    doCheck <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    doInstallCheck <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    postInstall <span style=color:#f92672>=</span> old<span style=color:#f92672>.</span>postInstall <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      rm $out/bin/nix-*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      mv $out/bin/nix $out/bin/nix-schema
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Then we can add it to our system packages, conveniently named <code>nix-schema</code> to avoid conflicts:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  environment<span style=color:#f92672>.</span>systemPackages <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    pkgs<span style=color:#f92672>.</span>nix-schema
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>NOTE</strong>: the <code>rm $out/bin/nix-*</code> bit ensures that all the usual commands such as <code>nix-build</code>, <code>nix-shell</code>, etc don&rsquo;t get overridden, which is <a href=https://discourse.nixos.org/t/the-program-nix-build-is-not-in-your-path/42943>one of the issues I got myself into</a>.</p><p>Next we have the <code>lib/schemas.nix</code> file referenced above, which defines the schema for the <code>out</code> custom output in my <code>nix-config</code> repo, which is a rather simple example of a flake schema:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ flake-schemas }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  out <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    version <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    doc <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Exports custom attrsets...&#34;</span>;
</span></span><span style=display:flex><span>    inventory <span style=color:#f92672>=</span> output:
</span></span><span style=display:flex><span>      flake-schemas<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>mkChildren (builtins<span style=color:#f92672>.</span>mapAttrs
</span></span><span style=display:flex><span>        (_: _: {
</span></span><span style=display:flex><span>          what <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;custom instance to be used by consumers of this flake&#34;</span>;
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        output);
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Explaining how flake schemas are actually defined is out of the scope of this post, but the meaning of &ldquo;inventory&rdquo;, &ldquo;children&rdquo; and other fields is briefly documented in the linked nix PR.</p><p>Moreover, the <code>nix</code> client is handily exposed as a flake app:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  apps<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;nix&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;app&#34;</span>;
</span></span><span style=display:flex><span>    program <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>nix-schema<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/nix-schema&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So we can run it directly from this flake without installing the special <code>nix</code> version.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix run github:gvolpe/nix-config#nix -- --version
</span></span><span style=display:flex><span>nix-schema <span style=color:#f92672>(</span>Nix<span style=color:#f92672>)</span> 2.21.0pre20240311_d76e5fb
</span></span></code></pre></div><h3 id=give-it-a-try-linux-only>Give it a try (Linux only)</h3><p>You can run the following command in any of your flake repositories to see the new &ldquo;show&rdquo; output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix run github:gvolpe/nix-config#nix -- flake show
</span></span></code></pre></div><p>Notice that the <code>nix</code> client exposed on my flake is only compiled for Linux; though, you can follow the same steps and build it for other systems in the same fashion.</p><p>One thing I noticed is that if your flake doesn&rsquo;t explicitly define <code>flake-schemas</code> as an input, then <code>homeManagerConfigurations</code> is not properly detected, but it could be something wrong with <a href=https://github.com/gvolpe/flake-schemas/blob/7d762079449d0ca63e92b0128c885021168c0c79/flake.nix#L242>my implementation</a> too, no idea (if you know what&rsquo;s wrong, please let me know!).</p><p>Another caveat of using the new command is that it&rsquo;s quite slow, as it seems to evaluate all outputs. For instance, it took about <strong>~33.7 seconds</strong> to evaluate my <code>nix-config</code> flake the first time, as shown in <a href=https://github.com/gvolpe/nix-config/pull/254#issuecomment-2042471639>this PR comment</a>.</p><p>Furthermore, there are a few schemas like <code>homeModules</code> and <code>nixosModules</code> that are unsupported at the moment, but that&rsquo;s just a matter of adding the right schemas in place.</p><h2 id=final-thoughts>Final thoughts</h2><p>I love this proposal and I wish it moves forward soon, so that every Nix user out there gets to enjoy it! However, considering how long it has been since its announcement, I&rsquo;m not sure what to think.</p><p>Frankly, I find the inactivity in the main <code>flake-schemas</code> repository as well as in the initial <code>nix</code> pull request a bit worrying, but I&rsquo;m hoping it all turns out in a positive way.</p><p>Have you tried flake schemas yet? What was your experience like?</p><p>Best,
Gabriel.</p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","30")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/private-flake/>Private Nix flake ğŸ”’</a></h4><div class=related-meta>2024.02.27 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 6 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/nix-remote-builds/>Nix remote builds</a></h4><div class=related-meta>2023.02.13 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“š 4 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/garnix/>Garnix CI</a></h4><div class=related-meta>2023.02.07 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 6 min read</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/private-flake/ class=nav-title>Private Nix flake ğŸ”’</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/nixos-server/ class=nav-title>NixOS server up in minutes!</a></div></nav></article><aside class=sidebar><nav class=toc><h4>Contents</h4><div id=toc-content></div></nav></aside></div></div></div></main><script src=https://gvolpe.com/js/main.js></script></body></html>