<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!--<meta name="viewport" content="width=device-width, initial-scale=1">--> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /> <title> Flake Schemas &bull; gvolpe's blog </title> <meta name="description" content="Introduction"> <link rel="icon" href="/images/favicon.png"> <link rel="canonical" href="https://gvolpe.github.io/blog/flake-schemas/"> <link rel="alternate" type="application/rss+xml" title="gvolpe's blog" href="https://gvolpe.github.io/blog/feed.xml" /> <link rel="stylesheet" href="/css/main.css"> <link rel="stylesheet" href="/assets/css/main.css"/> <!--Also needs to be set in ./_layouts/unified.html--> <script defer data-domain="gvolpe.com" src="https://analytics.gvolpe.com/js/script.js"></script> <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript> </head> <body class=""> <header id="header"> <h1> <a href="/blog">Gabriel Volpe's blog</a> </h1> <div class="overlay"> <div class="container"> <div class="darkmode-div"> <input type="checkbox" id="darkmode" onchange="darkModeEvent(this);"/> <label for="darkmode"> <div id="star"> <div class="star" id="star-1">★</div> <div class="star" id="star-2">★</div> </div> <div id="moon"></div> </label> </div> <nav> <ul> <li><a href="/">Home</a></li> <li><a href="/blog/categories/">Categories</a></li> </ul> </nav> </div> </div> <div id="progress-bar"></div> </header> <script type="text/javascript"> window.onload = function() { document.getElementById("darkmode").checked=false; }; window.onscroll = function() { var docElem = document.documentElement; var docBody = document.body; var scrollTop = docElem['scrollTop'] || docBody['scrollTop']; var scrollTop = docElem['scrollTop'] || docBody['scrollTop']; var scrollBottom = (docElem['scrollHeight'] || docBody['scrollHeight']) - window.innerHeight; var scrollPercent = scrollTop / scrollBottom * 100 + '%'; document.getElementById("progress-bar").style.setProperty("--scrollAmount", scrollPercent); }; function darkModeEvent(box) { var light = document.getElementById("projects"); var dark = document.getElementById("accessible"); if (box.checked && light != null) { light.id="accessible"; } if (!box.checked && dark != null) { dark.id="projects"; } return false; }; </script> <section id="projects" class="main style-post dark fullscreen"> <div class="content"> <div class="post-content"> <header class="post-header"> <h1 class="post-title">Flake Schemas</h1> <span class="post-meta"> <time class="post-date" datetime="2024-04-09">Apr 9, 2024</time> <span class="post-author">by <a href="/">Gabriel Volpe</a></span> </span> <div class="post-categories"> <span class="post-meta"> <a href="/blog/categories/#nix" class="cat-link">nix</a> &nbsp; <a href="/blog/categories/#nixos" class="cat-link">nixos</a> &nbsp; <a href="/blog/categories/#flakes" class="cat-link">flakes</a> &nbsp; <a href="/blog/categories/#experimental" class="cat-link">experimental</a> </span> </div> </header> <h2 id="introduction">Introduction</h2> <p>Flake schemas were <a href="https://determinate.systems/posts/flake-schemas/">introduced by Determinate Systems</a> (written by <a href="https://github.com/edolstra">Eelco Dolstra</a> — creator of Nix) about half a year ago now (August 2023), which is quite a promising feature, but what is the current status? Is it usable yet?</p> <p>The <a href="https://github.com/NixOS/nix/pull/8892">PR</a> that introduces flake schemas was submitted to <code>NixOS/nix</code> the same day the announcement was made, and it sadly remains in DRAFT mode until today. However, if you look at the comments, some expert users reported using this feature successfully, so I thought it was about time to give it a shot myself.</p> <p>So here’s where the fun starts: in order to use it, we need <em>that</em> specific <code>nix</code> client version (from the PR) with flake schemas support, which fortunately for us, is conveniently provided on <a href="https://github.com/DeterminateSystems/nix-src/tree/flake-schemas">this flake</a>.</p> <h2 id="sneak-preview">Sneak preview</h2> <p>Before we look into the shenanigans we need to get through to get this working, let’s appreciate for a second what it brings to the table.</p> <p>Shown below is a side-by-side comparison of <code>nix flake show</code>’s output on my <a href="https://github.com/gvolpe/nix-config">NixOS configuration</a> flake:</p> <p><img src="../../images/flake-show-schemas.png" alt="schemas" /></p> <p>Neat! Don’t you think? I was irked by the usual <code>homeConfigurations: unknown</code> output.</p> <h2 id="making-it-work">Making it work</h2> <p>One would need to add <a href="https://github.com/DeterminateSystems/flake-schemas">DeterminateSystems/flake-schemas</a> as an input to <code>flake.nix</code>, but you’ll find there are a few useful open PRs since last year that solve real problems, but pretty much like the entire feature, they also seem inactive. So to try this out, I’ve made <a href="https://github.com/gvolpe/flake-schemas">a fork</a> and applied some of those patches myself.</p> <p>With that out of the way, we can now define the schema inputs in our flake:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  <span class="ss">inputs =</span> <span class="p">{</span>
    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;nixpkgs/nixos-unstable&quot;</span><span class="p">;</span>
    flake-schemas<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:gvolpe/flake-schemas&quot;</span><span class="p">;</span>

    <span class="c1">## nix client with schema support: see https://github.com/NixOS/nix/pull/8892</span>
    <span class="ss">nix-schema =</span> <span class="p">{</span>
      inputs<span class="o">.</span>flake-schemas<span class="o">.</span><span class="ss">follows =</span> <span class="s2">&quot;flake-schemas&quot;</span><span class="p">;</span>
      <span class="ss">url =</span> <span class="s2">&quot;github:DeterminateSystems/nix-src/flake-schemas&quot;</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>And as outputs, we define the standard schemas plus a custom one we’ll see soon:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  <span class="ss">schemas =</span>
    inputs<span class="o">.</span>flake-schemas<span class="o">.</span>schemas <span class="o">//</span>
    <span class="nb">import</span> <span class="o">.</span><span class="l">/lib/schemas.nix</span> <span class="p">{</span> <span class="k">inherit</span> <span class="p">(</span>inputs<span class="p">)</span> flake-schemas<span class="p">;</span> <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>As pointed out by Greg in <a href="https://github.com/DeterminateSystems/flake-schemas/issues/14">one of the open issues</a>, the <code>nix</code> client from the fork doesn’t build straight away, so we need some tweaks that the following overlay takes care of:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">f: p: <span class="o">{</span>
  nix-schema <span class="o">=</span> inputs.nix-schema.packages.<span class="k">${</span><span class="nv">system</span><span class="k">}</span>.nix.overrideAttrs <span class="o">(</span>old: <span class="o">{</span>
    <span class="nv">doCheck</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="nv">doInstallCheck</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="nv">postInstall</span> <span class="o">=</span> old.postInstall + <span class="s1">&#39;&#39;</span>
      rm <span class="nv">$out</span>/bin/nix-*
      mv <span class="nv">$out</span>/bin/nix <span class="nv">$out</span>/bin/nix-schema
    <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="o">})</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span></code></pre></div> <p>Then we can add it to our system packages, conveniently named <code>nix-schema</code> to avoid conflicts:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  environment<span class="o">.</span><span class="ss">systemPackages =</span> <span class="p">[</span>
    pkgs<span class="o">.</span>nix-schema
  <span class="p">];</span>
<span class="p">}</span></code></pre></div> <p>NOTE: the <code>rm $out/bin/nix-*</code> bit ensures that all the usual commands such as <code>nix-build</code>, <code>nix-shell</code>, etc don’t get overridden, which is <a href="https://discourse.nixos.org/t/the-program-nix-build-is-not-in-your-path/42943">one of the issues I got myself into</a>.</p> <p>Next we have the <code>lib/schemas.nix</code> file referenced above, which defines the schema for the <code>out</code> custom output in my <code>nix-config</code> repo, which is a rather simple example of a flake schema:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> flake-schemas <span class="p">}:</span>

<span class="p">{</span>
  <span class="ss">out =</span> <span class="p">{</span>
    <span class="ss">version =</span> <span class="mi">1</span><span class="p">;</span>
    <span class="ss">doc =</span> <span class="s2">&quot;Exports custom attrsets...&quot;</span><span class="p">;</span>
    <span class="ss">inventory =</span> output<span class="p">:</span>
      flake-schemas<span class="o">.</span>lib<span class="o">.</span>mkChildren <span class="p">(</span><span class="nb">builtins</span><span class="o">.</span>mapAttrs
        <span class="p">(</span>_<span class="p">:</span> _<span class="p">:</span> <span class="p">{</span>
          <span class="ss">what =</span> <span class="s2">&quot;custom instance to be used by consumers of this flake&quot;</span><span class="p">;</span>
        <span class="p">})</span>
        output<span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>Explaining how flake schemas are actually defined is out of the scope of this post, but the meaning of “inventory”, “children” and other fields is briefly documented in the linked nix PR.</p> <p>Moreover, the <code>nix</code> client is handily exposed as a flake app:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  apps<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span><span class="s2">&quot;nix&quot;</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">type =</span> <span class="s2">&quot;app&quot;</span><span class="p">;</span>
    <span class="ss">program =</span> <span class="s2">&quot;</span><span class="si">${</span>pkgs<span class="o">.</span>nix-schema<span class="si">}</span><span class="s2">/bin/nix-schema&quot;</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>So we can run it directly from this flake without installing the special <code>nix</code> version.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix run github:gvolpe/nix-config#nix -- --version
nix-schema <span class="o">(</span>Nix<span class="o">)</span> 2.21.0pre20240311_d76e5fb</code></pre></div> <h3 id="give-it-a-try-linux-only">Give it a try (Linux only)</h3> <p>You can run the following command in any of your flake repositories to see the new “show” output:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix run github:gvolpe/nix-config#nix -- flake show</code></pre></div> <p>Notice that the <code>nix</code> client exposed on my flake is only compiled for Linux; though, you can follow the same steps and build it for other systems in the same fashion.</p> <p>One thing I noticed is that if your flake doesn’t explicitly define <code>flake-schemas</code> as an input, then <code>homeManagerConfigurations</code> is not properly detected, but it could be something wrong with <a href="https://github.com/gvolpe/flake-schemas/blob/7d762079449d0ca63e92b0128c885021168c0c79/flake.nix#L242">my implementation</a> too, no idea (if you know what’s wrong, please let me know!).</p> <p>Another caveat of using the new command is that it’s quite slow, as it seems to evaluate all outputs. For instance, it took about <strong>~33.7 seconds</strong> to evaluate my <code>nix-config</code> flake the first time, as shown in <a href="https://github.com/gvolpe/nix-config/pull/254#issuecomment-2042471639">this PR comment</a>.</p> <p>Furthermore, there are a few schemas like <code>homeModules</code> and <code>nixosModules</code> that are unsupported at the moment, but that’s just a matter of adding the right schemas in place.</p> <h2 id="final-thoughts">Final thoughts</h2> <p>I love this proposal and I wish it moves forward soon, so that every Nix user out there gets to enjoy it! However, considering how long it has been since its announcement, I’m not sure what to think.</p> <p>Frankly, I find the inactivity in the main <code>flake-schemas</code> repository as well as in the initial <code>nix</code> pull request a bit worrying, but I’m hoping it all turns out in a positive way.</p> <p>Have you tried flake schemas yet? What was your experience like?</p> <p>Best, Gabriel.</p> <div id="gh-comments"> <br/><br/> <div id="gh-comments-list"></div> </div> <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"> </script> <script src="/js/github-comments.js"> </script> <script type="text/javascript"> DoGithubComments ( "gvolpe/blog-comments" , "30" ); </script> <noscript>Please enable JavaScript to view comments.</noscript> </div> </div> </section> <footer id="footer"> <!-- Icons --> <!-- Look here for more brands icons: https://fortawesome.com/sets/font-awesome-5-brands --> <ul class="icons"> <li><a href="base64:aGVsbG9AZ3ZvbHBlLmNvbQo=" target="_blank" class="icon solid fa-envelope"><span class="label">Email</span></a></li> <!--<li><a href="https://discordapp.com/channels/@me/510276992156041217" target="_blank" class="icon brands fa-discord"><span class="label">Discord</span></a></li>--> <li><a href="https://github.com/gvolpe" target="_blank" class="icon brands fa-github"><span class="label">Github</span></a></li> <li><a href="https://matrix.to/#/@gvolpe:matrix.org" target="_blank" class="icon brands fa-gitter"><span class="label">Matrix</span></a></li> <li><a rel="me" href="https://fosstodon.org/@gvolpe" target="_blank" class="icon brands fa-mastodon"><span class="label">Mastodon</span>></a></li> <li><a href="https://twitter.com/volpegabriel87" target="_blank" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li> <li><a href="https://bsky.app/profile/gvolpe.com" target="_blank" class="icon brands fa-dribbble"><span class="label">Bluesky</span></a></li> <li><a href="https://linkedin.com/in/gmvolpe" target="_blank" class="icon brands fa-linkedin-in"><span class="label">LinkedIn</span></a></li> <li><a href="https://leanpub.com/u/gvolpe" target="_blank" class="icon brands fa-leanpub"><span class="label">LeanPub</span></a></li> <li><a href="https://www.blurb.co.uk/user/gvolpe" target="_blank" class="icon brands fa-bimobject"><span class="label">Blurb</span></a></li> </ul> <small> Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a> </small> <!-- Menu --> <ul class="menu"> <li> &copy; Gabriel Volpe 2020-2024 </li> </ul> </footer> </body> </html></body></html>
