<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!--<meta name="viewport" content="width=device-width, initial-scale=1">--> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /> <title> Unison: Forex API & Caching &bull; gvolpe's blog </title> <meta name="description" content="I have been following the Unison programming language for as long as I can remember, given that its authors are very well-known in the Scala ecosystem. Thoug..."> <link rel="icon" href="/images/favicon.png"> <link rel="canonical" href="https://gvolpe.github.io/blog/unison-forex/"> <link rel="alternate" type="application/rss+xml" title="gvolpe's blog" href="https://gvolpe.github.io/blog/feed.xml" /> <link rel="stylesheet" href="/css/main.css"> <link rel="stylesheet" href="/assets/css/main.css"/> <!--Also needs to be set in ./_layouts/unified.html--> <script defer data-domain="gvolpe.com" src="https://analytics.gvolpe.com/js/script.js"></script> <div class="main dark style1" style="padding:0;"> <dialog> <p>Get in touch: <a id="dec-contact" class="email-contact"></a></p> <form method="dialog"> <button>Close</button> </form> </dialog> </div> <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript> </head> <body class=""> <header id="header"> <h1> <a href="/blog">Gabriel Volpe's blog</a> </h1> <div class="overlay"> <div class="container"> <div class="darkmode-div"> <input type="checkbox" id="darkmode" onchange="darkModeEvent(this);"/> <label for="darkmode"> <div id="star"> <div class="star" id="star-1">‚òÖ</div> <div class="star" id="star-2">‚òÖ</div> </div> <div id="moon"></div> </label> </div> <nav> <ul> <li><a href="/">Home</a></li> <li><a href="/blog/categories/">Categories</a></li> </ul> </nav> </div> </div> <div id="progress-bar"></div> </header> <script type="text/javascript"> window.onload = function() { let box = document.getElementById("darkmode"); if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { box.checked=true; } else { box.checked=false; } darkModeEvent(box); }; window.onscroll = function() { var docElem = document.documentElement; var docBody = document.body; var scrollTop = docElem['scrollTop'] || docBody['scrollTop']; var scrollTop = docElem['scrollTop'] || docBody['scrollTop']; var scrollBottom = (docElem['scrollHeight'] || docBody['scrollHeight']) - window.innerHeight; var scrollPercent = scrollTop / scrollBottom * 100 + '%'; document.getElementById("progress-bar").style.setProperty("--scrollAmount", scrollPercent); }; function darkModeEvent(box) { var light = document.getElementById("blogpost"); var dark = document.getElementById("accessible"); if (box.checked && light != null) { light.id="accessible"; } if (!box.checked && dark != null) { dark.id="blogpost"; } return false; }; </script> <section id="blogpost" class="main style-post dark fullscreen"> <div class="content"> <div class="post-content"> <header class="post-header"> <h1 class="post-title">Unison: Forex API & Caching</h1> <span class="post-meta"> <time class="post-date" datetime="2025-05-11">May 11, 2025</time> <span class="post-author">by <a href="/">Gabriel Volpe</a></span> </span> <div class="post-categories"> <span class="post-meta"> <a href="/blog/categories/#unison" class="cat-link">unison</a> &nbsp; <a href="/blog/categories/#cloud" class="cat-link">cloud</a> &nbsp; <a href="/blog/categories/#programming" class="cat-link">programming</a> &nbsp; <a href="/blog/categories/#cache" class="cat-link">cache</a> </span> </div> </header> <p>I have been following the <a href="https://www.unison-lang.org/">Unison programming language</a> for as long as I can remember, given that <a href="https://www.unison-lang.org/unison-computing/">its authors</a> are very well-known in the Scala ecosystem. Though, it took me a good few years to finally learn it by immersing myself into their amazing documentation and tutorials.</p> <p><strong>TL;DR: I love it more and more every single day!</strong></p> <p>The language itself is easy to learn for anyone coming from a functional programming background. Even their implementation of <a href="https://arxiv.org/pdf/1611.09259">algebraic effects</a> ‚Äî called <a href="https://www.unison-lang.org/docs/fundamentals/abilities/">abilities</a> ‚Äî are quite straightforward. What sets the language apart from others is their interactive approach to writing code.</p> <p>Unison stores all code on a local database (under <code>~/.unison</code> by default), which can be shared with others on their platform: <a href="https://share.unison-lang.org">Unison Share</a>. Thus, our code doesn‚Äôt live on files tracked on a git repository: instead, they need to be fetched from the database to be edited. This is incredibly different from what we, programmers, are used to. It took me a while to get comfortable with this process ‚Äî forgetting about my vim fuzzy-finder in between ‚Äî and I would even say it was more challenging than learning the language itself, but it clicked‚Ä¶ eventually.</p> <p>I will spare you the details, however, as I find it quite hard to convey with words how it feels to experience it. So I would leave that to you to explore and find out for yourself. Instead, I would like to share more about my experience using the features that excite me the most in the Unison multiverse.</p> <h2 id="learn-by-doing">Learn by doing</h2> <p>A while ago now (~6 years ago), I wrote an <a href="https://github.com/gvolpe/exchange-rates">exchange rates</a> application in Haskell for fun that exposes an API endpoint to query specific currencies. Internally, it relies on a third-party API that‚Äôs rate-limited, so the results are cached in Redis with a configurable expiration time.</p> <p>I thought this could be good candidate for a rewrite in the Unison language, leveraging their <a href="https://www.unison.cloud/">cloud infrastructure</a> and native <a href="https://www.unison.cloud/docs/storage-solutions/">storage solutions</a>, so I could get acquainted with the language and its radical approach to writing code. After all, learning by doing is always more fun and rewarding.</p> <p>It all started by creating a new project via UCM: Unison Codebase Manager.</p> <p><img src="../../images/unison/ucm.png" alt="ucm" /></p> <p>And with me being a nix-head, of course I ended up creating a <a href="https://github.com/gvolpe/unison-dev">development shell</a> that provides the <code>ucm</code> program when I enter the directory where I write Unison code. All made possible thanks to <a href="https://github.com/ceedubs/unison-nix/">unison-nix</a>.</p> <h2 id="the-project">The Project</h2> <p>The requirements for this Foreign Exchange Rates API are rather simple. All we need is a single GET endpoint that returns the exchange rate between two supported currencies.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl https://gvolpe.unison-services.cloud/s/forex/api/rates?from<span class="o">=</span>USD<span class="p">&amp;</span><span class="nv">to</span><span class="o">=</span>EUR  <span class="p">|</span> jq
<span class="o">{</span>
  <span class="s2">&quot;rate&quot;</span>: 0.8885
<span class="o">}</span></code></pre></div> <p>And a healthcheck endpoint for good measure.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl https://gvolpe.unison-services.cloud/s/forex/api/healthcheck  <span class="p">|</span> jq
<span class="o">{</span>
  <span class="s2">&quot;db&quot;</span>: <span class="s2">&quot;6fcf7ba3-4a3b-440e-a225-cc3d8d1917e8 (currencies)&quot;</span>
<span class="o">}</span></code></pre></div> <p>The response body is irrelevant here. We mostly care about the HTTP response status being 200 OK.</p> <p>Internally, we will use a <a href="https://www.exchangerate-api.com/docs/standard-requests">third-party API</a> that‚Äôs rate-limited to 1500 requests per month, and it requires an API key used as an authorization bearer token to authenticate HTTP requests.</p> <p><img src="../../images/unison/ext-api.png" alt="ext-api" /></p> <p>The challenge will be to cache as many results as possible for a period of 24 hours (see <a href="https://www.exchangerate-api.com/terms">Data Caching Policy</a>) to avoid stale data, but also to optimize the number of external HTTP requests we need to make, while keeping away from getting rate-limited.</p> <p>In the next few sections, we‚Äôll cover the main components of the <a href="https://share.unison-lang.org/@gvolpe/forex">forex</a> system. Feel free to follow along by navigating directly through the source code for a more interactive approach. However, before we do, I would like to share my personal wish list from my first pain points I experienced with the language.</p> <h3 id="wish-list">Wish list</h3> <p>Unison doesn‚Äôt support bounded polymorphism as languages like Haskell do via typeclasses, but different options <a href="https://www.unison-lang.org/docs/usage-topics/general-faqs/#does-unison-have-haskell-style-type-classes">are being considered</a>. Having a functional programming background, I really miss a few things you can do with typeclasses. See, for example, the <a href="https://share.unison-lang.org/@gvolpe/forex/code/main/latest/types/domain/Currency">Currency</a> definition.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="kr">type</span> <span class="n">domain</span><span class="o">.</span><span class="kt">Currency</span>
  <span class="ow">=</span> <span class="kt">AED</span> <span class="o">|</span> <span class="kt">AFN</span> <span class="o">|</span> <span class="kt">ALL</span> <span class="o">|</span> <span class="kt">AMD</span> <span class="o">|</span> <span class="kt">ANG</span> <span class="o">|</span> <span class="kt">AOA</span> <span class="o">|</span> <span class="kt">ARS</span> <span class="o">|</span> <span class="kt">AUD</span></code></pre></div> <p>It consists of an enumeration of 166 values (trimmed here for brevity). However, in our API endpoint we parse the currencies as <code>Text</code>, and need to be able to convert them to a valid <code>Currency</code>. To do this, I had to write a <a href="https://share.unison-lang.org/@gvolpe/forex/code/main/latest/terms/domain/Currency/fromText">very lengthy and tedious string pattern-matching</a> for every single currency ‚Äî I wouldn‚Äôt have bothered with this if vim macros weren‚Äôt a thing üòÖ</p> <p>Conversely, in the Haskell version, this is easily achieved via typeclass derivation and enum support.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="kr">data</span> <span class="kt">Currency</span> <span class="ow">=</span> <span class="kt">AED</span> <span class="o">|</span> <span class="kt">AFN</span> <span class="o">|</span> <span class="kt">ALL</span> <span class="o">|</span> <span class="kt">AMD</span> <span class="o">|</span> <span class="kt">ANG</span> <span class="o">|</span> <span class="kt">AOA</span> <span class="o">|</span> <span class="kt">ARS</span> <span class="o">|</span> <span class="kt">AUD</span> <span class="o">|</span> <span class="kt">AWG</span> <span class="o">|</span> <span class="kt">AZN</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Enum</span><span class="p">,</span> <span class="kt">Generic</span><span class="p">,</span> <span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Show</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">FromJSON</span> <span class="kt">Currency</span>
<span class="kr">instance</span> <span class="kt">ToJSON</span> <span class="kt">Currency</span>

<span class="nf">currencies</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Currency</span><span class="p">]</span>
<span class="nf">currencies</span> <span class="ow">=</span> <span class="n">enumFrom</span> <span class="kt">AED</span>

<span class="nf">parseCurrency</span> <span class="ow">::</span> <span class="kt">Text</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="kt">Currency</span>
<span class="nf">parseCurrency</span> <span class="n">t</span> <span class="ow">=</span>
  <span class="kr">let</span> <span class="n">s</span> <span class="ow">=</span> <span class="n">pack</span> <span class="o">.</span> <span class="n">show</span> <span class="o">&lt;$&gt;</span> <span class="n">currencies</span>
      <span class="n">i</span> <span class="ow">=</span> <span class="n">elemIndex</span> <span class="p">(</span><span class="n">toUpper</span> <span class="n">t</span><span class="p">)</span> <span class="n">s</span>
  <span class="kr">in</span>  <span class="p">(</span><span class="n">currencies</span> <span class="o">!!</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">i</span></code></pre></div> <p>Typeclasses here are only a means to an end, so I would love to have the same kind of power while writing Unison code, whether that‚Äôs done via typeclasses or something from the future.</p> <p>Did I miss something obvious in Unison APIs or documentation that would simplify this?</p> <p>Another thing I miss compared to the usual Git repo approach is having a CI/CD job running regression and smoke tests. With Unison having its own platform for sharing code, deployments are left to running manual commands in <code>ucm</code> (like <code>run deploy</code>) instead of having an automated job taking care of it. I‚Äôm sure this will be supported at some point, but until then, it‚Äôll remain on my wish list.</p> <p>Now with this out of the way, let‚Äôs move on with the exciting bits of writing my first Unison project!</p> <h3 id="http-routes">HTTP routes</h3> <p>It all starts by defining the API endpoints that are combined via <code>&lt;|&gt;</code>.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">api</span><span class="o">.</span><span class="n">routes</span> <span class="kt">:</span>
  <span class="kt">HttpRequest</span>
  <span class="ow">-&gt;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span> <span class="kt">Http</span><span class="p">,</span> <span class="kt">Log</span><span class="p">,</span> <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">,</span> <span class="kt">Cache</span> <span class="kt">Currency</span> <span class="kt">ForexResponse</span><span class="p">}</span> <span class="kt">HttpResponse</span>
<span class="nf">api</span><span class="o">.</span><span class="n">routes</span> <span class="ow">=</span>
  <span class="n">use</span> <span class="kt">Route</span> <span class="o">&lt;|&gt;</span>
  <span class="kt">Route</span><span class="o">.</span><span class="n">run</span> <span class="p">(</span><span class="n">getExchangeRate</span> <span class="o">&lt;|&gt;</span> <span class="n">healthcheck</span><span class="p">)</span></code></pre></div> <p>It essentially returns a <code>HttpRequest -&gt; HttpResponse</code> function where the abilities expressed in <code>{}</code> need to be handled. The <code>{Exception, Http, Log}</code> abilities allow us to express what this program needs in order to run. The <code>Ask AppCtx</code> should be familiar to functional programmers: it lets us carry context around functions. Finally, the <code>Cache Currency ForexResponse</code> is the ability that lets us cache responses for each currency. We‚Äôll dive deeper into this topic in the next few sections.</p> <p>Let‚Äôs skip the <code>healthcheck</code> endpoint for now and let‚Äôs look at the <code>GET /rates</code> endpoint.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">api</span><span class="o">.</span><span class="n">getExchangeRate</span> <span class="kt">:</span>
  <span class="n">&#39;</span><span class="p">{</span><span class="kt">Route</span><span class="p">,</span>
  <span class="kt">Exception</span><span class="p">,</span>
  <span class="kt">Http</span><span class="p">,</span>
  <span class="kt">Log</span><span class="p">,</span>
  <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">,</span>
  <span class="kt">Cache</span> <span class="kt">Currency</span> <span class="kt">ForexResponse</span><span class="p">}</span> <span class="nb">()</span>
<span class="nf">api</span><span class="o">.</span><span class="n">getExchangeRate</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">use</span> <span class="kt">ParseQuery</span> <span class="n">currency</span>
  <span class="n">use</span> <span class="kt">Parser</span> <span class="o">&amp;</span> <span class="o">/</span>
  <span class="n">queries</span> <span class="ow">=</span> <span class="kr">do</span> <span class="p">(</span><span class="n">currency</span> <span class="s">&quot;from&quot;</span><span class="p">,</span> <span class="n">currency</span> <span class="s">&quot;to&quot;</span><span class="p">)</span>
  <span class="n">rate</span> <span class="ow">=</span>
    <span class="n">match</span> <span class="kt">Route</span><span class="o">.</span><span class="n">route</span> <span class="kt">GET</span> <span class="p">(</span><span class="n">s</span> <span class="s">&quot;api&quot;</span> <span class="o">/</span> <span class="n">s</span> <span class="s">&quot;rates&quot;</span> <span class="o">&amp;</span> <span class="n">queries</span><span class="p">)</span> <span class="n">with</span>
      <span class="p">(</span><span class="kt">Some</span> <span class="n">from</span><span class="p">,</span> <span class="kt">Some</span> <span class="n">to</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">service</span><span class="o">.</span><span class="n">forex</span> <span class="n">from</span> <span class="n">to</span>
      <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kr">do</span> <span class="n">throw</span> <span class="p">(</span><span class="kt">BadRequest</span> <span class="s">&quot;invalid from/to query params&quot;</span><span class="p">)</span>
  <span class="n">forex</span><span class="o">.</span><span class="n">handler</span> <span class="p">(</span><span class="n">toEither</span> <span class="n">rate</span><span class="p">)</span></code></pre></div> <p>We can observe the <code>Route</code> ability here, which is eliminated in the <code>api.routes</code> function by the <code>Route.run</code> handler. This is essentially how abilities are handled in Unison. In a way, they are similar to interfaces for which we provide a specific implementation when the components are wired up.</p> <p>The <code>forex.handler</code> function is responsible for building HTTP responses, capturing domain errors.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="kr">type</span> <span class="n">http</span><span class="o">.</span><span class="kt">ForexError</span>
  <span class="ow">=</span> <span class="kt">UnknownError</span> <span class="kt">Nat</span> <span class="kt">Text</span>
  <span class="o">|</span> <span class="kt">InvalidApiKey</span> <span class="kt">Text</span>
  <span class="o">|</span> <span class="kt">ApiLimitReached</span> <span class="kt">Text</span>
  <span class="o">|</span> <span class="kt">NotFound</span> <span class="kt">Text</span>
  <span class="o">|</span> <span class="kt">BadRequest</span> <span class="kt">Text</span>

<span class="nf">api</span><span class="o">.</span><span class="n">forex</span><span class="o">.</span><span class="n">handler</span> <span class="kt">:</span> <span class="kt">Either</span> <span class="kt">ForexError</span> <span class="kt">ExchangeRate</span> <span class="ow">-&gt;</span><span class="p">{</span><span class="kt">Route</span><span class="p">,</span> <span class="kt">Log</span><span class="p">}</span> <span class="nb">()</span></code></pre></div> <h3 id="forex-service">Forex Service</h3> <p>Ultimately, we have the <code>service.forex</code> function that, given two currencies (from and to, respectively), returns an <code>ExchangeRate</code> with domain errors expressed via the <code>Throw</code> ability.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">service</span><span class="o">.</span><span class="n">forex</span> <span class="kt">:</span>
  <span class="kt">Currency</span>
  <span class="ow">-&gt;</span> <span class="kt">Currency</span>
  <span class="ow">-&gt;</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span>
  <span class="kt">Http</span><span class="p">,</span>
  <span class="kt">Log</span><span class="p">,</span>
  <span class="kt">Throw</span> <span class="kt">ForexError</span><span class="p">,</span>
  <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">,</span>
  <span class="kt">Cache</span> <span class="kt">Currency</span> <span class="kt">ForexResponse</span><span class="p">}</span> <span class="kt">ExchangeRate</span>
<span class="nf">service</span><span class="o">.</span><span class="n">forex</span> <span class="n">from</span> <span class="n">to</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">use</span> <span class="kt">Currency</span> <span class="n">text</span>
  <span class="n">fromText</span> <span class="ow">=</span> <span class="n">text</span> <span class="n">from</span>
  <span class="n">toText</span> <span class="ow">=</span> <span class="n">text</span> <span class="n">to</span>
  <span class="n">match</span> <span class="kt">Cache</span><span class="o">.</span><span class="n">get</span> <span class="n">from</span> <span class="n">with</span>
    <span class="kt">Some</span> <span class="p">(</span><span class="kt">ForexResponse</span> <span class="n">kv</span><span class="p">)</span><span class="o">|</span> <span class="n">isSome</span> <span class="p">(</span><span class="kt">Map</span><span class="o">.</span><span class="n">get</span> <span class="n">toText</span> <span class="n">kv</span><span class="p">)</span>  <span class="ow">-&gt;</span>
      <span class="kt">Log</span><span class="o">.</span><span class="n">info</span> <span class="s">&quot;Cache hit!&quot;</span> <span class="p">[(</span><span class="s">&quot;from&quot;</span><span class="p">,</span> <span class="n">fromText</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;to&quot;</span><span class="p">,</span> <span class="n">toText</span><span class="p">)]</span>
      <span class="kt">ExchangeRate</span> <span class="o">&lt;|</span> <span class="kt">Optional</span><span class="o">.</span><span class="n">getOrBug</span> <span class="s">&quot;unreachable&quot;</span> <span class="p">(</span><span class="kt">Map</span><span class="o">.</span><span class="n">get</span> <span class="n">toText</span> <span class="n">kv</span><span class="p">)</span>
    <span class="kr">_</span> <span class="ow">-&gt;</span>
      <span class="kt">Log</span><span class="o">.</span><span class="n">warn</span>
        <span class="s">&quot;Cache miss. Making an external HTTP request.&quot;</span>
        <span class="p">[(</span><span class="s">&quot;from&quot;</span><span class="p">,</span> <span class="n">fromText</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;to&quot;</span><span class="p">,</span> <span class="n">toText</span><span class="p">)]</span>
      <span class="n">response</span><span class="o">@</span><span class="p">(</span><span class="kt">ForexResponse</span> <span class="n">kv</span><span class="p">)</span> <span class="ow">=</span> <span class="n">http</span><span class="o">.</span><span class="n">forex</span> <span class="n">from</span> <span class="n">to</span> <span class="nb">()</span>
      <span class="kt">Cache</span><span class="o">.</span><span class="n">set</span> <span class="n">from</span> <span class="n">response</span>
      <span class="n">match</span> <span class="kt">Optional</span><span class="o">.</span><span class="n">map</span> <span class="kt">ExchangeRate</span> <span class="p">(</span><span class="kt">Map</span><span class="o">.</span><span class="n">get</span> <span class="n">toText</span> <span class="n">kv</span><span class="p">)</span> <span class="n">with</span>
        <span class="kt">Some</span> <span class="n">rate</span> <span class="ow">-&gt;</span> <span class="n">rate</span>
        <span class="kt">None</span>      <span class="ow">-&gt;</span> <span class="n">throw</span> <span class="p">(</span><span class="kt">NotFound</span> <span class="s">&quot;cache 404&quot;</span><span class="p">)</span></code></pre></div> <p>It attempts to fetch the currency data from the cache via <code>Cache.get</code>. If there‚Äôs no cached value, it falls-back to calling the third-party API via the <code>http.forex</code> client ‚Äî caching the response for subsequent use.</p> <p>The <a href="https://share.unison-lang.org/@gvolpe/forex/code/main/latest/types/Cache">Cache</a> ability is defined as follows:</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">ability</span> <span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span> <span class="kr">where</span>
  <span class="n">get</span> <span class="kt">:</span> <span class="n">k</span> <span class="ow">-&gt;</span><span class="p">{</span><span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span><span class="p">}</span> <span class="kt">Optional</span> <span class="n">v</span>
  <span class="n">set</span> <span class="kt">:</span> <span class="n">k</span> <span class="ow">-&gt;</span> <span class="n">v</span> <span class="ow">-&gt;</span><span class="p">{</span><span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span><span class="p">}</span> <span class="nb">()</span>
  <span class="n">evict</span> <span class="kt">:</span> <span class="n">k</span> <span class="ow">-&gt;</span><span class="p">{</span><span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span><span class="p">}</span> <span class="nb">()</span>
  <span class="n">expire</span> <span class="kt">:</span> <span class="p">{</span><span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span><span class="p">}</span> <span class="nb">()</span></code></pre></div> <p>The service only uses the first two functions, but it also allows us to remove a specific key or remove all key-values that have expired. We‚Äôll dive into the internals of the handler shortly.</p> <h3 id="http-client">HTTP client</h3> <p>At last, we have the HTTP client that lets us fetch data from the third-party API.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">http</span><span class="o">.</span><span class="n">forex</span> <span class="kt">:</span>
  <span class="kt">Currency</span>
  <span class="ow">-&gt;</span> <span class="kt">Currency</span>
  <span class="ow">-&gt;</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span> <span class="kt">Http</span><span class="p">,</span> <span class="kt">Log</span><span class="p">,</span> <span class="kt">Throw</span> <span class="kt">ForexError</span><span class="p">,</span> <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">}</span> <span class="kt">ForexResponse</span>
<span class="nf">http</span><span class="o">.</span><span class="n">forex</span> <span class="n">from</span> <span class="n">to</span> <span class="ow">=</span>
  <span class="kr">do</span>
    <span class="p">(</span><span class="kt">AppCtx</span> <span class="kr">_</span> <span class="kr">_</span> <span class="p">(</span><span class="kt">ApiKey</span> <span class="n">apiKey</span><span class="p">))</span> <span class="ow">=</span> <span class="n">ask</span>
    <span class="n">use</span> <span class="kt">Currency</span> <span class="n">text</span>
    <span class="n">use</span> <span class="kt">Text</span> <span class="o">++</span>
    <span class="n">uri</span> <span class="ow">=</span> <span class="kt">URI</span><span class="o">.</span><span class="n">parse</span> <span class="p">(</span><span class="s">&quot;https://v6.exchangerate-api.com/v6/latest/&quot;</span> <span class="o">++</span> <span class="n">text</span> <span class="n">from</span><span class="p">)</span>
    <span class="n">request</span> <span class="ow">=</span>
      <span class="kt">HttpRequest</span><span class="o">.</span><span class="n">addHeader</span>
        <span class="s">&quot;Authorization&quot;</span> <span class="p">(</span><span class="s">&quot;Bearer &quot;</span> <span class="o">++</span> <span class="n">apiKey</span><span class="p">)</span> <span class="p">(</span><span class="kt">HttpRequest</span><span class="o">.</span><span class="n">get</span> <span class="n">uri</span><span class="p">)</span>
    <span class="n">response</span> <span class="ow">=</span> <span class="kt">Http</span><span class="o">.</span><span class="n">request</span> <span class="n">request</span>
    <span class="n">match</span> <span class="kt">HttpResponse</span><span class="o">.</span><span class="n">status</span> <span class="n">response</span> <span class="n">with</span>
      <span class="kt">Status</span> <span class="mi">200</span> <span class="kr">_</span>  <span class="ow">-&gt;</span>
        <span class="n">responseBody</span> <span class="ow">=</span> <span class="n">bodyText</span> <span class="n">response</span>
        <span class="n">info</span> <span class="s">&quot;External Forex Response: &quot;</span> <span class="p">[(</span><span class="s">&quot;body&quot;</span><span class="p">,</span> <span class="n">responseBody</span><span class="p">)]</span>
        <span class="n">match</span> <span class="n">catch</span> <span class="kr">do</span> <span class="kt">Decoder</span><span class="o">.</span><span class="n">run</span> <span class="kt">ForexResponse</span><span class="o">.</span><span class="n">fromJson</span> <span class="n">responseBody</span> <span class="n">with</span>
          <span class="kt">Left</span> <span class="p">(</span><span class="kt">Failure</span> <span class="kr">_</span> <span class="n">e</span> <span class="kr">_</span><span class="p">)</span>          <span class="ow">-&gt;</span>
            <span class="kt">Log</span><span class="o">.</span><span class="ne">error</span> <span class="n">e</span> <span class="kt">[]</span>
            <span class="n">throw</span> <span class="p">(</span><span class="kt">UnknownError</span> <span class="mi">500</span> <span class="s">&quot;JSON decoding failure&quot;</span><span class="p">)</span>
          <span class="kt">Right</span> <span class="n">resp</span><span class="o">@</span><span class="p">(</span><span class="kt">ForexResponse</span> <span class="n">kv</span><span class="p">)</span> <span class="ow">-&gt;</span>
            <span class="n">match</span> <span class="kt">Map</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="n">text</span> <span class="n">to</span><span class="p">)</span> <span class="n">kv</span> <span class="n">with</span>
              <span class="kt">Some</span> <span class="n">v</span> <span class="ow">-&gt;</span> <span class="n">resp</span>
              <span class="kt">None</span>   <span class="ow">-&gt;</span> <span class="n">throw</span> <span class="p">(</span><span class="kt">NotFound</span> <span class="p">(</span><span class="n">text</span> <span class="n">from</span> <span class="o">++</span> <span class="s">&quot; -&gt; &quot;</span> <span class="o">++</span> <span class="n">text</span> <span class="n">to</span><span class="p">))</span>
      <span class="kt">Status</span> <span class="mi">403</span> <span class="n">e</span>  <span class="ow">-&gt;</span> <span class="n">throw</span> <span class="p">(</span><span class="kt">InvalidApiKey</span> <span class="n">e</span><span class="p">)</span>
      <span class="kt">Status</span> <span class="mi">404</span> <span class="n">e</span>  <span class="ow">-&gt;</span> <span class="n">throw</span> <span class="p">(</span><span class="kt">NotFound</span> <span class="n">e</span><span class="p">)</span>
      <span class="kt">Status</span> <span class="mi">429</span> <span class="n">e</span>  <span class="ow">-&gt;</span> <span class="n">throw</span> <span class="p">(</span><span class="kt">ApiLimitReached</span> <span class="n">e</span><span class="p">)</span>
      <span class="kt">Status</span> <span class="n">code</span> <span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">throw</span> <span class="p">(</span><span class="kt">UnknownError</span> <span class="n">code</span> <span class="n">e</span><span class="p">)</span></code></pre></div> <p>In order to authorize requests, an API key is needed, which we can fetch from the context via the <code>Ask</code> ability. We will soon learn about the rest of the data our application context holds.</p> <p>Once the request is fired up, we pattern-match on the HTTP response status code and model each response accordingly. Domain errors are expressed via the <code>Throw</code> ability.</p> <h3 id="deploy">Deploy</h3> <p>For the fun part, let‚Äôs see how easy it is to deploy our service to the <a href="https://www.unison.cloud/">cloud</a>!</p> <p><img src="../../images/unison/deploy.png" alt="deploy" /></p> <p>Let‚Äôs ignore the <code>forex-cache-cleanser</code> service for a minute, and let‚Äôs focus on the <code>forex</code> service instead. We can observe the latest version of the service exposed at <code>https://gvolpe.unison-services.cloud/s/forex</code> now points to a specific service hash showed right above. Unison will ensure this URL stays up-to-date.</p> <p>The <code>deploy</code> function is our main entry point based on the <code>Cloud.main</code> handler.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">deploy</span> <span class="kt">:</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">IO</span><span class="p">,</span> <span class="kt">Exception</span><span class="p">}</span> <span class="nb">()</span>
<span class="nf">deploy</span> <span class="ow">=</span>
  <span class="kt">Cloud</span><span class="o">.</span><span class="n">main</span> <span class="kr">do</span>
    <span class="n">use</span> <span class="n">base</span> <span class="n">ignore</span>
    <span class="n">env</span> <span class="ow">=</span> <span class="kt">Environment</span><span class="o">.</span><span class="n">named</span> <span class="s">&quot;forex&quot;</span>
    <span class="n">db</span> <span class="ow">=</span> <span class="kt">Database</span><span class="o">.</span><span class="n">named</span> <span class="s">&quot;currencies&quot;</span>
    <span class="kt">Database</span><span class="o">.</span><span class="n">assign</span> <span class="n">db</span> <span class="n">env</span>
    <span class="n">apiKey</span> <span class="ow">=</span> <span class="kt">Cloud</span><span class="o">.</span><span class="n">submit</span> <span class="n">env</span> <span class="kt">ApiKey</span><span class="o">.</span><span class="n">fetch</span>
    <span class="n">cacheConfig</span> <span class="ow">=</span> <span class="kt">CacheConfig</span> <span class="s">&quot;currencies&quot;</span> <span class="p">(</span><span class="kt">Remote</span><span class="o">.</span><span class="kt">Duration</span><span class="o">.</span><span class="n">hours</span> <span class="mi">24</span><span class="p">)</span>
    <span class="n">appCtx</span> <span class="ow">=</span> <span class="kt">AppCtx</span> <span class="n">db</span> <span class="n">cacheConfig</span> <span class="n">apiKey</span>
    <span class="n">httpServiceHash</span> <span class="ow">=</span>
      <span class="kt">Cloud</span><span class="o">.</span><span class="n">deployHttp</span> <span class="n">env</span> <span class="p">(</span><span class="n">req</span> <span class="ow">-&gt;</span>
        <span class="kt">Ask</span><span class="o">.</span><span class="n">provide</span> <span class="n">appCtx</span> <span class="kr">do</span> <span class="kt">Cache</span><span class="o">.</span><span class="n">persistent</span> <span class="kr">do</span> <span class="n">api</span><span class="o">.</span><span class="n">routes</span> <span class="n">req</span><span class="p">)</span>
    <span class="n">httpServiceName</span> <span class="ow">=</span> <span class="kt">ServiceName</span><span class="o">.</span><span class="n">named</span> <span class="s">&quot;forex&quot;</span>
    <span class="n">ignore</span> <span class="o">&lt;|</span> <span class="kt">ServiceName</span><span class="o">.</span><span class="n">assign</span> <span class="n">httpServiceName</span> <span class="n">httpServiceHash</span></code></pre></div> <p>Here‚Äôs where all the abilities need to be eliminated, resulting only in <code>{IO, Exception}</code>, which are handled by the Unison runtime.</p> <ul> <li><code>Cache k v</code> is eliminated by <code>Cache.persistent</code>.</li> <li><code>Ask ctx</code> is eliminated by <code>Ask.provide</code></li> <li><code>Http, Log, Remote</code> are eliminated by <code>Cloud.deployHttp</code>, which introduces the <code>Cloud</code> ability.</li> <li><code>Cloud</code> is eliminated by the <code>Cloud.main</code> handler.</li> </ul> <p>Now we can monitor our application logs in the Unison Cloud console.</p> <p><img src="../../images/unison/api-logs.png" alt="forex" /></p> <p>Quite neat! Isn‚Äôt it? Now let‚Äôs move on to the next exciting topic.</p> <h3 id="caching">Caching</h3> <p>The main handler for the <code>Cache</code> ability is based on an internal <a href="https://share.unison-lang.org/@unison/cloud/code/main/latest/types/durable/Cell">Cell</a> ‚Äî a table that stores a single durable value, which requires a <a href="https://share.unison-lang.org/@unison/cloud/code/releases/20.7.2/latest/types/Database">Database</a> to be created.</p> <p>Without further ado, let‚Äôs look at the implementation and later discuss the relevant pieces.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="kt">Cache</span><span class="o">.</span><span class="n">persistent</span> <span class="kt">:</span> <span class="n">&#39;</span><span class="p">{</span><span class="n">g</span><span class="p">,</span> <span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span><span class="p">}</span> <span class="n">r</span> <span class="ow">-&gt;</span><span class="p">{</span><span class="n">g</span><span class="p">,</span> <span class="kt">Exception</span><span class="p">,</span> <span class="kt">Remote</span><span class="p">,</span> <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">}</span> <span class="n">r</span>
<span class="kt">Cache</span><span class="o">.</span><span class="n">persistent</span> <span class="n">interactions</span> <span class="ow">=</span>
  <span class="n">use</span> <span class="kt">Cell</span> <span class="n">modify</span>
  <span class="n">use</span> <span class="kt">Instant</span> <span class="o">+</span> <span class="o">&gt;</span>
  <span class="n">use</span> <span class="kt">Map</span> <span class="n">delete</span>
  <span class="p">(</span><span class="kt">AppCtx</span> <span class="n">db</span> <span class="p">(</span><span class="kt">CacheConfig</span> <span class="n">cacheName</span> <span class="n">cacheExpiration</span><span class="p">)</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">=</span> <span class="n">ask</span>
  <span class="n">expTime</span> <span class="ow">=</span> <span class="n">toBaseDuration</span> <span class="n">cacheExpiration</span>
  <span class="n">hasNotExpired</span> <span class="kt">:</span> <span class="kt">Instant</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kt">Instant</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Boolean</span>
  <span class="n">hasNotExpired</span> <span class="n">now</span> <span class="ow">=</span> <span class="n">cases</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">ts</span> <span class="o">+</span> <span class="n">expTime</span> <span class="o">&gt;</span> <span class="n">now</span>
  <span class="n">impl</span> <span class="kt">:</span> <span class="kt">Cell</span> <span class="p">(</span><span class="kt">Map</span> <span class="n">k</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kt">Instant</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="kt">Request</span> <span class="p">{</span><span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span><span class="p">}</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">r</span>
  <span class="n">impl</span> <span class="n">cell</span> <span class="ow">=</span> <span class="n">cases</span>
    <span class="p">{</span> <span class="n">pure</span> <span class="p">}</span>                          <span class="ow">-&gt;</span> <span class="n">pure</span>
    <span class="p">{</span> <span class="kt">Cache</span><span class="o">.</span><span class="n">get</span> <span class="n">key</span> <span class="ow">-&gt;</span> <span class="n">resume</span> <span class="p">}</span>       <span class="ow">-&gt;</span>
      <span class="n">now</span> <span class="ow">=</span> <span class="n">now</span><span class="o">!</span>
      <span class="n">lookup</span> <span class="ow">=</span> <span class="n">match</span> <span class="kt">Map</span><span class="o">.</span><span class="n">get</span> <span class="n">key</span> <span class="p">(</span><span class="kt">Cell</span><span class="o">.</span><span class="n">read</span> <span class="n">cell</span><span class="p">)</span> <span class="n">with</span>
        <span class="kt">Some</span> <span class="n">x</span><span class="o">@</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">hasNotExpired</span> <span class="n">now</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="kt">Some</span> <span class="n">v</span>
        <span class="kt">Some</span> <span class="kr">_</span>        <span class="ow">-&gt;</span>
          <span class="n">modify</span> <span class="n">cell</span> <span class="p">(</span><span class="n">kv</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">delete</span> <span class="n">key</span> <span class="n">kv</span><span class="p">,</span> <span class="nb">()</span><span class="p">))</span>
          <span class="kt">None</span>
        <span class="kt">None</span>          <span class="ow">-&gt;</span> <span class="kt">None</span>
      <span class="n">handle</span> <span class="n">resume</span> <span class="n">lookup</span> <span class="n">with</span> <span class="n">impl</span> <span class="n">cell</span>
    <span class="p">{</span> <span class="kt">Cache</span><span class="o">.</span><span class="n">set</span> <span class="n">key</span> <span class="n">value</span> <span class="ow">-&gt;</span> <span class="n">resume</span> <span class="p">}</span> <span class="ow">-&gt;</span>
      <span class="n">ts</span> <span class="ow">=</span> <span class="n">now</span><span class="o">!</span>
      <span class="n">modify</span> <span class="n">cell</span> <span class="p">(</span><span class="n">kv</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Map</span><span class="o">.</span><span class="n">put</span> <span class="n">key</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span> <span class="n">kv</span><span class="p">,</span> <span class="nb">()</span><span class="p">))</span>
      <span class="n">handle</span> <span class="n">resume</span><span class="nb">()</span> <span class="n">with</span> <span class="n">impl</span> <span class="n">cell</span>
    <span class="p">{</span> <span class="n">evict</span> <span class="n">key</span> <span class="ow">-&gt;</span> <span class="n">resume</span> <span class="p">}</span>           <span class="ow">-&gt;</span>
      <span class="n">modify</span> <span class="n">cell</span> <span class="p">(</span><span class="n">kv</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">delete</span> <span class="n">key</span> <span class="n">kv</span><span class="p">,</span> <span class="nb">()</span><span class="p">))</span>
      <span class="n">handle</span> <span class="n">resume</span><span class="nb">()</span> <span class="n">with</span> <span class="n">impl</span> <span class="n">cell</span>
    <span class="p">{</span> <span class="n">expire</span> <span class="ow">-&gt;</span> <span class="n">resume</span> <span class="p">}</span>              <span class="ow">-&gt;</span>
      <span class="n">now</span> <span class="ow">=</span> <span class="n">now</span><span class="o">!</span>
      <span class="n">modify</span> <span class="n">cell</span> <span class="p">(</span><span class="n">kv</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Map</span><span class="o">.</span><span class="n">filter</span> <span class="p">(</span><span class="n">hasNotExpired</span> <span class="n">now</span><span class="p">)</span> <span class="n">kv</span><span class="p">,</span> <span class="nb">()</span><span class="p">))</span>
      <span class="n">handle</span> <span class="n">resume</span><span class="nb">()</span> <span class="n">with</span> <span class="n">impl</span> <span class="n">cell</span>
  <span class="n">handle</span> <span class="n">interactions</span><span class="nb">()</span> <span class="n">with</span> <span class="n">impl</span> <span class="p">(</span><span class="kt">Cell</span><span class="o">.</span><span class="n">named</span> <span class="n">db</span> <span class="n">cacheName</span> <span class="kt">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span></code></pre></div> <p>A <code>Cache k v</code> is internally represented as a <code>Map k (v, Instant)</code> stored in a <code>Cell</code>.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">impl</span> <span class="kt">:</span> <span class="kt">Cell</span> <span class="p">(</span><span class="kt">Map</span> <span class="n">k</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kt">Instant</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="kt">Request</span> <span class="p">{</span><span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span><span class="p">}</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">r</span></code></pre></div> <p>The <code>Instant</code> value represents the time when the value was written to the cache (see how <code>Cache.set</code> is handled). When we look-up a key-value from the cache, we also look at the timestamp and check if it hasn‚Äôt expired yet. If it did, then the key-value is removed from the cache.</p> <p>This method of <a href="https://redis.io/glossary/cache-invalidation/">cache invalidation</a> (one of my favorite topics in software engineering) is also known as ‚Äúpassive‚Äù, where only data that‚Äôs being accessed is checked for expirations. However, in bigger systems, data that is not accessed can account for considerable storage space when neglected.</p> <p>Arguably, in this simple application we don‚Äôt need an ‚Äúactive‚Äù cache invalidation method. In the original Forex application written in Haskell, cache expiration was already taken for granted, as Redis handles everything. However, I absolutely love a good challenge, and this brings up a great opportunity to further explore what Unison has got to offer.</p> <p>To finish up with the implementation of this handler, the <code>evict</code> function is based on <code>Map.delete</code> whereas the <code>expire</code> function is based on <code>Map.filter</code>, filtering out the expired key-values from the internal map.</p> <h4 id="active-cache-invalidation">Active Cache Invalidation</h4> <p>A daily cron job calling <code>Cache.expire</code> will be one valid way of implementing active cache invalidation. Now can we do this with Unison services that are deployed via the <code>Cloud</code> handlers? Unfortunately, this only suits applications which follow a request-response cycle.</p> <p>For repeated scheduled jobs or queueing systems, we can leverage the <a href="https://share.unison-lang.org/@unison/cloud/code/releases/20.7.2/latest/types/Daemon">Daemon</a> ability, which is considered a low-level cloud utility and it‚Äôs a <a href="https://www.unison.cloud/pricing/">paid feature</a>.</p> <p>We could start defining a simple scheduled job that calls itself every 24 hours.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">daemon</span><span class="o">.</span><span class="n">job</span> <span class="kt">:</span>
  <span class="n">&#39;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span> <span class="kt">Remote</span><span class="p">,</span> <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">,</span> <span class="kt">Cache</span> <span class="kt">Currency</span> <span class="kt">ForexResponse</span><span class="p">}</span> <span class="nb">()</span>
<span class="nf">daemon</span><span class="o">.</span><span class="n">job</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">use</span> <span class="kt">Text</span> <span class="o">++</span>
  <span class="p">(</span><span class="kt">AppCtx</span> <span class="kr">_</span> <span class="p">(</span><span class="kt">CacheConfig</span> <span class="kr">_</span> <span class="n">cacheExpiration</span><span class="p">)</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">=</span> <span class="n">ask</span>
  <span class="n">durationText</span> <span class="ow">=</span> <span class="kt">Duration</span><span class="o">.</span><span class="n">toText</span> <span class="p">(</span><span class="n">toBaseDuration</span> <span class="n">cacheExpiration</span><span class="p">)</span>
  <span class="n">impl</span> <span class="kt">:</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span> <span class="kt">Remote</span><span class="p">,</span> <span class="kt">Cache</span> <span class="kt">Currency</span> <span class="kt">ForexResponse</span><span class="p">}</span> <span class="nb">()</span>
  <span class="n">impl</span> <span class="ow">=</span> <span class="kr">do</span>
      <span class="kt">Log</span><span class="o">.</span><span class="n">info</span> <span class="p">(</span><span class="s">&quot;Next cache removal in &quot;</span> <span class="o">++</span> <span class="n">durationText</span><span class="p">)</span> <span class="kt">[]</span>
      <span class="kt">Remote</span><span class="o">.</span><span class="n">sleep</span> <span class="n">cacheExpiration</span>
      <span class="kt">Cache</span><span class="o">.</span><span class="n">expire</span>
      <span class="kt">Log</span><span class="o">.</span><span class="n">warn</span> <span class="s">&quot;Expired key-values have been removed&quot;</span> <span class="kt">[]</span>
  <span class="n">forever</span> <span class="n">impl</span></code></pre></div> <p>However, there‚Äôs currently a big limitation and we can‚Äôt monitor daemon logs in the Unison Cloud console as we do with regular services; its API is limited to streaming to the <code>ucm</code> console. For this reason, we‚Äôll use a ‚Äúlogging service‚Äù, which the daemon can natively call via the <code>Services</code> ability.</p> <p>Firstly, we‚Äôll create the program that will log the messages.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="kr">type</span> <span class="n">domain</span><span class="o">.</span><span class="kt">LogMsg</span> <span class="ow">=</span> <span class="p">{</span> <span class="n">level</span> <span class="kt">:</span> <span class="kt">Level</span><span class="p">,</span> <span class="n">text</span> <span class="kt">:</span> <span class="kt">Text</span><span class="p">,</span> <span class="n">json</span> <span class="kt">:</span> <span class="kt">Json</span> <span class="p">}</span>

<span class="nf">daemon</span><span class="o">.</span><span class="n">logJson</span> <span class="kt">:</span> <span class="kt">LogMsg</span> <span class="ow">-&gt;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span> <span class="kt">Log</span><span class="p">}</span> <span class="nb">()</span>
<span class="nf">daemon</span><span class="o">.</span><span class="n">logJson</span> <span class="ow">=</span> <span class="n">cases</span>
  <span class="kt">LogMsg</span> <span class="n">level</span> <span class="n">msg</span> <span class="n">json</span> <span class="ow">-&gt;</span> <span class="n">atLevel</span><span class="o">.</span><span class="n">lazyJson</span> <span class="n">level</span> <span class="p">(</span><span class="kr">do</span> <span class="n">msg</span><span class="p">)</span> <span class="kr">do</span> <span class="n">json</span></code></pre></div> <p>We will then write a service named ‚Äúforex-cache-cleanser‚Äù whose only resposibility is to run the <code>logJson</code> program. The <code>Cloud.deploy</code> handler can be used to deploy this service and get its hash.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">deploy</span> <span class="kt">:</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">IO</span><span class="p">,</span> <span class="kt">Exception</span><span class="p">}</span> <span class="nb">()</span>
<span class="nf">deploy</span> <span class="ow">=</span> 
  <span class="kt">Cloud</span><span class="o">.</span><span class="n">main</span> <span class="kr">do</span>
    <span class="o">...</span>
    <span class="n">logServiceHash</span> <span class="kt">:</span> <span class="kt">ServiceHash</span> <span class="kt">LogMsg</span> <span class="nb">()</span>
    <span class="n">logServiceHash</span> <span class="ow">=</span> <span class="kt">Cloud</span><span class="o">.</span><span class="n">deploy</span> <span class="n">env</span> <span class="n">daemon</span><span class="o">.</span><span class="n">logJson</span>
    <span class="n">logServiceName</span> <span class="ow">=</span> <span class="kt">ServiceName</span><span class="o">.</span><span class="n">named</span> <span class="s">&quot;forex-cache-cleanser&quot;</span>
    <span class="n">ignore</span> <span class="o">&lt;|</span> <span class="kt">ServiceName</span><span class="o">.</span><span class="n">assign</span> <span class="n">logServiceName</span> <span class="n">logServiceHash</span>
    <span class="n">daemon</span><span class="o">.</span><span class="n">deploy</span> <span class="n">env</span> <span class="kr">do</span>
      <span class="n">provide</span> <span class="n">appCtx</span> <span class="kr">do</span> <span class="n">persistent</span> <span class="p">(</span><span class="n">cacheCleanser</span> <span class="n">logServiceHash</span><span class="p">)</span></code></pre></div> <p>Next, we invoke the <code>daemon.deploy</code> function with the <code>cacheCleanser</code> program that takes the logging service hash as input. It uses the <code>Daemon.deploy</code> handler, which is analogous to <code>Cloud.deploy</code> for regular services.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">daemon</span><span class="o">.</span><span class="n">deploy</span> <span class="kt">:</span>
  <span class="kt">Environment</span> <span class="ow">-&gt;</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span> <span class="kt">Services</span><span class="p">,</span> <span class="kt">Remote</span><span class="p">}</span> <span class="nb">()</span> <span class="ow">-&gt;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span> <span class="kt">Cloud</span><span class="p">}</span> <span class="nb">()</span>
<span class="nf">daemon</span><span class="o">.</span><span class="n">deploy</span> <span class="n">env</span> <span class="n">program</span> <span class="ow">=</span>
  <span class="n">cleanserDaemon</span> <span class="ow">=</span> <span class="kt">Daemon</span><span class="o">.</span><span class="n">named</span> <span class="s">&quot;forex-cache-cleanser-daemon&quot;</span>
  <span class="n">cleanserHash</span> <span class="ow">=</span> <span class="kt">Daemon</span><span class="o">.</span><span class="n">deploy</span> <span class="n">cleanserDaemon</span> <span class="n">env</span> <span class="n">program</span>
  <span class="kt">Daemon</span><span class="o">.</span><span class="n">assign</span> <span class="n">cleanserDaemon</span> <span class="n">cleanserHash</span></code></pre></div> <p>The final definition for the daily scheduled job is called <code>cacheCleanser</code> and is defined as follows.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">daemon</span><span class="o">.</span><span class="n">cacheCleanser</span> <span class="kt">:</span>
  <span class="kt">ServiceHash</span> <span class="kt">LogMsg</span> <span class="nb">()</span>
  <span class="ow">-&gt;</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span> <span class="kt">Services</span><span class="p">,</span> <span class="kt">Remote</span><span class="p">,</span> <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">,</span> <span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span><span class="p">}</span> <span class="nb">()</span>
<span class="nf">daemon</span><span class="o">.</span><span class="n">cacheCleanser</span> <span class="n">logService</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">use</span> <span class="kt">Services</span> <span class="n">call</span>
  <span class="n">use</span> <span class="kt">Text</span> <span class="o">++</span>
  <span class="n">logMsg</span> <span class="kt">:</span> <span class="kt">Text</span> <span class="ow">-&gt;</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">Remote</span><span class="p">}</span> <span class="kt">LogMsg</span>
  <span class="n">logMsg</span> <span class="n">msg</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">time</span> <span class="ow">=</span> <span class="n">now</span><span class="o">!</span> <span class="o">|&gt;</span> <span class="kt">Instant</span><span class="o">.</span><span class="n">toRFC2822</span>
    <span class="kt">LogMsg</span> <span class="kt">Info</span> <span class="n">msg</span> <span class="p">(</span><span class="kt">Json</span><span class="o">.</span><span class="n">object</span> <span class="p">[(</span><span class="s">&quot;timestamp&quot;</span><span class="p">,</span> <span class="kt">Json</span><span class="o">.</span><span class="n">text</span> <span class="n">time</span><span class="p">)])</span>
  <span class="p">(</span><span class="kt">AppCtx</span> <span class="kr">_</span> <span class="p">(</span><span class="kt">CacheConfig</span> <span class="kr">_</span> <span class="n">cacheExpiration</span><span class="p">)</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">=</span> <span class="n">ask</span>
  <span class="n">durationText</span> <span class="ow">=</span> <span class="kt">Duration</span><span class="o">.</span><span class="n">toText</span> <span class="p">(</span><span class="n">toBaseDuration</span> <span class="n">cacheExpiration</span><span class="p">)</span>
  <span class="n">impl</span> <span class="kt">:</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span> <span class="kt">Services</span><span class="p">,</span> <span class="kt">Remote</span><span class="p">,</span> <span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span><span class="p">}</span> <span class="nb">()</span>
  <span class="n">impl</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">call</span> <span class="n">logService</span> <span class="p">(</span><span class="n">logMsg</span> <span class="p">(</span><span class="s">&quot;Next cache removal in &quot;</span> <span class="o">++</span> <span class="n">durationText</span><span class="p">)</span> <span class="nb">()</span><span class="p">)</span>
    <span class="kt">Remote</span><span class="o">.</span><span class="n">sleep</span> <span class="n">cacheExpiration</span>
    <span class="kt">Cache</span><span class="o">.</span><span class="n">expire</span>
    <span class="n">call</span> <span class="n">logService</span> <span class="p">(</span><span class="n">logMsg</span> <span class="s">&quot;Expired key-values have been removed&quot;</span> <span class="nb">()</span><span class="p">)</span>
  <span class="n">forever</span> <span class="n">impl</span></code></pre></div> <p>At last, we can now monitor the daemon logs in the Unison Cloud console.</p> <p><img src="../../images/unison/daemon-logs.png" alt="daemon-logs" /></p> <p>This is it! We‚Äôve effectively implemented active cache invalidation by running a daily scheduled job using Unison‚Äôs Daemon API. It‚Äôs still early days, so I believe it will continue to evolve, and I‚Äôm personally hoping that in the near future we are able to easily monitor logs like we do with regular services.</p> <h3 id="testing">Testing</h3> <p>We couldn‚Äôt finish up this blog-post without talking about tests!</p> <p><img src="../../images/unison/tests-ok.png" alt="tests-ok" /></p> <p>There are a bunch of tests defined in this project, and the image above shows what it looks like to run the entire test suite in the UCM console. We can observe that 13 tests correspond to cached test results, whereas the remaining 5 tests were run once again.</p> <p>The reason is that Unison doesn‚Äôt run tests until a function that‚Äôs being used changes its hash. When this is the case, all those tests affected by the hash change will be re-run. Otherwise, the tests results displayed in the console will be those that have been previously cached.</p> <p>Here‚Äôs one of the tests for the HTTP client that expects a successful response.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">http</span><span class="o">.</span><span class="n">forex</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">ok</span> <span class="kt">:</span> <span class="p">[</span><span class="kt">Result</span><span class="p">]</span>
<span class="nf">http</span><span class="o">.</span><span class="n">forex</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">ok</span> <span class="ow">=</span> <span class="n">test</span><span class="o">.</span><span class="n">verify</span> <span class="kr">do</span>
  <span class="n">body</span> <span class="ow">=</span> <span class="s">&quot;{</span><span class="se">\&quot;</span><span class="s">conversion_rates</span><span class="se">\&quot;</span><span class="s">: {</span><span class="se">\&quot;</span><span class="s">EUR</span><span class="se">\&quot;</span><span class="s">: 1.2, </span><span class="se">\&quot;</span><span class="s">JPY</span><span class="se">\&quot;</span><span class="s">: 5.24}}&quot;</span>
  <span class="n">resp</span> <span class="ow">=</span> <span class="kt">HttpResponse</span><span class="o">.</span><span class="n">ok</span> <span class="p">(</span><span class="kt">Body</span><span class="o">.</span><span class="n">fromText</span> <span class="n">body</span><span class="p">)</span>
  <span class="n">response</span> <span class="ow">=</span> <span class="n">logAskThrow</span> <span class="kr">do</span> <span class="kt">Http</span><span class="o">.</span><span class="n">stub</span> <span class="n">resp</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">forex</span> <span class="kt">USD</span> <span class="kt">EUR</span><span class="p">)</span>
  <span class="n">expected</span> <span class="ow">=</span> <span class="kt">ForexResponse</span> <span class="p">(</span><span class="kt">List</span><span class="o">.</span><span class="n">toMap</span> <span class="p">[(</span><span class="s">&quot;EUR&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;JPY&quot;</span><span class="p">,</span> <span class="mf">5.24</span><span class="p">)])</span>
  <span class="n">test</span><span class="o">.</span><span class="n">ensureEqual</span> <span class="n">response</span> <span class="n">expected</span></code></pre></div> <p>It invokes the <code>http.forex</code> function, which has the following type signature (recap):</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">http</span><span class="o">.</span><span class="n">forex</span> <span class="kt">:</span>
  <span class="kt">Currency</span>
  <span class="ow">-&gt;</span> <span class="kt">Currency</span>
  <span class="ow">-&gt;</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">Exception</span><span class="p">,</span> <span class="kt">Http</span><span class="p">,</span> <span class="kt">Log</span><span class="p">,</span> <span class="kt">Throw</span> <span class="kt">ForexError</span><span class="p">,</span> <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">}</span> <span class="kt">ForexResponse</span></code></pre></div> <p>In this case, we‚Äôre only interested in the <code>Http</code> ability. We don‚Äôt want to deal with the other ones, so we can eliminate them with ‚Äústub‚Äù handlers defined under the <code>tests</code> namespace, e.g.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">tests</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">logAsk</span> <span class="kt">:</span> <span class="n">&#39;</span><span class="p">{</span><span class="n">g</span><span class="p">,</span> <span class="kt">Log</span><span class="p">,</span> <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">}</span> <span class="n">a</span> <span class="ow">-&gt;</span><span class="p">{</span><span class="n">g</span><span class="p">}</span> <span class="n">a</span>
<span class="nf">tests</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">logAsk</span> <span class="n">program</span> <span class="ow">=</span>
  <span class="n">db</span> <span class="ow">=</span> <span class="kt">Database</span> <span class="p">(</span><span class="kt">Database</span><span class="o">.</span><span class="kt">Id</span><span class="o">.</span><span class="kt">Id</span> <span class="s">&quot;test&quot;</span><span class="p">)</span> <span class="s">&quot;test&quot;</span>
  <span class="n">cfg</span> <span class="ow">=</span> <span class="kt">CacheConfig</span> <span class="s">&quot;test&quot;</span> <span class="p">(</span><span class="kt">Remote</span><span class="o">.</span><span class="kt">Duration</span><span class="o">.</span><span class="n">hours</span> <span class="mi">2</span><span class="p">)</span>
  <span class="n">ctx</span> <span class="ow">=</span> <span class="kt">AppCtx</span> <span class="n">db</span> <span class="n">cfg</span> <span class="p">(</span><span class="kt">ApiKey</span> <span class="s">&quot;test&quot;</span><span class="p">)</span>
  <span class="n">provide</span> <span class="n">ctx</span> <span class="kr">do</span> <span class="kt">Log</span><span class="o">.</span><span class="n">stub</span> <span class="n">program</span>

<span class="nf">tests</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">logAskThrow</span> <span class="kt">:</span> <span class="n">&#39;</span><span class="p">{</span><span class="n">g</span><span class="p">,</span> <span class="kt">Log</span><span class="p">,</span> <span class="kt">Throw</span> <span class="n">e</span><span class="p">,</span> <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">}</span> <span class="n">a</span> <span class="ow">-&gt;</span><span class="p">{</span><span class="n">g</span><span class="p">}</span> <span class="n">a</span>
<span class="nf">tests</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">logAskThrow</span> <span class="n">program</span> <span class="ow">=</span> <span class="kt">Throw</span><span class="o">.</span><span class="n">toBug</span> <span class="kr">do</span> <span class="n">logAsk</span> <span class="n">program</span></code></pre></div> <p>Here‚Äôs another interesting test that requires a different set of abilities.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">api</span><span class="o">.</span><span class="n">getExchangeRate</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">cachedOk</span> <span class="kt">:</span> <span class="p">[</span><span class="kt">Result</span><span class="p">]</span>
<span class="nf">api</span><span class="o">.</span><span class="n">getExchangeRate</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">cachedOk</span> <span class="ow">=</span> <span class="n">test</span><span class="o">.</span><span class="n">verify</span> <span class="kr">do</span>
  <span class="n">keyValue</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">USD</span><span class="p">,</span> <span class="kt">ForexResponse</span> <span class="p">(</span><span class="kt">List</span><span class="o">.</span><span class="n">toMap</span> <span class="p">[(</span><span class="s">&quot;EUR&quot;</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">)]))</span>
  <span class="n">route</span> <span class="ow">=</span> <span class="n">cacheRoute</span> <span class="n">getExchangeRate</span> <span class="n">keyValue</span>
  <span class="n">request</span> <span class="ow">=</span> <span class="kt">HttpRequest</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="kt">URI</span><span class="o">.</span><span class="n">parse</span> <span class="s">&quot;/api/rates?from=USD&amp;to=EUR&quot;</span><span class="p">)</span>
  <span class="n">response</span> <span class="ow">=</span> <span class="n">runRoute</span> <span class="n">route</span> <span class="n">request</span>
  <span class="n">test</span><span class="o">.</span><span class="n">ensureEqual</span> <span class="p">(</span><span class="kt">HttpResponse</span><span class="o">.</span><span class="n">status</span> <span class="n">response</span><span class="p">)</span> <span class="p">(</span><span class="kt">Status</span> <span class="mi">200</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span></code></pre></div> <p>It verifies the result comes from the cache, for which we use the <code>Cache.inMemory</code> handler.</p> <div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="nf">tests</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">cacheRoute</span> <span class="kt">:</span>
  <span class="n">&#39;</span><span class="p">{</span><span class="kt">Route</span><span class="p">,</span> <span class="kt">Exception</span><span class="p">,</span> <span class="kt">Http</span><span class="p">,</span> <span class="kt">Remote</span><span class="p">,</span> <span class="kt">Log</span><span class="p">,</span> <span class="kt">Ask</span> <span class="kt">AppCtx</span><span class="p">,</span> <span class="kt">Cache</span> <span class="n">k</span> <span class="n">v</span><span class="p">}</span> <span class="nb">()</span>
  <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
  <span class="ow">-&gt;</span> <span class="n">&#39;</span><span class="p">{</span><span class="kt">Route</span><span class="p">,</span> <span class="kt">Exception</span><span class="p">,</span> <span class="kt">Remote</span><span class="p">}</span> <span class="nb">()</span>
<span class="nf">tests</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">cacheRoute</span> <span class="n">api</span> <span class="n">kv</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="kt">Cache</span><span class="o">.</span><span class="n">inMemory</span> <span class="kr">do</span>
    <span class="kt">Cache</span><span class="o">.</span><span class="n">set</span> <span class="p">(</span><span class="n">at1</span> <span class="n">kv</span><span class="p">)</span> <span class="p">(</span><span class="n">at2</span> <span class="n">kv</span><span class="p">)</span>
    <span class="kt">Http</span><span class="o">.</span><span class="n">stub&#39;</span> <span class="kr">do</span> <span class="n">logAsk</span> <span class="n">api</span></code></pre></div> <p>To summarize this section, the following image shows that tests can sometimes fail.</p> <p><img src="../../images/unison/tests-fail.png" alt="tests-fail" /></p> <p>Have a look at the other available tests and let me know if we can do better!</p> <h2 id="final-thoughts">Final thoughts</h2> <p>Quoting their official website, I couldn‚Äôt agree more with it.</p> <blockquote> <p>Unison is a friendly programming language from the future: statically-typed, functional, and a lot of fun üòÑ <img src="../../images/gifs/future.webp" alt="future" /></p> </blockquote> <p>I will certainly continue to learn what this great language has to offer while having lots of fun. There are multiple applications that can be written in it, but if there‚Äôs an area where you should seriously consider it, is for building distributed systems deployed to their cloud infrastructure.</p> <p>Last but not least, I would like to give a big shout out to the Unison team for all the great work they are doing. I had a few questions when going through the documentation and you guys have been awesome!</p> <p>Check out the source code and discover more: <a href="https://share.unison-lang.org/@gvolpe/forex">https://share.unison-lang.org/@gvolpe/forex</a>.</p> <p>Best, Gabriel.</p> <div id="gh-comments"> <br/><br/> <div id="gh-comments-list"></div> </div> <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"> </script> <script src="/js/github-comments.js"> </script> <script type="text/javascript"> DoGithubComments ( "gvolpe/blog-comments" , "33" ); </script> <noscript>Please enable JavaScript to view comments.</noscript> </div> </div> </section> <footer id="footer"> <!-- Icons --> <!-- Look here for more brands icons: https://fortawesome.com/sets/font-awesome-5-brands --> <script src="/js/email.js"> </script> <ul class="icons"> <li><a href="#" class="icon solid fa-envelope" onclick="showContact()"><span class="label">Email</span></a></li> <li><a href="https://github.com/gvolpe" target="_blank" class="icon brands fa-github"><span class="label">Github</span></a></li> <li><a href="https://matrix.to/#/@gvolpe:matrix.org" target="_blank" class="icon brands fa-gitter"><span class="label">Matrix</span></a></li> <li><a rel="me" href="https://fosstodon.org/@gvolpe" target="_blank" class="icon brands fa-mastodon"><span class="label">Mastodon</span>></a></li> <li><a href="https://twitter.com/volpegabriel87" target="_blank" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li> <li><a href="https://bsky.app/profile/gvolpe.com" target="_blank" class="icon brands fa-dribbble"><span class="label">Bluesky</span></a></li> <li><a href="https://linkedin.com/in/gmvolpe" target="_blank" class="icon brands fa-linkedin-in"><span class="label">LinkedIn</span></a></li> <li><a href="https://leanpub.com/u/gvolpe" target="_blank" class="icon brands fa-leanpub"><span class="label">LeanPub</span></a></li> <li><a href="https://www.blurb.co.uk/user/gvolpe" target="_blank" class="icon brands fa-bimobject"><span class="label">Blurb</span></a></li> </ul> <small> Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a> </small> <!-- Menu --> <ul class="menu"> <li> &copy; Gabriel Volpe 2020-2025 </li> </ul> </footer> </body> </html></body></html>
