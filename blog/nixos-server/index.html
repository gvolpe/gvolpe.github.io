<!doctype html><html lang=en-us data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://gvolpe.com/images/favicon.png><title>NixOS server up in minutes! - Gabriel Volpe</title><meta name=description content="Introduction
The folks at Garnix have done it again! You can now deploy a NixOS server in minutes, just by defining your system on a flake.nix and git push â€¦"><meta property="og:title" content="NixOS server up in minutes!"><meta property="og:description" content="Introduction
The folks at Garnix have done it again! You can now deploy a NixOS server in minutes, just by defining your system on a flake.nix and git push â€¦"><meta property="og:type" content="article"><meta property="og:url" content="https://gvolpe.com/blog/nixos-server/"><meta property="og:site_name" content="Gabriel Volpe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="NixOS server up in minutes!"><meta name=twitter:description content="Introduction
The folks at Garnix have done it again! You can now deploy a NixOS server in minutes, just by defining your system on a flake.nix and git push â€¦"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://gvolpe.com/css/style.css><script type=text/javascript defer data-domain=gvolpe.com src=https://gvolpe.com/js/plausible.js></script></head><body><main><div id=post-overlay-id class="post-overlay active"><div class=reading-progress></div><div class=post-overlay-backdrop></div><div id=post-overlay-content-id class=post-overlay-content style=position:relative;min-height:100vh;padding:0;transform:translateY(0)><div class=post-overlay-header><div class=post-overlay-title><a href=/ class=overlay-site-title>Gabriel Volpe</a></div><button class=post-overlay-close aria-label="Close post" onclick='window.location.href="/"'>
<i class="fas fa-times"></i></button></div><div class=post-layout><article class=post-content><header class=post-header><div class=post-meta><span class=post-date>2024.09.15</span><div class=reading-time-post><span class=coffee-cups>ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š
</span><span>5 min read</span></div></div><h1 class=post-title>NixOS server up in minutes!</h1><div class=post-tags-header><a href=https://gvolpe.com/tags/nix class=post-tag>nix</a>
<a href=https://gvolpe.com/tags/nixos class=post-tag>nixos</a>
<a href=https://gvolpe.com/tags/flakes class=post-tag>flakes</a>
<a href=https://gvolpe.com/tags/garnix class=post-tag>garnix</a>
<a href=https://gvolpe.com/tags/hosting class=post-tag>hosting</a></div></header><div class=post-body><h2 id=introduction>Introduction</h2><p>The folks at <a href=https://garnix.io>Garnix</a> have done it again! You can now deploy a <a href=https://nixos.org/>NixOS server</a> in minutes, just by defining your system on a <code>flake.nix</code> and <code>git push</code>&lsquo;ing your changes (Garnix needs to be enabled for the repo).</p><p>In their latest blog post <a href=https://garnix.io/blog/hosting-nixos>Hands-on NixOS servers</a>, they explain all the necessary steps to deploy your own server, so I won&rsquo;t repeat things over. Furthermore, there&rsquo;s <a href=https://garnix.io/docs/hosting>official documentation</a>.</p><p>Instead, I will explain how I used this opportunity to set up a web analytics server for this blog.</p><h2 id=web-analytics>Web Analytics</h2><p>I first looked into the different open-source solutions that allow self-hosting, and ended up choosing <a href=https://plausible.io/>Plausible</a>, briefly defined as follows:</p><style>.quote::before{content:"ğŸ“œ"}</style><div class=quote><h4>Official</h4><p>"Plausible is intuitive, lightweight and open source web analytics. No cookies and fully compliant with GDPR, CCPA and PECR. Made and hosted in the EU, powered by European-owned cloud infrastructure ğŸ‡ªğŸ‡º"</p></div><p>You can find the source code for the self-hosting community edition <a href=https://github.com/plausible/community-edition/>here</a>.</p><p>So, how do we set it up to run as a service with NixOS? Here are the relevant pieces:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;analytics.gvolpe.com&#34;</span>;
</span></span><span style=display:flex><span>  internalPort <span style=color:#f92672>=</span> <span style=color:#ae81ff>8000</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  imports <span style=color:#f92672>=</span> [ <span style=color:#e6db74>./agenix.nix</span> ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  services<span style=color:#f92672>.</span>plausible <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    adminUser <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin&#34;</span>;
</span></span><span style=display:flex><span>      email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin@garnix.io&#34;</span>;
</span></span><span style=display:flex><span>      activate <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      passwordFile <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/run/agenix/admin&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    server <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      baseUrl <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://</span><span style=color:#e6db74>${</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>      port <span style=color:#f92672>=</span> internalPort;
</span></span><span style=display:flex><span>      secretKeybaseFile <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/run/agenix/keybase&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  services<span style=color:#f92672>.</span>nginx <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    virtualHosts<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      locations<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>.</span>proxyPass <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:</span><span style=color:#e6db74>${</span>toString internalPort<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This configuration is written to <code>hosts/default.nix</code>. The Plausible server runs on <code>localhost:8000</code>, which is proxied via <a href=https://nginx.org/en/>nginx</a> to ports 80 and 443 (the latter handled directly by Garnix).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  networking<span style=color:#f92672>.</span>firewall<span style=color:#f92672>.</span>allowedTCPPorts <span style=color:#f92672>=</span> [ <span style=color:#ae81ff>80</span> <span style=color:#ae81ff>443</span> ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It also uses a <a href=https://www.postgresql.org/>PostgreSQL</a> instance <a href=https://github.com/NixOS/nixpkgs/blob/345c263f2f53a3710abe117f28a5cb86d0ba4059/nixos/modules/services/web-apps/plausible.nix#L308>auto-magically set up by its NixOS module</a> &mdash; gotta love NixOS! ğŸ¤©</p><p>Moreover, note that I used a <a href=https://garnix.io/docs/hosting/custom-domain>custom domain</a>, but this is not a requirement. You can get started by setting it to a value that adheres to the following format:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&lt;HOST&gt;.&lt;BRANCH&gt;.&lt;REPONAME&gt;.&lt;GITHUB ORG/USER&gt;.garnix.me
</span></span></code></pre></div><p>So, for this example in particular, it would be as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;web.main.web-analytics.gvolpe.garnix.me&#34;</span>;
</span></span></code></pre></div><h3 id=secrets>Secrets</h3><p>The Plausible service requires two secrets: the admin user&rsquo;s password, and the keybase secret. To set them up safely, we use <a href=https://github.com/ryantm/agenix>agenix</a>, as documented in the <a href=https://garnix.io/docs/hosting/secrets>Garnix docs</a> &mdash; though, keep in mind its caveats!</p><p>Here&rsquo;s the <code>agenix.nix</code> file imported in the previous code snippet:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  age <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    secrets <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      admin<span style=color:#f92672>.</span>file <span style=color:#f92672>=</span> <span style=color:#e6db74>../secrets/admin.age</span>;
</span></span><span style=display:flex><span>      keybase<span style=color:#f92672>.</span>file <span style=color:#f92672>=</span> <span style=color:#e6db74>../secrets/keybase.age</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    identityPaths <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/var/garnix/keys/repo-key&#34;</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This requires the agenix NixOS module to be imported first:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  nixosConfigurations<span style=color:#f92672>.</span>web <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixosSystem {
</span></span><span style=display:flex><span>    modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      garnix-lib<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>garnix
</span></span><span style=display:flex><span>      agenix<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>default
</span></span><span style=display:flex><span>      <span style=color:#e6db74>./hosts</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Also note that every secret needs to be manually set up via <code>agenix</code> (see documentation), resulting in two encrypted files that can only be decrypted with the supplied SSH keys.</p><h3 id=garnix-configuration>Garnix configuration</h3><p>We can opt for <a href=https://garnix.io/docs/hosting/branch>continuous deployment</a>, so that our server is re-deployed on every commit to the main branch. Here&rsquo;s what we need to set in our <code>garnix.yaml</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>servers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>configuration</span>: <span style=color:#ae81ff>web</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>deployment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#66d9ef>on</span>-<span style=color:#ae81ff>branch</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>branch</span>: <span style=color:#ae81ff>main</span>
</span></span></code></pre></div><p>The configuration name <code>web</code> corresponds to the exposed NixOS configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix flake show
</span></span><span style=display:flex><span>git+file:///home/gvolpe/workspace/web-analytics
</span></span><span style=display:flex><span>â”œâ”€â”€â”€nixosConfigurations
</span></span><span style=display:flex><span>â”‚   â””â”€â”€â”€web: NixOS configuration
</span></span><span style=display:flex><span>â””â”€â”€â”€packages
</span></span><span style=display:flex><span>    â””â”€â”€â”€x86_64-linux
</span></span><span style=display:flex><span>        â””â”€â”€â”€default: package <span style=color:#e6db74>&#39;agenix-0.15.0&#39;</span>
</span></span></code></pre></div><p>And of course, we could deploy on every <a href=https://garnix.io/docs/hosting/pr>pull request</a> too!</p><h3 id=see-it-live>See it live!</h3><p>Sure enough, after a few hours of traffic, we can already see active metrics:</p><p><img src=../../images/plausible.png alt=analytics></p><p>You can see it <a href=https://analytics.gvolpe.com/gvolpe.com>live here</a> &mdash; these analytics are publicly available.</p><p>NOTE: By default, signing up via the web is disabled; the only way to access it is with the &ldquo;admin&rdquo; user.</p><h2 id=persistence>Persistence</h2><p>Let&rsquo;s now discuss a crucial aspect of server deployments: <em>state</em>.</p><p>I tried a few deployments until I got the service up and running, and by default, a new server with unique IP address would be provisioned on every commit to the configured branch, as we can see in the list of servers below (it can be accessed via your <a href=https://garnix.io/servers>Garnix account</a>):</p><p><img src=../../images/hosting-garnix.png alt=servers></p><p>This is great for zero-downtime deployments, but Plausible persists its data in PostgreSQL, so we need that data to still be available on new deployments.</p><p>Fortunately, Garnix <a href=https://garnix.io/docs/hosting/persistence>supports persistence</a> via the following NixOS configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  garnix<span style=color:#f92672>.</span>server<span style=color:#f92672>.</span>persistence <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;plausible&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As long as the <code>name</code> remains the same, Garnix will deploy new commits to the same machine (same IP address). This is great for quick solutions, but for anything serious, please consider backing up your data.</p><p>I might give <a href=https://www.borgbackup.org/>Borg</a> a try soon enough, as it&rsquo;s <a href="https://search.nixos.org/options?channel=unstable&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=services.borgbackup">already packaged</a> for Nix :)</p><h2 id=machine>Machine</h2><p>It is worth mentioning a few things about the <strong>FREE machine</strong> we get by default on the free account, which you can connect to via SSH with its assigned IP address.</p><p><img src=../../images/ssh-machine.png alt=ssh-machine></p><p>We&rsquo;re obviously running NixOS! Furthermore, we have an Intel Xeon CPU with two cores and 4Gb of RAM, which I find very generous already, but what stands out the most to me is the free 40Gb of disk space!</p><p><img src=../../images/ssh-monitor.png alt=ssh-monitor></p><p>Here we can observe a few services like Clickhouse and Postgres up and running, among other metrics.</p><h2 id=final-words>Final words</h2><p>If you have followed my blog for a while, it shouldn&rsquo;t come as a surprise to see Garnix featured <a href=../categories/#garnix>once again</a>; they keep on delivering great features!</p><p>I think of this one as <strong>hosting and continuous deployment made simpleâ„¢ï¸</strong>. Nevertheless, bear in mind that this feature is currently in beta, so please report any issues you may find.</p><p>Have you tried Garnix yet? If not, what are you waiting for? ğŸ˜‰</p><p><strong>DISCLAIMER</strong>: I am not affiliated to Garnix; this is an independent review.</p><p>Best,
Gabriel.</p><hr><h3 id=addendum>Addendum</h3><p>Well, apparently someone shared this blog-post on <a href="https://news.ycombinator.com/item?id=41558865">Hacker News</a> and the metrics have blown up, so this was actually a great test for the Plausible server, thank you all! ğŸ™</p><p><img src=../../images/hn-metrics.png alt=hacker-news></p></div><div id=gh-comments><div id=gh-comments-list></div></div><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://gvolpe.com/js/github-comments.js></script><script type=text/javascript>DoGithubComments("gvolpe/blog-comments","31")</script><noscript>Please enable JavaScript to view comments.</noscript><div class=related-posts><h3>Related Content</h3><div class=related-grid><div class=related-post><h4><a href=https://gvolpe.com/blog/private-flake/>Private Nix flake ğŸ”’</a></h4><div class=related-meta>2024.02.27 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 6 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/nix-remote-builds/>Nix remote builds</a></h4><div class=related-meta>2023.02.13 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“š 4 min read</div></div><div class=related-post><h4><a href=https://gvolpe.com/blog/garnix/>Garnix CI</a></h4><div class=related-meta>2023.02.07 â€¢
ğŸ“šğŸ“šğŸ“šğŸ“šğŸ“š 6 min read</div></div></div></div><nav class=post-navigation><div class=nav-previous><span class=nav-label>â† Previous</span>
<a href=https://gvolpe.com/blog/flake-schemas/ class=nav-title>Flake Schemas</a></div><div class=nav-next><span class=nav-label>Next â†’</span>
<a href=https://gvolpe.com/blog/home-manager-dotfiles-management/ class=nav-title>Home Manager: dotfiles management</a></div></nav></article><aside class=sidebar><nav class=toc><h4>Contents</h4><div id=toc-content></div></nav></aside></div></div></div></main><script src=https://gvolpe.com/js/email.js></script><script src=https://gvolpe.com/js/main.js></script></body></html>