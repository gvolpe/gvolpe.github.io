<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!--<meta name="viewport" content="width=device-width, initial-scale=1">--> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /> <title> NixOS server up in minutes! &bull; gvolpe's blog </title> <meta name="description" content="Introduction"> <link rel="icon" href="/images/favicon.png"> <link rel="canonical" href="https://gvolpe.github.io/blog/nixos-server/"> <link rel="alternate" type="application/rss+xml" title="gvolpe's blog" href="https://gvolpe.github.io/blog/feed.xml" /> <link rel="stylesheet" href="/css/main.css"> <link rel="stylesheet" href="/assets/css/main.css"/> <!--Also needs to be set in ./_layouts/unified.html--> <script defer data-domain="gvolpe.com" src="https://analytics.gvolpe.com/js/script.js"></script> <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript> </head> <body class=""> <header id="header"> <h1> <a href="/blog">Gabriel Volpe's blog</a> </h1> <div class="overlay"> <div class="container"> <nav> <ul> <li><a href="/">Home</a></li> <li><a href="/blog/categories/">Categories</a></li> </ul> </nav> </div> </div> </header> <section id="projects" class="main style-post dark fullscreen"> <div class="content"> <div class="post-content"> <header class="post-header"> <h1 class="post-title">NixOS server up in minutes!</h1> <span class="post-meta"> <time class="post-date" datetime="2024-09-15">Sep 15, 2024</time> <span class="post-author">by <a href="/">Gabriel Volpe</a></span> </span> <div class="post-categories"> <span class="post-meta"> <a href="/blog/categories/#nix" class="cat-link">nix</a> &nbsp; <a href="/blog/categories/#nixos" class="cat-link">nixos</a> &nbsp; <a href="/blog/categories/#flakes" class="cat-link">flakes</a> &nbsp; <a href="/blog/categories/#garnix" class="cat-link">garnix</a> &nbsp; <a href="/blog/categories/#hosting" class="cat-link">hosting</a> </span> </div> </header> <h2 id="introduction">Introduction</h2> <p>The folks at <a href="https://garnix.io">Garnix</a> have done it again! You can now deploy a <a href="https://nixos.org/">NixOS server</a> in minutes, just by defining your system on a <code>flake.nix</code> and <code>git push</code>‘ing your changes (Garnix needs to be enabled for the repo).</p> <p>In their latest blog post <a href="https://garnix.io/blog/hosting-nixos">Hands-on NixOS servers</a>, they explain all the necessary steps to deploy your own server, so I won’t repeat things over. Furthermore, there’s <a href="https://garnix.io/docs/hosting">official documentation</a>.</p> <p>Instead, I will explain how I used this opportunity to set up a web analytics server for this website.</p> <h2 id="web-analytics">Web Analytics</h2> <p>I looked into the different open-source solutions that allow self-hosting, and ended up choosing <a href="https://plausible.io/">Plausible</a>, briefly defined as follows:</p> <blockquote> <p>Plausible is intuitive, lightweight and open source web analytics. No cookies and fully compliant with GDPR, CCPA and PECR. Made and hosted in the EU, powered by European-owned cloud infrastructure 🇪🇺</p> </blockquote> <p>You can find the source code for the self-hosting community edition <a href="https://github.com/plausible/community-edition/">here</a>.</p> <p>So, how do we set it up to run as a service with NixOS? Here are the relevant pieces:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="k">let</span>
  <span class="ss">host =</span> <span class="s2">&quot;analytics.gvolpe.com&quot;</span><span class="p">;</span>
  <span class="ss">internalPort =</span> <span class="mi">8000</span><span class="p">;</span>
<span class="k">in</span>
<span class="p">{</span>
  <span class="ss">imports =</span> <span class="p">[</span> <span class="o">.</span><span class="l">/agenix.nix</span> <span class="p">];</span>

  services<span class="o">.</span><span class="ss">plausible =</span> <span class="p">{</span>
    <span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
    <span class="ss">adminUser =</span> <span class="p">{</span>
      <span class="ss">name =</span> <span class="s2">&quot;admin&quot;</span><span class="p">;</span>
      <span class="ss">email =</span> <span class="s2">&quot;admin@garnix.io&quot;</span><span class="p">;</span>
      <span class="ss">activate =</span> <span class="no">true</span><span class="p">;</span>
      <span class="ss">passwordFile =</span> <span class="s2">&quot;/run/agenix/admin&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="ss">server =</span> <span class="p">{</span>
      <span class="ss">baseUrl =</span> <span class="s2">&quot;https://</span><span class="si">${</span>host<span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
      <span class="ss">port =</span> internalPort<span class="p">;</span>
      <span class="ss">secretKeybaseFile =</span> <span class="s2">&quot;/run/agenix/keybase&quot;</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>

  services<span class="o">.</span><span class="ss">nginx =</span> <span class="p">{</span>
    <span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
    virtualHosts<span class="o">.</span><span class="s2">&quot;</span><span class="si">${</span>host<span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="p">{</span>
      locations<span class="o">.</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="ss">proxyPass =</span> <span class="s2">&quot;http://localhost:</span><span class="si">${</span><span class="nb">toString</span> internalPort<span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>The Plausible server runs on <code>localhost:8000</code>, which is proxied via <a href="https://nginx.org/en/">nginx</a> to ports 80 and 443 (the latter handled directly by Garnix).</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  networking<span class="o">.</span>firewall<span class="o">.</span><span class="ss">allowedTCPPorts =</span> <span class="p">[</span> <span class="mi">80</span> <span class="mi">443</span> <span class="p">];</span>
<span class="p">}</span></code></pre></div> <p>It also uses a <a href="https://www.postgresql.org/">PostgreSQL</a> instance <a href="https://github.com/NixOS/nixpkgs/blob/345c263f2f53a3710abe117f28a5cb86d0ba4059/nixos/modules/services/web-apps/plausible.nix#L308">auto-magically set up by its NixOS module</a> — gotta love NixOS! 🤩</p> <h3 id="secrets">Secrets</h3> <p>The Plausible service requires two secrets: the admin user’s password, and the keybase secret. To set them up safely, we use <a href="https://github.com/ryantm/agenix">agenix</a>, as documented in the <a href="https://garnix.io/docs/hosting/secrets">Garnix docs</a> — though, keep in mind its caveats!</p> <p>Here’s the <code>agenix.nix</code> file imported in the previous code snippet:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> <span class="o">...</span> <span class="p">}:</span>

<span class="p">{</span>
  <span class="ss">age =</span> <span class="p">{</span>
    <span class="ss">secrets =</span> <span class="p">{</span>
      admin<span class="o">.</span><span class="ss">file =</span> <span class="o">..</span><span class="l">/secrets/admin.age</span><span class="p">;</span>
      keybase<span class="o">.</span><span class="ss">file =</span> <span class="o">..</span><span class="l">/secrets/keybase.age</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="ss">identityPaths =</span> <span class="p">[</span>
      <span class="s2">&quot;/var/garnix/keys/repo-key&quot;</span>
    <span class="p">];</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>This requires the agenix NixOS module to be imported first:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  nixosConfigurations<span class="o">.</span><span class="ss">web =</span> nixpkgs<span class="o">.</span>lib<span class="o">.</span>nixosSystem <span class="p">{</span>
    <span class="ss">modules =</span> <span class="p">[</span>
      garnix-lib<span class="o">.</span>nixosModules<span class="o">.</span>garnix
      agenix<span class="o">.</span>nixosModules<span class="o">.</span>default
      <span class="o">.</span><span class="l">/hosts</span>
    <span class="p">];</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>Also note that every secret needs to be manually set up via <code>agenix</code> (see documentation), resulting in two encrypted files that can only be decrypted with the configured SSH keys.</p> <h3 id="garnix-configuration">Garnix configuration</h3> <p>We can set up a <a href="https://garnix.io/docs/hosting/branch">continuous deployment</a>, so that our server is re-deployed on every commit to the main branch. Here’s what we need to set in our <code>garnix.yaml</code> file:</p> <div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">servers</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">configuration</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web</span>
    <span class="l-Scalar-Plain">deployment</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">on-branch</span>
      <span class="l-Scalar-Plain">branch</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">main</span></code></pre></div> <p>The configuration name <code>web</code> corresponds to the exposed NixOS configuration:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix flake show
git+file:///home/gvolpe/workspace/web-analytics
├───nixosConfigurations
│   └───web: NixOS configuration
└───packages
    └───x86_64-linux
        └───default: package <span class="s1">&#39;agenix-0.15.0&#39;</span></code></pre></div> <p>And of course, we could deploy on every <a href="https://garnix.io/docs/hosting/pr">pull request</a> too!</p> <h3 id="see-it-live">See it live!</h3> <p>Nothing better than seeing the fruits of your work paying off!</p> <p><img src="../../images/analytics.png" alt="analytics" /></p> <p>You can see it <a href="https://analytics.gvolpe.com/gvolpe.com">live here</a> — these analytics are publicly available.</p> <p>NOTE: By default, signing up via the web is disabled; the only way to access it is with the “admin” user.</p> <h2 id="persistence">Persistence</h2> <p>You can see the list of servers and their status in your <a href="https://garnix.io/servers">Garnix account</a>.</p> <p><img src="../../images/hosting-garnix.png" alt="servers" /></p> <p>I tried a few deployments until I got the service up and running, and by default, a new server with unique IP address would be provisioned on every commit to the configured branch.</p> <p>This is great for zero-downtime deployments, but Plausible persists its data in PostgreSQL, so we need that data to still be available on new deployments.</p> <p>Fortunately, Garnix <a href="https://garnix.io/docs/hosting/persistence">supports persistence</a> via the following NixOS configuration:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  garnix<span class="o">.</span>server<span class="o">.</span><span class="ss">persistence =</span> <span class="p">{</span>
    <span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
    <span class="ss">name =</span> <span class="s2">&quot;plausible&quot;</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>As long as the <code>name</code> remains the same, Garnix will deploy new commits to the same machine (same IP address). This is great for quick solutions, but for anything serious, please consider backing up your data.</p> <p>I might give <a href="https://www.borgbackup.org/">Borg</a> a try soon enough, as it’s <a href="https://search.nixos.org/options?channel=unstable&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=services.borgbackup">already packaged</a> for Nix :)</p> <h2 id="final-words">Final words</h2> <p>If you have followed my blog for a while, it shouldn’t come as a surprise to see Garnix featured <a href="../categories/#garnix">once again</a>; they keep on delivering great features!</p> <p>I think of this one as <strong>hosting and continuous deployment made simple™️</strong>. Nevertheless, bear in mind that this feature is currently in beta, so please report any issues you may find.</p> <p>Have you tried Garnix yet? If not, what are you waiting for? 😉</p> <p>Best, Gabriel.</p> <div id="gh-comments"> <br/><br/> <div id="gh-comments-list"></div> </div> <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"> </script> <script src="/js/github-comments.js"> </script> <script type="text/javascript"> DoGithubComments ( "gvolpe/blog-comments" , "31" ); </script> <noscript>Please enable JavaScript to view comments.</noscript> </div> </div> </section> <footer id="footer"> <!-- Icons --> <!-- Look here for more brands icons: https://fortawesome.com/sets/font-awesome-5-brands --> <ul class="icons"> <li><a href="base64:aGVsbG9AZ3ZvbHBlLmNvbQo=" target="_blank" class="icon solid fa-envelope"><span class="label">Email</span></a></li> <!--<li><a href="https://discordapp.com/channels/@me/510276992156041217" target="_blank" class="icon brands fa-discord"><span class="label">Discord</span></a></li>--> <li><a href="https://github.com/gvolpe" target="_blank" class="icon brands fa-github"><span class="label">Github</span></a></li> <li><a href="https://matrix.to/#/@gvolpe:matrix.org" target="_blank" class="icon brands fa-gitter"><span class="label">Matrix</span></a></li> <li><a rel="me" href="https://fosstodon.org/@gvolpe" target="_blank" class="icon brands fa-mastodon"><span class="label">Mastodon</span>></a></li> <li><a href="https://twitter.com/volpegabriel87" target="_blank" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li> <li><a href="https://bsky.app/profile/gvolpe.com" target="_blank" class="icon brands fa-dribbble"><span class="label">Bluesky</span></a></li> <li><a href="https://linkedin.com/in/gmvolpe" target="_blank" class="icon brands fa-linkedin-in"><span class="label">LinkedIn</span></a></li> <li><a href="https://leanpub.com/u/gvolpe" target="_blank" class="icon brands fa-leanpub"><span class="label">LeanPub</span></a></li> <li><a href="https://www.blurb.co.uk/user/gvolpe" target="_blank" class="icon brands fa-bimobject"><span class="label">Blurb</span></a></li> </ul> <small> Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a> </small> <!-- Menu --> <ul class="menu"> <li> &copy; Gabriel Volpe 2020-2024 </li> </ul> </footer> </body> </html></body></html>
